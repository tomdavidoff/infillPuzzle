
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # main.vancouver_permits_
> # main analysis script
> # Tom Davidoff
> # 01/16/26
> 
> library(data.table)
> library(ggplot2)
> library(fixest)
> 
> # Vancouver analysis # note neighbourhoodDescription better than tract for analysis level
> # get slopes and mean values from BCA sales analysis by census tract merge
> nameSlope <- "tables/bca19_mean_ppsf_slope_by_tract.csv"
> if (!file.exists(nameSlope)) {
+   source("scripts/bcaSales.R")
+ }
> # specify column CTUID is a number
> dtSlope <- fread(nameSlope,colClasses=c(CTUID="character"))
> # giant outlier at low obs
> CUTOFFN <- .05
> dtSlope <- dtSlope[nobs>quantile(nobs,CUTOFFN)]
> 
> # Now get projects merged with BCA and census tracts
> nameSpatial <- "~/OneDrive - UBC/dataProcessed/vancouverPermitLotsTracts.rds"
> if (!file.exists(nameSpatial)) {
+   source("scripts/mergePermitsSpatial.R")
+ }
> dtSpatial <- readRDS(nameSpatial)
> 
> print(head(dtSpatial))
        CTUID     ROLL_NUMBER    folioID permitnumbercreateddate     use
       <char>          <char>     <char>                  <IDat>  <char>
1: 9330044.00 001633021620000 A0000000CR              2024-01-17  single
2: 9330029.00 009697153290000 A00000191E              2019-02-21  single
3: 9330030.00 016185716270000 A0000025QE              2018-04-30  single
4: 9330013.01 019237750590000 A000002L99              2025-05-13 laneway
5: 9330008.02 006769050140000 A000000U30              2021-07-15  single
6: 9330043.02 001650034570000 A0000001L4              2024-11-27 laneway
   MB_effective_year MB_total_finished_area neighbourhoodDescription
              <char>                 <char>                   <char>
1:              1965                   4002               POINT GREY
2:                                                            CAMBIE
3:              2019                   3342              MAIN/FRASER
4:              2007                   2198                   KNIGHT
5:              1978                   3064               SOUTHLANDS
6:              1975                   2764               POINT GREY
                                        address LANDAREA
                                         <char>    <num>
1:   4632 LANGARA AVENUE, Vancouver, BC V6R 1E1   2.8772
2:     869 W 20TH AVENUE, Vancouver, BC V5Z 1Y3   1.5016
3:     4427 JAMES STREET, Vancouver, BC V5V 3H9   1.4562
4: 5835 ARGYLE STREET #3, Vancouver, BC V6P 3J8   1.1375
5:    3280 W 48TH AVENUE, Vancouver, BC V6N 3P8   3.5378
6:    3863 W BROADWAY #3, Vancouver, BC V6R 2C2   0.9967
               geo_point_2d
                     <char>
1: 49.2729074, -123.2125593
2: 49.2537249, -123.1237645
3: 49.2456172, -123.1042038
4: 49.2313344, -123.0719816
5: 49.2281967, -123.1779482
6:  49.2647127, -123.189698
> print(head(dtSlope))
        CTUID meanPPSF  nobs      slope elasticity
       <char>    <num> <int>      <num>      <num>
1:            732.2076     7         NA         NA
2: 9330001.02 603.2265    10 -0.3711131 -0.8065417
3: 9330002.01 631.6724    54 -0.3260755 -0.5973253
4: 9330002.03 614.8959    66 -0.3021881 -0.6117229
5: 9330002.04 586.0877    37 -0.3341864 -0.7916304
6: 9330003.01 612.5530    55 -0.3039813 -0.3420110
> 
> dtMerge <- merge(dtSpatial,dtSlope,by="CTUID")
> print(head(dtMerge))
Key: <CTUID>
        CTUID     ROLL_NUMBER    folioID permitnumbercreateddate    use
       <char>          <char>     <char>                  <IDat> <char>
1: 9330001.02 025821302570000 A000003GB0              2022-06-27 duplex
2: 9330001.02 025821302870000 A000003GB3              2018-08-23 single
3: 9330001.02 025821306320000 A000003GBH              2021-08-13 duplex
4: 9330001.02 025818302040000 A000003G6M              2021-09-20 duplex
5: 9330002.01 025270817560000 A000003DPP              2021-12-01 single
6: 9330002.01 025813270050000 A000003FS4              2021-06-14 duplex
   MB_effective_year MB_total_finished_area neighbourhoodDescription
              <char>                 <char>                   <char>
1:              1973                   3846               FRASERVIEW
2:              2019                   2566               FRASERVIEW
3:              1973                   3082               FRASERVIEW
4:              1974                   3220               FRASERVIEW
5:              1963                   2008               FRASERVIEW
6:              1970                   2316               FRASERVIEW
                                       address LANDAREA
                                        <char>    <num>
1:   3141 E 62ND AVENUE, Vancouver, BC V5S 2G6   1.8621
2:   3157 E 62ND AVENUE, Vancouver, BC V5S 2G6   1.8621
3:   3210 E 62ND AVENUE, Vancouver, BC V5S 2G5   1.8621
4: 7726 MUNROE CRESCENT, Vancouver, BC V5S 3J9   1.8621
5:  7770 ELLIOTT STREET, Vancouver, BC V5S 2N9   1.9403
6:  7376 ELLIOTT STREET, Vancouver, BC V5S 2N5   1.9403
               geo_point_2d meanPPSF  nobs      slope elasticity
                     <char>    <num> <int>      <num>      <num>
1:   49.21401, -123.0392725 603.2265    10 -0.3711131 -0.8065417
2: 49.2140062, -123.0388062 603.2265    10 -0.3711131 -0.8065417
3: 49.2132602, -123.0365756 603.2265    10 -0.3711131 -0.8065417
4: 49.2143439, -123.0399512 603.2265    10 -0.3711131 -0.8065417
5: 49.2138533, -123.0545981 631.6724    54 -0.3260755 -0.5973253
6: 49.2174104, -123.0535628 631.6724    54 -0.3260755 -0.5973253
> print(summary(dtMerge))
    CTUID           ROLL_NUMBER          folioID         
 Length:2362        Length:2362        Length:2362       
 Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character  
                                                         
                                                         
                                                         
 permitnumbercreateddate     use            MB_effective_year 
 Min.   :2017-01-04      Length:2362        Length:2362       
 1st Qu.:2020-09-28      Class :character   Class :character  
 Median :2022-06-21      Mode  :character   Mode  :character  
 Mean   :2022-04-13                                           
 3rd Qu.:2024-07-30                                           
 Max.   :2025-10-17                                           
 MB_total_finished_area neighbourhoodDescription   address         
 Length:2362            Length:2362              Length:2362       
 Class :character       Class :character         Class :character  
 Mode  :character       Mode  :character         Mode  :character  
                                                                   
                                                                   
                                                                   
    LANDAREA      geo_point_2d          meanPPSF          nobs       
 Min.   :0.4194   Length:2362        Min.   :586.1   Min.   :  7.00  
 1st Qu.:0.8985   Class :character   1st Qu.:659.3   1st Qu.: 32.00  
 Median :1.2593   Mode  :character   Median :746.7   Median : 50.00  
 Mean   :1.3036                      Mean   :736.8   Mean   : 55.49  
 3rd Qu.:1.5016                      3rd Qu.:814.9   3rd Qu.: 70.00  
 Max.   :3.5378                      Max.   :870.8   Max.   :161.00  
     slope           elasticity      
 Min.   :-0.3814   Min.   :-0.80654  
 1st Qu.:-0.3131   1st Qu.:-0.42390  
 Median :-0.2671   Median :-0.25240  
 Mean   :-0.2722   Mean   :-0.26410  
 3rd Qu.:-0.2319   3rd Qu.:-0.05431  
 Max.   :-0.1391   Max.   : 0.32787  
> print(table(dtMerge[,use]))

 duplex laneway   multi  single 
    760     510     173     919 
> # permitnumbercreateddate     use            MB_effective_year 
> # Min.   :2017-01-03      Length:3762        Length:3762       
> 
> dtMerge[,pYear:=year(permitnumbercreateddate)]
> for (y in sort(unique(dtMerge[,pYear]))) {
+   print(y)
+   print(table(dtMerge[pYear==y,use]))
+ }
[1] 2017

laneway  single 
      8     209 
[1] 2018

 duplex laneway  single 
      1       2     153 
[1] 2019

 duplex laneway   multi  single 
     14       2       1     127 
[1] 2020

 duplex laneway   multi  single 
     34       8       1      65 
[1] 2021

 duplex laneway   multi  single 
    272      14       2     152 
[1] 2022

 duplex laneway   multi  single 
    116       7       3      77 
[1] 2023

 duplex laneway   multi  single 
    101      41       3      66 
[1] 2024

 duplex laneway   multi  single 
    129     290      95      48 
[1] 2025

 duplex laneway   multi  single 
     93     138      68      22 
> 
> 
> dtMerge[,MB_total_finished_area:=as.numeric(MB_total_finished_area)]
> dtMerge[,MB_effective_year:=as.numeric(MB_effective_year)]
> dtMerge[,effectiveAge:=pYear - MB_effective_year]
> 
> dtMerge[,notSingle:=use!="single" & use!="laneway"]
> # use geo_point_2d to plot variable notSingle by lon,lat
> ggplot(dtMerge,aes(x=as.numeric(tstrsplit(geo_point_2d,", ")[[2]]),
+                     y=as.numeric(tstrsplit(geo_point_2d,", ")[[1]]),
+                     color=notSingle)) +
+   geom_point() +
+   theme_minimal() +
+   labs(title="Vancouver Permits 2017-2025",
+        subtitle="Not Single Family (including laneway) Permits")
>   ggsave("text/notSingleLocation.png",width=8,height=6)
> 
>   # now plot meanPPSF by lon,lat
> ggplot(dtMerge,aes(x=as.numeric(tstrsplit(geo_point_2d,", ")[[2]]),
+                     y=as.numeric(tstrsplit(geo_point_2d,", ")[[1]]),
+                     color=meanPPSF)) +
+   geom_point() +
+   theme_minimal() +
+   labs(title="Vancouver Permits 2017-2025",
+        subtitle="Mean PPSF from BCA Sales 2019-2021 by Census Tract")
>   ggsave("text/meanPPSFLocation.png",width=8,height=6)
> 
>   # now plot elasticity by lon,lat
> ggplot(dtMerge,aes(x=as.numeric(tstrsplit(geo_point_2d,", ")[[2]]),
+                     y=as.numeric(tstrsplit(geo_point_2d,", ")[[1]]),
+                     color=elasticity)) +
+   geom_point() +
+   theme_minimal() +
+   labs(title="Vancouver Permits 2017-2025",
+        subtitle="Elasticity from BCA Sales 2019-2021 by Census Tract")
>   ggsave("text/elasticityLocation.png",width=8,height=6)
> 
>   # and slope
> ggplot(dtMerge,aes(x=as.numeric(tstrsplit(geo_point_2d,", ")[[2]]),
+                     y=as.numeric(tstrsplit(geo_point_2d,", ")[[1]]),
+                     color=slope)) +
+   geom_point() +
+   theme_minimal() +
+   labs(title="Vancouver Permits 2017-2025",
+        subtitle="Slope from BCA Sales 2019-2021 by Census Tract")
>   ggsave("text/slopeLocation.png",width=8,height=6)
> 
> # combinedera
> print(summary(feols(notSingle ~ meanPPSF  | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
          Estimate Std. Error  t value Pr(>|t|) 
meanPPSF -0.001255   0.000815 -1.54025  0.19834 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.481524     Adj. R2: 0.069634
                 Within R2: 0.041803
> print(summary(feols(notSingle ~ slope  | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
       Estimate Std. Error  t value Pr(>|t|)    
slope -0.992974   0.359114 -2.76507 0.050586 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.489198     Adj. R2: 0.039744
                 Within R2: 0.01102 
> print(summary(feols(notSingle ~ elasticity  | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
            Estimate Std. Error  t value Pr(>|t|) 
elasticity -0.173673    0.11637 -1.49242  0.20987 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.490246     Adj. R2: 0.035626
                 Within R2: 0.006778
> print(summary(feols(notSingle ~ meanPPSF + elasticity  | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
            Estimate Std. Error   t value Pr(>|t|) 
meanPPSF   -0.001366   0.000885 -1.542132  0.19790 
elasticity  0.072194   0.075037  0.962112  0.39048 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.481311     Adj. R2: 0.069921
                 Within R2: 0.042653
> print(summary(feols(notSingle ~ meanPPSF + slope  | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
          Estimate Std. Error   t value Pr(>|t|) 
meanPPSF -0.001212   0.000912 -1.329027  0.25458 
slope    -0.147427   0.418311 -0.352435  0.74230 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.481476     Adj. R2: 0.069283
                 Within R2: 0.041997
> print(summary(feols(notSingle ~ meanPPSF + log(MB_total_finished_area) + log(LANDAREA) + log(effectiveAge) | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
                             Estimate Std. Error  t value   Pr(>|t|)    
meanPPSF                    -0.000744   0.000680 -1.09357 0.33558307    
log(MB_total_finished_area) -0.220539   0.038389 -5.74489 0.00455012 ** 
log(LANDAREA)               -0.038982   0.018075 -2.15664 0.09725431 .  
log(effectiveAge)            0.358071   0.028874 12.40117 0.00024305 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.428549     Adj. R2: 0.261804
                 Within R2: 0.24104 
> print(summary(feols(notSingle ~ meanPPSF+slope + log(MB_total_finished_area) + log(LANDAREA) + log(effectiveAge) | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
                             Estimate Std. Error   t value   Pr(>|t|)    
meanPPSF                    -0.000793   0.000757 -1.047276 0.35408081    
slope                        0.176830   0.326864  0.540988 0.61723535    
log(MB_total_finished_area) -0.224902   0.040075 -5.612043 0.00495345 ** 
log(LANDAREA)               -0.036693   0.019927 -1.841331 0.13938320    
log(effectiveAge)            0.357264   0.030212 11.825376 0.00029273 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.428473     Adj. R2: 0.261637
                 Within R2: 0.241308
> print(summary(feols(notSingle ~ meanPPSF+elasticity + log(MB_total_finished_area) + log(LANDAREA) + log(effectiveAge) | pYear,data=dtMerge[pYear %between% c(2021,2025)])))
OLS estimation, Dep. Var.: notSingle
Observations: 1,737
Fixed-effects: pYear: 5
Standard-errors: Clustered (pYear) 
                             Estimate Std. Error  t value   Pr(>|t|)    
meanPPSF                    -0.000921   0.000737 -1.24985 0.27948840    
elasticity                   0.116223   0.052174  2.22762 0.08984786 .  
log(MB_total_finished_area) -0.230317   0.039219 -5.87254 0.00419984 ** 
log(LANDAREA)               -0.030517   0.019520 -1.56339 0.19300053    
log(effectiveAge)            0.355733   0.030286 11.74595 0.00030054 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.427949     Adj. R2: 0.263443
                 Within R2: 0.243163
> 
> # aggregate
> dtAgg <- dtMerge[,.(nPermits=.N,
+                       nNotSingle=sum(use!="single" & use!="laneway"),
+                       meanPPSF=mean(meanPPSF,na.rm=TRUE),
+                       slope=mean(slope,na.rm=TRUE),
+                       elasticity=mean(elasticity,na.rm=TRUE),
+                       meanFinishedArea=mean(MB_total_finished_area,na.rm=TRUE),
+                       meanLandArea=mean(LANDAREA,na.rm=TRUE),
+                       meanEffectiveAge=mean(effectiveAge,na.rm=TRUE)),
+                   by=.(CTUID)]
> 
> print(summary(feols(nNotSingle/nPermits ~ meanPPSF + log(meanLandArea) + log(meanEffectiveAge) | 1,data=dtAgg)))
OLS estimation, Dep. Var.: nNotSingle/nPermits
Observations: 69
Standard-errors: IID 
                       Estimate Std. Error   t value   Pr(>|t|)    
(Intercept)           -2.012313   0.459703 -4.377418 4.4547e-05 ***
meanPPSF              -0.000326   0.000238 -1.369478 1.7556e-01    
log(meanLandArea)     -0.002716   0.035432 -0.076657 9.3913e-01    
log(meanEffectiveAge)  0.711475   0.090717  7.842811 5.5521e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.116448   Adj. R2: 0.663583
> print(summary(feols(nNotSingle/nPermits ~ meanPPSF + slope + log(meanLandArea) + log(meanEffectiveAge) | 1,data=dtAgg)))
OLS estimation, Dep. Var.: nNotSingle/nPermits
Observations: 69
Standard-errors: IID 
                       Estimate Std. Error   t value   Pr(>|t|)    
(Intercept)           -1.999275   0.480058 -4.164653 9.5145e-05 ***
meanPPSF              -0.000336   0.000259 -1.296336 1.9951e-01    
slope                  0.030736   0.296916  0.103517 9.1788e-01    
log(meanLandArea)     -0.002163   0.036102 -0.059911 9.5241e-01    
log(meanEffectiveAge)  0.712228   0.091704  7.766586 8.3162e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.116439   Adj. R2: 0.658384
> print(summary(feols(nNotSingle/nPermits ~ meanPPSF + elasticity + log(meanLandArea) + log(meanEffectiveAge) | 1,data=dtAgg)))
OLS estimation, Dep. Var.: nNotSingle/nPermits
Observations: 69
Standard-errors: IID 
                       Estimate Std. Error   t value   Pr(>|t|)    
(Intercept)           -1.971334   0.478794 -4.117293 1.1195e-04 ***
meanPPSF              -0.000372   0.000276 -1.346398 1.8292e-01    
elasticity             0.023348   0.069758  0.334706 7.3894e-01    
log(meanLandArea)     -0.000404   0.036339 -0.011121 9.9116e-01    
log(meanEffectiveAge)  0.711131   0.091349  7.784798 7.7234e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.116347   Adj. R2: 0.658923
> 
> proc.time()
   user  system elapsed 
  2.005   0.093   1.505 
