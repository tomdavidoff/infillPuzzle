
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # main.R
> # main analysis script
> # Tom Davidoff
> # 01/16/26
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(ggplot2)
> library(fixest)
> 
> # Vancouver analysis # note neighbourhoodDescription better than tract for analysis level
> # get slopes and mean values from BCA sales analysis by census tract merge
> nameSlope <- "tables/bca19_mean_ppsf_slope_All_by_neighbourhood.csv"
> if (!file.exists(nameSlope)) {
+   source("scripts/bcaSalesAll.R")
+ }
> # specify column CTUID is a number
> dtSlope <- fread(nameSlope)
> 
> # Now get projects merged with BCA and census tracts
> nameSpatial <- "~/OneDrive - UBC/dataProcessed/vancouverPermitLotsTracts.rds"
> if (!file.exists(nameSpatial)) {
+   source("scripts/mergePermitsSpatial.R")
+ }
> dtSpatial <- readRDS(nameSpatial)
> 
> print(head(dtSpatial))
        CTUID     ROLL_NUMBER    folioID permitnumbercreateddate     use
       <char>          <char>     <char>                  <IDat>  <char>
1: 9330044.00 001633021620000 A0000000CR              2024-01-17  single
2: 9330029.00 009697153290000 A00000191E              2019-02-21  single
3: 9330030.00 016185716270000 A0000025QE              2018-04-30  single
4: 9330013.01 019237750590000 A000002L99              2025-05-13 laneway
5: 9330008.02 006769050140000 A000000U30              2021-07-15  single
6: 9330043.02 001650034570000 A0000001L4              2024-11-27 laneway
   maxSingle MB_effective_year MB_total_finished_area neighbourhoodDescription
       <int>            <char>                 <char>                   <char>
1:         1              1965                   4002               POINT GREY
2:         1                                                            CAMBIE
3:         1              2019                   3342              MAIN/FRASER
4:         0              2007                   2198                   KNIGHT
5:         1              1978                   3064               SOUTHLANDS
6:         0              1975                   2764               POINT GREY
                                        address LANDAREA landWidth landDepth
                                         <char>    <num>    <char>    <char>
1:   4632 LANGARA AVENUE, Vancouver, BC V6R 1E1   2.8772        65       110
2:     869 W 20TH AVENUE, Vancouver, BC V5Z 1Y3   1.5016        33       122
3:     4427 JAMES STREET, Vancouver, BC V5V 3H9   1.4562      49.5       111
4: 5835 ARGYLE STREET #3, Vancouver, BC V6P 3J8   1.1375        33       122
5:    3280 W 48TH AVENUE, Vancouver, BC V6N 3P8   3.5378     65.99    164.84
6:    3863 W BROADWAY #3, Vancouver, BC V6R 2C2   0.9967     58.54    108.84
               geo_point_2d            typeofwork
                     <char>                <char>
1: 49.2729074, -123.2125593 Addition / Alteration
2: 49.2537249, -123.1237645          New Building
3: 49.2456172, -123.1042038          New Building
4: 49.2313344, -123.0719816          New Building
5: 49.2281967, -123.1779482          New Building
6:  49.2647127, -123.189698          New Building
> print(head(dtSlope))
    neighbourhoodDescription meanPPSF  nobs meanPPSF_duplex nobs_duplex
                      <char>    <num> <int>           <num>       <int>
1: ARBUTUS/MACKENZIE HEIGHTS 881.4887  1445        792.4155         514
2:                    CAMBIE 833.1853  2011        812.2540        1263
3:             CEDAR COTTAGE 654.1520  2071        650.2828        1392
4:               COLLINGWOOD 591.3192  5080        600.0929        4046
5:                  DOWNTOWN 808.6779  7860        808.6779        7860
6:            DOWNTOWN SOUTH 819.1813  7443        819.0719        7440
   meanPPSF_single nobs_single        slope elasticity
             <num>       <int>        <num>      <num>
1:        930.6655         931 -0.002710578  0.4098047
2:        868.5279         748 -0.067257728  0.1646034
3:        662.0843         679 -0.129774167 -0.1304721
4:        556.9878        1034 -0.120356325 -0.0433349
5:              NA          NA  0.123665249  0.7144922
6:       1090.4724           3  0.029837476  0.5269922
> dtMerge <- merge(dtSpatial,dtSlope,by="neighbourhoodDescription")
> print(head(dtMerge))
Key: <neighbourhoodDescription>
    neighbourhoodDescription      CTUID     ROLL_NUMBER    folioID
                      <char>     <char>          <char>     <char>
1: ARBUTUS/MACKENZIE HEIGHTS 9330026.00 004698070060000 A000000MK2
2: ARBUTUS/MACKENZIE HEIGHTS 9330026.00 004701067070000 A000000MPG
3: ARBUTUS/MACKENZIE HEIGHTS 9330023.00 004726060300000 A000000P3A
4: ARBUTUS/MACKENZIE HEIGHTS 9330023.00 004726054310000 A000000P1R
5: ARBUTUS/MACKENZIE HEIGHTS 9330026.00 004698067070000 A000000MJA
6: ARBUTUS/MACKENZIE HEIGHTS 9330026.00 004710062840000 A000000N4W
   permitnumbercreateddate     use maxSingle MB_effective_year
                    <IDat>  <char>     <int>            <char>
1:              2021-05-04  duplex         0              1940
2:              2023-03-06  single         1              1944
3:              2024-10-11 laneway         0              1996
4:              2025-06-06  single         1              2003
5:              2023-08-30  single         1              1970
6:              2025-10-03 laneway         0              1970
   MB_total_finished_area                                      address LANDAREA
                   <char>                                       <char>    <num>
1:                   1619    2796 W 21ST AVENUE, Vancouver, BC V6L 1K3   1.2593
2:                   1539    2893 W 22ND AVENUE, Vancouver, BC V6L 1M7   1.2593
3:                   2576 2882 W 32ND AVENUE #3, Vancouver, BC V6L 2B6   1.2002
4:                   4339    3131 W 32ND AVENUE, Vancouver, BC V6L 2B9   1.2002
5:                   1829    2895 W 21ST AVENUE, Vancouver, BC V6L 1K5   1.2593
6:                   3387  2806 W KING EDWARD AVENUE #3, Vancouver, BC   1.2593
   landWidth landDepth             geo_point_2d            typeofwork meanPPSF
      <char>    <char>                   <char>                <char>    <num>
1:     40.07    122.07 49.2534415, -123.1675267          New Building 881.4887
2:        33       122 49.2530631, -123.1699259          New Building 881.4887
3:        33    130.25 49.2429853, -123.1696341          New Building 881.4887
4:        50    130.15  49.243546, -123.1748728 Addition / Alteration 881.4887
5:      37.5       122 49.2539631, -123.1698984          New Building 881.4887
6:                     49.2478066, -123.1683513          New Building 881.4887
    nobs meanPPSF_duplex nobs_duplex meanPPSF_single nobs_single        slope
   <int>           <num>       <int>           <num>       <int>        <num>
1:  1445        792.4155         514        930.6655         931 -0.002710578
2:  1445        792.4155         514        930.6655         931 -0.002710578
3:  1445        792.4155         514        930.6655         931 -0.002710578
4:  1445        792.4155         514        930.6655         931 -0.002710578
5:  1445        792.4155         514        930.6655         931 -0.002710578
6:  1445        792.4155         514        930.6655         931 -0.002710578
   elasticity
        <num>
1:  0.4098047
2:  0.4098047
3:  0.4098047
4:  0.4098047
5:  0.4098047
6:  0.4098047
> print(summary(dtMerge))
 neighbourhoodDescription    CTUID           ROLL_NUMBER       
 Length:2441              Length:2441        Length:2441       
 Class :character         Class :character   Class :character  
 Mode  :character         Mode  :character   Mode  :character  
                                                               
                                                               
                                                               
   folioID          permitnumbercreateddate     use              maxSingle     
 Length:2441        Min.   :2017-01-04      Length:2441        Min.   :0.0000  
 Class :character   1st Qu.:2020-09-04      Class :character   1st Qu.:0.0000  
 Mode  :character   Median :2022-06-20      Mode  :character   Median :0.0000  
                    Mean   :2022-04-09                         Mean   :0.4015  
                    3rd Qu.:2024-07-29                         3rd Qu.:1.0000  
                    Max.   :2025-10-17                         Max.   :1.0000  
 MB_effective_year  MB_total_finished_area   address             LANDAREA     
 Length:2441        Length:2441            Length:2441        Min.   :0.3178  
 Class :character   Class :character       Class :character   1st Qu.:0.8885  
 Mode  :character   Mode  :character       Mode  :character   Median :1.2593  
                                                              Mean   :1.3065  
                                                              3rd Qu.:1.5340  
                                                              Max.   :3.5378  
  landWidth          landDepth         geo_point_2d        typeofwork       
 Length:2441        Length:2441        Length:2441        Length:2441       
 Class :character   Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character   Mode  :character  
                                                                            
                                                                            
                                                                            
    meanPPSF          nobs      meanPPSF_duplex  nobs_duplex    
 Min.   :521.4   Min.   : 522   Min.   :496.5   Min.   :  15.0  
 1st Qu.:564.6   1st Qu.:1188   1st Qu.:571.1   1st Qu.: 242.0  
 Median :654.2   Median :1522   Median :658.7   Median : 362.0  
 Mean   :717.9   Mean   :1840   Mean   :672.0   Mean   : 850.9  
 3rd Qu.:881.5   3rd Qu.:2011   3rd Qu.:749.3   3rd Qu.: 850.0  
 Max.   :912.6   Max.   :5855   Max.   :923.8   Max.   :5006.0  
 meanPPSF_single  nobs_single         slope             elasticity     
 Min.   :541.4   Min.   :  26.0   Min.   :-0.231595   Min.   :-0.1870  
 1st Qu.:569.3   1st Qu.: 748.0   1st Qu.:-0.067258   1st Qu.: 0.1298  
 Median :662.1   Median : 931.0   Median :-0.014334   Median : 0.3155  
 Mean   :741.7   Mean   : 989.3   Mean   :-0.025541   Mean   : 0.3004  
 3rd Qu.:930.7   3rd Qu.:1247.0   3rd Qu.: 0.007878   3rd Qu.: 0.4711  
 Max.   :993.9   Max.   :1452.0   Max.   : 0.037843   Max.   : 0.6388  
> print(table(dtMerge[,use]))

 duplex laneway   multi  single 
    765     517     179     980 
> # permitnumbercreateddate     use            MB_effective_year 
> # Min.   :2017-01-03      Length:3762        Length:3762       
> 
> dtMerge[,pYear:=year(permitnumbercreateddate)]
> for (y in sort(unique(dtMerge[,pYear]))) {
+   print(y)
+   print(table(dtMerge[pYear==y,use]))
+ }
[1] 2017

laneway  single 
      8     217 
[1] 2018

 duplex laneway  single 
      1       3     156 
[1] 2019

 duplex laneway   multi  single 
     14       2       1     138 
[1] 2020

 duplex laneway   multi  single 
     36       8       1      70 
[1] 2021

 duplex laneway   multi  single 
    274      13       1     164 
[1] 2022

 duplex laneway   multi  single 
    116       7       3      82 
[1] 2023

 duplex laneway   multi  single 
    101      42       4      72 
[1] 2024

 duplex laneway   multi  single 
    130     291      96      57 
[1] 2025

 duplex laneway   multi  single 
     93     143      73      24 
> 
> 
> dtMerge[,MB_total_finished_area:=as.numeric(MB_total_finished_area)]
> dtMerge[,MB_effective_year:=as.numeric(MB_effective_year)]
> dtMerge[,landWidth:=as.numeric(landWidth)]
> dtMerge[,landDepth:=as.numeric(landDepth)]
> dtMerge[,effectiveAge:=pYear - MB_effective_year]
> dtMerge[maxSingle==0 & use=="laneway",use:="lanewayOnly"]
> # No duplexes under 25 years old (?)
> print(summary(dtMerge[,.(MB_total_finished_area,landWidth,landDepth,effectiveAge)]))
 MB_total_finished_area   landWidth        landDepth      effectiveAge   
 Min.   :  100          Min.   : 16.50   Min.   : 50.0   Min.   : -3.00  
 1st Qu.: 1866          1st Qu.: 33.00   1st Qu.:116.5   1st Qu.: 21.00  
 Median : 2362          Median : 36.00   Median :122.0   Median : 49.00  
 Mean   : 2705          Mean   : 42.69   Mean   :124.0   Mean   : 42.13  
 3rd Qu.: 3089          3rd Qu.: 50.00   3rd Qu.:129.0   3rd Qu.: 62.00  
 Max.   :26505          Max.   :132.00   Max.   :404.0   Max.   :114.00  
 NA's   :21             NA's   :180      NA's   :180     NA's   :21      
> 
> dtMerge[,notSingle:=use!="single" & use!="laneway"]
> 
> print(names(dtMerge))
 [1] "neighbourhoodDescription" "CTUID"                   
 [3] "ROLL_NUMBER"              "folioID"                 
 [5] "permitnumbercreateddate"  "use"                     
 [7] "maxSingle"                "MB_effective_year"       
 [9] "MB_total_finished_area"   "address"                 
[11] "LANDAREA"                 "landWidth"               
[13] "landDepth"                "geo_point_2d"            
[15] "typeofwork"               "meanPPSF"                
[17] "nobs"                     "meanPPSF_duplex"         
[19] "nobs_duplex"              "meanPPSF_single"         
[21] "nobs_single"              "slope"                   
[23] "elasticity"               "pYear"                   
[25] "effectiveAge"             "notSingle"               
> dtMerge[,pDelta:=meanPPSF_single-meanPPSF_duplex]
> print(feols(notSingle ~ meanPPSF + pDelta | pYear, data=dtMerge))
OLS estimation, Dep. Var.: notSingle
Observations: 2,441
Fixed-effects: pYear: 9
Standard-errors: Clustered (pYear) 
          Estimate Std. Error   t value  Pr(>|t|)    
meanPPSF -0.001025   0.000285 -3.596112 0.0070218 ** 
pDelta   -0.000023   0.000139 -0.168596 0.8702988    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.337072     Adj. R2: 0.525226
                 Within R2: 0.160212
> print(feols(notSingle ~ meanPPSF_single + meanPPSF_duplex | pYear, data=dtMerge[pYear>2020],cluster="neighbourhoodDescription"))
OLS estimation, Dep. Var.: notSingle
Observations: 1,786
Fixed-effects: pYear: 5
Standard-errors: Clustered (neighbourhoodDescription) 
                 Estimate Std. Error   t value   Pr(>|t|)    
meanPPSF_single -0.000924   0.000115 -8.004817 1.1549e-07 ***
meanPPSF_duplex -0.000139   0.000166 -0.840421 4.1061e-01    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.355817     Adj. R2: 0.267802
                 Within R2: 0.181053
> print(cor(dtMerge[,.(meanPPSF_single,meanPPSF_duplex,pDelta,elasticity)]))
                meanPPSF_single meanPPSF_duplex    pDelta elasticity
meanPPSF_single       1.0000000       0.8004259 0.7725250  0.4235603
meanPPSF_duplex       0.8004259       1.0000000 0.2377192  0.1465288
pDelta                0.7725250       0.2377192 1.0000000  0.5311280
elasticity            0.4235603       0.1465288 0.5311280  1.0000000
> q("no")
> proc.time()
   user  system elapsed 
  0.546   0.062   0.489 
