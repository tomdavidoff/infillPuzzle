
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # portlandAnalysis.R
> # Analyze the ppsf slope in sf and infill, as in Vancouver
> # Tom Davidoff
> # 12/26/25
> 
> 
> library(data.table)
> library(fixest)
> library(ggplot2)
> 
> # 1. Load ------------------------------------------------------------------
> permits <- readRDS("~/OneDrive - UBC/dataProcessed/portland_zip_propensity.rds")
> slopes  <- readRDS("~/OneDrive - UBC/dataProcessed/portland_attom_slopes_by_zip.rds")
> 
> setDT(permits); setDT(slopes)
> 
> # 2. Align -----------------------------------------------------------------
> # Ensure ZIPs are 5-character strings and types match
> print(head(permits))
   geo_id   zone  geo_name infill_lot_count total_lots_active propensity
   <char> <char>    <char>            <int>             <int>      <num>
1:  97206     R5 ZIP 97206               31               268 0.11567164
2:  97202     R5 ZIP 97202               15               213 0.07042254
3:  97212     R5 ZIP 97212                4               176 0.02272727
4:  97203     R5 ZIP 97203               32               175 0.18285714
5:  97211     R5 ZIP 97211               20               166 0.12048193
6:  97213     R5 ZIP 97213               10               147 0.06802721
> print(head(slopes))
      zip       slope     N mean_ppsf
   <char>       <num> <int>     <num>
1:  97206 -0.18288334   854  401.8969
2:  97217 -0.16115506   620  420.2160
3:  97203 -0.14871082   589  376.0504
4:  97230 -0.06212572   546  263.0407
5:  97266 -0.11562770   543  306.9385
6:  97219 -0.03137507   531  339.7798
> setnames(permits,"geo_id","zip")
> permits[, zip := sprintf("%05s", as.character(zip))]
> slopes[,  zip := sprintf("%05s", as.character(zip))]
> 
> # Merge on Zip
> dt <- merge(permits, slopes, by = "zip")
> 
> # 3. Clean -----------------------------------------------------------------
> # Convert slope to numeric (it was <char>) and take absolute value
> # (A larger negative slope = a steeper 'size discount')
> dt[, size_slope := abs(as.numeric(slope))]
> dt[, price_level := as.numeric(mean_ppsf)]
> 
> # Focus on Zips with enough data to be credible
> MINOBS <- 50
> dt <- dt[N >= MINOBS & total_lots_active>=MINOBS]
> dtCensus <- fread("~/OneDrive - UBC/dataRaw/ACSDT5Y2024/ACSDT5Y2024.B19013-Data.csv", skip=1,select = c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)","Geographic Area Name"),header=TRUE)
> print(head(dtCensus))
   Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)
                                                                                         <char>
1:                                                                                        19454
2:                                                                                        21420
3:                                                                                        20933
4:                                                                                        20992
5:                                                                                        24496
6:                                                                                        20360
   Geographic Area Name
                 <char>
1:          ZCTA5 00601
2:          ZCTA5 00602
3:          ZCTA5 00603
4:          ZCTA5 00606
5:          ZCTA5 00610
6:          ZCTA5 00611
> setnames(dtCensus, old=c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)"), new=c("medianIncome"))
> dtCensus[, medianIncome := log(as.numeric(medianIncome))]
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> setnames(dtCensus,"Geographic Area Name","zip")
> dtCensus[,zip:=substring(zip,7,11)]
> 
> print(head(dtCensus))
   medianIncome    zip
          <num> <char>
1:     9.875808  00601
2:     9.972080  00602
3:     9.949082  00603
4:     9.951897  00606
5:    10.106265  00610
6:     9.921327  00611
> print(head(dt))
Key: <zip>
      zip   zone  geo_name infill_lot_count total_lots_active propensity
   <char> <char>    <char>            <int>             <int>      <num>
1:  97202     R5 ZIP 97202               15               213 0.07042254
2:  97202   R2.5 ZIP 97202               23                85 0.27058824
3:  97203     R5 ZIP 97203               32               175 0.18285714
4:  97203   R2.5 ZIP 97203               17                66 0.25757576
5:  97206     R5 ZIP 97206               31               268 0.11567164
6:  97206   R2.5 ZIP 97206               35               133 0.26315789
        slope     N mean_ppsf size_slope price_level
        <num> <int>     <num>      <num>       <num>
1: -0.1858285   450  488.9082  0.1858285    488.9082
2: -0.1858285   450  488.9082  0.1858285    488.9082
3: -0.1487108   589  376.0504  0.1487108    376.0504
4: -0.1487108   589  376.0504  0.1487108    376.0504
5: -0.1828833   854  401.8969  0.1828833    401.8969
6: -0.1828833   854  401.8969  0.1828833    401.8969
> dt <- merge(dt,dtCensus,by="zip")
> print(head(dt))
Key: <zip>
      zip   zone  geo_name infill_lot_count total_lots_active propensity
   <char> <char>    <char>            <int>             <int>      <num>
1:  97202     R5 ZIP 97202               15               213 0.07042254
2:  97202   R2.5 ZIP 97202               23                85 0.27058824
3:  97203     R5 ZIP 97203               32               175 0.18285714
4:  97203   R2.5 ZIP 97203               17                66 0.25757576
5:  97206     R5 ZIP 97206               31               268 0.11567164
6:  97206   R2.5 ZIP 97206               35               133 0.26315789
        slope     N mean_ppsf size_slope price_level medianIncome
        <num> <int>     <num>      <num>       <num>        <num>
1: -0.1858285   450  488.9082  0.1858285    488.9082     11.56144
2: -0.1858285   450  488.9082  0.1858285    488.9082     11.56144
3: -0.1487108   589  376.0504  0.1487108    376.0504     11.27289
4: -0.1487108   589  376.0504  0.1487108    376.0504     11.27289
5: -0.1828833   854  401.8969  0.1828833    401.8969     11.49830
6: -0.1828833   854  401.8969  0.1828833    401.8969     11.49830
> print(cor(dt[,.(slope,price_level,propensity,medianIncome)],))
                  slope price_level propensity medianIncome
slope         1.0000000 -0.70320613 -0.6692026   0.53857317
price_level  -0.7032061  1.00000000  0.2919191  -0.07357787
propensity   -0.6692026  0.29191912  1.0000000  -0.47500025
medianIncome  0.5385732 -0.07357787 -0.4750003   1.00000000
> 
> 
> 
> # 4. Model -----------------------------------------------------------------
> # Does the price-size gradient predict development propensity?
> # we use robust standard errors (hc1)
> m1 <- feols(propensity ~ slope, dt, vcov = "hc1")
> m2 <- feols(propensity ~ slope + price_level, dt, vcov = "hc1")
> m3 <- feols(propensity ~ price_level, dt, vcov = "hc1")
> 
> # Zen summary: No complex tables, just the facts
> print(etable(m1, m2,m3))
                                 m1                 m2               m3
Dependent Var.:          propensity         propensity       propensity
                                                                       
Constant           -0.0075 (0.0230)    0.1594 (0.1083) -0.0642 (0.1047)
slope           -0.9908*** (0.2190) -1.359*** (0.2963)                 
price_level                           -0.0005 (0.0003)  0.0004 (0.0003)
_______________ ___________________ __________________ ________________
S.E. type       Heteroskedast.-rob. Heteroskedas.-rob. Heterosked.-rob.
Observations                     23                 23               23
R2                          0.44783            0.51098          0.08522
Adj. R2                     0.42154            0.46208          0.04166
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # 5. Plot ------------------------------------------------------------------
> ggplot(dt, aes(size_slope, propensity)) +
+   geom_point(alpha = 0.5) +
+   geom_smooth(method = "lm", color = "black", fill = "gray80") +
+   theme_minimal() +
+   labs(x = "Price-Size Gradient (Absolute)", 
+        y = "Permit Propensity",
+        title = "Portland Supply Response")
`geom_smooth()` using formula = 'y ~ x'
> 
> # 6. Export ----------------------------------------------------------------
> saveRDS(dt, "~/OneDrive - UBC/dataProcessed/portland_analysis_final.rds")
> 
> proc.time()
   user  system elapsed 
  1.282   0.309   0.747 
