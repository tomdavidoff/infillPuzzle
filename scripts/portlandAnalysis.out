
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # portlandAnalysis.R
> # Analyze the ppsf slope in sf and infill, as in Vancouver
> # Tom Davidoff
> # 12/26/25
> 
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(fixest)
> library(ggplot2)
> 
> # 1. Load ------------------------------------------------------------------
> permits <- readRDS("~/OneDrive - UBC/dataProcessed/portland_zip_propensity.rds")
> slopes  <- readRDS("~/OneDrive - UBC/dataProcessed/portland_attom_slopes_by_zip.rds")
> 
> setDT(permits); setDT(slopes)
> 
> # 2. Align -----------------------------------------------------------------
> # Ensure ZIPs are 5-character strings and types match
> print(head(permits))
   geo_id  geo_name infill_lot_count total_lots_active propensity
   <char>    <char>            <int>             <int>      <num>
1:  97206 ZIP 97206               67               408  0.1642157
2:  97219 ZIP 97219               22               367  0.0599455
3:  97202 ZIP 97202               38               322  0.1180124
4:  97211 ZIP 97211               45               261  0.1724138
5:  97203 ZIP 97203               49               241  0.2033195
6:  97213 ZIP 97213               21               204  0.1029412
> print(head(slopes))
      zip      slope     N mean_ppsf
   <char>      <num> <int>     <num>
1:  97080 -0.1580697   318  1.726301
2:  97230 -0.1639070   290  1.742120
3:  97219 -0.1305547   265  1.764212
4:  97236 -0.1664914   234  1.723754
5:  97030 -0.1527425   233  1.732680
6:  97266 -0.1383125   200  1.735376
> setnames(permits,"geo_id","zip")
> permits[, zip := sprintf("%05s", as.character(zip))]
> slopes[,  zip := sprintf("%05s", as.character(zip))]
> 
> # Merge on Zip
> dt <- merge(permits, slopes, by = "zip")
> 
> # 3. Clean -----------------------------------------------------------------
> # Convert slope to numeric (it was <char>) and take absolute value
> # (A larger negative slope = a steeper 'size discount')
> dt[, size_slope := abs(as.numeric(slope))]
> dt[, price_level := as.numeric(mean_ppsf)]
> 
> # Focus on Zips with enough data to be credible
> MINOBS <- 50
> dt <- dt[N >= MINOBS & total_lots_active>=MINOBS]
> dtCensus <- fread("~/OneDrive - UBC/dataRaw/ACSDT5Y2024/ACSDT5Y2024.B19013-Data.csv", skip=1,select = c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)","Geographic Area Name"),header=TRUE)
> print(head(dtCensus))
   Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)
                                                                                         <char>
1:                                                                                        19454
2:                                                                                        21420
3:                                                                                        20933
4:                                                                                        20992
5:                                                                                        24496
6:                                                                                        20360
   Geographic Area Name
                 <char>
1:          ZCTA5 00601
2:          ZCTA5 00602
3:          ZCTA5 00603
4:          ZCTA5 00606
5:          ZCTA5 00610
6:          ZCTA5 00611
> setnames(dtCensus, old=c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)"), new=c("medianIncome"))
> dtCensus[, medianIncome := log(as.numeric(medianIncome))]
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> setnames(dtCensus,"Geographic Area Name","zip")
> dtCensus[,zip:=substring(zip,7,11)]
> 
> print(head(dtCensus))
   medianIncome    zip
          <num> <char>
1:     9.875808  00601
2:     9.972080  00602
3:     9.949082  00603
4:     9.951897  00606
5:    10.106265  00610
6:     9.921327  00611
> print(head(dt))
Key: <zip>
      zip  geo_name infill_lot_count total_lots_active propensity       slope
   <char>    <char>            <int>             <int>      <num>       <num>
1:  97202 ZIP 97202               38               322 0.11801242 -0.15110512
2:  97203 ZIP 97203               49               241 0.20331950 -0.14043683
3:  97206 ZIP 97206               67               408 0.16421569 -0.16425060
4:  97210 ZIP 97210                0                56 0.00000000 -0.08837692
5:  97211 ZIP 97211               45               261 0.17241379 -0.14401623
6:  97212 ZIP 97212               10               198 0.05050505 -0.14075797
       N mean_ppsf size_slope price_level
   <int>     <num>      <num>       <num>
1:   167  1.789080 0.15110512    1.789080
2:   188  1.762762 0.14043683    1.762762
3:   199  1.763577 0.16425060    1.763577
4:    72  1.820485 0.08837692    1.820485
5:   161  1.788297 0.14401623    1.788297
6:   130  1.791938 0.14075797    1.791938
> dt <- merge(dt,dtCensus,by="zip")
> print(head(dt))
Key: <zip>
      zip  geo_name infill_lot_count total_lots_active propensity       slope
   <char>    <char>            <int>             <int>      <num>       <num>
1:  97202 ZIP 97202               38               322 0.11801242 -0.15110512
2:  97203 ZIP 97203               49               241 0.20331950 -0.14043683
3:  97206 ZIP 97206               67               408 0.16421569 -0.16425060
4:  97210 ZIP 97210                0                56 0.00000000 -0.08837692
5:  97211 ZIP 97211               45               261 0.17241379 -0.14401623
6:  97212 ZIP 97212               10               198 0.05050505 -0.14075797
       N mean_ppsf size_slope price_level medianIncome
   <int>     <num>      <num>       <num>        <num>
1:   167  1.789080 0.15110512    1.789080     11.56144
2:   188  1.762762 0.14043683    1.762762     11.27289
3:   199  1.763577 0.16425060    1.763577     11.49830
4:    72  1.820485 0.08837692    1.820485     11.44701
5:   161  1.788297 0.14401623    1.788297     11.63147
6:   130  1.791938 0.14075797    1.791938     11.79004
> print(cor(dt[,.(slope,price_level,propensity,medianIncome)],))
                  slope price_level propensity medianIncome
slope         1.0000000   0.2720596 -0.4450128    0.3460232
price_level   0.2720596   1.0000000 -0.3678643    0.3903597
propensity   -0.4450128  -0.3678643  1.0000000   -0.6445365
medianIncome  0.3460232   0.3903597 -0.6445365    1.0000000
> 
> 
> 
> # 4. Model -----------------------------------------------------------------
> # Does the price-size gradient predict development propensity?
> # we use robust standard errors (hc1)
> m1 <- feols(propensity ~ slope, dt, vcov = "hc1")
> m2 <- feols(propensity ~ slope + medianIncome, dt, vcov = "hc1")
> m3 <- feols(propensity ~ price_level, dt, vcov = "hc1")
> m4 <- feols(propensity ~ price_level + medianIncome, dt, vcov = "hc1")
> 
> # Zen summary: No complex tables, just the facts
> print(etable(m1, m2,m3,m4))
                              m1                 m2                m3
Dependent Var.:       propensity         propensity        propensity
                                                                     
Constant        -0.0616 (0.0655)    1.582* (0.5501)   1.639. (0.8591)
slope           -1.130* (0.4129)   -0.6403 (0.6094)                  
medianIncome                     -0.1367** (0.0429)                  
price_level                                         -0.8658. (0.4829)
_______________ ________________ __________________ _________________
S.E. type       Heterosked.-rob. Heteroskedas.-rob. Heteroskeda.-rob.
Observations                  19                 19                19
R2                       0.19804            0.47141           0.13532
Adj. R2                  0.15086            0.40534           0.08446

                                m4
Dependent Var.:         propensity
                                  
Constant           2.344* (0.8598)
slope                             
medianIncome    -0.1449** (0.0460)
price_level       -0.3228 (0.5977)
_______________ __________________
S.E. type       Heteroskedas.-rob.
Observations                    19
R2                         0.43137
Adj. R2                    0.36030
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # 5. Plot ------------------------------------------------------------------
> ggplot(dt, aes(size_slope, propensity)) +
+   geom_point(alpha = 0.5) +
+   geom_smooth(method = "lm", color = "black", fill = "gray80") +
+   theme_minimal() +
+   labs(x = "Price-Size Gradient (Absolute)", 
+        y = "Permit Propensity",
+        title = "Portland Supply Response")
`geom_smooth()` using formula = 'y ~ x'
> 
> # 6. Export ----------------------------------------------------------------
> saveRDS(dt, "~/OneDrive - UBC/dataProcessed/portland_analysis_final.rds")
> 
> proc.time()
   user  system elapsed 
  1.721   0.117   0.978 
