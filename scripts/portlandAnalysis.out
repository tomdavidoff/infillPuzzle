
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # portlandAnalysis.R
> # Analyze the ppsf slope in sf and infill, as in Vancouver
> # Tom Davidoff
> # 12/26/25
> 
> 
> library(data.table)
> library(fixest)
> library(ggplot2)
> 
> # 1. Load ------------------------------------------------------------------
> permits <- readRDS("~/OneDrive - UBC/dataProcessed/portland_zip_propensity.rds")
> slopes  <- readRDS("~/OneDrive - UBC/dataProcessed/portland_attom_slopes_by_zip.rds")
> print(nrow(permits))
[1] 28
> print(nrow(slopes))
[1] 30
> 
> setDT(permits); setDT(slopes)
> 
> # 2. Align -----------------------------------------------------------------
> # Ensure ZIPs are 5-character strings and types match
> print(head(permits))
   geo_id  geo_name infill_lot_count total_lots_active propensity
   <char>    <char>            <int>             <int>      <num>
1:  97206 ZIP 97206               64               244  0.2622951
2:  97219 ZIP 97219               22               176  0.1250000
3:  97211 ZIP 97211               44               152  0.2894737
4:  97203 ZIP 97203               49               147  0.3333333
5:  97202 ZIP 97202               36               138  0.2608696
6:  97236 ZIP 97236               15               106  0.1415094
> print(head(slopes))
      zip      slope     N mean_ppsf
   <char>      <num> <int>     <num>
1:  97080 -0.6091277   263  236.2019
2:  97230 -0.6852048   230  245.2452
3:  97219 -0.2954360   216  320.9933
4:  97236 -0.5784304   180  232.0701
5:  97203 -0.2908970   154  286.7947
6:  97206 -0.5759600   149  290.4123
> setnames(permits,"geo_id","zip")
> permits[, zip := sprintf("%05s", as.character(zip))]
> slopes[,  zip := sprintf("%05s", as.character(zip))]
> 
> # Merge on Zip
> dt <- merge(permits, slopes, by = "zip")
> print(nrow(dt))
[1] 25
> 
> # 3. Clean -----------------------------------------------------------------
> # Convert slope to numeric (it was <char>) and take absolute value
> # (A larger negative slope = a steeper 'size discount')
> dt[, size_slope := abs(as.numeric(slope))]
> dt[, price_level := as.numeric(mean_ppsf)]
> 
> # Focus on Zips with enough data to be credible
> MINOBS <- 50
> dt <- dt[N >= MINOBS & total_lots_active>=MINOBS]
> dtCensus <- fread("~/OneDrive - UBC/dataRaw/ACSDT5Y2024/ACSDT5Y2024.B19013-Data.csv", skip=1,select = c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)","Geographic Area Name"),header=TRUE)
> print(head(dtCensus))
   Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)
                                                                                         <char>
1:                                                                                        19454
2:                                                                                        21420
3:                                                                                        20933
4:                                                                                        20992
5:                                                                                        24496
6:                                                                                        20360
   Geographic Area Name
                 <char>
1:          ZCTA5 00601
2:          ZCTA5 00602
3:          ZCTA5 00603
4:          ZCTA5 00606
5:          ZCTA5 00610
6:          ZCTA5 00611
> setnames(dtCensus, old=c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)"), new=c("medianIncome"))
> dtCensus[, medianIncome := log(as.numeric(medianIncome))]
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> setnames(dtCensus,"Geographic Area Name","zip")
> dtCensus[,zip:=substring(zip,7,11)]
> 
> print(head(dtCensus))
   medianIncome    zip
          <num> <char>
1:     9.875808  00601
2:     9.972080  00602
3:     9.949082  00603
4:     9.951897  00606
5:    10.106265  00610
6:     9.921327  00611
> print(head(dt))
Key: <zip>
      zip  geo_name infill_lot_count total_lots_active propensity      slope
   <char>    <char>            <int>             <int>      <num>      <num>
1:  97202 ZIP 97202               36               138  0.2608696 -0.3541620
2:  97203 ZIP 97203               49               147  0.3333333 -0.2908970
3:  97206 ZIP 97206               64               244  0.2622951 -0.5759600
4:  97211 ZIP 97211               44               152  0.2894737 -0.4059000
5:  97212 ZIP 97212                9                80  0.1125000 -0.3760065
6:  97213 ZIP 97213               21                86  0.2441860 -0.5003517
       N mean_ppsf size_slope price_level
   <int>     <num>      <num>       <num>
1:    99  380.8901  0.3541620    380.8901
2:   154  286.7947  0.2908970    286.7947
3:   149  290.4123  0.5759600    290.4123
4:   112  378.0714  0.4059000    378.0714
5:    94  404.2413  0.3760065    404.2413
6:    83  355.2263  0.5003517    355.2263
> dt <- merge(dt,dtCensus,by="zip",all.x=TRUE)
> print(nrow(dt))
[1] 12
> print(head(dt))
Key: <zip>
      zip  geo_name infill_lot_count total_lots_active propensity      slope
   <char>    <char>            <int>             <int>      <num>      <num>
1:  97202 ZIP 97202               36               138  0.2608696 -0.3541620
2:  97203 ZIP 97203               49               147  0.3333333 -0.2908970
3:  97206 ZIP 97206               64               244  0.2622951 -0.5759600
4:  97211 ZIP 97211               44               152  0.2894737 -0.4059000
5:  97212 ZIP 97212                9                80  0.1125000 -0.3760065
6:  97213 ZIP 97213               21                86  0.2441860 -0.5003517
       N mean_ppsf size_slope price_level medianIncome
   <int>     <num>      <num>       <num>        <num>
1:    99  380.8901  0.3541620    380.8901     11.56144
2:   154  286.7947  0.2908970    286.7947     11.27289
3:   149  290.4123  0.5759600    290.4123     11.49830
4:   112  378.0714  0.4059000    378.0714     11.63147
5:    94  404.2413  0.3760065    404.2413     11.79004
6:    83  355.2263  0.5003517    355.2263     11.48317
> print(cor(dt[,.(slope,price_level,propensity,medianIncome)],))
                  slope price_level  propensity medianIncome
slope        1.00000000   0.4012562  0.06564645    0.2670005
price_level  0.40125621   1.0000000 -0.28159281    0.8448673
propensity   0.06564645  -0.2815928  1.00000000   -0.5991225
medianIncome 0.26700052   0.8448673 -0.59912245    1.0000000
> 
> 
> 
> # 4. Model -----------------------------------------------------------------
> # Does the price-size gradient predict development propensity?
> # we use robust standard errors (hc1)
> m1 <- feols(propensity ~ slope, dt, vcov = "hc1")
> m2 <- feols(propensity ~ slope + medianIncome, dt, vcov = "hc1")
> m3 <- feols(propensity ~ price_level, dt, vcov = "hc1")
> m4 <- feols(propensity ~ price_level + medianIncome, dt, vcov = "hc1")
> 
> # Zen summary: No complex tables, just the facts
> print(etable(m1, m2,m3,m4))
                              m1                m2               m3
Dependent Var.:       propensity        propensity       propensity
                                                                   
Constant        0.2451. (0.1115)    3.609* (1.255) 0.3725* (0.1670)
slope            0.0517 (0.2256)   0.1915 (0.1655)                 
medianIncome                     -0.2866* (0.1101)                 
price_level                                        -0.0005 (0.0005)
_______________ ________________ _________________ ________________
S.E. type       Heterosked.-rob. Heteroskeda.-rob. Heterosked.-rob.
Observations                  12                12               12
R2                       0.00431           0.41376          0.07930
Adj. R2                 -0.09526           0.28348         -0.01278

                                m4
Dependent Var.:         propensity
                                  
Constant          6.072*** (1.224)
slope                             
medianIncome    -0.5448** (0.1174)
price_level       0.0013. (0.0006)
_______________ __________________
S.E. type       Heteroskedas.-rob.
Observations                    12
R2                         0.53518
Adj. R2                    0.43189
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # 5. Plot ------------------------------------------------------------------
> ggplot(dt, aes(size_slope, propensity)) +
+   geom_point(alpha = 0.5) +
+   geom_smooth(method = "lm", color = "black", fill = "gray80") +
+   theme_minimal() +
+   labs(x = "Price-Size Gradient (Absolute)", 
+        y = "Permit Propensity",
+        title = "Portland Supply Response")
`geom_smooth()` using formula = 'y ~ x'
> 
> # 6. Export ----------------------------------------------------------------
> saveRDS(dt, "~/OneDrive - UBC/dataProcessed/portland_analysis_final.rds")
> 
> proc.time()
   user  system elapsed 
  1.262   0.323   0.732 
