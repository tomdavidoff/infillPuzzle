
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # portlandAnalysis.R
> # Analyze the ppsf slope in sf and infill, as in Vancouver
> # Tom Davidoff
> # 12/26/25
> 
> 
> library(data.table)
> library(fixest)
> library(ggplot2)
> 
> # 1. Load ------------------------------------------------------------------
> permits <- readRDS("~/OneDrive - UBC/dataProcessed/portland_zip_propensity.rds")
> slopes  <- readRDS("~/OneDrive - UBC/dataProcessed/portland_attom_slopes_by_zip.rds")
> print(nrow(permits))
[1] 88
> print(nrow(slopes))
[1] 30
> 
> setDT(permits); setDT(slopes)
> 
> # 2. Align -----------------------------------------------------------------
> # Ensure ZIPs are 5-character strings and types match
> print(head(permits))
   geo_id  geo_name   zone infill_lot_count total_lots_active propensity
   <char>    <char> <char>            <int>             <int>      <num>
1:  97206 ZIP 97206     R5               31               268 0.11567164
2:  97202 ZIP 97202     R5               15               213 0.07042254
3:  97212 ZIP 97212     R5                4               176 0.02272727
4:  97203 ZIP 97203     R5               32               175 0.18285714
5:  97211 ZIP 97211     R5               20               166 0.12048193
6:  97213 ZIP 97213     R5               10               147 0.06802721
> print(head(slopes))
      zip      slope     N mean_ppsf
   <char>      <num> <int>     <num>
1:  97080 -0.6091277   263  236.2019
2:  97230 -0.6852048   230  245.2452
3:  97219 -0.2954360   216  320.9933
4:  97236 -0.5784304   180  232.0701
5:  97203 -0.2908970   154  286.7947
6:  97206 -0.5759600   149  290.4123
> setnames(permits,"geo_id","zip")
> permits[, zip := sprintf("%05s", as.character(zip))]
> slopes[,  zip := sprintf("%05s", as.character(zip))]
> 
> # Merge on Zip
> dt <- merge(permits, slopes, by = "zip")
> print(nrow(dt))
[1] 83
> 
> # 3. Clean -----------------------------------------------------------------
> # Convert slope to numeric (it was <char>) and take absolute value
> # (A larger negative slope = a steeper 'size discount')
> dt[, size_slope := abs(as.numeric(slope))]
> dt[, price_level := as.numeric(mean_ppsf)]
> 
> # Focus on Zips with enough data to be credible
> MINOBS <- 50
> dt <- dt[N >= MINOBS & total_lots_active>=MINOBS]
> dtCensus <- fread("~/OneDrive - UBC/dataRaw/ACSDT5Y2024/ACSDT5Y2024.B19013-Data.csv", skip=1,select = c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)","Geographic Area Name"),header=TRUE)
> print(head(dtCensus))
   Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)
                                                                                         <char>
1:                                                                                        19454
2:                                                                                        21420
3:                                                                                        20933
4:                                                                                        20992
5:                                                                                        24496
6:                                                                                        20360
   Geographic Area Name
                 <char>
1:          ZCTA5 00601
2:          ZCTA5 00602
3:          ZCTA5 00603
4:          ZCTA5 00606
5:          ZCTA5 00610
6:          ZCTA5 00611
> setnames(dtCensus, old=c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)"), new=c("medianIncome"))
> dtCensus[, medianIncome := log(as.numeric(medianIncome))]
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> setnames(dtCensus,"Geographic Area Name","zip")
> dtCensus[,zip:=substring(zip,7,11)]
> 
> print(head(dtCensus))
   medianIncome    zip
          <num> <char>
1:     9.875808  00601
2:     9.972080  00602
3:     9.949082  00603
4:     9.951897  00606
5:    10.106265  00610
6:     9.921327  00611
> print(head(dt))
Key: <zip>
      zip  geo_name   zone infill_lot_count total_lots_active propensity
   <char>    <char> <char>            <int>             <int>      <num>
1:  97202 ZIP 97202     R5               15               213 0.07042254
2:  97202 ZIP 97202   R2.5               23                85 0.27058824
3:  97203 ZIP 97203     R5               32               175 0.18285714
4:  97203 ZIP 97203   R2.5               17                66 0.25757576
5:  97206 ZIP 97206     R5               31               268 0.11567164
6:  97206 ZIP 97206   R2.5               35               133 0.26315789
       slope     N mean_ppsf size_slope price_level
       <num> <int>     <num>      <num>       <num>
1: -0.354162    99  380.8901   0.354162    380.8901
2: -0.354162    99  380.8901   0.354162    380.8901
3: -0.290897   154  286.7947   0.290897    286.7947
4: -0.290897   154  286.7947   0.290897    286.7947
5: -0.575960   149  290.4123   0.575960    290.4123
6: -0.575960   149  290.4123   0.575960    290.4123
> dt <- merge(dt,dtCensus,by="zip",all.x=TRUE)
> print(nrow(dt))
[1] 21
> print(head(dt))
Key: <zip>
      zip  geo_name   zone infill_lot_count total_lots_active propensity
   <char>    <char> <char>            <int>             <int>      <num>
1:  97202 ZIP 97202     R5               15               213 0.07042254
2:  97202 ZIP 97202   R2.5               23                85 0.27058824
3:  97203 ZIP 97203     R5               32               175 0.18285714
4:  97203 ZIP 97203   R2.5               17                66 0.25757576
5:  97206 ZIP 97206     R5               31               268 0.11567164
6:  97206 ZIP 97206   R2.5               35               133 0.26315789
       slope     N mean_ppsf size_slope price_level medianIncome
       <num> <int>     <num>      <num>       <num>        <num>
1: -0.354162    99  380.8901   0.354162    380.8901     11.56144
2: -0.354162    99  380.8901   0.354162    380.8901     11.56144
3: -0.290897   154  286.7947   0.290897    286.7947     11.27289
4: -0.290897   154  286.7947   0.290897    286.7947     11.27289
5: -0.575960   149  290.4123   0.575960    290.4123     11.49830
6: -0.575960   149  290.4123   0.575960    290.4123     11.49830
> print(cor(dt[,.(slope,price_level,propensity,medianIncome)],))
                  slope price_level  propensity medianIncome
slope        1.00000000   0.2219930  0.03605252    0.1548154
price_level  0.22199301   1.0000000 -0.20425373    0.5505780
propensity   0.03605252  -0.2042537  1.00000000   -0.4096491
medianIncome 0.15481538   0.5505780 -0.40964907    1.0000000
> print(table(dt[,zone]))

 R10 R2.5  R20   R5   R7 
   3    5    1    9    3 
> print(cor(dt[zone %chin% c("R2.5","R5"),.(slope,price_level,propensity,medianIncome)],))
                   slope price_level  propensity medianIncome
slope         1.00000000   0.1450513  0.05701132  -0.06107302
price_level   0.14505128   1.0000000 -0.47118542   0.46867246
propensity    0.05701132  -0.4711854  1.00000000  -0.24047603
medianIncome -0.06107302   0.4686725 -0.24047603   1.00000000
> print(cor(dt[zone %chin% c("R2.5"),.(slope,price_level,propensity,medianIncome)],))
                   slope price_level propensity medianIncome
slope         1.00000000   0.2515518 0.06850779   -0.4050567
price_level   0.25155177   1.0000000 0.71045095    0.7601696
propensity    0.06850779   0.7104510 1.00000000    0.5089145
medianIncome -0.40505669   0.7601696 0.50891445    1.0000000
> print(cor(dt[zone %chin% c("R5"),.(slope,price_level,propensity,medianIncome)],))
                  slope price_level propensity medianIncome
slope        1.00000000  0.07994256  0.2507962   0.09764375
price_level  0.07994256  1.00000000 -0.8521651   0.33157725
propensity   0.25079616 -0.85216512  1.0000000  -0.35381978
medianIncome 0.09764375  0.33157725 -0.3538198   1.00000000
> print(dt[,.(mp=mean(propensity),mpl=mean(price_level)),by=zone])
     zone        mp      mpl
   <char>     <num>    <num>
1:     R5 0.1005576 349.7861
2:   R2.5 0.2630003 329.8669
3:     R7 0.0587484 327.7390
4:    R10 0.0286590 309.3539
5:    R20 0.0000000 320.9933
> print(dt[zone=="R2.5" | zone=="R5"])
Key: <zip>
       zip  geo_name   zone infill_lot_count total_lots_active propensity
    <char>    <char> <char>            <int>             <int>      <num>
 1:  97202 ZIP 97202     R5               15               213 0.07042254
 2:  97202 ZIP 97202   R2.5               23                85 0.27058824
 3:  97203 ZIP 97203     R5               32               175 0.18285714
 4:  97203 ZIP 97203   R2.5               17                66 0.25757576
 5:  97206 ZIP 97206     R5               31               268 0.11567164
 6:  97206 ZIP 97206   R2.5               35               133 0.26315789
 7:  97211 ZIP 97211     R5               20               166 0.12048193
 8:  97211 ZIP 97211   R2.5               25                90 0.27777778
 9:  97212 ZIP 97212     R5                4               176 0.02272727
10:  97213 ZIP 97213     R5               10               147 0.06802721
11:  97214 ZIP 97214     R5                3                71 0.04225352
12:  97217 ZIP 97217     R5               18               127 0.14173228
13:  97217 ZIP 97217   R2.5               15                61 0.24590164
14:  97219 ZIP 97219     R5               10                71 0.14084507
         slope     N mean_ppsf size_slope price_level medianIncome
         <num> <int>     <num>      <num>       <num>        <num>
 1: -0.3541620    99  380.8901  0.3541620    380.8901     11.56144
 2: -0.3541620    99  380.8901  0.3541620    380.8901     11.56144
 3: -0.2908970   154  286.7947  0.2908970    286.7947     11.27289
 4: -0.2908970   154  286.7947  0.2908970    286.7947     11.27289
 5: -0.5759600   149  290.4123  0.5759600    290.4123     11.49830
 6: -0.5759600   149  290.4123  0.5759600    290.4123     11.49830
 7: -0.4059000   112  378.0714  0.4059000    378.0714     11.63147
 8: -0.4059000   112  378.0714  0.4059000    378.0714     11.63147
 9: -0.3760065    94  404.2413  0.3760065    404.2413     11.79004
10: -0.5003517    83  355.2263  0.5003517    355.2263     11.48317
11: -0.4179859    62  418.2797  0.4179859    418.2797     11.37517
12: -0.4419592   110  313.1658  0.4419592    313.1658     11.51653
13: -0.4419592   110  313.1658  0.4419592    313.1658     11.51653
14: -0.2954360   216  320.9933  0.2954360    320.9933     11.70607
> print(dt[,sum(infill_lot_count),by=zone])
     zone    V1
   <char> <int>
1:     R5   143
2:   R2.5   115
3:     R7    13
4:    R10     7
5:    R20     0
> 
> 
> 
> # 4. Model -----------------------------------------------------------------
> # Does the price-size gradient predict development propensity?
> # we use robust standard errors (hc1)
> m1 <- feols(propensity ~ slope, dt, vcov = "hc1")
> m2 <- feols(propensity ~ slope + medianIncome, dt, vcov = "hc1")
> m3 <- feols(propensity ~ log(price_level), dt, vcov = "hc1")
> m4 <- feols(propensity ~ log(price_level) + slope, dt[zone %chin% c("R2.5","R5")], vcov = "hc1")
> m5 <- feols(propensity ~ log(price_level) + slope|zone, dt[zone %chin% c("R2.5","R5")], vcov = "hc1")
> 
> # Zen summary: No complex tables, just the facts
> print(etable(m1, m2,m3,m4,m5))
                              m1                m2               m3
Dependent Var.:       propensity        propensity       propensity
                                                                   
Constant         0.1308 (0.0774)    2.655* (1.004)  0.8231 (0.8964)
slope            0.0297 (0.1671)   0.0840 (0.1437)                 
medianIncome                     -0.2163* (0.0879)                 
log(price_level)                                   -0.1215 (0.1545)
Fixed-Effects:   --------------- ----------------- ----------------
zone                          No                No               No
________________ _______________ _________________ ________________
S.E. type        Heteroske.-rob. Heteroskeda.-rob. Heterosked.-rob.
Observations                  21                21               21
R2                       0.00130           0.17795          0.03467
Within R2                     --                --               --

                                m4                m5
Dependent Var.:         propensity        propensity
                                                    
Constant           2.062* (0.8929)                  
slope              0.1229 (0.2090)   0.1299 (0.0858)
medianIncome                                        
log(price_level) -0.3180. (0.1581) -0.2052* (0.0787)
Fixed-Effects:   ----------------- -----------------
zone                            No               Yes
________________ _________________ _________________
S.E. type        Heteroskeda.-rob. Heteroskeda.-rob.
Observations                    14                14
R2                         0.23115           0.88789
Within R2                       --           0.46972
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # 5. Plot ------------------------------------------------------------------
> ggplot(dt, aes(size_slope, propensity)) +
+   geom_point(alpha = 0.5) +
+   geom_smooth(method = "lm", color = "black", fill = "gray80") +
+   theme_minimal() +
+   labs(x = "Price-Size Gradient (Absolute)", 
+        y = "Permit Propensity",
+        title = "Portland Supply Response")
`geom_smooth()` using formula = 'y ~ x'
> 
> # 6. Export ----------------------------------------------------------------
> saveRDS(dt, "~/OneDrive - UBC/dataProcessed/portland_analysis_final.rds")
> 
> proc.time()
   user  system elapsed 
  1.316   0.322   0.765 
