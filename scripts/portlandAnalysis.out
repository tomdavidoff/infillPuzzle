
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # portlandAnalysis.R
> # Analyze the ppsf slope in sf and infill, as in Vancouver
> # Tom Davidoff
> # 12/26/25
> 
> 
> library(data.table)
> library(fixest)
> library(ggplot2)
> 
> # 1. Load ------------------------------------------------------------------
> permits <- readRDS("data/derived/portland_zip_propensity.rds")
> slopes  <- readRDS("data/derived/portland_attom_slopes_by_zip.rds")
> 
> setDT(permits); setDT(slopes)
> 
> # 2. Align -----------------------------------------------------------------
> # Ensure ZIPs are 5-character strings and types match
> print(head(permits))
   geo_id   zone  geo_name infill_lot_count total_lots_active propensity
   <char> <char>    <char>            <int>             <int>      <num>
1:  97206     R5 ZIP 97206               41               268  0.1529851
2:  97202     R5 ZIP 97202               32               213  0.1502347
3:  97212     R5 ZIP 97212               11               176  0.0625000
4:  97203     R5 ZIP 97203               41               175  0.2342857
5:  97211     R5 ZIP 97211               26               166  0.1566265
6:  97213     R5 ZIP 97213               17               147  0.1156463
> print(head(slopes))
      zip       slope     N mean_ppsf
   <char>       <num> <int>     <num>
1:  97206 -0.18288334   854  401.8969
2:  97217 -0.16115506   620  420.2160
3:  97203 -0.14871082   589  376.0504
4:  97230 -0.06212572   546  263.0407
5:  97266 -0.11562770   543  306.9385
6:  97219 -0.03137507   531  339.7798
> setnames(permits,"geo_id","zip")
> permits[, zip := sprintf("%05s", as.character(zip))]
> slopes[,  zip := sprintf("%05s", as.character(zip))]
> 
> # Merge on Zip
> dt <- merge(permits, slopes, by = "zip")
> 
> # 3. Clean -----------------------------------------------------------------
> # Convert slope to numeric (it was <char>) and take absolute value
> # (A larger negative slope = a steeper 'size discount')
> dt[, size_slope := abs(as.numeric(slope))]
> dt[, price_level := as.numeric(mean_ppsf)]
> 
> # Focus on Zips with enough data to be credible
> MINOBS <- 50
> dt <- dt[N >= MINOBS & total_lots_active>=MINOBS]
> print(cor(dt[,.(slope,price_level)]))
                 slope price_level
slope        1.0000000  -0.7032061
price_level -0.7032061   1.0000000
> 
> # 4. Model -----------------------------------------------------------------
> # Does the price-size gradient predict development propensity?
> # we use robust standard errors (hc1)
> m1 <- feols(propensity ~ size_slope, dt, vcov = "hc1")
> m2 <- feols(propensity ~ size_slope + price_level, dt, vcov = "hc1")
> m3 <- feols(propensity ~ price_level, dt, vcov = "hc1")
> 
> # Zen summary: No complex tables, just the facts
> print(etable(m1, m2,m3))
                               m1                m2               m3
Dependent Var.:        propensity        propensity       propensity
                                                                    
Constant          0.0247 (0.0308)   0.1474 (0.1264) -0.0759 (0.1145)
size_slope      1.086*** (0.2383) 1.356*** (0.3111)                 
price_level                        -0.0004 (0.0004) 0.0006. (0.0003)
_______________ _________________ _________________ ________________
S.E. type       Heteroskeda.-rob. Heteroskeda.-rob. Heterosked.-rob.
Observations                   23                23               23
R2                        0.48095           0.51143          0.13216
Adj. R2                   0.45623           0.46258          0.09084
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # 5. Plot ------------------------------------------------------------------
> ggplot(dt, aes(size_slope, propensity)) +
+   geom_point(alpha = 0.5) +
+   geom_smooth(method = "lm", color = "black", fill = "gray80") +
+   theme_minimal() +
+   labs(x = "Price-Size Gradient (Absolute)", 
+        y = "Permit Propensity",
+        title = "Portland Supply Response")
`geom_smooth()` using formula = 'y ~ x'
> 
> # 6. Export ----------------------------------------------------------------
> saveRDS(dt, "data/derived/portland_analysis_final.rds")
> 
> proc.time()
   user  system elapsed 
  0.626   0.052   0.693 
