
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # reconcileLanewayFSR.R
> # Triangulate laneway presence via permits AND roll number matching
> # Tom Davidoff, 12/29/25
> 
> library(data.table)
> library(ggplot2)
> library(readxl)
> library(stringr)
> library(fixest)
> 
> clean_pc <- function(x) gsub(" ", "", toupper(trimws(x)))
> 
> # ==========================================
> # PATHS
> # ==========================================
> PERMIT_F <- "data/raw/vancouver_permits_full.csv"
> LANEWAY_F <- "data/raw/20231231_UBC_CustomLanewayReport.xlsx"
> 
> # ==========================================
> # 1. LOAD PERMIT DATA
> # ==========================================
> dtPermit <- fread(PERMIT_F)
> setnames(dtPermit, make.names(names(dtPermit)))
> 
> dtPermit <- dtPermit[as.IDate(issuedate) >= "2019-01-01"]
> dtPermit[, cleanPostal := clean_pc(str_sub(address, -7))]
> 
> # ==========================================
> # 2. FLAG LANEWAY FROM PERMIT DESCRIPTIONS
> # ==========================================
> dtPermit[, laneway_from_permit := grepl(
+   "laneway|accessory dwelling|adu|coach house|carriage house|secondary suite",
+   paste(projectdescription, specificusecategory, typeofwork),
+   ignore.case = TRUE
+ )]
> 
> addr_has_laneway_permit <- dtPermit[laneway_from_permit == TRUE,
+                                     .(has_laneway_permit = TRUE),
+                                     by = cleanPostal]
> 
> # ==========================================
> # 3. FLAG LANEWAY FROM ROLL NUMBER (2025 BCA DATA)
> # ==========================================
> dtLaneway <- as.data.table(read_excel(LANEWAY_F, sheet = "DATA"))
> setnames(dtLaneway, "ROLL_NUM", "Roll_Number_char")
> dtLaneway[, roll_base := floor(as.numeric(Roll_Number_char) / 1000)]
> 
> # Load 2025 BCA data (from your earlier code)
> dtDesc <- fread(
+   "~/OneDrive - UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_descriptions_20250331_REVD25.csv",
+   select = c("FOLIO_ID", "ROLL_NUMBER", "ACTUAL_USE_DESCRIPTION", "LAND_SIZE")
+ )
> dtDesc[, Roll_Number := as.numeric(ROLL_NUMBER)]
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> 
> dtRoll <- fread(
+   "~/OneDrive - UBC/Documents/data/bca/Residential_inventory_202501/20250101_A09_Residential_Inventory_Extract.txt",
+   select = c("Roll_Number")
+ )
> 
> # Get address file for postal codes
> dtAddr <- fread(
+   "~/OneDrive - UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_addresses_20250331_REVD25.csv",
+   select = c("FOLIO_ID", "POSTAL_CODE")
+ )
> 
> # Merge to get postal â†’ roll_number
> dtAddrMerge <- merge(dtAddr, dtDesc[, .(FOLIO_ID, Roll_Number)], by = "FOLIO_ID")
> dtAddrMerge[, `:=`(
+   cleanPostal = clean_pc(POSTAL_CODE),
+   roll_base = floor(Roll_Number / 1000)
+ )]
> 
> # Flag addresses with laneways
> addr_has_laneway_roll <- dtAddrMerge[roll_base %in% dtLaneway$roll_base,
+                                      .(has_laneway_roll = TRUE),
+                                      by = cleanPostal]
> 
> # ==========================================
> # 4. MERGE & ANALYZE
> # ==========================================
> dtPermit <- merge(dtPermit, addr_has_laneway_permit, by = "cleanPostal", all.x = TRUE)
> dtPermit <- merge(dtPermit, addr_has_laneway_roll, by = "cleanPostal", all.x = TRUE)
> 
> dtPermit[is.na(has_laneway_permit), has_laneway_permit := FALSE]
> dtPermit[is.na(has_laneway_roll), has_laneway_roll := FALSE]
> dtPermit[, has_laneway := has_laneway_permit | has_laneway_roll]
> 
> print("=== Laneway Detection Agreement ===")
[1] "=== Laneway Detection Agreement ==="
> print(dtPermit[, .N, by = .(has_laneway_permit, has_laneway_roll,year(issuedate))])
    has_laneway_permit has_laneway_roll  year     N
                <lgcl>           <lgcl> <int> <int>
 1:               TRUE             TRUE  2022  1286
 2:               TRUE             TRUE  2023   551
 3:               TRUE             TRUE  2021   954
 4:               TRUE             TRUE  2024   368
 5:               TRUE             TRUE  2025   301
 6:               TRUE             TRUE  2019   483
 7:               TRUE             TRUE  2020   582
 8:              FALSE            FALSE  2019  2648
 9:              FALSE            FALSE  2021  2476
10:              FALSE            FALSE  2022  2633
11:              FALSE            FALSE  2020  2050
12:               TRUE            FALSE  2019  2393
13:               TRUE            FALSE  2022  2008
14:               TRUE            FALSE  2020  1735
15:               TRUE            FALSE  2021  1557
16:               TRUE            FALSE  2024  1995
17:               TRUE            FALSE  2025  2090
18:               TRUE            FALSE  2023  1914
19:              FALSE            FALSE  2023  2224
20:              FALSE            FALSE  2025  2695
21:              FALSE            FALSE  2024  2543
22:              FALSE             TRUE  2022    43
23:              FALSE             TRUE  2024     4
24:              FALSE             TRUE  2021    25
25:              FALSE             TRUE  2020    11
26:              FALSE             TRUE  2019    11
27:              FALSE             TRUE  2023    19
28:              FALSE             TRUE  2025    16
    has_laneway_permit has_laneway_roll  year     N
> 
> # Focus on main house permits
> dtMain <- dtPermit[!laneway_from_permit &
+                    grepl("Single|Dwelling", specificusecategory, ignore.case = TRUE)]
> 
> print("=== Main House Permits: With vs Without Laneway ===")
[1] "=== Main House Permits: With vs Without Laneway ==="
> dtMain[, .(
+   n_permits = .N,
+   mean_value = mean(projectvalue, na.rm = TRUE),
+   median_value = median(projectvalue, na.rm = TRUE)
+ ), by = has_laneway]
   has_laneway n_permits mean_value median_value
        <lgcl>     <int>      <num>        <num>
1:        TRUE      8306   776988.5        15000
2:       FALSE      8412   852785.1        30000
> 
> # Regression
> m1 <- feols(log(projectvalue) ~ has_laneway, data = dtMain[projectvalue > 0])
> m2 <- feols(log(projectvalue) ~ has_laneway + factor(year(issuedate)),
+             data = dtMain[projectvalue > 0])
> 
> etable(m1, m2)
                                             m1                  m2
Dependent Var.:               log(projectvalue)   log(projectvalue)
                                                                   
Constant                      11.11*** (0.0224)   10.84*** (0.0464)
has_lanewayTRUE             -0.4361*** (0.0344) -0.4396*** (0.0341)
factor(year(issuedate))2020                         0.1010 (0.0660)
factor(year(issuedate))2021                         0.0603 (0.0628)
factor(year(issuedate))2022                        0.1454* (0.0602)
factor(year(issuedate))2023                      0.3750*** (0.0631)
factor(year(issuedate))2024                      0.3493*** (0.0636)
factor(year(issuedate))2025                      0.8329*** (0.0617)
___________________________ ___________________ ___________________
S.E. type                                   IID                 IID
Observations                             12,029              12,029
R2                                      0.01317             0.03402
Adj. R2                                 0.01309             0.03345
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # Plot
> ggplot(dtMain[projectvalue < 2e6], aes(x = projectvalue, fill = has_laneway)) +
+   geom_density(alpha = 0.5) +
+   scale_x_continuous(labels = scales::dollar) +
+   labs(
+     title = "Main House Permit Values: With vs Without Laneway",
+     x = "Project Value"
+   ) +
+   theme_minimal()
> 
> ggsave("text/main_house_value_distribution_laneway.png", width = 8, height = 6)
> 
> proc.time()
   user  system elapsed 
 24.223   8.753   8.143 
