
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # permitOriginalLotVancouver.R 
> # R to map R-zone permits to original (2016) Vancouver lots via parcel-address fabric and BCA data.
> # Tom Davidoff
> # 01/07/26
> # ------------------------------------------------------------
> # Vancouver infill puzzle: Permits x Parcel-address fabric x BCA(2016)
> #
> # Goal: produce one row per ORIGINAL (2016) lot:
> #   (a) outcome ∈ {sf_rebuild_or_upgrade, duplex, multiplex}
> #   (b) lot_size_original = landWidth * landDepth  (ignore land_area)
> #
> # Notes / tips baked in:
> # - Fixes Vancouver address quirks (unit numbers, VANCOUVER BC, postal codes)
> # - Canonicalizes street types (STREET->ST, AVENUE/AVE->AV), ordinals (12TH->12),
> #   direction placement (e.g. "... ST E" -> "E ... ST")
> # - Uses parcel GeoJSON as address normalizer (since it has civic_number + streetname)
> # - BCA join path: permit -> parcel addr_key -> BCA.address -> folio -> rollNumber
> # - Correct BCA dims query: residentialInventory has roll_number; folioDescription has rollNumber
> # - Classifier tightened (multiplex overcount guard): excludes obvious big projects and,
> #   if units column exists, uses it.
> #
> # Dependencies: data.table, DBI, RSQLite, jsonlite, stringi
> # ------------------------------------------------------------
> 
> suppressPackageStartupMessages({
+   library(data.table)
+   library(DBI)
+   library(RSQLite)
+   library(jsonlite)
+   library(stringi)
+ })
Warning messages:
1: package ‘data.table’ was built under R version 4.4.1 
2: package ‘jsonlite’ was built under R version 4.4.1 
> 
> # ---- paths
> dir_raw <- "~/OneDrive - UBC/dataRaw"
> dir_bca <- "~/OneDrive - UBC/Documents/data/bca"
> f_perm  <- file.path(dir_raw, "vancouver_permits_full.csv")
> f_parc  <- file.path(dir_raw, "property-parcel-polygons.geojson")
> f_bca   <- file.path(dir_bca, "REVD16_and_inventory_extracts.sqlite3")
> f_bca18 <- file.path(dir_bca, "REVD18_and_inventory_extracts_CSV_files/address.csv")
> 
> library(data.table)
> library(stringi)
> 
> # ---------- helpers
> norm <- function(x) {
+   x <- fifelse(is.na(x), "", x)
+   x <- toupper(trimws(x))
+   x <- stri_replace_all_regex(x, "[^A-Z0-9 ]+", " ")
+   x <- stri_replace_all_regex(x, "\\s+", " ")
+   trimws(x)
+ }
> 
> # Extract civic number (first integer)
> civic_num <- function(addr) as.integer(stri_extract_first_regex(norm(addr), "\\b\\d{1,6}\\b"))
> 
> # Extract postal (optional)
> postal <- function(addr) stri_extract_first_regex(norm(addr), "\\b[ABCEGHJ-NPRSTVXY]\\d[ABCEGHJ-NPRSTVXY]\\s*\\d[ABCEGHJ-NPRSTVXY]\\d\\b")
> 
> # Canonical street string from permit free-form:
> # remove civic num, unit, city/province/postal tail; normalize common street types + ordinals
> canon_street <- function(addr) {
+   a <- norm(addr)
+ 
+   a <- stri_replace_all_regex(a, "#\\s*\\d+\\b", "")                  # unit like #205
+   a <- stri_replace_first_regex(a, "^\\s*\\d{1,6}\\s+", "")           # drop civic num
+   a <- stri_replace_all_regex(a, "\\bVANCOUVER\\b.*$", "")            # drop city onward
+   a <- stri_replace_all_regex(a, "\\bBC\\b.*$", "")
+   a <- stri_replace_all_regex(a, "\\b[ABCEGHJ-NPRSTVXY]\\d[ABCEGHJ-NPRSTVXY]\\s*\\d[ABCEGHJ-NPRSTVXY]\\d\\b.*$", "")
+ 
+   a <- stri_replace_all_regex(a, "\\b(\\d+)(ST|ND|RD|TH)\\b", "$1")   # 1ST -> 1
+   a <- stri_replace_all_regex(a, "\\bAVENUE\\b|\\bAVE\\b", "AV")
+   a <- stri_replace_all_regex(a, "\\bSTREET\\b", "ST")
+   a <- stri_replace_all_regex(a, "\\bROAD\\b", "RD")
+   a <- stri_replace_all_regex(a, "\\bDRIVE\\b", "DR")
+   a <- stri_replace_all_regex(a, "\\bLANE\\b", "LN")
+   a <- stri_replace_all_regex(a, "\\bBOULEVARD\\b", "BLVD")
+   a <- stri_replace_all_regex(a, "\\s+", " ")
+   trimws(a)
+ }
> 
> # Build key: "NUM DIR NAME TYPE DIR2" (spaces normalized)
> mk_key <- function(num, dir_pre, name, type, dir_suf) {
+   norm(paste(num, dir_pre, name, type, dir_suf))
+ }
> 
> # ---------- load permit data (example: you already have perm)
> # perm <- fread("vancouver_permits_full.csv", sep=";")
> # expects column: address and permitnumber (or similar)
> perm <- fread(f_perm, sep=";", na.strings=c("", "NA"))
> perm <- copy(perm)  # if already in memory
> 
> perm[, civic := civic_num(address)]
> perm[, street := canon_street(address)]
> perm[, permit_key := norm(paste(civic, street))]
> perm_use <- perm[!is.na(civic) & civic > 0 & nzchar(street), .(permitnumber, permit_key)]
> 
> # ---------- load BCA address CSV (2018)
> # bca_addr <- fread(".../address_2018.csv")
> bca_addr <- fread(f_bca18)
> 
> # primary only (as text "true"/"false" in your head)
> bca_addr <- bca_addr[norm(primaryFlag) %in% c("TRUE", "T", "1")]
Error in .checkTypos(e, names_x) : 
  'no' is of type logical but 'yes' is character. Please make all arguments have the same type.
Calls: [ ... <Anonymous> -> .checkTypos -> stopf -> raise_condition -> signal
Execution halted
