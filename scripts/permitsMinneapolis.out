
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # permitsMinneapolis.R 
> # R code to grab Minneapolis permits for single family / infill areas
> # Tom Davidoff
> # Adapted from Portland code by Claude
> # Purpose: Analyze permit activity around Minneapolis 2040 zoning reform
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(sf)
Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE
> library(ggplot2)
> library(tigris)
To enable caching of data, set `options(tigris_use_cache = TRUE)`
in your R script or .Rprofile.
Warning message:
package ‘tigris’ was built under R version 4.4.1 
> 
> # ==========================================
> # TOGGLE: "zip" or "tract"
> # ==========================================
> GEOGRAPHY <- "zip"
> # ==========================================
> 
> options(timeout = 600)
> options(tigris_use_cache = TRUE)
> 
> # --- MINNEAPOLIS PERMITS ---
> # Based on header provided: data has HOUSING_TY, UNITS, YEAR, RES_PERMIT, ZIP_CODE, geometry
> # CO_CODE 053 = Hennepin County
> mpls_file <- "~/OneDrive - UBC/dataRaw/shp_econ_residential_building_permts/ResidentialPermits.shp"  # UPDATE THIS
> 
> message("Reading Minneapolis permit data...")
Reading Minneapolis permit data...
> sfPermit <- st_read(mpls_file)
Reading layer `ResidentialPermits' from data source 
  `/Users/davidoff/Library/CloudStorage/OneDrive-UBC/dataRaw/shp_econ_residential_building_permts/ResidentialPermits.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 107370 features and 28 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 420204.1 ymin: 4923165 xmax: 521207.2 ymax: 5028983
Projected CRS: NAD83 / UTM zone 15N
> names(sfPermit) <- tolower(names(sfPermit))
> 
> # Check the CRS - your data showed NAD83 / UTM zone 15N (EPSG:26915)
> # Transform to a common CRS if needed
> if (st_crs(sfPermit)$epsg != 26915) {
+ 
+   sfPermit <- st_transform(sfPermit, 26915)
+ }
> 
> # Convert to data.table for filtering, then back to sf
> dtPermit <- as.data.table(sfPermit)
> 
> # --- FILTER FOR ANALYSIS PERIOD ---
> # Minneapolis 2040: Adopted Dec 2018, effective Jan 1, 2020
> # Option A: Pre-reform (2016-2019)
> # Option B: Post-reform (2020-2023)
> # Adjust as needed for your research question
> 
> #dtPermit <- dtPermit[year >= 2016 & year <= 2019]  # PRE-REFORM
>  dtPermit <- dtPermit[year >= 2020 & year <= 2025]  # POST-REFORM
> 
> # --- FILTER FOR NEW CONSTRUCTION ---
> # RES_PERMIT: NU = New, RM = Remodel (based on your header)
> dtPermit <- dtPermit[res_permit == "NU"]
> # reduce to Minneapolis city only
> dtPermit <- dtPermit[ctu_name == "Minneapolis"]
> 
> # --- MINNEAPOLIS INFILL LOGIC ---
> # Identify "plex" permits (2+ units, or non-SFD housing types)
> # HOUSING_TY: SFD = Single-Family Detached
> # HOUSING__1 appears to be the full description
> 
> dtPermit[, isPlex := units >= 2 | 
+            !housing_ty %in% c("SFD") |
+            grepl("duplex|triplex|fourplex|twinhome|townhouse", 
+                  housing__1, ignore.case = TRUE)]
> 
> # Filter to Hennepin County (Minneapolis area) if needed
> # CO_CODE 053 = Hennepin
> dtPermit <- dtPermit[co_code == "053" | co_code == 53]
> 
> message("Permits after filtering: ", nrow(dtPermit))
Permits after filtering: 648
> 
> # Convert back to sf
> sfPermit <- st_as_sf(dtPermit)
> sfPermit <- st_transform(sfPermit, 26915)
> 
> # --- MINNEAPOLIS ZONING DISTRICTS ---
> zoning_file <- "~/OneDrive - UBC/dataRaw/Planning_Primary_Zoning/Planning_Primary_Zoning.shp"  # UPDATE if different
> 
> message("Reading Minneapolis zoning data...")
Reading Minneapolis zoning data...
> sfZoning <- st_read(zoning_file)
Reading layer `Planning_Primary_Zoning' from data source 
  `/Users/davidoff/Library/CloudStorage/OneDrive-UBC/dataRaw/Planning_Primary_Zoning/Planning_Primary_Zoning.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1259 features and 6 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -10389350 ymin: 5604313 xmax: -10374400 ymax: 5629592
Projected CRS: WGS 84 / Pseudo-Mercator
> names(sfZoning) <- tolower(names(sfZoning))
> sfZoning <- st_transform(sfZoning, 26915)
> 
> # Print zoning field names to identify the zone column
> message("Zoning fields: ", paste(names(sfZoning), collapse = ", "))
Zoning fields: objectid, land_use, land_use_c, ruleid, shape__are, shape__len, geometry
> 
> # --- SPATIAL JOIN: PERMITS + ZONING ---
> message("Joining permits to zoning...")
Joining permits to zoning...
> sfPermitZoned <- st_join(sfPermit, sfZoning)
> 
> # ==========================================
> # GEOGRAPHY-SPECIFIC JOIN
> # ==========================================
> 
> if (GEOGRAPHY == "tract") {
+   message("Fetching census tracts...")
+   sfTracts <- tracts(state = "MN", county = "Hennepin", year = 2021, cb = TRUE)
+   sfTracts <- st_transform(sfTracts, 26915)
+   sfFinal <- st_join(sfPermitZoned, sfTracts[, c("GEOID", "NAMELSAD")])
+   dtFinal <- as.data.table(sfFinal)
+   setnames(dtFinal, c("GEOID", "NAMELSAD"), c("geo_id", "geo_name"), skip_absent = TRUE)
+ } else {
+   message("Fetching ZCTAs...")
+   sfZips <- zctas(year = 2020, cb = TRUE)
+   # Minneapolis area ZIPs start with 554 or 553
+   sfZips <- sfZips[grepl("^55[34]", sfZips$ZCTA5CE20), ]
+   sfZips <- st_transform(sfZips, 26915)
+   sfFinal <- st_join(sfPermitZoned, sfZips[, c("ZCTA5CE20")])
+   dtFinal <- as.data.table(sfFinal)
+   setnames(dtFinal, "ZCTA5CE20", "geo_id", skip_absent = TRUE)
+   dtFinal[, geo_name := paste("ZIP", geo_id)]
+ }
Fetching ZCTAs...
> 
> # ==========================================
> # IDENTIFY R-ZONES (Single-Family Equivalent)
> # ==========================================
> # Minneapolis zoning: R1, R1A = single-family; R2, R2B, R3 = small multi-family
> # The zoning field name may vary - check output above and adjust
> 
> # Print unique zone values to help identify the right field
> message("Checking zoning categories...")
Checking zoning categories...
> # Uncomment and run to see what zones exist:
> # print(unique(dtFinal$zone))  # or whatever the zone column is called
> 
> # Filter for residential zones (adjust field name as needed)
> # Pre-2020 Minneapolis had R1, R1A, R2, R2B, R3, R4, R5, R6
> # These are the "interior" residential zones analogous to Portland's R-zones
> print(head(dtFinal))
   sde_id co_code ctu_code   ctu_id    coctu_id    ctu_name   year tenure
    <num>  <char>   <char>   <char>      <char>      <char> <char> <char>
1: 129173     053    43000 02395345 05302395345 Minneapolis   2020    OWN
2: 129174     053    43000 02395345 05302395345 Minneapolis   2020    OWN
3: 130711     053    43000 02395345 05302395345 Minneapolis   2020    OWN
4: 130712     053    43000 02395345 05302395345 Minneapolis   2020    OWN
5: 130713     053    43000 02395345 05302395345 Minneapolis   2020    OWN
6: 130714     053    43000 02395345 05302395345 Minneapolis   2020    OWN
   housing_ty              housing__1 res_permit           address zip_code
       <char>                  <char>     <char>            <char>   <char>
1:        ADU Accessory Dwelling Unit         NU  4120 BEARD AVE S     <NA>
2:        ADU Accessory Dwelling Unit         NU   4600 36TH AVE S     <NA>
3:        ADU Accessory Dwelling Unit         NU 3241 PORTLAND AVE     <NA>
4:        ADU Accessory Dwelling Unit         NU   4404 29TH AVE S     <NA>
5:        ADU Accessory Dwelling Unit         NU 4148 COLFAX AVE S     <NA>
6:        ADU Accessory Dwelling Unit         NU  5600 CLINTON AVE     <NA>
   zip_plus_4   name buildings units age_restri memory_car assisted com_off_re
       <char> <char>     <num> <num>      <num>      <num>    <num>     <char>
1:       <NA>   <NA>         0     1          0          0        0       <NA>
2:       <NA>   <NA>         0     1          0          0        0       <NA>
3:       <NA>   <NA>         0     1          0          0        0       <NA>
4:       <NA>   <NA>         0     1          0          0        0       <NA>
5:       <NA>   <NA>         0     1          0          0        0       <NA>
6:       <NA>   <NA>         0     1          0          0        0       <NA>
   acreage   sqf    pin public_fun permit_val community_  notes isPlex objectid
     <num> <num> <char>     <char>      <num>     <char> <char> <lgcl>    <int>
1:       0     0   <NA>       <NA>     227500      Urban     \r   TRUE      339
2:       0     0   <NA>       <NA>      75000      Urban     \r   TRUE     1178
3:       0     0   <NA>       <NA>      80000      Urban     \r   TRUE       72
4:       0     0   <NA>       <NA>     100000      Urban     \r   TRUE     1027
5:       0     0   <NA>       <NA>     167000      Urban     \r   TRUE      339
6:       0     0   <NA>       <NA>      78000      Urban     \r   TRUE      339
                land_use land_use_c ruleid  shape__are shape__len geo_id
                  <char>     <char>  <int>       <num>      <num> <char>
1:  Urban Neighborhood 1        UN1     13 54195565.67 131543.078  55410
2: Destination Mixed Use        CM4      4    32197.25   1392.368  55406
3:  Urban Neighborhood 2        UN2     14  1426707.90   6101.081  55407
4:  Urban Neighborhood 2        UN2     14   131148.37   3942.304  55406
5:  Urban Neighborhood 1        UN1     13 54195565.67 131543.078  55409
6:  Urban Neighborhood 1        UN1     13 54195565.67 131543.078  55419
                   geometry  geo_name
                <sfc_POINT>    <char>
1: POINT (474406.5 4975006) ZIP 55410
2: POINT (482576.8 4974036) ZIP 55406
3: POINT (478913.9 4976713) ZIP 55407
4: POINT (481753.2 4974425) ZIP 55406
5:   POINT (476921 4974896) ZIP 55409
6: POINT (478421.8 4972049) ZIP 55419
> print(table(dtFinal[,land_use]))

         Community Mixed Use           Corridor Mixed Use 
                          25                           36 
       Destination Mixed Use              Downtown Center 
                           6                            6 
        Downtown Destination       Neighborhood Mixed Use 
                           7                           10 
   Production and Processing         Production Mixed Use 
                           3                            8 
 Residence and Institutional Residence Goods and Services 
                           6                           22 
        Urban Neighborhood 1         Urban Neighborhood 2 
                         184                          292 
        Urban Neighborhood 3 
                          43 
> print(table(dtFinal[,land_use_c]))

CM1 CM2 CM3 CM4 DT1 DT2 PR1 PR2 RM1 RM3 UN1 UN2 UN3 
 10  36  25   6   6   7   8   3  22   6 184 292  43 
> dtAnalysis <- dtFinal[grepl("UN1|UN2", land_use_c, ignore.case = TRUE)] # not UN3 that's more density
> 
> # Alternative: if the zone field has different naming, try:
> # dtAnalysis <- dtFinal[grepl("residential", zone, ignore.case = TRUE)]
> 
> message("Permits in R-zones: ", nrow(dtAnalysis))
Permits in R-zones: 476
> 
> # ==========================================
> # LOT-LEVEL COLLAPSE
> # ==========================================
> # Minneapolis data uses PIN for parcel ID
> 
> # Check what ID field exists
> if ("pin" %in% names(dtAnalysis)) {
+   parcel_id <- "address"
+ } else if ("property_id" %in% names(dtAnalysis)) {
+   parcel_id <- "property_id"
+ } else {
+   # Use address as fallback
+   parcel_id <- "address"
+   message("Warning: Using address as parcel ID - may not be unique")
+ }
> 
> # Collapse multiple permits per parcel into a single lot record
> dtLots <- dtAnalysis[!is.na(geo_id) & !is.na(get(parcel_id)), .(
+   isPlexLot = any(isPlex, na.rm = TRUE),
+   total_units = sum(units, na.rm = TRUE),
+   permit_count = .N
+ ), by = c(parcel_id, "geo_id", "land_use_c", "geo_name")]
> 
> message("Total lots with permits: ", nrow(dtLots))
Total lots with permits: 468
> message("Lots with plex permits: ", sum(dtLots$isPlexLot))
Lots with plex permits: 166
> 
> # ==========================================
> # GEOGRAPHY-LEVEL PROPENSITY (Based on Lots)
> # ==========================================
> 
> dtGeo <- dtLots[, .(
+   infill_lot_count = sum(isPlexLot, na.rm = TRUE),
+   total_lots_active = .N,
+   total_units = sum(total_units, na.rm = TRUE),
+   propensity = sum(isPlexLot, na.rm = TRUE) / .N
+ ), by = .(geo_id, geo_name)]
> 
> setorder(dtGeo, -total_lots_active)
> 
> # ==========================================
> # SAVE & SUMMARY
> # ==========================================
> output_file <- sprintf("~/OneDrive - UBC/dataProcessed/minneapolis_%s_propensity.rds", GEOGRAPHY)
> saveRDS(dtGeo, output_file)
> 
> cat("\n=== LOT-LEVEL SUMMARY BY", toupper(GEOGRAPHY), "===\n")

=== LOT-LEVEL SUMMARY BY ZIP ===
> cat("Total Active Lots (R-Zones):", nrow(dtLots), "\n")
Total Active Lots (R-Zones): 468 
> cat("Total Infill Lots (Plexes):", sum(dtLots$isPlexLot), "\n")
Total Infill Lots (Plexes): 166 
> cat("Overall Infill Propensity (Lot-based):",
+     round(sum(dtGeo$infill_lot_count) / sum(dtGeo$total_lots_active), 4), "\n")
Overall Infill Propensity (Lot-based): 0.3547 
> 
> print(head(dtGeo, 15))
    geo_id  geo_name infill_lot_count total_lots_active total_units propensity
    <char>    <char>            <int>             <int>       <num>      <num>
 1:  55411 ZIP 55411               14                94         227 0.14893617
 2:  55410 ZIP 55410               13                71          83 0.18309859
 3:  55406 ZIP 55406               17                62          82 0.27419355
 4:  55414 ZIP 55414               39                41          98 0.95121951
 5:  55412 ZIP 55412                3                38         117 0.07894737
 6:  55417 ZIP 55417               12                34          63 0.35294118
 7:  55405 ZIP 55405               23                33          73 0.69696970
 8:  55418 ZIP 55418               11                18         145 0.61111111
 9:  55407 ZIP 55407                7                17         169 0.41176471
10:  55419 ZIP 55419                4                15          38 0.26666667
11:  55408 ZIP 55408                7                11         149 0.63636364
12:  55413 ZIP 55413                6                10          47 0.60000000
13:  55404 ZIP 55404                3                 7          18 0.42857143
14:  55409 ZIP 55409                3                 6           8 0.50000000
15:  55416 ZIP 55416                1                 6           8 0.16666667
> 
> # ==========================================
> # DIAGNOSTIC: Check zoning field names
> # ==========================================
> cat("\n=== DIAGNOSTIC INFO ===\n")

=== DIAGNOSTIC INFO ===
> cat("Zoning column names available:\n")
Zoning column names available:
> print(names(sfZoning)[1:min(10, length(names(sfZoning)))])
[1] "objectid"   "land_use"   "land_use_c" "ruleid"     "shape__are"
[6] "shape__len" "geometry"  
> cat("\nSample zone values (first 20 unique):\n
+ ")

Sample zone values (first 20 unique):

> # print(head(unique(dtFinal$land_use_c), 20))
> 
> proc.time()
   user  system elapsed 
  3.281   0.231   2.702 
