
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # minneapolisAnalysis.R
> # Analyze the ppsf slope in sf and infill, as in Vancouver
> # Tom Davidoff
> # Adapted from Portland code for Minneapolis 2040 analysis
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(fixest)
> library(ggplot2)
> 
> # 1. Load ------------------------------------------------------------------
> permits <- readRDS("~/OneDrive - UBC/dataProcessed/minneapolis_zip_propensity.rds")
> slopes  <- readRDS("~/OneDrive - UBC/dataProcessed/minneapolis_attom_slopes_by_zip.rds")
> 
> setDT(permits); setDT(slopes)
> 
> 
> 
> # 2. Align -----------------------------------------------------------------
> # Ensure ZIPs are 5-character strings and types match
> print(head(permits))
   geo_id  geo_name infill_lot_count total_lots_active total_units propensity
   <char>    <char>            <int>             <int>       <num>      <num>
1:  55411 ZIP 55411               14                94         227 0.14893617
2:  55410 ZIP 55410               13                71          83 0.18309859
3:  55406 ZIP 55406               17                62          82 0.27419355
4:  55414 ZIP 55414               39                41          98 0.95121951
5:  55412 ZIP 55412                3                38         117 0.07894737
6:  55417 ZIP 55417               12                34          63 0.35294118
> print(head(slopes))
      zip      slope     N mean_ppsf
   <char>      <num> <int>     <num>
1:  55412 -0.6412811  1372  155.8269
2:  55422 -0.3792076  1276  196.9297
3:  55369 -0.5084602  1245  209.6103
4:  55407 -0.6137788  1159  201.5972
5:  55311 -0.2613013  1148  176.1614
6:  55418 -0.5193964  1124  212.3561
> 
> 
> setnames(permits, "geo_id", "zip")
> permits[, zip := sprintf("%05s", as.character(zip))]
> slopes[,  zip := sprintf("%05s", as.character(zip))]
> 
> # Merge on Zip
> dt <- merge(permits, slopes, by = "zip")
> print(head(dt))
Key: <zip>
      zip  geo_name infill_lot_count total_lots_active total_units propensity
   <char>    <char>            <int>             <int>       <num>      <num>
1:  55403 ZIP 55403                1                 2           4  0.5000000
2:  55404 ZIP 55404                3                 7          18  0.4285714
3:  55405 ZIP 55405               23                33          73  0.6969697
4:  55406 ZIP 55406               17                62          82  0.2741935
5:  55407 ZIP 55407                7                17         169  0.4117647
6:  55408 ZIP 55408                7                11         149  0.6363636
         slope     N mean_ppsf
         <num> <int>     <num>
1:  0.05991602   495  235.5795
2: -0.59084398   495  234.7968
3: -0.16913812   326  233.6245
4: -0.52861261  1094  235.5426
5: -0.61377875  1159  201.5972
6: -0.27075761   729  222.7664
> print(summary(dt))
     zip              geo_name         infill_lot_count total_lots_active
 Length:18          Length:18          Min.   : 0.000   Min.   : 1.00    
 Class :character   Class :character   1st Qu.: 3.000   1st Qu.: 6.25    
 Mode  :character   Mode  :character   Median : 6.500   Median :16.00    
                                       Mean   : 9.222   Mean   :26.00    
                                       3rd Qu.:12.750   3rd Qu.:37.00    
                                       Max.   :39.000   Max.   :94.00    
  total_units       propensity         slope                N         
 Min.   :  1.00   Min.   :0.0000   Min.   :-0.72374   Min.   :  21.0  
 1st Qu.: 10.50   1st Qu.:0.2040   1st Qu.:-0.60805   1st Qu.: 477.0  
 Median : 68.00   Median :0.4202   Median :-0.38801   Median : 714.0  
 Mean   : 74.22   Mean   :0.4337   Mean   :-0.40817   Mean   : 730.5  
 3rd Qu.:112.25   3rd Qu.:0.6083   3rd Qu.:-0.24010   3rd Qu.:1013.2  
 Max.   :227.00   Max.   :1.0000   Max.   : 0.05992   Max.   :1372.0  
   mean_ppsf    
 Min.   :133.3  
 1st Qu.:204.3  
 Median :229.5  
 Mean   :224.2  
 3rd Qu.:239.6  
 Max.   :352.8  
> 
> # 3. Clean -----------------------------------------------------------------
> # Convert slope to numeric (it was <char>) and take absolute value
> # (A larger negative slope = a steeper 'size discount')
> dt[, price_level := as.numeric(mean_ppsf)]
> 
> # Focus on Zips with enough data to be credible
> MINOBS <- 2
> dt <- dt[N >= MINOBS & total_lots_active >= MINOBS]
> 
> dtCensus <- fread("~/OneDrive - UBC/dataRaw/ACSDT5Y2024/ACSDT5Y2024.B19013-Data.csv", skip=1,select = c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)","Geographic Area Name"),header=TRUE)
> print(head(dtCensus))
   Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)
                                                                                         <char>
1:                                                                                        19454
2:                                                                                        21420
3:                                                                                        20933
4:                                                                                        20992
5:                                                                                        24496
6:                                                                                        20360
   Geographic Area Name
                 <char>
1:          ZCTA5 00601
2:          ZCTA5 00602
3:          ZCTA5 00603
4:          ZCTA5 00606
5:          ZCTA5 00610
6:          ZCTA5 00611
> setnames(dtCensus, old=c("Estimate!!Median household income in the past 12 months (in 2024 inflation-adjusted dollars)"), new=c("medianIncome"))
> dtCensus[, medianIncome := log(as.numeric(medianIncome))]
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> setnames(dtCensus,"Geographic Area Name","zip")
> dtCensus[,zip:=substring(zip,7,11)]
> dt <- merge(dt,dtCensus,by="zip")
> print(cor(dt[, .(slope, price_level, propensity,medianIncome)]))
                  slope price_level  propensity medianIncome
slope        1.00000000   0.6402688  0.07263364    0.2280953
price_level  0.64026884   1.0000000 -0.12911978    0.5480293
propensity   0.07263364  -0.1291198  1.00000000   -0.3736446
medianIncome 0.22809531   0.5480293 -0.37364460    1.0000000
> 
> 
> # 4. Model -----------------------------------------------------------------
> # Does the price-size gradient predict development propensity?
> # we use robust standard errors (hc1)
> m1 <- feols(propensity ~ slope, dt, vcov = "hc1")
> m2 <- feols(propensity ~ slope + price_level, dt, vcov = "hc1")
> m3 <- feols(propensity ~ price_level, dt, vcov = "hc1")
> m4 <- feols(propensity ~ price_level + medianIncome, dt, vcov = "hc1")
> 
> # Zen summary: No complex tables, just the facts
> print(etable(m1, m2, m3,m4))
                               m1               m2               m3
Dependent Var.:        propensity       propensity       propensity
                                                                   
Constant        0.4944** (0.1360) 0.9566* (0.3959)  0.6198 (0.4196)
slope             0.0896 (0.3592)  0.3248 (0.3192)                 
price_level                       -0.0016 (0.0015) -0.0007 (0.0017)
medianIncome                                                       
_______________ _________________ ________________ ________________
S.E. type       Heteroskeda.-rob. Heterosked.-rob. Heterosked.-rob.
Observations                   17               17               17
R2                        0.00528          0.05755          0.01667
Adj. R2                  -0.06104         -0.07709         -0.04888

                              m4
Dependent Var.:       propensity
                                
Constant          4.086. (2.199)
slope                           
price_level      0.0006 (0.0020)
medianIncome    -0.3324 (0.2151)
_______________ ________________
S.E. type       Heterosked.-rob.
Observations                  17
R2                       0.14779
Adj. R2                  0.02604
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> # 5. Plot ------------------------------------------------------------------
> ggplot(dt, aes(slope, propensity)) +
+   geom_point(alpha = 0.5) +
+   geom_smooth(method = "lm", color = "black", fill = "gray80") +
+   theme_minimal() +
+   labs(x = "Price-Size Gradient (Absolute)", 
+        y = "Permit Propensity",
+        title = "Minneapolis Supply Response")
`geom_smooth()` using formula = 'y ~ x'
> 
> ggsave("~/OneDrive - UBC/dataProcessed/minneapolis_supply_response.png", 
+        width = 8, height = 6)
`geom_smooth()` using formula = 'y ~ x'
> 
> # 6. Export ----------------------------------------------------------------
> saveRDS(dt, "~/OneDrive - UBC/dataProcessed/minneapolis_analysis_final.rds")
> 
> proc.time()
   user  system elapsed 
  1.927   0.146   1.295 
