
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # vancouverProfit.R
> # estimate profitability of redevelopment choices in Vancouver
> # Tom Davidoff 
> # 01/31/26
> 
> library(data.table)
> library(ggplot2)
> library(fixest)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> 
> # Job 1 show that in Vancouver, elasticity and price per square foot are not two different things by showing reg price/sqft on elasticity and meanPPSF from prior regression yields only significant coeff on meanPPSF?
> 
> # grab and save folio geometries for Vancouver if not yet saved
> fGeo <- "~/OneDrive - UBC/dataProcessed/bca26FolioGeometryVancouver.rds"
> if (!file.exists(fGeo)) {
+   library(sf)
+   dfG <- st_read(
+   "/Volumes/T7Office/bigFiles/bca_folios_spatial_file_20251103/bca_folios.gpkg.gpkg",
+   query = "SELECT ROLL_NUMBER, ACTUAL_USE_DESCRIPTION, NEIGHBOURHOOD, 
+            SHAPE_AREA, SHAPE_LEN, geom, JURISDICTION
+            FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV 
+            WHERE JURISDICTION = 'City of Vancouver'"
+ )
+   print(head(dfG))
+   print(table(dfG$JURISDICTION))
+   saveRDS(dfG,fGeo)
+ }
> 
> dfG <- readRDS(fGeo)
> 
> # merge geo with census tract geography
> # now get census tracts
> fCT <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
> dCT <- st_read(fCT)
Reading layer `lct_000b21a_e' from data source 
  `/Users/tdavidof/Library/CloudStorage/OneDrive-UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 6247 features and 5 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 3912489 ymin: 687427.7 xmax: 8996148 ymax: 2810992
Projected CRS: NAD83 / Statistics Canada Lambert
> print(head(dCT))
Simple feature collection with 6 features and 5 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 7172098 ymin: 860422.8 xmax: 8980685 ymax: 2153697
Projected CRS: NAD83 / Statistics Canada Lambert
       CTUID               DGUID  CTNAME LANDAREA PRUID
1 5370001.08 2021S05075370001.08 0001.08   1.6383    35
2 0010002.00 2021S05070010002.00 0002.00   1.9638    10
3 5370001.09 2021S05075370001.09 0001.09   1.9699    35
4 5370120.02 2021S05075370120.02 0120.02  76.9650    35
5 0010006.00 2021S05070010006.00 0006.00   1.0467    10
6 0010007.00 2021S05070010007.00 0007.00   0.5364    10
                        geometry
1 MULTIPOLYGON (((7196507 869...
2 MULTIPOLYGON (((8980217 215...
3 MULTIPOLYGON (((7196437 869...
4 MULTIPOLYGON (((7189476 865...
5 MULTIPOLYGON (((8980091 215...
6 MULTIPOLYGON (((8980158 215...
> # swap crs of census tracts to that of merged)
> print(st_crs(dCT))
Coordinate Reference System:
  User input: NAD83 / Statistics Canada Lambert 
  wkt:
PROJCRS["NAD83 / Statistics Canada Lambert",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["Statistics Canada Lambert",
        METHOD["Lambert Conic Conformal (2SP)",
            ID["EPSG",9802]],
        PARAMETER["Latitude of false origin",63.390675,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-91.8666666666667,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",49,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",77,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",6200000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",3000000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Topographic mapping (small scale)."],
        AREA["Canada - onshore and offshore - Alberta; British Columbia; Manitoba; New Brunswick; Newfoundland and Labrador; Northwest Territories; Nova Scotia; Nunavut; Ontario; Prince Edward Island; Quebec; Saskatchewan; Yukon."],
        BBOX[38.21,-141.01,86.46,-40.73]],
    ID["EPSG",3347]]
> print(st_crs(dfG))
Coordinate Reference System:
  User input: NAD83 / BC Albers 
  wkt:
PROJCRS["NAD83 / BC Albers",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["British Columbia Albers",
        METHOD["Albers Equal Area",
            ID["EPSG",9822]],
        PARAMETER["Latitude of false origin",45,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-126,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",50,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",58.5,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",1000000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Province-wide spatial data management."],
        AREA["Canada - British Columbia."],
        BBOX[48.25,-139.04,60.01,-114.08]],
    ID["EPSG",3005]]
> dCT <- st_transform(dCT,st_crs(dfG))
> 
> dfG <- st_join(dfG,dCT,join=st_within)
> dtGeo <- as.data.table(dfG)[,.(ROLL_NUMBER,CTNAME,ACTUAL_USE_DESCRIPTION)]
> print(table(dtGeo$ACTUAL_USE_DESCRIPTION))

                         2 Acres Or More (Outbuilding) 
                                                     3 
      2 Acres Or More (Single Family Dwelling, Duplex) 
                                                    36 
                              2 Acres Or More (Vacant) 
                                                     4 
                                       Air Space Title 
                                                    27 
                                                  Alrt 
                                                    22 
                                        Asphalt Plants 
                                                     1 
                                 Automobile Dealership 
                                                    37 
                  Automobile Paint Shop, Garages, Etc. 
                                                   141 
                                Automobile Sales (Lot) 
                                                     4 
                        Bakery & Biscuit Manufacturing 
                                                     6 
                                                  Bank 
                                                    64 
             Bed & Breakfast Operation 4 Or More Units 
                                                     8 
           Bed & Breakfast Operation Less Than 4 Units 
                                                    14 
                                               Big Box 
                                                    15 
                                         Bowling Alley 
                                                     1 
                                               Brewery 
                                                     4 
                 Bus Company, Including Street Railway 
                                                    22 
                                              Car Wash 
                                                     4 
              Cemeteries (Includes Public Or Private). 
                                                    12 
               Chemical & Chemical Products Industries 
                                                     1 
                              Churches & Bible Schools 
                                                   264 
          Civic, Institutional & Recreational (Vacant) 
                                                   523 
                                     Clothing Industry 
                                                    23 
                                 Commercial Strata-Lot 
                                                  6090 
                                Concrete Mixing Plants 
                                                     2 
        Confectionery Manufacturing & Sugar Processing 
                                                     2 
                     Convenience Store/Service Station 
                                                    12 
                                        Dairy Products 
                                                     2 
                        Department Store - Stand Alone 
                                                     2 
                                            Distillery 
                                                     1 
                                       Docks & Wharves 
                                                     6 
                                   Drive-In Restaurant 
                                                     5 
       Duplex, Non-Strata Side by Side or Front / Back 
                                                  1045 
                          Duplex, Non-Strata Up / Down 
                                                   102 
                           Duplex, Strata Front / Back 
                                                  4145 
                           Duplex, Strata Side by Side 
                                                  2213 
                              Duplex, Strata Up / Down 
                                                   181 
            Electrical & Electronics Products Industry 
                                                     1 
       Electrical Power Systems (Including Non-Utility 
                                                    23 
                                 Fast Food Restaurants 
                                                    26 
                                    Fiberoptic Conduit 
                                                     7 
                                           Food Market 
                                                    24 
                                              Fourplex 
                                                     2 
                                     Fruit & Vegetable 
                                                     2 
                         Furniture & Fixtures Industry 
                                                     6 
    Garbage Dumps, Sanitary Fills, Sewer Lagoons, Etc. 
                                                     5 
                              Gas Distribution Systems 
                                                     3 
              Golf Courses (Includes Public & Private) 
                                                    10 
Government Buildings (Includes Courthouse, Post Office 
                                                    60 
     Government Research Centres (Includes Nurseries & 
                                                     3 
                                        Grain & Forage 
                                                     1 
                                       Grain Elevators 
                                                     8 
                   Hall (Community, Lodge, Club, Etc.) 
                                                    67 
Hospitals (Nursing Homes Refer To Commercial Section). 
                                                    16 
                                                 Hotel 
                                                    58 
                             IC&I Water Lot (Improved) 
                                                    13 
                               IC&I Water Lot (Vacant) 
                                                   135 
                   Individual Strata Lot (Hotel/Motel) 
                                                  2660 
                                   Industrial (Vacant) 
                                                   125 
                                      Leather Industry 
                                                     2 
                      Lumber Yard Or Building Supplies 
                                                     3 
        Machinery Manufacturing (Excluding Electrical) 
                                                     4 
      Marine & Navigational Facilities (Includes Ferry 
                                                     4 
                            Marine Facilities (Marina) 
                                                   144 
                                        Meat & Poultry 
                                                     7 
                          Metal Fabricating Industries 
                                                    14 
                       Miscellaneous (Food Processing) 
                                                    12 
            Miscellaneous (Forest And Allied Industry) 
                                                     1 
          Miscellaneous (Mining And Allied Industries) 
                                                     1 
                    Miscellaneous (Petroleum Industry) 
                                                     1 
        Miscellaneous (Transportation & Communication) 
                                                     5 
                    Miscellaneous & (Industrial Other) 
                                                    34 
                                                 Mixed 
                                                     2 
                                    Motel & Auto Court 
                                                     3 
                        Multi-Family (Apartment Block) 
                                                  1787 
                             Multi-Family (Conversion) 
                                                  2145 
         Multi-Family (Garden Apartment & Row Housing) 
                                                   129 
                              Multi-Family (High-Rise) 
                                                   395 
                     Multi-Family (Minimal Commercial) 
                                                   339 
                      Multi-Family (Residential Hotel) 
                                                   144 
                                 Multi-Family (Vacant) 
                                                    79 
                                     Neighbourhood Pub 
                                                     6 
                         Office Building (Primary Use) 
                                                   647 
                                                 Other 
                                                     9 
                                        Other (Vacant) 
                                                     2 
Paper Box, Paper Bag, And Other Paper Remanufacturing. 
                                                     1 
               Parking (Lot Only, Paved Or Gravel-Com) 
                                                   262 
               Parking (Lot Only, Paved Or Gravel-Res) 
                                                     9 
                                        Parking Garage 
                                                    44 
                    Parking Lot Only (Paved Or Gravel) 
                                                    57 
                                Parks & Playing Fields 
                                                   174 
         Primary Metal Industries (Iron & Steel Mills, 
                                                     1 
                        Printing & Publishing Industry 
                                                    15 
                     Property Subject To Section 19(8) 
                                                  1106 
                                               Railway 
                                                    91 
   Recreational & Cultural Buildings (Includes Curling 
                                                    63 
                         Recreational Clubs, Ski Hills 
                                                     2 
                       Residential Dwelling with Suite 
                                                 35731 
                          Residential Outbuilding Only 
                                                    18 
                                       Restaurant Only 
                                                   121 
                                          Retail Strip 
                                                    45 
                   Row Housing (Single Unit Ownership) 
                                                 12479 
                                              Sawmills 
                                                     1 
  Schools & Universities, College Or Technical Schools 
                                                   190 
                                              Sea Food 
                                                     4 
                                          Self Storage 
                                                    27 
                            Self-Serve Service Station 
                                                    10 
                 Seniors Independent & Assisted Living 
                                                    22 
                                 Seniors Licensed Care 
                                                    35 
 Seniors Strata - Care, Independent or Assisted Living 
                                                    62 
                                       Service Station 
                                                    45 
                           Shopping Centre (Community) 
                                                    10 
                       Shopping Centre (Neighbourhood) 
                                                     8 
                            Shopping Centre (Regional) 
                                                    13 
                                Sign Or Billboard Only 
                                                    12 
                                Single Family Dwelling 
                                                 36975 
                        Storage & Warehousing (Closed) 
                                                   884 
                          Storage & Warehousing (Cold) 
                                                     8 
                          Storage & Warehousing (Open) 
                                                    13 
                          Store(S) And Living Quarters 
                                                   731 
                                  Store(S) And Offices 
                                                   564 
                       Store(S) And Service Commercial 
                                                  1090 
                 Stores And/Or Offices With Apartments 
                                                    31 
                       Strata Lot (Parking Commercial) 
                                                   243 
                      Strata Lot (Parking Residential) 
                                                   388 
                    Strata-Lot Residence (Condominium) 
                                                101931 
                 Stratified Operational Facility Areas 
                                                   224 
      Stratified Rental Apartment (Frame Construction) 
                                                  2210 
    Stratified Rental Apartment (Hi-Rise Construction) 
                                                  2503 
                           Stratified Rental Townhouse 
                                                    68 
             Telecommunications (Other Than Telephone) 
                                                     8 
                                             Telephone 
                                                    10 
                             Textiles & Knitting Mills 
                                                     1 
                                     Theatre Buildings 
                                                    21 
                                               Triplex 
                                                    73 
                                           Vacant IC&I 
                                                   178 
                  Vacant Residential Less Than 2 Acres 
                                                   241 
                                     Vegetable & Truck 
                                                     2 
                            Water Distribution Systems 
                                                    11 
                                           Works Yards 
                                                     8 
> dtGeo <- dtGeo[ACTUAL_USE_DESCRIPTION %in% c("Single Family Dwelling", "Residential Dwelling with Suite")]
> dtSales <- fread("~/OneDrive - UBC/Documents/data/bca/data_advice_REVD24_20240331/bca_folio_sales_20240331_REVD24.csv",select=c("ROLL_NUMBER","CONVEYANCE_DATE","CONVEYANCE_PRICE"))
> print(head(dtSales))
       ROLL_NUMBER CONVEYANCE_DATE CONVEYANCE_PRICE
            <char>           <i64>            <int>
1: 001019635940000  20150703000000         17550000
2: 001019635940000  20111028000000         10327000
3: 001019635940000  20080425000000          6280000
4: 001019635970000  19870910000000           471800
5: 001019636070000  20230905000000          8800000
6: 001019636070000  20230630000000          9200000
> dtInventory <- fread("~/OneDrive - UBC/Documents/data/bca/Residential_inventory_202501/20250101_A09_Residential_Inventory_Extract.txt",select=c("Roll_Number","MB_Effective_Year","MB_Total_Finished_Area","Land_Width_Width","Land_Depth_Depth"),colClasses=list(character=c("Roll_Number"),numeric=c("MB_Effective_Year","MB_Total_Finished_Area","Land_Width_Width","Land_Depth_Depth")))
> print(head(dtInventory))
       Roll_Number MB_Effective_Year MB_Total_Finished_Area Land_Width_Width
            <char>             <num>                  <num>            <num>
1: 001019632060000              2020                  11895               NA
2: 001019632290000              1997                   7760              195
3: 001019632450000              1945                   3215              150
4: 001019632650000              2011                   8673              150
5: 001019632760000              2022                   2942              170
6: 001019635070000              1995                   4739              170
   Land_Depth_Depth
              <num>
1:                0
2:              252
3:              250
4:              250
5:              215
6:              219
> 
> dtSales <- merge(dtSales,dtInventory,by.x="ROLL_NUMBER",by.y="Roll_Number")
> dtSales <- merge(dtSales,dtGeo,by="ROLL_NUMBER")
> print(head(dtSales))
Key: <ROLL_NUMBER>
       ROLL_NUMBER CONVEYANCE_DATE CONVEYANCE_PRICE MB_Effective_Year
            <char>           <i64>            <int>             <num>
1: 001019632060000  20190405000000         17309000              2020
2: 001019632060000  20140616000000          9450000              2020
3: 001019632060000  20140605000000                1              2020
4: 001019632290000  20130208000000          8800000              1997
5: 001019632290000  19910709000000          1700000              1997
6: 001019632450000  20061204000000          3850000              1945
   MB_Total_Finished_Area Land_Width_Width Land_Depth_Depth  CTNAME
                    <num>            <num>            <num>  <char>
1:                  11895               NA                0 0044.00
2:                  11895               NA                0 0044.00
3:                  11895               NA                0 0044.00
4:                   7760              195              252 0044.00
5:                   7760              195              252 0044.00
6:                   3215              150              250 0044.00
            ACTUAL_USE_DESCRIPTION
                            <char>
1:          Single Family Dwelling
2:          Single Family Dwelling
3:          Single Family Dwelling
4:          Single Family Dwelling
5:          Single Family Dwelling
6: Residential Dwelling with Suite
> print(summary(dtSales))
 ROLL_NUMBER        CONVEYANCE_DATE          CONVEYANCE_PRICE   
 Length:179586      Min.   :19050111000000   Min.   :        0  
 Class :character   1st Qu.:19920928000000   1st Qu.:   251000  
 Mode  :character   Median :20041006000000   Median :   540000  
                    Mean   :20026501631384   Mean   :   977812  
                    3rd Qu.:20131107000000   3rd Qu.:  1288000  
                    Max.   :20240313000000   Max.   :216200000  
                                             NA's   :1092       
 MB_Effective_Year MB_Total_Finished_Area Land_Width_Width Land_Depth_Depth
 Min.   :1901      Min.   :  396          Min.   : 13.00   Min.   :  0.0   
 1st Qu.:1972      1st Qu.: 2098          1st Qu.: 33.00   1st Qu.:112.0   
 Median :1989      Median : 2428          Median : 33.00   Median :122.0   
 Mean   :1987      Mean   : 2737          Mean   : 41.53   Mean   :121.4   
 3rd Qu.:2002      3rd Qu.: 3079          3rd Qu.: 49.00   3rd Qu.:126.0   
 Max.   :2024      Max.   :28794          Max.   :978.00   Max.   :624.0   
 NA's   :163       NA's   :157            NA's   :697                      
    CTNAME          ACTUAL_USE_DESCRIPTION
 Length:179586      Length:179586         
 Class :character   Class :character      
 Mode  :character   Mode  :character      
                                          
                                          
                                          
                                          
> dtSales[,year:=as.numeric(substr(CONVEYANCE_DATE,1,4))]
> MINYEAR <- 2019
> MINPRICE <- 500000
> dtSales <- dtSales[year>=MINYEAR & CONVEYANCE_PRICE>=MINPRICE & MB_Total_Finished_Area>0 & Land_Width_Width>0 & Land_Depth_Depth>0]
> setnames(dtSales,"CTNAME","tract")
> 
> # load data
> dtPrice <- fread("~/OneDrive - UBC/dataProcessed/bca19_mean_ppsf_slope_by_tract.csv",colClasses=list(character=c("CTUID")))
> dtChoice <- readRDS("~/OneDrive - UBC/dataProcessed/vancouverPermitLotsTracts.rds")
> 
> dtMerge <- merge(dtChoice,dtPrice,by="CTUID")
> dtMerge[,tract:=substr(CTUID,4,10)]
> 
> dtPrice[,tract:=substr(CTUID,4,10)]
> dtSales <- merge(dtSales,dtPrice,by="tract")
> print(summary(feols(log(CONVEYANCE_PRICE/MB_Total_Finished_Area) ~ meanPPSF + log(MB_Total_Finished_Area)*(meanPPSF+elasticity), data=dtSales)))
NOTE: 815 observations removed because of NA values (RHS: 815).
OLS estimation, Dep. Var.: log(CONVEYANCE_PRICE/MB_Total_Finished_Area)
Observations: 17,188
Standard-errors: IID 
                                        Estimate Std. Error   t value  Pr(>|t|)
(Intercept)                            17.364170   0.574409  30.22962 < 2.2e-16
meanPPSF                               -0.008310   0.000606 -13.71576 < 2.2e-16
log(MB_Total_Finished_Area)            -1.609706   0.072709 -22.13898 < 2.2e-16
elasticity                             -0.304543   0.122831  -2.47938  0.013171
meanPPSF:log(MB_Total_Finished_Area)    0.001332   0.000076  17.41456 < 2.2e-16
log(MB_Total_Finished_Area):elasticity  0.038943   0.015284   2.54803  0.010842
                                          
(Intercept)                            ***
meanPPSF                               ***
log(MB_Total_Finished_Area)            ***
elasticity                             *  
meanPPSF:log(MB_Total_Finished_Area)   ***
log(MB_Total_Finished_Area):elasticity *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.311622   Adj. R2: 0.318643
> print(head(dtMerge))
Key: <CTUID>
        CTUID     ROLL_NUMBER    folioID permitnumbercreateddate     use
       <char>          <char>     <char>                  <IDat>  <char>
1: 9330001.01 025790312140000 A000003EVP              2021-09-20  duplex
2: 9330001.01 025772318600000 A000003EVF              2024-12-21 laneway
3: 9330001.01 025772312520000 A000003EUQ              2021-01-27  duplex
4: 9330001.02 025821302570000 A000003GB0              2022-06-27  duplex
5: 9330001.02 025821302870000 A000003GB3              2018-08-23  single
6: 9330001.02 025821306320000 A000003GBH              2021-08-13  duplex
   maxSingle MB_effective_year MB_total_finished_area neighbourhoodDescription
       <int>            <char>                 <char>                   <char>
1:         0              1975                   2595               FRASERVIEW
2:         0              1971                   2787               FRASERVIEW
3:         0              1971                   2786               FRASERVIEW
4:         0              1973                   3846               FRASERVIEW
5:         1              2019                   2566               FRASERVIEW
6:         0              1973                   3082               FRASERVIEW
                                     address LANDAREA landWidth landDepth
                                      <char>    <num>    <char>    <char>
1: 3412 E 49TH AVENUE, Vancouver, BC V5S 1M2   1.0195                    
2:      3658 E 48TH AVENUE #3, Vancouver, BC   1.0195        40    157.83
3: 3498 E 48TH AVENUE, Vancouver, BC V5S 1H7   1.0195        45    158.17
4: 3141 E 62ND AVENUE, Vancouver, BC V5S 2G6   1.8621        55       115
5: 3157 E 62ND AVENUE, Vancouver, BC V5S 2G6   1.8621        55       115
6: 3210 E 62ND AVENUE, Vancouver, BC V5S 2G5   1.8621        50       140
               geo_point_2d   typeofwork meanPPSF  nobs slope elasticity
                     <char>       <char>    <num> <int> <num>      <num>
1:  49.2243407, -123.031668 New Building 872.5392     5    NA         NA
2: 49.2249031, -123.0246175 New Building 872.5392     5    NA         NA
3: 49.2249233, -123.0292697 New Building 872.5392     5    NA         NA
4:   49.21401, -123.0392725 New Building 710.9111     9    NA         NA
5: 49.2140062, -123.0388062 New Building 710.9111     9    NA         NA
6: 49.2132602, -123.0365756 New Building 710.9111     9    NA         NA
     tract
    <char>
1: 0001.01
2: 0001.01
3: 0001.01
4: 0001.02
5: 0001.02
6: 0001.02
> print(head(dtMerge))
Key: <CTUID>
        CTUID     ROLL_NUMBER    folioID permitnumbercreateddate     use
       <char>          <char>     <char>                  <IDat>  <char>
1: 9330001.01 025790312140000 A000003EVP              2021-09-20  duplex
2: 9330001.01 025772318600000 A000003EVF              2024-12-21 laneway
3: 9330001.01 025772312520000 A000003EUQ              2021-01-27  duplex
4: 9330001.02 025821302570000 A000003GB0              2022-06-27  duplex
5: 9330001.02 025821302870000 A000003GB3              2018-08-23  single
6: 9330001.02 025821306320000 A000003GBH              2021-08-13  duplex
   maxSingle MB_effective_year MB_total_finished_area neighbourhoodDescription
       <int>            <char>                 <char>                   <char>
1:         0              1975                   2595               FRASERVIEW
2:         0              1971                   2787               FRASERVIEW
3:         0              1971                   2786               FRASERVIEW
4:         0              1973                   3846               FRASERVIEW
5:         1              2019                   2566               FRASERVIEW
6:         0              1973                   3082               FRASERVIEW
                                     address LANDAREA landWidth landDepth
                                      <char>    <num>    <char>    <char>
1: 3412 E 49TH AVENUE, Vancouver, BC V5S 1M2   1.0195                    
2:      3658 E 48TH AVENUE #3, Vancouver, BC   1.0195        40    157.83
3: 3498 E 48TH AVENUE, Vancouver, BC V5S 1H7   1.0195        45    158.17
4: 3141 E 62ND AVENUE, Vancouver, BC V5S 2G6   1.8621        55       115
5: 3157 E 62ND AVENUE, Vancouver, BC V5S 2G6   1.8621        55       115
6: 3210 E 62ND AVENUE, Vancouver, BC V5S 2G5   1.8621        50       140
               geo_point_2d   typeofwork meanPPSF  nobs slope elasticity
                     <char>       <char>    <num> <int> <num>      <num>
1:  49.2243407, -123.031668 New Building 872.5392     5    NA         NA
2: 49.2249031, -123.0246175 New Building 872.5392     5    NA         NA
3: 49.2249233, -123.0292697 New Building 872.5392     5    NA         NA
4:   49.21401, -123.0392725 New Building 710.9111     9    NA         NA
5: 49.2140062, -123.0388062 New Building 710.9111     9    NA         NA
6: 49.2132602, -123.0365756 New Building 710.9111     9    NA         NA
     tract
    <char>
1: 0001.01
2: 0001.01
3: 0001.01
4: 0001.02
5: 0001.02
6: 0001.02
> print(table(dtMerge[,use]))

 duplex laneway   multi  single 
    766     517     176     972 
> 
> # some major outliers in slope
> 
> print(summary(dtMerge))
    CTUID           ROLL_NUMBER          folioID         
 Length:2431        Length:2431        Length:2431       
 Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character  
                                                         
                                                         
                                                         
                                                         
 permitnumbercreateddate     use              maxSingle      MB_effective_year 
 Min.   :2017-01-04      Length:2431        Min.   :0.0000   Length:2431       
 1st Qu.:2020-07-24      Class :character   1st Qu.:0.0000   Class :character  
 Median :2022-05-27      Mode  :character   Median :0.0000   Mode  :character  
 Mean   :2022-03-29                         Mean   :0.3998                     
 3rd Qu.:2024-07-29                         3rd Qu.:1.0000                     
 Max.   :2025-10-17                         Max.   :1.0000                     
                                                                               
 MB_total_finished_area neighbourhoodDescription   address         
 Length:2431            Length:2431              Length:2431       
 Class :character       Class :character         Class :character  
 Mode  :character       Mode  :character         Mode  :character  
                                                                   
                                                                   
                                                                   
                                                                   
    LANDAREA       landWidth          landDepth         geo_point_2d      
 Min.   :0.4194   Length:2431        Length:2431        Length:2431       
 1st Qu.:0.8985   Class :character   Class :character   Class :character  
 Median :1.2593   Mode  :character   Mode  :character   Mode  :character  
 Mean   :1.3235                                                           
 3rd Qu.:1.5554                                                           
 Max.   :3.5378                                                           
                                                                          
  typeofwork           meanPPSF           nobs           slope          
 Length:2431        Min.   : 710.9   Min.   :  4.0   Min.   :-0.189986  
 Class :character   1st Qu.: 828.1   1st Qu.: 30.0   1st Qu.: 0.009014  
 Mode  :character   Median : 938.5   Median : 49.0   Median : 0.091240  
                    Mean   : 927.8   Mean   : 51.9   Mean   : 0.088911  
                    3rd Qu.:1012.6   3rd Qu.: 68.0   3rd Qu.: 0.135894  
                    Max.   :1097.0   Max.   :155.0   Max.   : 0.502588  
                                                     NA's   :75         
   elasticity          tract          
 Min.   :-1.08118   Length:2431       
 1st Qu.:-0.52344   Class :character  
 Median :-0.35004   Mode  :character  
 Mean   :-0.19164                     
 3rd Qu.: 0.07948                     
 Max.   : 1.30575                     
 NA's   :75                           
> print(summary(dtMerge[nobs>quantile(nobs,.05)]))
    CTUID           ROLL_NUMBER          folioID         
 Length:2289        Length:2289        Length:2289       
 Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character  
                                                         
                                                         
                                                         
 permitnumbercreateddate     use              maxSingle      MB_effective_year 
 Min.   :2017-01-04      Length:2289        Min.   :0.0000   Length:2289       
 1st Qu.:2020-10-27      Class :character   1st Qu.:0.0000   Class :character  
 Median :2022-07-13      Mode  :character   Median :0.0000   Mode  :character  
 Mean   :2022-04-26                         Mean   :0.3818                     
 3rd Qu.:2024-08-02                         3rd Qu.:1.0000                     
 Max.   :2025-10-17                         Max.   :1.0000                     
 MB_total_finished_area neighbourhoodDescription   address         
 Length:2289            Length:2289              Length:2289       
 Class :character       Class :character         Class :character  
 Mode  :character       Mode  :character         Mode  :character  
                                                                   
                                                                   
                                                                   
    LANDAREA       landWidth          landDepth         geo_point_2d      
 Min.   :0.4194   Length:2289        Length:2289        Length:2289       
 1st Qu.:0.8985   Class :character   Class :character   Class :character  
 Median :1.2593   Mode  :character   Mode  :character   Mode  :character  
 Mean   :1.3084                                                           
 3rd Qu.:1.5340                                                           
 Max.   :3.5378                                                           
  typeofwork           meanPPSF           nobs           slope          
 Length:2289        Min.   : 747.5   Min.   : 14.0   Min.   :-0.189986  
 Class :character   1st Qu.: 828.1   1st Qu.: 30.0   1st Qu.: 0.009014  
 Mode  :character   Median : 911.3   Median : 49.0   Median : 0.091240  
                    Mean   : 923.9   Mean   : 54.7   Mean   : 0.089407  
                    3rd Qu.:1012.6   3rd Qu.: 72.0   3rd Qu.: 0.135894  
                    Max.   :1097.0   Max.   :155.0   Max.   : 0.502588  
   elasticity          tract          
 Min.   :-1.08118   Length:2289       
 1st Qu.:-0.51141   Class :character  
 Median :-0.32995   Mode  :character  
 Mean   :-0.17882                     
 3rd Qu.: 0.07948                     
 Max.   : 1.30575                     
> print(summary(dtMerge[nobs>quantile(nobs,.1)]))
    CTUID           ROLL_NUMBER          folioID         
 Length:2144        Length:2144        Length:2144       
 Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character  
                                                         
                                                         
                                                         
 permitnumbercreateddate     use              maxSingle      MB_effective_year 
 Min.   :2017-01-04      Length:2144        Min.   :0.0000   Length:2144       
 1st Qu.:2020-12-09      Class :character   1st Qu.:0.0000   Class :character  
 Median :2022-07-25      Mode  :character   Median :0.0000   Mode  :character  
 Mean   :2022-05-12                         Mean   :0.3638                     
 3rd Qu.:2024-08-06                         3rd Qu.:1.0000                     
 Max.   :2025-10-17                         Max.   :1.0000                     
 MB_total_finished_area neighbourhoodDescription   address         
 Length:2144            Length:2144              Length:2144       
 Class :character       Class :character         Class :character  
 Mode  :character       Mode  :character         Mode  :character  
                                                                   
                                                                   
                                                                   
    LANDAREA       landWidth          landDepth         geo_point_2d      
 Min.   :0.4194   Length:2144        Length:2144        Length:2144       
 1st Qu.:0.8985   Class :character   Class :character   Class :character  
 Median :1.2593   Mode  :character   Mode  :character   Mode  :character  
 Mean   :1.3272                                                           
 3rd Qu.:1.5554                                                           
 Max.   :3.5378                                                           
  typeofwork           meanPPSF           nobs           slope          
 Length:2144        Min.   : 747.5   Min.   : 17.0   Min.   :-0.189986  
 Class :character   1st Qu.: 826.2   1st Qu.: 32.0   1st Qu.: 0.009014  
 Mode  :character   Median : 901.4   Median : 49.0   Median : 0.091240  
                    Mean   : 915.5   Mean   : 57.4   Mean   : 0.089257  
                    3rd Qu.:1008.4   3rd Qu.: 74.0   3rd Qu.: 0.142119  
                    Max.   :1074.4   Max.   :155.0   Max.   : 0.502588  
   elasticity          tract          
 Min.   :-1.08118   Length:2144       
 1st Qu.:-0.51141   Class :character  
 Median :-0.35004   Mode  :character  
 Mean   :-0.19039                     
 3rd Qu.: 0.01245                     
 Max.   : 1.30575                     
> print(unique(dtMerge[elasticity>0,.(nobs,neighbourhoodDescription,elasticity)]))
     nobs  neighbourhoodDescription  elasticity
    <int>                    <char>       <num>
 1:    52                FRASERVIEW 0.116370331
 2:    52              MARINE DRIVE 0.116370331
 3:    62                   MARPOLE 0.078449334
 4:    62           SOUTH GRANVILLE 0.078449334
 5:    40           SOUTH GRANVILLE 0.079479499
 6:    40                SOUTHLANDS 0.079479499
 7:    40                   MARPOLE 0.079479499
 8:    17                SOUTHLANDS 0.227224644
 9:    17           SOUTH GRANVILLE 0.227224644
10:    17                KERRISDALE 0.227224644
11:    53                  OAKRIDGE 1.305753525
12:    53           SOUTH GRANVILLE 1.305753525
13:    68                 KILLARNEY 0.335313841
14:    68                    KNIGHT 0.335313841
15:    25                 KILLARNEY 0.006776214
16:    72                    CAMBIE 0.103720608
17:    72               MAIN/FRASER 0.103720608
18:    26 ARBUTUS/MACKENZIE HEIGHTS 0.708747363
19:    26                KERRISDALE 0.708747363
20:    49                    DUNBAR 0.563236058
21:    31 ARBUTUS/MACKENZIE HEIGHTS 0.447946366
22:    19                KERRISDALE 0.895135071
23:    19 ARBUTUS/MACKENZIE HEIGHTS 0.895135071
24:    18                    CAMBIE 0.247198884
25:    37                 KITSILANO 0.012449788
26:    37                POINT GREY 0.012449788
27:    16                POINT GREY 0.199732440
28:    14                POINT GREY 0.462398279
29:    20                 GRANDVIEW 0.150555481
30:    43             HASTINGS EAST 0.637744173
31:    43                 GRANDVIEW 0.637744173
     nobs  neighbourhoodDescription  elasticity
> dtMerge <- dtMerge[nobs>4]
> # Economic intuition says elasticity can't be less than -1 or else price falls in square feet. Also, as there is no assembly for larger lots, elasticity must be less than 0
> dtMerge <- dtMerge[elasticity>0,elasticity:=0]
> dtMerge <- dtMerge[elasticity < -1,elasticity:=-1]
> 
> # plot use against lat/long --extract from geo_point_2d
> dtMerge[, c("lat", "lon") := tstrsplit(geo_point_2d, ", ", type.convert = TRUE)]
> ggplot(dtMerge,aes(x=lon,y=lat,color=use)) + geom_point() + theme_minimal()
> ggsave("text/vancouverUseSpatial.png",width=6,height=6)
> 
> # also do ppsf against lat/long and then do elasticity
> ggplot(dtMerge,aes(x=lon,y=lat,color=meanPPSF)) + geom_point() + theme_minimal() + scale_color_viridis_c()
> ggsave("text/vancouverPPSFSpatial.png",width=6,height=6)
> 
> ggplot(dtMerge,aes(x=lon,y=lat,color=elasticity)) + geom_point() + theme_minimal() + scale_color_viridis_c()
> ggsave("text/vancouverElasticitySpatial.png",width=6,height=6)
> 
> # show uses with ppsf on x-axis - bar chart with share of uses by ppsf bin
> # make ppsf bins by quintile of meanPPSF
> dtMerge[,ppsfBin:=cut(meanPPSF,breaks=quantile(meanPPSF,probs=seq(0,1,by=.1),na.rm=TRUE),include.lowest=TRUE)]
> dtUsePPSF <- dtMerge[,.N,by=.(ppsfBin,use)]
> dtUsePPSF[,totalN:=sum(N),by=ppsfBin]
> dtUsePPSF[,share:=N/totalN]
> ggplot(dtUsePPSF,aes(x=ppsfBin,y=share,fill=use)) + geom_bar(stat="identity",position="fill") + theme_minimal() +
+   labs(title="Vancouver Residential Permits by Price per Square Foot",
+        x="Mean Price per Square Foot Bin",
+        y="Share of Permits by Use") +
+   scale_fill_viridis_d()
> ggsave("text/vancouverUseShareByPPSF.png",width=8,height=6)
> 
> print(summary(dtMerge))
    CTUID           ROLL_NUMBER          folioID         
 Length:2368        Length:2368        Length:2368       
 Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character  
                                                         
                                                         
                                                         
                                                         
 permitnumbercreateddate     use              maxSingle      MB_effective_year 
 Min.   :2017-01-04      Length:2368        Min.   :0.0000   Length:2368       
 1st Qu.:2020-09-30      Class :character   1st Qu.:0.0000   Class :character  
 Median :2022-06-21      Mode  :character   Median :0.0000   Mode  :character  
 Mean   :2022-04-14                         Mean   :0.3881                     
 3rd Qu.:2024-07-30                         3rd Qu.:1.0000                     
 Max.   :2025-10-17                         Max.   :1.0000                     
                                                                               
 MB_total_finished_area neighbourhoodDescription   address         
 Length:2368            Length:2368              Length:2368       
 Class :character       Class :character         Class :character  
 Mode  :character       Mode  :character         Mode  :character  
                                                                   
                                                                   
                                                                   
                                                                   
    LANDAREA       landWidth          landDepth         geo_point_2d      
 Min.   :0.4194   Length:2368        Length:2368        Length:2368       
 1st Qu.:0.8985   Class :character   Class :character   Class :character  
 Median :1.2593   Mode  :character   Mode  :character   Mode  :character  
 Mean   :1.3025                                                           
 3rd Qu.:1.5016                                                           
 Max.   :3.5378                                                           
                                                                          
  typeofwork           meanPPSF           nobs            slope          
 Length:2368        Min.   : 710.9   Min.   :  5.00   Min.   :-0.189986  
 Class :character   1st Qu.: 828.1   1st Qu.: 30.00   1st Qu.: 0.009014  
 Mode  :character   Median : 938.5   Median : 49.00   Median : 0.091240  
                    Mean   : 925.3   Mean   : 53.17   Mean   : 0.088911  
                    3rd Qu.:1012.6   3rd Qu.: 69.00   3rd Qu.: 0.135894  
                    Max.   :1097.0   Max.   :155.00   Max.   : 0.502588  
                                                      NA's   :12         
   elasticity         tract                lat             lon        
 Min.   :-1.0000   Length:2368        Min.   :49.21   Min.   :-123.2  
 1st Qu.:-0.5234   Class :character   1st Qu.:49.23   1st Qu.:-123.2  
 Median :-0.3500   Mode  :character   Median :49.24   Median :-123.1  
 Mean   :-0.3123                      Mean   :49.24   Mean   :-123.1  
 3rd Qu.: 0.0000                      3rd Qu.:49.26   3rd Qu.:-123.1  
 Max.   : 0.0000                      Max.   :49.29   Max.   :-123.0  
 NA's   :12                                                           
                ppsfBin   
 (1.02e+03,1.07e+03]:309  
 (859,939]          :271  
 (818,833]          :252  
 (984,1.01e+03]     :248  
 (800,818]          :238  
 [711,800]          :237  
 (Other)            :813  
> dtMerge[,MB_total_finished_area:=as.numeric(MB_total_finished_area)]
> # ratio of acres to sqft
> ACRESF <- 43560
> dtMerge[,lotSizeSqftX:=LANDAREA*ACRESF]
> dtMerge[,landWidth:=as.numeric(landWidth)]
> dtMerge[,landDepth:=as.numeric(landDepth)]
> dtMerge[,lotSizeSqft:=landWidth*landDepth]
> FSR_SINGLEDUPLEX <- .7 # appx
> FSR_LANEWAY <- .16
> COSTPSF <- 500
> dtMerge[,buildableLaneway:=pmax(MB_total_finished_area+FSR_LANEWAY,(FSR_SINGLEDUPLEX+FSR_LANEWAY*lotSizeSqft))]
> dtMerge[,buildableDuplex:=pmax(MB_total_finished_area,FSR_SINGLEDUPLEX*lotSizeSqft)]
> dtMerge[,profitLaneway:=buildableLaneway*(meanPPSF - COSTPSF)]
> dtMerge[,profitDuplex:=buildableDuplex*(meanPPSF*exp(elasticity/2)-COSTPSF)]
> dtMerge[,profitMulti:=lotSizeSqft*(meanPPSF*exp(elasticity/3)-COSTPSF-150)] # placeholder
> dtMerge[,single := use %chin% c("single","laneway")]
> dtMerge[,plex := use %chin% c("duplex","multi")]
> dtMerge[,laneway := use %chin% c("laneway")]
> dtMerge[,deltaProfit := profitLaneway - profitDuplex]
> dtMerge <- dtMerge[abs(deltaProfit)<1000000]
> print(summary(dtMerge))
    CTUID           ROLL_NUMBER          folioID         
 Length:1995        Length:1995        Length:1995       
 Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character  
                                                         
                                                         
                                                         
                                                         
 permitnumbercreateddate     use              maxSingle      MB_effective_year 
 Min.   :2017-01-04      Length:1995        Min.   :0.0000   Length:1995       
 1st Qu.:2021-02-21      Class :character   1st Qu.:0.0000   Class :character  
 Median :2022-10-03      Mode  :character   Median :0.0000   Mode  :character  
 Mean   :2022-05-28                         Mean   :0.3554                     
 3rd Qu.:2024-08-12                         3rd Qu.:1.0000                     
 Max.   :2025-10-17                         Max.   :1.0000                     
                                                                               
 MB_total_finished_area neighbourhoodDescription   address         
 Min.   : 466           Length:1995              Length:1995       
 1st Qu.:1819           Class :character         Class :character  
 Median :2260           Mode  :character         Mode  :character  
 Mean   :2492                                                      
 3rd Qu.:2862                                                      
 Max.   :9462                                                      
                                                                   
    LANDAREA        landWidth        landDepth     geo_point_2d      
 Min.   :0.4194   Min.   : 16.50   Min.   : 50.0   Length:1995       
 1st Qu.:0.8070   1st Qu.: 33.00   1st Qu.:115.8   Class :character  
 Median :1.1824   Median : 33.06   Median :122.0   Mode  :character  
 Mean   :1.2725   Mean   : 40.59   Mean   :122.2                     
 3rd Qu.:1.5016   3rd Qu.: 49.20   3rd Qu.:125.5                     
 Max.   :3.5378   Max.   :132.00   Max.   :277.2                     
                                                                     
  typeofwork           meanPPSF           nobs            slope          
 Length:1995        Min.   : 747.5   Min.   :  5.00   Min.   :-0.189986  
 Class :character   1st Qu.: 826.2   1st Qu.: 32.00   1st Qu.: 0.009014  
 Mode  :character   Median : 900.5   Median : 49.00   Median : 0.091240  
                    Mean   : 916.2   Mean   : 56.46   Mean   : 0.086136  
                    3rd Qu.:1009.7   3rd Qu.: 74.00   3rd Qu.: 0.132585  
                    Max.   :1097.0   Max.   :155.00   Max.   : 0.502588  
                                                                         
   elasticity         tract                lat             lon        
 Min.   :-1.0000   Length:1995        Min.   :49.21   Min.   :-123.2  
 1st Qu.:-0.5114   Class :character   1st Qu.:49.23   1st Qu.:-123.2  
 Median :-0.3500   Mode  :character   Median :49.25   Median :-123.1  
 Mean   :-0.3110                      Mean   :49.24   Mean   :-123.1  
 3rd Qu.: 0.0000                      3rd Qu.:49.26   3rd Qu.:-123.1  
 Max.   : 0.0000                      Max.   :49.29   Max.   :-123.0  
                                                                      
                ppsfBin     lotSizeSqftX     lotSizeSqft    buildableLaneway
 (859,939]          :257   Min.   : 18269   Min.   : 1600   Min.   : 483.2  
 (818,833]          :242   1st Qu.: 35153   1st Qu.: 4026   1st Qu.:1819.2  
 (1.02e+03,1.07e+03]:215   Median : 51505   Median : 4285   Median :2260.2  
 (800,818]          :211   Mean   : 55432   Mean   : 4986   Mean   :2492.7  
 [711,800]          :202   3rd Qu.: 65410   3rd Qu.: 5756   3rd Qu.:2862.2  
 (833,859]          :202   Max.   :154107   Max.   :25300   Max.   :9462.2  
 (Other)            :666                                                    
 buildableDuplex profitLaneway      profitDuplex      profitMulti     
 Min.   : 1238   Min.   : 163603   Min.   :  11818   Min.   :-518645  
 1st Qu.: 2818   1st Qu.: 638678   1st Qu.: 465350   1st Qu.: 248116  
 Median : 3003   Median : 869473   Median : 875725   Median : 727478  
 Mean   : 3496   Mean   :1079525   Mean   :1066358   Mean   : 958058  
 3rd Qu.: 4039   3rd Qu.:1385704   3rd Qu.:1521583   3rd Qu.:1508447  
 Max.   :17710   Max.   :4806451   Max.   :5171657   Max.   :5272167  
                                                                      
   single           plex          laneway         deltaProfit     
 Mode :logical   Mode :logical   Mode :logical   Min.   :-999671  
 FALSE:834       FALSE:1161      FALSE:1543      1st Qu.:-272362  
 TRUE :1161      TRUE :834       TRUE :452       Median :  18031  
                                                 Mean   :  13167  
                                                 3rd Qu.: 294975  
                                                 Max.   : 995711  
                                                                  
> dtMerge <- dtMerge[!is.na(profitLaneway) & !is.na(profitDuplex)]
> print(cor(dtMerge[use!="laneway",.(single,plex,meanPPSF,elasticity,deltaProfit)]))
                single       plex   meanPPSF elasticity deltaProfit
single       1.0000000 -1.0000000  0.4600984  0.1115610   0.1556848
plex        -1.0000000  1.0000000 -0.4600984 -0.1115610  -0.1556848
meanPPSF     0.4600984 -0.4600984  1.0000000  0.3336143  -0.2114533
elasticity   0.1115610 -0.1115610  0.3336143  1.0000000  -0.7028418
deltaProfit  0.1556848 -0.1556848 -0.2114533 -0.7028418   1.0000000
> print(cor(dtMerge[MB_effective_year<2000,.(single,plex,laneway,meanPPSF,elasticity,deltaProfit)]))
                 single        plex     laneway   meanPPSF  elasticity
single       1.00000000 -1.00000000  0.58925815  0.2220389 -0.02064591
plex        -1.00000000  1.00000000 -0.58925815 -0.2220389  0.02064591
laneway      0.58925815 -0.58925815  1.00000000 -0.1020174 -0.09350842
meanPPSF     0.22203894 -0.22203894 -0.10201745  1.0000000  0.34185920
elasticity  -0.02064591  0.02064591 -0.09350842  0.3418592  1.00000000
deltaProfit  0.07734303 -0.07734303  0.17823098 -0.4116420 -0.79675887
            deltaProfit
single       0.07734303
plex        -0.07734303
laneway      0.17823098
meanPPSF    -0.41164201
elasticity  -0.79675887
deltaProfit  1.00000000
> print(cor(dtMerge[,.(lotSizeSqft,lotSizeSqftX)]))
             lotSizeSqft lotSizeSqftX
lotSizeSqft    1.0000000    0.2813449
lotSizeSqftX   0.2813449    1.0000000
> print(feols(single ~ meanPPSF + deltaProfit,data=dtMerge[MB_effective_year<1960]))
OLS estimation, Dep. Var.: single
Observations: 416
Standard-errors: IID 
                 Estimate   Std. Error   t value   Pr(>|t|)    
(Intercept) -8.030326e-01 0.2237093675 -3.589625 3.7094e-04 ***
meanPPSF     1.212005e-03 0.0002546458  4.759572 2.6877e-06 ***
deltaProfit  6.250000e-09 0.0000000709  0.088097 9.2984e-01    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.43205   Adj. R2: 0.062248
> print(feols(single ~ meanPPSF + elasticity,data=dtMerge[MB_effective_year<1960]))
OLS estimation, Dep. Var.: single
Observations: 416
Standard-errors: IID 
             Estimate Std. Error  t value   Pr(>|t|)    
(Intercept) -0.895112   0.218369 -4.09909 4.9954e-05 ***
meanPPSF     0.001277   0.000231  5.51878 6.0389e-08 ***
elasticity  -0.096709   0.088405 -1.09393 2.7462e-01    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.431429   Adj. R2: 0.06494
> print(summary(dtMerge[,deltaProfit]))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-999671 -272362   18031   13167  294975  995711 
> 
> #perfect correlation among price/elasticity/income
> # conjecture -- ordered probit, but 2-dimensional
> dtSingle <- dtMerge[use %in% c("single","laneway"),.(laneway=mean(laneway),meanPPSF=mean(meanPPSF),elasticity=mean(elasticity)),by=CTUID]
> ggplot(dtSingle,aes(x=meanPPSF,y=elasticity,color=laneway)) + geom_point() + theme_minimal()
> ggsave("text/singleMeanElasticity.png",width=6,height=6)
> print(feols(laneway ~ log(meanPPSF) + elasticity,data=dtSingle))
OLS estimation, Dep. Var.: laneway
Observations: 68
Standard-errors: IID 
               Estimate Std. Error  t value   Pr(>|t|)    
(Intercept)   12.827522   1.804249  7.10962 1.1103e-09 ***
log(meanPPSF) -1.826510   0.264459 -6.90658 2.5359e-09 ***
elasticity    -0.169322   0.093593 -1.80912 7.5057e-02 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.22186   Adj. R2: 0.460837
> 
> 
> 
> ### LATER -- income doesn't really help
> dtIncome <- fread("~/OneDrive - UBC/dataRaw/9810005801_databaseLoadingData.csv",select=c("GEO","DGUID","Household income statistics (6)","VALUE"))
> print(head(dtIncome))
                              GEO               DGUID
                           <char>              <char>
1: 0001.00 - Abbotsford - Mission 2021S05079320001.00
2: 0001.00 - Abbotsford - Mission 2021S05079320001.00
3: 0001.00 - Abbotsford - Mission 2021S05079320001.00
4: 0002.00 - Abbotsford - Mission 2021S05079320002.00
5: 0002.00 - Abbotsford - Mission 2021S05079320002.00
6: 0002.00 - Abbotsford - Mission 2021S05079320002.00
                                Household income statistics (6)  VALUE
                                                         <char>  <int>
1:                                  Number of households (2021)    660
2:                                  Number of households (2016)    650
3: Median household total income (2020) (2020 constant dollars) 121000
4:                                  Number of households (2021)    425
5:                                  Number of households (2016)    420
6: Median household total income (2020) (2020 constant dollars)  85000
> setnames(dtIncome,c("DGUID","Household income statistics (6)","VALUE"),c("DGUID","incomeStat","medianIncome"))
> print(head(dtIncome))
                              GEO               DGUID
                           <char>              <char>
1: 0001.00 - Abbotsford - Mission 2021S05079320001.00
2: 0001.00 - Abbotsford - Mission 2021S05079320001.00
3: 0001.00 - Abbotsford - Mission 2021S05079320001.00
4: 0002.00 - Abbotsford - Mission 2021S05079320002.00
5: 0002.00 - Abbotsford - Mission 2021S05079320002.00
6: 0002.00 - Abbotsford - Mission 2021S05079320002.00
                                                     incomeStat medianIncome
                                                         <char>        <int>
1:                                  Number of households (2021)          660
2:                                  Number of households (2016)          650
3: Median household total income (2020) (2020 constant dollars)       121000
4:                                  Number of households (2021)          425
5:                                  Number of households (2016)          420
6: Median household total income (2020) (2020 constant dollars)        85000
> dtIncome <- dtIncome[incomeStat=="Median household total income (2020) (2020 constant dollars)"]
> print(head(dtIncome))
                              GEO               DGUID
                           <char>              <char>
1: 0001.00 - Abbotsford - Mission 2021S05079320001.00
2: 0002.00 - Abbotsford - Mission 2021S05079320002.00
3: 0003.00 - Abbotsford - Mission 2021S05079320003.00
4: 0004.00 - Abbotsford - Mission 2021S05079320004.00
5: 0005.01 - Abbotsford - Mission 2021S05079320005.01
6: 0005.02 - Abbotsford - Mission 2021S05079320005.02
                                                     incomeStat medianIncome
                                                         <char>        <int>
1: Median household total income (2020) (2020 constant dollars)       121000
2: Median household total income (2020) (2020 constant dollars)        85000
3: Median household total income (2020) (2020 constant dollars)        77000
4: Median household total income (2020) (2020 constant dollars)        93000
5: Median household total income (2020) (2020 constant dollars)        83000
6: Median household total income (2020) (2020 constant dollars)        54000
> dtIncome <- dtIncome[grepl("Vancouver",GEO)==TRUE]
> print(head(dtIncome))
                         GEO               DGUID
                      <char>              <char>
1: Vancouver (CMA) 933, B.C.        2021S0503933
2:       0001.01 - Vancouver 2021S05079330001.01
3:       0001.02 - Vancouver 2021S05079330001.02
4:       0002.01 - Vancouver 2021S05079330002.01
5:       0002.03 - Vancouver 2021S05079330002.03
6:       0002.04 - Vancouver 2021S05079330002.04
                                                     incomeStat medianIncome
                                                         <char>        <int>
1: Median household total income (2020) (2020 constant dollars)        90000
2: Median household total income (2020) (2020 constant dollars)        89000
3: Median household total income (2020) (2020 constant dollars)        95000
4: Median household total income (2020) (2020 constant dollars)        88000
5: Median household total income (2020) (2020 constant dollars)        91000
6: Median household total income (2020) (2020 constant dollars)        95000
> dtIncome[,tract:=substr(DGUID,13,19)]
> print(head(dtIncome))
                         GEO               DGUID
                      <char>              <char>
1: Vancouver (CMA) 933, B.C.        2021S0503933
2:       0001.01 - Vancouver 2021S05079330001.01
3:       0001.02 - Vancouver 2021S05079330001.02
4:       0002.01 - Vancouver 2021S05079330002.01
5:       0002.03 - Vancouver 2021S05079330002.03
6:       0002.04 - Vancouver 2021S05079330002.04
                                                     incomeStat medianIncome
                                                         <char>        <int>
1: Median household total income (2020) (2020 constant dollars)        90000
2: Median household total income (2020) (2020 constant dollars)        89000
3: Median household total income (2020) (2020 constant dollars)        95000
4: Median household total income (2020) (2020 constant dollars)        88000
5: Median household total income (2020) (2020 constant dollars)        91000
6: Median household total income (2020) (2020 constant dollars)        95000
     tract
    <char>
1:        
2: 0001.01
3: 0001.02
4: 0002.01
5: 0002.03
6: 0002.04
> print(head(dtMerge))
Key: <CTUID>
        CTUID     ROLL_NUMBER    folioID permitnumbercreateddate     use
       <char>          <char>     <char>                  <IDat>  <char>
1: 9330002.01 025266813710000 A000003DHE              2024-01-29 laneway
2: 9330002.01 025279811050000 A000003DT5              2025-01-27  duplex
3: 9330002.01 025268813960000 A000003DKC              2019-10-18  duplex
4: 9330002.01 025277813220000 A000003DS7              2020-07-31  duplex
5: 9330002.01 025277813430000 A000003DSC              2021-12-22  duplex
6: 9330002.01 025270814230000 A000003DNV              2024-01-17  duplex
   maxSingle MB_effective_year MB_total_finished_area neighbourhoodDescription
       <int>            <char>                  <num>                   <char>
1:         0              1960                   1772               FRASERVIEW
2:         0              1985                   2548               FRASERVIEW
3:         0              1953                   1782               FRASERVIEW
4:         0              1962                   2274               FRASERVIEW
5:         0              1962                   2321               FRASERVIEW
6:         0              1980                   2301               FRASERVIEW
                                         address LANDAREA landWidth landDepth
                                          <char>    <num>     <num>     <num>
1: 7507 ASHBURN STREET #3, Vancouver, BC V5S 2L1   1.9403     47.00    132.00
2:     2736 E 56TH AVENUE, Vancouver, BC V5S 1Z7   1.9403     51.00    120.00
3:    2615 HOYLAKE AVENUE, Vancouver, BC V5S 2E4   1.9403     47.05    130.12
4:    7428 GATINEAU PLACE, Vancouver, BC V5S 2S4   1.9403     45.00    131.49
5:    7449 GATINEAU PLACE, Vancouver, BC V5S 2S3   1.9403     47.50    112.06
6:    7541 ELLIOTT STREET, Vancouver, BC V5S 2N8   1.9403     48.00    100.00
               geo_point_2d   typeofwork meanPPSF  nobs     slope elasticity
                     <char>       <char>    <num> <int>     <num>      <num>
1: 49.2162116, -123.0568366 New Building 796.2599    52 0.1326562          0
2:   49.21879, -123.0509773 New Building 796.2599    52 0.1326562          0
3: 49.2163694, -123.0546993 New Building 796.2599    52 0.1326562          0
4: 49.2167033, -123.0517548 New Building 796.2599    52 0.1326562          0
5: 49.2164766, -123.0526887 New Building 796.2599    52 0.1326562          0
6: 49.2157913, -123.0543105 New Building 796.2599    52 0.1326562          0
     tract      lat       lon   ppsfBin lotSizeSqftX lotSizeSqft
    <char>    <num>     <num>    <fctr>        <num>       <num>
1: 0002.01 49.21621 -123.0568 [711,800]     84519.47    6204.000
2: 0002.01 49.21879 -123.0510 [711,800]     84519.47    6120.000
3: 0002.01 49.21637 -123.0547 [711,800]     84519.47    6122.146
4: 0002.01 49.21670 -123.0518 [711,800]     84519.47    5917.050
5: 0002.01 49.21648 -123.0527 [711,800]     84519.47    5322.850
6: 0002.01 49.21579 -123.0543 [711,800]     84519.47    4800.000
   buildableLaneway buildableDuplex profitLaneway profitDuplex profitMulti
              <num>           <num>         <num>        <num>       <num>
1:          1772.16        4342.800      525019.9    1286597.4    907396.2
2:          2548.16        4284.000      754917.5    1269177.3    895110.4
3:          1782.16        4285.502      527982.5    1269622.3    895424.3
4:          2274.16        4141.935      673742.3    1227089.1    865427.0
5:          2321.16        3725.995      687666.6    1103862.8    778519.3
6:          2301.16        3360.000      681741.4     995433.2    702047.4
   single   plex laneway deltaProfit
   <lgcl> <lgcl>  <lgcl>       <num>
1:   TRUE  FALSE    TRUE   -761577.5
2:  FALSE   TRUE   FALSE   -514259.7
3:  FALSE   TRUE   FALSE   -741639.8
4:  FALSE   TRUE   FALSE   -553346.8
5:  FALSE   TRUE   FALSE   -416196.2
6:  FALSE   TRUE   FALSE   -313691.8
> dtMerge <- merge(dtMerge,dtIncome[,.(tract,medianIncome)],by="tract")
> print(cor(dtMerge[MB_effective_year<1960,.(single,plex,laneway,meanPPSF,elasticity,deltaProfit,medianIncome)]))
                  single        plex     laneway    meanPPSF  elasticity
single        1.00000000 -1.00000000  0.60474597  0.25835954  0.02866592
plex         -1.00000000  1.00000000 -0.60474597 -0.25835954 -0.02866592
laneway       0.60474597 -0.60474597  1.00000000 -0.03972305 -0.03740258
meanPPSF      0.25835954 -0.25835954 -0.03972305  1.00000000  0.30251962
elasticity    0.02866592 -0.02866592 -0.03740258  0.30251962  1.00000000
deltaProfit  -0.12481308  0.12481308  0.02252261 -0.49716230 -0.77431462
medianIncome  0.17182798 -0.17182798 -0.03530621  0.49195085  0.09560253
             deltaProfit medianIncome
single       -0.12481308   0.17182798
plex          0.12481308  -0.17182798
laneway       0.02252261  -0.03530621
meanPPSF     -0.49716230   0.49195085
elasticity   -0.77431462   0.09560253
deltaProfit   1.00000000  -0.22071541
medianIncome -0.22071541   1.00000000
> 
> dtMerge[,permitYear:=as.numeric(substr(permitnumbercreateddate,1,4))]
> # do share of multi/duplex for years 2024, 2025 (exclude laneway/single)
> # Same bin plot as before, but confined to year in 2024/2025 and only multi/duplex, key var is plex share
> dtYear <- dtMerge[permitYear %in% c(2024,2025) & plex==1,.(N=.N),by=.(ppsfBin,use)]
> dtYear[,totalN:=sum(N),by=.(ppsfBin)]
> dtYear[,share:=N/totalN]
> print(dtYear)
                ppsfBin    use     N totalN     share
                 <fctr> <char> <int>  <int>     <num>
 1:           [711,800] duplex    16     30 0.5333333
 2:           [711,800]  multi    14     30 0.4666667
 3:           (859,939]  multi    17     59 0.2881356
 4:           (818,833]  multi    28     48 0.5833333
 5:      (984,1.01e+03] duplex    26     34 0.7647059
 6:      (984,1.01e+03]  multi     8     34 0.2352941
 7:           (939,984] duplex    18     28 0.6428571
 8:           (939,984]  multi    10     28 0.3571429
 9: (1.01e+03,1.02e+03] duplex    12     24 0.5000000
10: (1.01e+03,1.02e+03]  multi    12     24 0.5000000
11:  (1.07e+03,1.1e+03] duplex     7      9 0.7777778
12:  (1.07e+03,1.1e+03]  multi     2      9 0.2222222
13: (1.02e+03,1.07e+03]  multi     9     28 0.3214286
14: (1.02e+03,1.07e+03] duplex    19     28 0.6785714
15:           (818,833] duplex    20     48 0.4166667
16:           (859,939] duplex    42     59 0.7118644
17:           (833,859] duplex    23     41 0.5609756
18:           (833,859]  multi    18     41 0.4390244
19:           (800,818]  multi    20     41 0.4878049
20:           (800,818] duplex    21     41 0.5121951
                ppsfBin    use     N totalN     share
> dtPlexShare <- dtYear[use=="multi"]
> print(head(dtPlexShare))
               ppsfBin    use     N totalN     share
                <fctr> <char> <int>  <int>     <num>
1:           [711,800]  multi    14     30 0.4666667
2:           (859,939]  multi    17     59 0.2881356
3:           (818,833]  multi    28     48 0.5833333
4:      (984,1.01e+03]  multi     8     34 0.2352941
5:           (939,984]  multi    10     28 0.3571429
6: (1.01e+03,1.02e+03]  multi    12     24 0.5000000
> ggplot(dtPlexShare,aes(x=ppsfBin,y=share)) + geom_bar(stat="identity",position="dodge") + theme_minimal() +
+   labs(title="Vancouver Duplex/Multiplex Permits by Price per Square Foot",
+        x="Mean Price per Square Foot Bin",
+        y="Share of Duplex/Multiplex Permits") +
+   scale_fill_viridis_d(name="Permit Year")
> 
> ggsave("text/vancouverPlexShareByPPSF.png",width=8,height=6)
> 
> # profit from multi vs duplex
> dtMerge[,deltaProfitMulti:=profitMulti - profitDuplex]
> print(cor(dtMerge[plex==1,.(meanPPSF,elasticity,use=="multi",use=="duplex",deltaProfitMulti)]))
                    meanPPSF  elasticity          V3          V4
meanPPSF          1.00000000  0.34241500  0.02214019 -0.02214019
elasticity        0.34241500  1.00000000 -0.07750638  0.07750638
V3                0.02214019 -0.07750638  1.00000000 -1.00000000
V4               -0.02214019  0.07750638 -1.00000000  1.00000000
deltaProfitMulti  0.94647531  0.31957439 -0.02959651  0.02959651
                 deltaProfitMulti
meanPPSF               0.94647531
elasticity             0.31957439
V3                    -0.02959651
V4                     0.02959651
deltaProfitMulti       1.00000000
> print(cor(dtMerge[laneway==0,.(meanPPSF,elasticity,use=="multi",use=="duplex",deltaProfit)]))
              meanPPSF  elasticity          V3          V4 deltaProfit
meanPPSF     1.0000000  0.33361433 -0.12257887 -0.38928349 -0.21145326
elasticity   0.3336143  1.00000000 -0.08691667 -0.06082005 -0.70284181
V3          -0.1225789 -0.08691667  1.00000000 -0.28927513 -0.04743971
V4          -0.3892835 -0.06082005 -0.28927513  1.00000000 -0.12822333
deltaProfit -0.2114533 -0.70284181 -0.04743971 -0.12822333  1.00000000
> 
> proc.time()
   user  system elapsed 
 13.812   3.259   8.319 
