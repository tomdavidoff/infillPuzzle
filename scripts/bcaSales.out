
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSales.R
> # R to use 2019 sales to get census-tract level coefficients on duplex vs single family and also square footage coefficients on ppsf
> # Tom Davidoff
> # 01/14/26
> 
> # strategy:
> # Get 2026 roll centroids, merge on roll/1000 (for subdivisions), confirm coverage for 2019 sales data (through 2018)
> # merge with census tract centroids
> # Regress coefficients, etc.
> 
> library(data.table)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(ggplot2)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> BCA26 <- "/Volumes/T7Office/bigFiles/bca_folios.gpkg"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> fRollLatLon <- "~/OneDrive - UBC/dataProcessed/bca26RollCensusTract.rds"
> fLaneway <-  "~/OneDrive - UBC/dataRaw/20231231_UBC_CustomLanewayReport.xlsx"
> 
> 
> if (!file.exists(fRollLatLon)) {
+   cat("Extracting lot centroids from BCA 2026 data...\n")
+   desc26 <- st_read(BCA26,
+       layer="WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV",
+       query = "SELECT ROLL_NUMBER, geom FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV WHERE JURISDICTION_CODE=='200' AND (ACTUAL_USE_DESCRIPTION IN ('Residential Dwelling with Suite','Single Family Dwelling') OR INSTR(ACTUAL_USE_DESCRIPTION, 'uplex') > 0)", 
+       quiet = TRUE
+   )
+   print(head(desc26))
+   stDesc <- st_crs(desc26)
+   roll_pt <- st_point_on_surface(desc26)
+ # convert geom to centroid
+ # --- 2021 Census Tracts (cartographic) via download
+   ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
+   sCT <- st_read(ct_file, quiet = TRUE)
+   # sCT: your census tract sf (currently 3347)
+   sCT <- st_make_valid(sCT)
+   sCT<- st_transform(sCT, stDesc)
+ 
+   roll_ct <- st_join( roll_pt, sCT[, c("CTUID", "DGUID", "CTNAME", "PRUID")], join = st_within, left = TRUE)
+   print(head(roll_ct))
+   saveRDS(roll_ct,fRollLatLon)
+ 
+ }
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19Sales.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.land_width, i.land_depth, i.land_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, a.postalCode
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+         AND (d.actualUseDescription IN ('Residential Dwelling with Suite','Single Family Dwelling') OR INSTR(d.actualUseDescription, 'uplex') > 0)
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019,fSales)
+   } 
> dtBCA2019 <- readRDS(fSales)
> print(head(dtBCA2019))
      folioID conveyancePrice conveyanceDate MB_effective_year
       <char>          <char>         <char>            <char>
1: A000000009         9450000     2014-06-16              2019
2: A00000000A         8800000     2013-02-08              1997
3: A00000000A         1700000     1991-07-09              1997
4: A00000000B         3850000     2006-12-04              1945
5: A00000000B          190000     1977-04-15              1945
6: A00000000C         2308000     1991-09-03              2011
   MB_total_finished_area land_width land_depth land_area     roll_number
                   <char>     <char>     <char>    <char>          <char>
1:                  11895                                 001019632060000
2:                   7760        195      251.9           001019632290000
3:                   7760        195      251.9           001019632290000
4:                   3215        150        250           001019632450000
5:                   3215        150        250           001019632450000
6:                   8673        150        250           001019632650000
   zoning   actualUseDescription neighbourhoodDescription postalCode
   <char>                 <char>                   <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6T 1A9
2:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
3:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
4:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
5:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
6:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
> 
> # merge back with census tract on roll number/1000
> dtRollLatLon <- as.data.table(readRDS(fRollLatLon))
> dtBCA2019[, roll_base := floor(as.numeric(roll_number) / 1000)]
> dtRollLatLon[, roll_base := floor(as.numeric(ROLL_NUMBER) / 1000)]
> dtBCA2019 <- merge(dtBCA2019, dtRollLatLon[, .(roll_base, CTUID, DGUID, CTNAME)], by = "roll_base", all.x = TRUE)
> print(table(is.na(dtBCA2019[, CTUID])))

 FALSE   TRUE 
165645   1204 
> print(table(dtBCA2019[is.na(CTUID), actualUseDescription]))

Duplex, Non-Strata Side by Side or Front / Back 
                                             43 
                   Duplex, Non-Strata Up / Down 
                                              2 
                    Duplex, Strata Front / Back 
                                             24 
                    Duplex, Strata Side by Side 
                                              7 
                Residential Dwelling with Suite 
                                            530 
                         Single Family Dwelling 
                                            598 
> print(table(dtBCA2019[!is.na(CTUID), actualUseDescription]))

2 Acres Or More (Single Family Dwelling, Duplex) 
                                              86 
 Duplex, Non-Strata Side by Side or Front / Back 
                                            2098 
                    Duplex, Non-Strata Up / Down 
                                             254 
                     Duplex, Strata Front / Back 
                                            8357 
                     Duplex, Strata Side by Side 
                                            4964 
                        Duplex, Strata Up / Down 
                                             478 
                 Residential Dwelling with Suite 
                                           79320 
                          Single Family Dwelling 
                                           70088 
> 
> 
> # Numeric conversion and cleaning
> cols <- c("conveyancePrice", "MB_effective_year", "MB_total_finished_area")
> dtBCA2019[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
> dtBCA2019 <- dtBCA2019[!is.na(MB_total_finished_area) & conveyancePrice > 100000]
> 
> # filter types to only single and duplex 
> # Metrics & Outliers
> CUT <- 0.05
> 
> print(names(dtBCA2019))
 [1] "roll_base"                "folioID"                 
 [3] "conveyancePrice"          "conveyanceDate"          
 [5] "MB_effective_year"        "MB_total_finished_area"  
 [7] "land_width"               "land_depth"              
 [9] "land_area"                "roll_number"             
[11] "zoning"                   "actualUseDescription"    
[13] "neighbourhoodDescription" "postalCode"              
[15] "CTUID"                    "DGUID"                   
[17] "CTNAME"                  
> print(head(dtBCA2019))
Key: <roll_base>
    roll_base    folioID conveyancePrice conveyanceDate MB_effective_year
        <num>     <char>           <num>         <char>             <num>
1: 1019632060 A000000009         9450000     2014-06-16              2019
2: 1019632290 A00000000A         8800000     2013-02-08              1997
3: 1019632290 A00000000A         1700000     1991-07-09              1997
4: 1019632450 A00000000B         3850000     2006-12-04              1945
5: 1019632450 A00000000B          190000     1977-04-15              1945
6: 1019632650 A00000000C         2308000     1991-09-03              2011
   MB_total_finished_area land_width land_depth land_area     roll_number
                    <num>     <char>     <char>    <char>          <char>
1:                  11895                                 001019632060000
2:                   7760        195      251.9           001019632290000
3:                   7760        195      251.9           001019632290000
4:                   3215        150        250           001019632450000
5:                   3215        150        250           001019632450000
6:                   8673        150        250           001019632650000
   zoning   actualUseDescription neighbourhoodDescription postalCode      CTUID
   <char>                 <char>                   <char>     <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6T 1A9 9330044.00
2:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2 9330044.00
3:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2 9330044.00
4:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2 9330044.00
5:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2 9330044.00
6:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2 9330044.00
                 DGUID  CTNAME
                <char>  <char>
1: 2021S05079330044.00 0044.00
2: 2021S05079330044.00 0044.00
3: 2021S05079330044.00 0044.00
4: 2021S05079330044.00 0044.00
5: 2021S05079330044.00 0044.00
6: 2021S05079330044.00 0044.00
> dtBCA2019[, `:=`(
+     age = year(conveyanceDate) - MB_effective_year, 
+     ppsf = conveyancePrice / MB_total_finished_area, 
+     dwelling_type = ifelse(grepl("uplex", actualUseDescription, ignore.case = TRUE), "duplex", "single")
+ )]
> 
> dtBCA2019 <- dtBCA2019[
+     age >= 0 &
+     MB_total_finished_area %between% quantile(MB_total_finished_area, c(CUT, 1-CUT)) &
+     ppsf %between% quantile(ppsf,c(CUT,1-CUT))
+ ]
> 
> cat("BCA 2019 transactions loaded:", nrow(dtBCA2019), "\n")
BCA 2019 transactions loaded: 96060 
> cat("  Single:", dtBCA2019[dwelling_type == "single", .N], "\n")
  Single: 88123 
> cat("  Duplex:", dtBCA2019[dwelling_type == "duplex", .N], "\n")
  Duplex: 7937 
> 
> # ==========================================
> # Exclude from the sales homes with laneways in some (all?) specifications
> # ==========================================
> cat("\n=== PART 2: Loading BCA 2025 inventory for FSR analysis ===\n")

=== PART 2: Loading BCA 2025 inventory for FSR analysis ===
> # Load laneway data
> 
> dtLaneway <- as.data.table(read_excel(fLaneway, sheet = "DATA"))
> setnames(dtLaneway, "ROLL_NUM", "Roll_Number_char")
> dtLaneway[, `:=`(
+   Roll_Number = as.numeric(Roll_Number_char),
+   roll_base = floor(as.numeric(Roll_Number_char) / 1000)
+ )]
> print(head(dtLaneway))
   ROLLYEAR   AREA    JUR Roll_Number_char ACTUAL_USE_CODE
     <char> <char> <char>           <char>          <char>
1:     2024     09    200  001634020620000             000
2:     2024     09    200  001636019550000             000
3:     2024     09    200  001636022740000             032
4:     2024     09    200  001636036970000             000
5:     2024     09    200  001637022770000             000
6:     2024     09    200  001638037950000             000
                  MANUAL_CLASS_DESC YEAR_BUILT EFFECTIVE_YEAR
                             <char>      <num>          <num>
1: 1155 - 1 STY house - Semi-Custom       2021           2021
2: 1155 - 1 STY house - Semi-Custom       2021           2021
3: 1155 - 1 STY house - Semi-Custom       2022           2022
4: 1155 - 1 STY house - Semi-Custom       2021           2021
5: 1155 - 1 STY house - Semi-Custom       2022           2022
6: 1156 - 1.5 STY house-Semi-Custom       2021           2021
   TOTAL_FINISHED_AREA BASEMENT_AREA SLAB_AREA CRAWL_SPACE_AREA  Roll_Number
                 <num>         <num>     <num>            <num>        <num>
1:                 465             0        56              409 1.634021e+12
2:                 955             0         0              955 1.636020e+12
3:                 635           525         0              130 1.636023e+12
4:                 434             0       434                0 1.636037e+12
5:                 855             0       855                0 1.637023e+12
6:                 565             0       297                0 1.638038e+12
    roll_base
        <num>
1: 1634020620
2: 1636019550
3: 1636022740
4: 1636036970
5: 1637022770
6: 1638037950
> 
> dtBCA2019 <- merge(dtBCA2019,dtLaneway[,.(roll_base,lanewayBuilt=YEAR_BUILT)],by="roll_base",all.x=TRUE)
> dtBCA2019[, hasLaneway := !is.na(lanewayBuilt) & (year(conveyanceDate) >= lanewayBuilt) ]
> print(names(dtBCA2019))
 [1] "roll_base"                "folioID"                 
 [3] "conveyancePrice"          "conveyanceDate"          
 [5] "MB_effective_year"        "MB_total_finished_area"  
 [7] "land_width"               "land_depth"              
 [9] "land_area"                "roll_number"             
[11] "zoning"                   "actualUseDescription"    
[13] "neighbourhoodDescription" "postalCode"              
[15] "CTUID"                    "DGUID"                   
[17] "CTNAME"                   "age"                     
[19] "ppsf"                     "dwelling_type"           
[21] "lanewayBuilt"             "hasLaneway"              
> print(head(dtBCA2019))
Key: <roll_base>
    roll_base    folioID conveyancePrice conveyanceDate MB_effective_year
        <num>     <char>           <num>         <char>             <num>
1: 1019632450 A00000000B          190000     1977-04-15              1945
2: 1019635500 A00000000N         1550000     1999-07-29              1970
3: 1019636570 A00000000Z         2525000     2003-09-30              1965
4: 1020636620 D00002YZLV         2150000     2011-08-22              2004
5: 1020636620 D00002YZLV         2150000     2011-08-22              2004
6: 1020674600 A00000001B         1705500     2019-04-04              1941
   MB_total_finished_area land_width land_depth land_area     roll_number
                    <num>     <char>     <char>    <char>          <char>
1:                   3215        150        250           001019632450000
2:                   3940                                 001019635500000
3:                   3599                                 001019636570000
4:                   2431       82.6         66           001020636620001
5:                   2431       82.6         66           001020636620001
6:                   2448         61         66           001020674600000
   zoning            actualUseDescription neighbourhoodDescription postalCode
   <char>                          <char>                   <char>     <char>
1:    RS1          Single Family Dwelling               POINT GREY    V6T 1B2
2:    RS1          Single Family Dwelling               POINT GREY    V6T 1B6
3:    RS1 Residential Dwelling with Suite               POINT GREY    V6T 1B7
4:    RS1     Duplex, Strata Side by Side               POINT GREY    V6R 4E5
5:    RS1     Duplex, Strata Side by Side               POINT GREY    V6R 4E5
6:    RS1          Single Family Dwelling               POINT GREY    V6R 4E8
        CTUID               DGUID  CTNAME   age      ppsf dwelling_type
       <char>              <char>  <char> <num>     <num>        <char>
1: 9330044.00 2021S05079330044.00 0044.00    32  59.09798        single
2: 9330044.00 2021S05079330044.00 0044.00    29 393.40102        single
3: 9330044.00 2021S05079330044.00 0044.00    38 701.58377        single
4: 9330044.00 2021S05079330044.00 0044.00     7 884.40971        duplex
5: 9330044.00 2021S05079330044.00 0044.00     7 884.40971        duplex
6: 9330043.01 2021S05079330043.01 0043.01    78 696.69118        single
   lanewayBuilt hasLaneway
          <num>     <lgcl>
1:           NA      FALSE
2:           NA      FALSE
3:           NA      FALSE
4:           NA      FALSE
5:           NA      FALSE
6:           NA      FALSE
> 
> MINYEAR <- 2012
> 
> dtBCA2019[,duplex:= ifelse(dwelling_type=="duplex",1,0)]
> dtBCA2019[,nDuplex:=sum(duplex),by=.(CTUID)]
> dtBCA2019 <- dtBCA2019[ grepl("RS",zoning)]
> dtbca2019 <- dtBCA2019[ neighbourhoodDescription %chin% c("SHAUGNESSY","WEST END")==FALSE]
> print(dtBCA2019[year(conveyanceDate)>MINYEAR,quantile(ppsf),by=year(conveyanceDate)])
     year       V1
    <int>    <num>
 1:  2019 348.0445
 2:  2019 614.4815
 3:  2019 717.8786
 4:  2019 795.2808
 5:  2019 927.6438
 6:  2013 164.8213
 7:  2013 392.3834
 8:  2013 486.3553
 9:  2013 648.1190
10:  2013 928.2802
11:  2014 220.0000
12:  2014 434.6793
13:  2014 526.5763
14:  2014 691.9054
15:  2014 929.0323
16:  2015 184.2471
17:  2015 516.3802
18:  2015 610.4129
19:  2015 744.2923
20:  2015 929.0016
21:  2016 246.5596
22:  2016 625.7465
23:  2016 707.5489
24:  2016 801.5549
25:  2016 928.2649
26:  2017 337.2388
27:  2017 643.8515
28:  2017 722.5870
29:  2017 808.4526
30:  2017 928.6776
31:  2018 295.8580
32:  2018 645.0041
33:  2018 735.0272
34:  2018 810.8108
35:  2018 928.7097
     year       V1
> 
> m_dwelling <- feols(ppsf ~ duplex + log(age + 1) | CTUID, data = dtBCA2019[hasLaneway==FALSE & year(conveyanceDate) >= MINYEAR])
NOTE: 52 observations removed because of NA values (Fixed-effects: 52).
> m_sf <- feols(ppsf ~ log(age + 1) + MB_total_finished_area | CTUID, data = dtBCA2019[hasLaneway==FALSE & year(conveyanceDate) >= MINYEAR & nDuplex>20])
NOTE: 52 observations removed because of NA values (Fixed-effects: 52).
> print(etable(m_dwelling,m_sf))
                            m_dwelling                m_sf
Dependent Var.:                   ppsf                ppsf
                                                          
duplex                  -32.97 (23.05)                    
log(age+1)             6.295** (2.152)      -2.767 (2.972)
MB_total_finished_area                 -0.0384*** (0.0093)
Fixed-Effects:         --------------- -------------------
CTUID                              Yes                 Yes
______________________ _______________ ___________________
S.E.: Clustered              by: CTUID           by: CTUID
Observations                    13,103               5,093
R2                             0.24053             0.22161
Within R2                      0.00280             0.01965
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> m_dwellingNbhd <- feols(ppsf ~ neighbourhoodDescription + duplex + neighbourhoodDescription:duplex + log(age + 1) | year(conveyanceDate) , data = dtBCA2019[hasLaneway==FALSE & year(conveyanceDate) >= MINYEAR])
The variables 'neighbourhoodDescriptionCOLLINGWOOD:duplex', 'neighbourhoodDescriptionDUNBAR:duplex', 'neighbourhoodDescriptionGRANDVIEW:duplex', 'neighbourhoodDescriptionKERRISDALE:duplex', 'neighbourhoodDescriptionKNIGHT:duplex', 'neighbourhoodDescriptionMARINE DRIVE:duplex' and 7 others have been removed because of collinearity (see $collin.var).
> 
> m_sqftNbhd <- feols(ppsf ~ neighbourhoodDescription + log(MB_total_finished_area) + neighbourhoodDescription:log(MB_total_finished_area) + log(age + 1) | year(conveyanceDate) , data = dtBCA2019[hasLaneway==FALSE & year(conveyanceDate) >= MINYEAR])
> print(etable(m_dwellingNbhd,m_sqftNbhd))
                                                                        m_dwellingNbhd
Dependent Var.:                                                                   ppsf
                                                                                      
neighbourhoodDescriptionCAMBIE                                       -70.81*** (12.24)
neighbourhoodDescriptionCEDARCOTTAGE                                 -214.2*** (20.19)
neighbourhoodDescriptionCOLLINGWOOD                                  -311.0*** (19.17)
neighbourhoodDescriptionDUNBAR                                         -18.00. (7.675)
neighbourhoodDescriptionFRASERVIEW                                   -310.6*** (20.91)
neighbourhoodDescriptionGRANDVIEW                                    -265.1*** (22.94)
neighbourhoodDescriptionHASTINGSEAST                                 -297.4*** (21.77)
neighbourhoodDescriptionKERRISDALE                                    -40.02** (10.13)
neighbourhoodDescriptionKILLARNEY                                    -281.3*** (19.66)
neighbourhoodDescriptionKITSILANO                                      -46.74. (24.01)
neighbourhoodDescriptionKNIGHT                                       -294.9*** (20.16)
neighbourhoodDescriptionMAIN/FRASER                                  -233.5*** (24.46)
neighbourhoodDescriptionMARINEDRIVE                                  -355.0*** (30.04)
neighbourhoodDescriptionMARPOLE                                      -129.8*** (16.51)
neighbourhoodDescriptionOAKRIDGE                                     -116.8*** (16.61)
neighbourhoodDescriptionPOINTGREY                                        11.34 (14.60)
neighbourhoodDescriptionRENFREW                                      -310.0*** (20.25)
neighbourhoodDescriptionRENFREWHEIGHTS                               -300.0*** (19.19)
neighbourhoodDescriptionSHAUGHNESSY                                     -40.45 (24.13)
neighbourhoodDescriptionSOUTHGRANVILLE                               -81.14*** (14.28)
neighbourhoodDescriptionSOUTHVANCOUVER                               -294.0*** (19.07)
neighbourhoodDescriptionSOUTHLANDS                                   -100.3*** (16.36)
duplex                                                               -75.47*** (11.95)
log(age+1)                                                              -8.018 (4.474)
neighbourhoodDescriptionCAMBIE x duplex                                 122.5* (40.86)
neighbourhoodDescriptionCEDARCOTTAGE x duplex                            10.44 (10.01)
neighbourhoodDescriptionFRASERVIEW x duplex                            -33.05. (16.04)
neighbourhoodDescriptionHASTINGSEAST x duplex                         275.6*** (11.16)
neighbourhoodDescriptionKILLARNEY x duplex                            142.0*** (10.86)
neighbourhoodDescriptionKITSILANO x duplex                              71.44. (36.80)
neighbourhoodDescriptionMAIN/FRASER x duplex                          106.0*** (8.154)
neighbourhoodDescriptionPOINTGREY x duplex                               35.05 (24.51)
neighbourhoodDescriptionSHAUGHNESSY x duplex                            -14.12 (93.11)
log(MB_total_finished_area)                                                           
neighbourhoodDescriptionCAMBIE x log(MB_total_finished_area)                          
neighbourhoodDescriptionCEDARCOTTAGE x log(MB_total_finished_area)                    
neighbourhoodDescriptionCOLLINGWOOD x log(MB_total_finished_area)                     
neighbourhoodDescriptionDUNBAR x log(MB_total_finished_area)                          
neighbourhoodDescriptionFRASERVIEW x log(MB_total_finished_area)                      
neighbourhoodDescriptionGRANDVIEW x log(MB_total_finished_area)                       
neighbourhoodDescriptionHASTINGSEAST x log(MB_total_finished_area)                    
neighbourhoodDescriptionKERRISDALE x log(MB_total_finished_area)                      
neighbourhoodDescriptionKILLARNEY x log(MB_total_finished_area)                       
neighbourhoodDescriptionKITSILANO x log(MB_total_finished_area)                       
neighbourhoodDescriptionKNIGHT x log(MB_total_finished_area)                          
neighbourhoodDescriptionMAIN/FRASER x log(MB_total_finished_area)                     
neighbourhoodDescriptionMARINEDRIVE x log(MB_total_finished_area)                     
neighbourhoodDescriptionMARPOLE x log(MB_total_finished_area)                         
neighbourhoodDescriptionOAKRIDGE x log(MB_total_finished_area)                        
neighbourhoodDescriptionPOINTGREY x log(MB_total_finished_area)                       
neighbourhoodDescriptionRENFREW x log(MB_total_finished_area)                         
neighbourhoodDescriptionRENFREWHEIGHTS x log(MB_total_finished_area)                  
neighbourhoodDescriptionSHAUGHNESSY x log(MB_total_finished_area)                     
neighbourhoodDescriptionSOUTHGRANVILLE x log(MB_total_finished_area)                  
neighbourhoodDescriptionSOUTHVANCOUVER x log(MB_total_finished_area)                  
neighbourhoodDescriptionSOUTHLANDS x log(MB_total_finished_area)                      
Fixed-Effects:                                                       -----------------
year(conveyanceDate)                                                               Yes
________________________________________                             _________________
S.E.: Clustered                                                      by: conveyanceD..
Observations                                                                    13,155
R2                                                                             0.62027
Within R2                                                                      0.50952

                                                                            m_sqftNbhd
Dependent Var.:                                                                   ppsf
                                                                                      
neighbourhoodDescriptionCAMBIE                                          969.0* (327.4)
neighbourhoodDescriptionCEDARCOTTAGE                                     330.7 (322.4)
neighbourhoodDescriptionCOLLINGWOOD                                     768.3* (299.9)
neighbourhoodDescriptionDUNBAR                                          -33.96 (246.6)
neighbourhoodDescriptionFRASERVIEW                                      -50.27 (166.8)
neighbourhoodDescriptionGRANDVIEW                                    1,123.4** (313.5)
neighbourhoodDescriptionHASTINGSEAST                                 1,073.1** (237.8)
neighbourhoodDescriptionKERRISDALE                                      -56.14 (369.2)
neighbourhoodDescriptionKILLARNEY                                       825.4* (289.0)
neighbourhoodDescriptionKITSILANO                                       944.4* (298.1)
neighbourhoodDescriptionKNIGHT                                          809.5* (278.2)
neighbourhoodDescriptionMAIN/FRASER                                   1,032.4* (354.7)
neighbourhoodDescriptionMARINEDRIVE                                      792.4 (462.0)
neighbourhoodDescriptionMARPOLE                                         425.0. (212.2)
neighbourhoodDescriptionOAKRIDGE                                        677.0* (273.6)
neighbourhoodDescriptionPOINTGREY                                       -484.4 (524.5)
neighbourhoodDescriptionRENFREW                                      1,159.8** (267.9)
neighbourhoodDescriptionRENFREWHEIGHTS                                1,320.2* (431.9)
neighbourhoodDescriptionSHAUGHNESSY                                      353.1 (713.8)
neighbourhoodDescriptionSOUTHGRANVILLE                                  -327.6 (339.6)
neighbourhoodDescriptionSOUTHVANCOUVER                                  555.9. (245.3)
neighbourhoodDescriptionSOUTHLANDS                                       528.9 (404.1)
duplex                                                                                
log(age+1)                                                            -25.34** (5.791)
neighbourhoodDescriptionCAMBIE x duplex                                               
neighbourhoodDescriptionCEDARCOTTAGE x duplex                                         
neighbourhoodDescriptionFRASERVIEW x duplex                                           
neighbourhoodDescriptionHASTINGSEAST x duplex                                         
neighbourhoodDescriptionKILLARNEY x duplex                                            
neighbourhoodDescriptionKITSILANO x duplex                                            
neighbourhoodDescriptionMAIN/FRASER x duplex                                          
neighbourhoodDescriptionPOINTGREY x duplex                                            
neighbourhoodDescriptionSHAUGHNESSY x duplex                                          
log(MB_total_finished_area)                                            -80.23* (28.06)
neighbourhoodDescriptionCAMBIE x log(MB_total_finished_area)           -132.4* (41.62)
neighbourhoodDescriptionCEDARCOTTAGE x log(MB_total_finished_area)      -74.52 (39.93)
neighbourhoodDescriptionCOLLINGWOOD x log(MB_total_finished_area)     -143.1** (37.92)
neighbourhoodDescriptionDUNBAR x log(MB_total_finished_area)             1.317 (30.12)
neighbourhoodDescriptionFRASERVIEW x log(MB_total_finished_area)        -35.17 (21.62)
neighbourhoodDescriptionGRANDVIEW x log(MB_total_finished_area)       -183.8** (38.49)
neighbourhoodDescriptionHASTINGSEAST x log(MB_total_finished_area)   -181.9*** (28.77)
neighbourhoodDescriptionKERRISDALE x log(MB_total_finished_area)         2.023 (45.81)
neighbourhoodDescriptionKILLARNEY x log(MB_total_finished_area)       -142.8** (35.41)
neighbourhoodDescriptionKITSILANO x log(MB_total_finished_area)        -128.0* (40.72)
neighbourhoodDescriptionKNIGHT x log(MB_total_finished_area)          -146.5** (33.99)
neighbourhoodDescriptionMAIN/FRASER x log(MB_total_finished_area)     -167.7** (43.29)
neighbourhoodDescriptionMARINEDRIVE x log(MB_total_finished_area)      -154.0* (59.54)
neighbourhoodDescriptionMARPOLE x log(MB_total_finished_area)          -72.16* (26.10)
neighbourhoodDescriptionOAKRIDGE x log(MB_total_finished_area)         -96.92* (34.07)
neighbourhoodDescriptionPOINTGREY x log(MB_total_finished_area)          61.27 (64.98)
neighbourhoodDescriptionRENFREW x log(MB_total_finished_area)        -191.9*** (33.34)
neighbourhoodDescriptionRENFREWHEIGHTS x log(MB_total_finished_area)  -212.5** (54.00)
neighbourhoodDescriptionSHAUGHNESSY x log(MB_total_finished_area)       -45.40 (86.60)
neighbourhoodDescriptionSOUTHGRANVILLE x log(MB_total_finished_area)     31.85 (40.67)
neighbourhoodDescriptionSOUTHVANCOUVER x log(MB_total_finished_area)  -112.1** (29.51)
neighbourhoodDescriptionSOUTHLANDS x log(MB_total_finished_area)        -76.55 (49.22)
Fixed-Effects:                                                       -----------------
year(conveyanceDate)                                                               Yes
________________________________________                             _________________
S.E.: Clustered                                                      by: conveyanceD..
Observations                                                                    13,155
R2                                                                             0.67603
Within R2                                                                      0.58155
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> print(dtBCA2019[ , mean(ppsf), by = .(neighbourhoodDescription, duplex) ])
     neighbourhoodDescription duplex        V1
                       <char>  <num>     <num>
 1:                POINT GREY      0 351.20704
 2:                POINT GREY      1 480.97227
 3:                 KITSILANO      0 324.55579
 4:                 KITSILANO      1 390.61902
 5:                    DUNBAR      0 336.23388
 6:                    DUNBAR      1 114.78202
 7: ARBUTUS/MACKENZIE HEIGHTS      0 375.94744
 8:                KERRISDALE      0 367.20094
 9:                KERRISDALE      1 317.56193
10:                SOUTHLANDS      0 338.43288
11:                SOUTHLANDS      1 549.37868
12:               SHAUGHNESSY      0 320.05795
13:               SHAUGHNESSY      1 494.74010
14:                    CAMBIE      0 331.21357
15:                    CAMBIE      1 408.56724
16:           SOUTH GRANVILLE      0 332.10705
17:                  OAKRIDGE      0 336.57446
18:                   MARPOLE      0 326.75947
19:                 GRANDVIEW      0 269.92734
20:                 GRANDVIEW      1 156.87019
21:             CEDAR COTTAGE      0 277.81574
22:             CEDAR COTTAGE      1 406.62958
23:               MAIN/FRASER      0 283.65749
24:               MAIN/FRASER      1 351.87554
25:           SOUTH VANCOUVER      0 268.68766
26:           SOUTH VANCOUVER      1 100.85227
27:              MARINE DRIVE      0 289.53971
28:              MARINE DRIVE      1 248.82751
29:                    KNIGHT      0 262.62204
30:                    KNIGHT      1  99.72106
31:             HASTINGS EAST      0 275.08000
32:             HASTINGS EAST      1 842.26491
33:                   RENFREW      0 262.97221
34:           RENFREW HEIGHTS      0 265.93430
35:               COLLINGWOOD      0 246.04566
36:                 KILLARNEY      0 261.94035
37:                 KILLARNEY      1 426.04627
38:                FRASERVIEW      0 260.25026
39:                FRASERVIEW      1 253.30289
     neighbourhoodDescription duplex        V1
> 
> print(dtBCA2019[,median(MB_total_finished_area),by=.(duplex)])
   duplex    V1
    <num> <num>
1:      0  2361
2:      1  1808
> 
> print(table(dtBCA2019[,.(zoning)]))
zoning
 RS05   RS1  RS1A  RS1B  RS1S   RS2   RS3  RS3A   RS4   RS5  RS5S   RS6   RS7 
    1 53593   212   423    97   127   279    95    19 12420     3  1033  2156 
> 
> mainReg <- feols(ppsf ~ i(CTUID,MB_total_finished_area) + log(age+1) + MB_total_finished_area | CTUID + duplex, data=dtBCA2019[hasLaneway==FALSE & year(conveyanceDate) >=MINYEAR])
NOTE: 52 observations removed because of NA values (RHS: 52, Fixed-effects: 52).
The variable 'MB_total_finished_area' has been removed because of collinearity (see $collin.var).
> # extract interaction coefficients by CTUID into a data.table
> dtSlopes <- as.data.table(broom::tidy(mainReg))[grepl("MB_total_finished_area", term)]
> dtSlopes[, CTUID := gsub("CTUID::(.*):MB_total_finished_area", "\\1", term)]
> print(head(dtSlopes))
                                       term    estimate    std.error
                                     <char>       <num>        <num>
1: CTUID::9330001.01:MB_total_finished_area -0.24805602 0.0006465836
2: CTUID::9330001.02:MB_total_finished_area -0.03285001 0.0009671321
3: CTUID::9330002.01:MB_total_finished_area -0.06549629 0.0016986671
4: CTUID::9330002.03:MB_total_finished_area -0.08092621 0.0021209813
5: CTUID::9330002.04:MB_total_finished_area -0.03911302 0.0097092562
6: CTUID::9330003.01:MB_total_finished_area -0.01694708 0.0025975600
     statistic       p.value      CTUID
         <num>         <num>     <char>
1: -383.641062 2.986680e-125 9330001.01
2:  -33.966411  2.732901e-47 9330001.02
3:  -38.557464  3.376614e-51 9330002.01
4:  -38.155079  7.142139e-51 9330002.03
5:   -4.028426  1.332890e-04 9330002.04
6:   -6.524231  7.135477e-09 9330003.01
> 
> # Now get mean ppsf by CTUID and merge with slopes
> MEANYEAR <- 2015
> dtBcaMeans <- dtBCA2019[hasLaneway==FALSE & year(conveyanceDate) >=MEANYEAR, .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = sum(year(conveyanceDate)>=MINYEAR)), by = CTUID]
> dtBcaMeans <- merge(dtBcaMeans, dtSlopes[, .(CTUID, slope = estimate)], by = "CTUID", all.x = TRUE)
> print(head(dtBcaMeans))
Key: <CTUID>
        CTUID meanPPSF  nobs       slope
       <char>    <num> <int>       <num>
1:       <NA> 696.7770    31          NA
2: 9330001.01 689.6406    14 -0.24805602
3: 9330001.02 540.2713    20 -0.03285001
4: 9330002.01 634.0783   116 -0.06549629
5: 9330002.03 639.3170   110 -0.08092621
6: 9330002.04 536.1255   122 -0.03911302
> fwrite(dtBcaMeans, "tables/bca19_mean_ppsf_slope_by_tract.csv")
> ggplot(dtBcaMeans[nobs>quantile(nobs,.025)], aes(x=slope,y=meanPPSF)) + geom_point() + geom_smooth(method="lm") + labs(title="Mean BCA Price per SqFt vs Pricing Slope by Census Tract", x="BCA Pricing Slope ($/sqft per sqft)", y="Mean Price per SqFt")
`geom_smooth()` using formula = 'y ~ x'
Warning messages:
1: Removed 1 row containing non-finite outside the scale range (`stat_smooth()`). 
2: Removed 1 row containing missing values or values outside the scale range
(`geom_point()`). 
> ggsave("text/bca19_mean_ppsf_vs_slope.png")
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'
Warning messages:
1: Removed 1 row containing non-finite outside the scale range (`stat_smooth()`). 
2: Removed 1 row containing missing values or values outside the scale range
(`geom_point()`). 
> print(cor(dtBcaMeans[!is.na(slope),.(slope,meanPPSF)]))
              slope   meanPPSF
slope    1.00000000 0.08640369
meanPPSF 0.08640369 1.00000000
> print(cor(dtBcaMeans[!is.na(slope) & nobs>quantile(nobs,.025),.(slope,meanPPSF)]))
             slope  meanPPSF
slope    1.0000000 0.5229345
meanPPSF 0.5229345 1.0000000
> print(cor(dtBcaMeans[!is.na(slope) & nobs>quantile(nobs,.05),.(slope,meanPPSF)]))
             slope  meanPPSF
slope    1.0000000 0.5030124
meanPPSF 0.5030124 1.0000000
> 
> q("no")
> proc.time()
   user  system elapsed 
 15.068   4.273  11.485 
