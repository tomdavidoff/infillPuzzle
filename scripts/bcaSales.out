
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSales.R
> # R to use 2019 sales to get census-tract level coefficients on duplex vs single family and also square footage coefficients on ppsf
> # Tom Davidoff
> # 01/14/26
> 
> # strategy:
> # Get 2026 roll centroids, merge on roll/1000 (for subdivisions), confirm coverage for 2019 sales data (through 2018)
> # merge with census tract centroids
> # Regress coefficients, etc.
> 
> library(data.table)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(ggplot2)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> BCA26 <- "/Volumes/T7Office/bigFiles/bca_folios.gpkg"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> fRollLatLon <- "~/OneDrive - UBC/dataProcessed/bca26RollCensusTract.rds"
> fLaneway <-  "~/OneDrive - UBC/dataRaw/20231231_UBC_CustomLanewayReport.xlsx"
> 
> # drop duplex
> if (!file.exists(fRollLatLon)) {
+   cat("Extracting lot centroids from BCA 2026 data...\n")
+   desc26 <- st_read(BCA26,
+       layer="WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV",
+       query = "SELECT ROLL_NUMBER, geom FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV WHERE JURISDICTION_CODE=='200' AND ACTUAL_USE_DESCRIPTION IN ('Residential Dwelling with Suite','Single Family Dwelling')  > 0", 
+       quiet = TRUE
+   )
+   print(head(desc26))
+   stDesc <- st_crs(desc26)
+   roll_pt <- st_point_on_surface(desc26)
+   # convert geom to centroid
+   # --- 2021 Census Tracts (cartographic) via download
+   ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
+   sCT <- st_read(ct_file, quiet = TRUE)
+   sCT <- st_make_valid(sCT)
+   sCT <- st_transform(sCT, stDesc)
+ 
+   roll_ct <- st_join(roll_pt, sCT[, c("CTUID", "DGUID", "CTNAME", "PRUID")], join = st_within, left = TRUE)
+   print(head(roll_ct))
+   saveRDS(roll_ct, fRollLatLon)
+ }
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19Sales.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.land_width, i.land_depth, i.land_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, a.postalCode
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+         AND (d.actualUseDescription IN ('Residential Dwelling with Suite','Single Family Dwelling') OR INSTR(d.actualUseDescription, 'uplex') > 0)
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019, fSales)
+ } 
> dtBCA2019 <- readRDS(fSales)
> print(head(dtBCA2019))
      folioID conveyancePrice conveyanceDate MB_effective_year
       <char>          <char>         <char>            <char>
1: A000000009         9450000     2014-06-16              2019
2: A00000000A         8800000     2013-02-08              1997
3: A00000000A         1700000     1991-07-09              1997
4: A00000000B         3850000     2006-12-04              1945
5: A00000000B          190000     1977-04-15              1945
6: A00000000C         2308000     1991-09-03              2011
   MB_total_finished_area land_width land_depth land_area     roll_number
                   <char>     <char>     <char>    <char>          <char>
1:                  11895                                 001019632060000
2:                   7760        195      251.9           001019632290000
3:                   7760        195      251.9           001019632290000
4:                   3215        150        250           001019632450000
5:                   3215        150        250           001019632450000
6:                   8673        150        250           001019632650000
   zoning   actualUseDescription neighbourhoodDescription postalCode
   <char>                 <char>                   <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6T 1A9
2:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
3:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
4:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
5:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
6:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
> 
> # merge back with census tract on roll number/1000
> dtRollLatLon <- as.data.table(readRDS(fRollLatLon))
> dtBCA2019[, roll_base := floor(as.numeric(roll_number) / 1000)]
> dtRollLatLon[, roll_base := floor(as.numeric(ROLL_NUMBER) / 1000)]
> dtBCA2019 <- merge(dtBCA2019, dtRollLatLon[, .(roll_base, CTUID, DGUID, CTNAME)], by = "roll_base", all.x = TRUE)
> print(table(is.na(dtBCA2019[, CTUID])))

 FALSE   TRUE 
165645   1204 
> print(table(dtBCA2019[is.na(CTUID), actualUseDescription]))

Duplex, Non-Strata Side by Side or Front / Back 
                                             43 
                   Duplex, Non-Strata Up / Down 
                                              2 
                    Duplex, Strata Front / Back 
                                             24 
                    Duplex, Strata Side by Side 
                                              7 
                Residential Dwelling with Suite 
                                            530 
                         Single Family Dwelling 
                                            598 
> print(table(dtBCA2019[!is.na(CTUID), actualUseDescription]))

2 Acres Or More (Single Family Dwelling, Duplex) 
                                              86 
 Duplex, Non-Strata Side by Side or Front / Back 
                                            2098 
                    Duplex, Non-Strata Up / Down 
                                             254 
                     Duplex, Strata Front / Back 
                                            8357 
                     Duplex, Strata Side by Side 
                                            4964 
                        Duplex, Strata Up / Down 
                                             478 
                 Residential Dwelling with Suite 
                                           79320 
                          Single Family Dwelling 
                                           70088 
> 
> 
> # Numeric conversion and cleaning
> cols <- c("conveyancePrice", "MB_effective_year", "MB_total_finished_area","land_area","land_width","land_depth")
> dtBCA2019[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
> dtBCA2019 <- dtBCA2019[!is.na(MB_total_finished_area) & conveyancePrice > 100000]
> dtBCA2019[, land_area_approximate := land_width * land_depth]
> dtBCA2019 <- dtBCA2019[!is.na(land_depth) & !is.na(land_width)]
> 
> # Metrics
> dtBCA2019[, `:=`(
+     age = year(conveyanceDate) - MB_effective_year, 
+     ppsf = conveyancePrice / MB_total_finished_area 
+ )]
> 
> # Outlier removal (global)
> CUT <- 0.05
> dtBCA2019 <- dtBCA2019[
+     age >= 0 &
+     MB_total_finished_area %between% quantile(MB_total_finished_area, c(CUT, 1-CUT)) &
+     ppsf %between% quantile(ppsf, c(CUT, 1-CUT))
+ ]
> 
> cat("BCA 2019 transactions loaded:", nrow(dtBCA2019), "\n")
BCA 2019 transactions loaded: 89950 
> 
> # ==========================================
> # Exclude from the sales homes with laneways
> # ==========================================
> 
> dtLaneway <- as.data.table(read_excel(fLaneway, sheet = "DATA"))
> setnames(dtLaneway, "ROLL_NUM", "Roll_Number_char")
> dtLaneway[, `:=`(
+   Roll_Number = as.numeric(Roll_Number_char),
+   roll_base = floor(as.numeric(Roll_Number_char) / 1000)
+ )]
> 
> dtBCA2019 <- merge(dtBCA2019, dtLaneway[, .(roll_base, lanewayBuilt = YEAR_BUILT)], by = "roll_base", all.x = TRUE)
> dtBCA2019[, hasLaneway := !is.na(lanewayBuilt) & (year(conveyanceDate) >= lanewayBuilt)]
> 
> MINYEAR <- 2012
> MEANYEAR <- 2015
> WIDTHCUT <- 0.15
> DEPTHMIN <- 110
> DEPTHMAX <- 150
> 
> dtBCA2019 <- dtBCA2019[grepl("RS", zoning)]
> # Exclude Shaughnessy and West End
> dtBCA2019 <- dtBCA2019[!neighbourhoodDescription %chin% c("SHAUGNESSY", "WEST END")]
> 
> # ==========================================
> # Function to run analysis at a given geographic level
> # ==========================================
> 
> runAnalysis <- function(dt, groupVar, label) {
+   cat("\n==========================================\n")
+   cat("Running analysis at", label, "level\n")
+   cat("==========================================\n")
+   
+   # Compute median land_width within each group
+   dt[, landWidthMedian := median(land_width, na.rm = TRUE), by = groupVar]
+   
+   # Filter to observations near median width for that group
+   dtFiltered <- dt[
+     land_width >= landWidthMedian * (1 - WIDTHCUT) & 
+     land_width <= landWidthMedian * (1 + WIDTHCUT) &
+     land_depth >= DEPTHMIN & 
+     land_depth < DEPTHMAX
+   ]
+   
+   # Analysis sample: no laneways, post-MINYEAR
+   dtAnalysis <- dtFiltered[hasLaneway == FALSE & year(conveyanceDate) >= MINYEAR]
+   cat("Analysis sample size:", nrow(dtAnalysis), "\n")
+   
+   # Build formulas dynamically
+   fmlaMain <- as.formula(paste0(
+     "ppsf ~ i(", groupVar, ", MB_total_finished_area) + log(age + 1) + MB_total_finished_area + log(land_width) + log(land_depth) | ", groupVar
+   ))
+ 
+   fmlaLog <- as.formula(paste0(
+     "log(ppsf) ~ i(", groupVar, ", log(MB_total_finished_area)) + log(age + 1) + log(MB_total_finished_area) + log(land_width) + log(land_depth) | ", groupVar 
+   ))# no main effect for Wald purposes
+   
+   fmlaLogRestricted <- as.formula(paste0(
+   "log(ppsf) ~ log(MB_total_finished_area) + log(age + 1) + log(land_width) + log(land_depth) | ", groupVar
+ ))
+ 
+   # Run regressions
+   mainReg <- feols(fmlaMain, data = dtAnalysis)
+   print(r2(mainReg, typ = c("r2", "ar2")))
+   
+   logReg <- feols(fmlaLog, data = dtAnalysis)
+   print(r2(logReg, typ = c("r2", "ar2")))
+ 
+   logRegRestricted <- feols(fmlaLogRestricted, data = dtAnalysis)
+   print(r2(logRegRestricted,typ=c("r2","ar2")))
+ 
+   # Extract slopes
+   dtSlopes <- as.data.table(coeftable(mainReg), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
+   # Extract group identifier from term
+   pattern <- paste0(groupVar, "::(.*):MB_total_finished_area")
+   dtSlopes[, (groupVar) := gsub(pattern, "\\1", term)]
+   
+   # Extract elasticities
+   dtElasticities <- as.data.table(coeftable(logReg), keep.rownames = "term")[grepl("log\\(MB_total_finished_area\\)", term)]
+   patternLog <- paste0(groupVar, "::(.*):log\\(MB_total_finished_area\\)")
+   dtElasticities[, (groupVar) := gsub(patternLog, "\\1", term)]
+   
+   # Compute means
+   dtMeans <- dtFiltered[hasLaneway == FALSE & year(conveyanceDate) >= MEANYEAR, 
+                         .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = .N), 
+                         by = groupVar]
+   
+   # Merge slopes and elasticities
+   dtMeans <- merge(dtMeans, dtSlopes[, c(groupVar, "Estimate"), with = FALSE], by = groupVar, all.x = TRUE)
+   setnames(dtMeans, "Estimate", "slope")
+   dtMeans <- merge(dtMeans, dtElasticities[, c(groupVar, "Estimate"), with = FALSE], by = groupVar, all.x = TRUE)
+   setnames(dtMeans, "Estimate", "elasticity")
+   
+   # Output
+   fwrite(dtMeans, paste0("tables/bca19_mean_ppsf_slope_by_", label, ".csv"))
+   
+   # Plot
+   p <- ggplot(dtMeans[nobs > quantile(nobs, .025) & !is.na(slope)], aes(x = slope, y = meanPPSF)) + 
+     geom_point() + 
+     geom_smooth(method = "lm") + 
+     labs(title = paste("Mean BCA Price per SqFt vs Pricing Slope by", label), 
+          x = "BCA Pricing Slope ($/sqft per sqft)", 
+          y = "Mean Price per SqFt")
+   ggsave(paste0("text/bca19_mean_ppsf_vs_slope_", label, ".png"), plot = p)
+   
+   # Correlations
+   cat("\nCorrelations (", label, "):\n", sep = "")
+   print(cor(dtMeans[!is.na(slope), .(slope, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity), .(elasticity, meanPPSF)]))
+   print(cor(dtMeans[!is.na(slope) & nobs > quantile(nobs, .025), .(slope, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .05), .(elasticity, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .1), .(elasticity, meanPPSF)]))
+   print(summary(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .025), .(elasticity, meanPPSF)]))
+   print(summary(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .05), .(elasticity, meanPPSF)]))
+   print(summary(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .1), .(elasticity, meanPPSF)]))
+   
+   return(dtMeans)
+ }
> 
> # ==========================================
> # Run analyses
> # ==========================================
> 
> dtResultsTract <- runAnalysis(copy(dtBCA2019), "CTUID", "tract")

==========================================
Running analysis at tract level
==========================================
Analysis sample size: 7202 
NOTE: 12 observations removed because of NA values (RHS: 12, Fixed-effects: 12).
       r2       ar2 
0.2969622 0.2816745 
NOTE: 12 observations removed because of NA values (RHS: 12, Fixed-effects: 12).
The variable 'log(MB_total_finished_area)' has been removed because of collinearity (see $collin.var).
       r2       ar2 
0.2806088 0.2650698 
NOTE: 12 observations removed because of NA values (Fixed-effects: 12).
       r2       ar2 
0.2613159 0.2532133 
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'

Correlations (tract):
            slope meanPPSF
slope    1.000000 0.332441
meanPPSF 0.332441 1.000000
           elasticity  meanPPSF
elasticity  1.0000000 0.3812883
meanPPSF    0.3812883 1.0000000
             slope  meanPPSF
slope    1.0000000 0.4720291
meanPPSF 0.4720291 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.5422212
meanPPSF    0.5422212 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.5109796
meanPPSF    0.5109796 1.0000000
   elasticity         meanPPSF    
 Min.   :-0.8065   Min.   :586.1  
 1st Qu.:-0.4579   1st Qu.:648.6  
 Median :-0.3284   Median :688.3  
 Mean   :-0.3002   Mean   :712.7  
 3rd Qu.:-0.1020   3rd Qu.:786.8  
 Max.   : 0.3279   Max.   :870.8  
   elasticity         meanPPSF    
 Min.   :-0.8065   Min.   :586.1  
 1st Qu.:-0.4579   1st Qu.:648.6  
 Median :-0.3284   Median :688.3  
 Mean   :-0.3002   Mean   :712.7  
 3rd Qu.:-0.1020   3rd Qu.:786.8  
 Max.   : 0.3279   Max.   :870.8  
   elasticity         meanPPSF    
 Min.   :-0.7916   Min.   :586.1  
 1st Qu.:-0.4628   1st Qu.:651.7  
 Median :-0.3350   Median :686.5  
 Mean   :-0.3026   Mean   :712.7  
 3rd Qu.:-0.1062   3rd Qu.:786.2  
 Max.   : 0.3279   Max.   :870.8  
> dtResultsNbhd <- runAnalysis(copy(dtBCA2019), "neighbourhoodDescription", "neighbourhood")

==========================================
Running analysis at neighbourhood level
==========================================
Analysis sample size: 7037 
The variable 'MB_total_finished_area' has been removed because of collinearity (see $collin.var).
       r2       ar2 
0.2553175 0.2502023 
The variable 'log(MB_total_finished_area)' has been removed because of collinearity (see $collin.var).
       r2       ar2 
0.2388709 0.2336427 
       r2       ar2 
0.2305034 0.2276494 
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'

Correlations (neighbourhood):
             slope  meanPPSF
slope    1.0000000 0.5722268
meanPPSF 0.5722268 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.6458095
meanPPSF    0.6458095 1.0000000
             slope  meanPPSF
slope    1.0000000 0.6734513
meanPPSF 0.6734513 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.7102436
meanPPSF    0.7102436 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.7924633
meanPPSF    0.7924633 1.0000000
   elasticity          meanPPSF    
 Min.   :-0.66057   Min.   :618.8  
 1st Qu.:-0.38411   1st Qu.:656.9  
 Median :-0.26497   Median :747.5  
 Mean   :-0.26360   Mean   :738.3  
 3rd Qu.:-0.12913   3rd Qu.:805.9  
 Max.   : 0.09305   Max.   :846.4  
   elasticity          meanPPSF    
 Min.   :-0.66057   Min.   :618.8  
 1st Qu.:-0.39205   1st Qu.:654.5  
 Median :-0.27582   Median :722.4  
 Mean   :-0.26994   Mean   :734.5  
 3rd Qu.:-0.12868   3rd Qu.:799.5  
 Max.   : 0.09305   Max.   :846.4  
   elasticity          meanPPSF    
 Min.   :-0.66057   Min.   :618.8  
 1st Qu.:-0.40015   1st Qu.:654.2  
 Median :-0.25412   Median :719.9  
 Mean   :-0.26685   Mean   :725.2  
 3rd Qu.:-0.12567   3rd Qu.:792.0  
 Max.   : 0.09305   Max.   :832.9  
> 
> q("no")
> proc.time()
   user  system elapsed 
  7.236   2.135   3.107 
