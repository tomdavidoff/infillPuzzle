
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSales.R
> # R to use 2019 sales to get census-tract level coefficients on duplex vs single family and also square footage coefficients on ppsf
> # Tom Davidoff
> # 01/14/26
> 
> # strategy:
> # Get 2026 roll centroids, merge on roll/1000 (for subdivisions), confirm coverage for 2019 sales data (through 2018)
> # merge with census tract centroids
> # Regress coefficients, etc.
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(sf)
Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(ggplot2)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> BCA26 <- "/Volumes/T7Office/bigFiles/bca_folios.gpkg"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> fRollLatLon <- "~/OneDrive - UBC/dataProcessed/bca26RollCensusTract.rds"
> fLaneway <-  "~/OneDrive - UBC/dataRaw/20231231_UBC_CustomLanewayReport.xlsx"
> 
> # drop duplex
> if (!file.exists(fRollLatLon)) {
+   cat("Extracting lot centroids from BCA 2026 data...\n")
+   desc26 <- st_read(BCA26,
+       layer="WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV",
+       query = "SELECT ROLL_NUMBER, geom FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV WHERE JURISDICTION_CODE=='200' AND ACTUAL_USE_DESCRIPTION IN ('Residential Dwelling with Suite','Single Family Dwelling')  > 0", 
+       quiet = TRUE
+   )
+   print(head(desc26))
+   stDesc <- st_crs(desc26)
+   roll_pt <- st_point_on_surface(desc26)
+   # convert geom to centroid
+   # --- 2021 Census Tracts (cartographic) via download
+   ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
+   sCT <- st_read(ct_file, quiet = TRUE)
+   sCT <- st_make_valid(sCT)
+   sCT <- st_transform(sCT, stDesc)
+ 
+   roll_ct <- st_join(roll_pt, sCT[, c("CTUID", "DGUID", "CTNAME", "PRUID")], join = st_within, left = TRUE)
+   print(head(roll_ct))
+   saveRDS(roll_ct, fRollLatLon)
+ }
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19Sales.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.land_width, i.land_depth, i.land_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, a.postalCode
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+         AND (d.actualUseDescription IN ('Residential Dwelling with Suite','Single Family Dwelling') OR INSTR(d.actualUseDescription, 'uplex') > 0)
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019, fSales)
+ } 
> dtBCA2019 <- readRDS(fSales)
> print(head(dtBCA2019))
      folioID conveyancePrice conveyanceDate MB_effective_year
       <char>          <char>         <char>            <char>
1: A000000009         9450000     2014-06-16              2019
2: A00000000A         8800000     2013-02-08              1997
3: A00000000A         1700000     1991-07-09              1997
4: A00000000B         3850000     2006-12-04              1945
5: A00000000B          190000     1977-04-15              1945
6: A00000000C         2308000     1991-09-03              2011
   MB_total_finished_area land_width land_depth land_area     roll_number
                   <char>     <char>     <char>    <char>          <char>
1:                  11895                                 001019632060000
2:                   7760        195      251.9           001019632290000
3:                   7760        195      251.9           001019632290000
4:                   3215        150        250           001019632450000
5:                   3215        150        250           001019632450000
6:                   8673        150        250           001019632650000
   zoning   actualUseDescription neighbourhoodDescription postalCode
   <char>                 <char>                   <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6T 1A9
2:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
3:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
4:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
5:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
6:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
> 
> # merge back with census tract on roll number/1000
> dtRollLatLon <- as.data.table(readRDS(fRollLatLon))
> dtBCA2019[, roll_base := floor(as.numeric(roll_number) / 1000)]
> dtRollLatLon[, roll_base := floor(as.numeric(ROLL_NUMBER) / 1000)]
> dtBCA2019 <- merge(dtBCA2019, dtRollLatLon[, .(roll_base, CTUID, DGUID, CTNAME)], by = "roll_base", all.x = TRUE)
> print(table(is.na(dtBCA2019[, CTUID])))

 FALSE   TRUE 
165645   1204 
> print(table(dtBCA2019[is.na(CTUID), actualUseDescription]))

Duplex, Non-Strata Side by Side or Front / Back 
                                             43 
                   Duplex, Non-Strata Up / Down 
                                              2 
                    Duplex, Strata Front / Back 
                                             24 
                    Duplex, Strata Side by Side 
                                              7 
                Residential Dwelling with Suite 
                                            530 
                         Single Family Dwelling 
                                            598 
> print(table(dtBCA2019[!is.na(CTUID), actualUseDescription]))

2 Acres Or More (Single Family Dwelling, Duplex) 
                                              86 
 Duplex, Non-Strata Side by Side or Front / Back 
                                            2098 
                    Duplex, Non-Strata Up / Down 
                                             254 
                     Duplex, Strata Front / Back 
                                            8357 
                     Duplex, Strata Side by Side 
                                            4964 
                        Duplex, Strata Up / Down 
                                             478 
                 Residential Dwelling with Suite 
                                           79320 
                          Single Family Dwelling 
                                           70088 
> 
> 
> # Numeric conversion and cleaning
> print(dtBCA2019[,.(land_area,land_width,land_depth)])
        land_area land_width land_depth
           <char>     <char>     <char>
     1:                                
     2:                  195      251.9
     3:                  195      251.9
     4:                  150        250
     5:                  150        250
    ---                                
166845:                                
166846:                                
166847:                                
166848:                                
166849:                                
> cols <- c("conveyancePrice", "MB_effective_year", "MB_total_finished_area","land_area","land_width","land_depth")
> dtBCA2019[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
> dtBCA2019 <- dtBCA2019[!is.na(MB_total_finished_area) & conveyancePrice > 100000]
> dtBCA2019[,land_area_approximate:=land_width*land_depth]
> # Only include reasonable lot sizes
> print(table(dtBCA2019[,.(is.na(land_width),is.na(land_area))]))
       V2
V1       FALSE   TRUE
  FALSE    274 141087
  TRUE      77   7775
> print(quantile(dtBCA2019[,land_width],na.rm=TRUE))
   0%   25%   50%   75%  100% 
 13.0  33.0  33.0  49.5 564.6 
> print(quantile(dtBCA2019[,land_depth],na.rm=TRUE))
   0%   25%   50%   75%  100% 
 21.4 112.0 122.0 125.0 697.0 
> dtBCA2019 <- dtBCA2019[!is.na(land_depth)]
> # See if 33 the norm everywhere, versus 50 in some. It's not
> for (n in unique(dtBCA2019[!is.na(land_width),neighbourhoodDescription])) {
+   print(n)
+   print(quantile(dtBCA2019[neighbourhoodDescription==n & !is.na(land_width),land_width],na.rm=TRUE))
+ }
[1] "POINT GREY"
   0%   25%   50%   75%  100% 
 16.5  33.0  33.0  50.0 211.9 
[1] "KITSILANO"
   0%   25%   50%   75%  100% 
 16.5  33.0  33.0  49.5 146.1 
[1] "DUNBAR"
   0%   25%   50%   75%  100% 
 16.5  33.0  40.0  50.0 132.0 
[1] "ARBUTUS/MACKENZIE HEIGHTS"
  0%  25%  50%  75% 100% 
  24   35   50   52  126 
[1] "KERRISDALE"
   0%   25%   50%   75%  100% 
 16.5  33.0  50.0  59.4 144.8 
[1] "SOUTHLANDS"
   0%   25%   50%   75%  100% 
 26.0  50.0  66.0  75.0 564.6 
[1] "FAIRVIEW"
  0%  25%  50%  75% 100% 
  25   50   50   50   66 
[1] "SHAUGHNESSY"
   0%   25%   50%   75%  100% 
 25.0  66.0  75.0  97.1 257.4 
[1] "CAMBIE"
  0%  25%  50%  75% 100% 
16.5 33.0 33.0 49.5 80.3 
[1] "SOUTH GRANVILLE"
   0%   25%   50%   75%  100% 
 25.0  55.0  62.5  66.0 129.4 
[1] "OAKRIDGE"
   0%   25%   50%   75%  100% 
 28.0  46.5  54.0  58.0 132.1 
[1] "MARPOLE"
   0%   25%   50%   75%  100% 
 16.5  33.0  33.0  43.5 107.0 
[1] "MOUNT PLEASANT"
  0%  25%  50%  75% 100% 
16.5 30.0 33.0 35.1 69.6 
[1] "GRANDVIEW"
  0%  25%  50%  75% 100% 
19.3 33.0 33.0 33.0 82.0 
[1] "CEDAR COTTAGE"
  0%  25%  50%  75% 100% 
20.0 32.0 33.0 36.0 96.2 
[1] "MAIN/FRASER"
  0%  25%  50%  75% 100% 
13.0 33.0 33.0 33.3 73.0 
[1] "SOUTH VANCOUVER"
  0%  25%  50%  75% 100% 
17.5 33.0 33.0 41.5 83.8 
[1] "MARINE DRIVE"
   0%   25%   50%   75%  100% 
 20.3  32.0  33.0  34.5 100.0 
[1] "KNIGHT"
  0%  25%  50%  75% 100% 
21.3 33.0 33.0 35.7 75.8 
[1] "HASTINGS EAST"
  0%  25%  50%  75% 100% 
24.0 33.0 33.0 33.0 74.6 
[1] "RENFREW"
  0%  25%  50%  75% 100% 
16.5 33.0 33.0 36.0 70.0 
[1] "RENFREW HEIGHTS"
  0%  25%  50%  75% 100% 
25.5 33.0 33.0 41.0 70.0 
[1] "COLLINGWOOD"
   0%   25%   50%   75%  100% 
 17.0  33.0  33.0  40.0 143.5 
[1] "KILLARNEY"
  0%  25%  50%  75% 100% 
21.1 33.0 37.0 43.9 80.6 
[1] "FRASERVIEW"
  0%  25%  50%  75% 100% 
  30   43   46   50  130 
[1] "WEST END"
  0%  25%  50%  75% 100% 
27.5 32.7 33.0 33.0 65.5 
> dtBCA2019[,landWidthMedian:=median(land_width,na.rm=TRUE),by=neighbourhoodDescription]
> WIDTHCUT <- .15
> dtBCA2019 <- dtBCA2019[land_width>=landWidthMedian*(1-WIDTHCUT) & land_depth>=110 & land_width<=landWidthMedian*(1+WIDTHCUT) & land_depth<150]
> 
> # Metrics & Outliers
> CUT <- 0.05
> 
> print(names(dtBCA2019))
 [1] "roll_base"                "folioID"                 
 [3] "conveyancePrice"          "conveyanceDate"          
 [5] "MB_effective_year"        "MB_total_finished_area"  
 [7] "land_width"               "land_depth"              
 [9] "land_area"                "roll_number"             
[11] "zoning"                   "actualUseDescription"    
[13] "neighbourhoodDescription" "postalCode"              
[15] "CTUID"                    "DGUID"                   
[17] "CTNAME"                   "land_area_approximate"   
[19] "landWidthMedian"         
> print(head(dtBCA2019))
Key: <roll_base>
    roll_base    folioID conveyancePrice conveyanceDate MB_effective_year
        <num>     <char>           <num>         <char>             <num>
1: 1023636270 D0000GM3GA         5060747     2013-09-16              2013
2: 1023636370 D0000GM3H5         5128971     2014-05-23              2013
3: 1023637870 A000000023          420000     1987-06-02              2011
4: 1023637870 A000000023          420000     1987-06-02              2011
5: 1023637870 A000000023          420000     1987-06-02              2011
6: 1026683240 D0000150K1         2500000     2019-10-21              2005
   MB_total_finished_area land_width land_depth land_area     roll_number
                    <num>      <num>      <num>     <num>          <char>
1:                   3364       33.0      147.2        NA 001023636270000
2:                   3137       37.0      119.5        NA 001023636370000
3:                   3766       36.6      123.0        NA 001023637870000
4:                   3766       36.6      123.0        NA 001023637870000
5:                   3766       36.6      123.0        NA 001023637870000
6:                   1996       30.0      112.0        NA 001026683240000
   zoning            actualUseDescription neighbourhoodDescription postalCode
   <char>                          <char>                   <char>     <char>
1:    RS1          Single Family Dwelling               POINT GREY    V6R 1E5
2:    RS1          Single Family Dwelling               POINT GREY    V6R 1E5
3:    RS1 Residential Dwelling with Suite               POINT GREY    V6R 1E3
4:    RS1 Residential Dwelling with Suite               POINT GREY    V6R 1E3
5:    RS1 Residential Dwelling with Suite               POINT GREY    V6R 1E3
6:    RS1          Single Family Dwelling               POINT GREY    V6R 4A1
        CTUID               DGUID  CTNAME land_area_approximate landWidthMedian
       <char>              <char>  <char>                 <num>           <num>
1: 9330044.00 2021S05079330044.00 0044.00                4857.6              33
2: 9330044.00 2021S05079330044.00 0044.00                4421.5              33
3: 9330044.00 2021S05079330044.00 0044.00                4501.8              33
4: 9330044.00 2021S05079330044.00 0044.00                4501.8              33
5: 9330044.00 2021S05079330044.00 0044.00                4501.8              33
6: 9330043.01 2021S05079330043.01 0043.01                3360.0              33
> dtBCA2019[, `:=`(
+     age = year(conveyanceDate) - MB_effective_year, 
+     ppsf = conveyancePrice / MB_total_finished_area 
+ )]
> 
> dtBCA2019 <- dtBCA2019[
+     age >= 0 &
+     MB_total_finished_area %between% quantile(MB_total_finished_area, c(CUT, 1-CUT)) &
+     ppsf %between% quantile(ppsf, c(CUT, 1-CUT))
+ ]
> 
> cat("BCA 2019 transactions loaded:", nrow(dtBCA2019), "\n")
BCA 2019 transactions loaded: 43827 
> 
> # ==========================================
> # Exclude from the sales homes with laneways
> # ==========================================
> 
> dtLaneway <- as.data.table(read_excel(fLaneway, sheet = "DATA"))
> setnames(dtLaneway, "ROLL_NUM", "Roll_Number_char")
> dtLaneway[, `:=`(
+   Roll_Number = as.numeric(Roll_Number_char),
+   roll_base = floor(as.numeric(Roll_Number_char) / 1000)
+ )]
> print(head(dtLaneway))
   ROLLYEAR   AREA    JUR Roll_Number_char ACTUAL_USE_CODE
     <char> <char> <char>           <char>          <char>
1:     2024     09    200  001634020620000             000
2:     2024     09    200  001636019550000             000
3:     2024     09    200  001636022740000             032
4:     2024     09    200  001636036970000             000
5:     2024     09    200  001637022770000             000
6:     2024     09    200  001638037950000             000
                  MANUAL_CLASS_DESC YEAR_BUILT EFFECTIVE_YEAR
                             <char>      <num>          <num>
1: 1155 - 1 STY house - Semi-Custom       2021           2021
2: 1155 - 1 STY house - Semi-Custom       2021           2021
3: 1155 - 1 STY house - Semi-Custom       2022           2022
4: 1155 - 1 STY house - Semi-Custom       2021           2021
5: 1155 - 1 STY house - Semi-Custom       2022           2022
6: 1156 - 1.5 STY house-Semi-Custom       2021           2021
   TOTAL_FINISHED_AREA BASEMENT_AREA SLAB_AREA CRAWL_SPACE_AREA  Roll_Number
                 <num>         <num>     <num>            <num>        <num>
1:                 465             0        56              409 1.634021e+12
2:                 955             0         0              955 1.636020e+12
3:                 635           525         0              130 1.636023e+12
4:                 434             0       434                0 1.636037e+12
5:                 855             0       855                0 1.637023e+12
6:                 565             0       297                0 1.638038e+12
    roll_base
        <num>
1: 1634020620
2: 1636019550
3: 1636022740
4: 1636036970
5: 1637022770
6: 1638037950
> 
> dtBCA2019 <- merge(dtBCA2019, dtLaneway[, .(roll_base, lanewayBuilt = YEAR_BUILT)], by = "roll_base", all.x = TRUE)
> dtBCA2019[, hasLaneway := !is.na(lanewayBuilt) & (year(conveyanceDate) >= lanewayBuilt)]
> print(names(dtBCA2019))
 [1] "roll_base"                "folioID"                 
 [3] "conveyancePrice"          "conveyanceDate"          
 [5] "MB_effective_year"        "MB_total_finished_area"  
 [7] "land_width"               "land_depth"              
 [9] "land_area"                "roll_number"             
[11] "zoning"                   "actualUseDescription"    
[13] "neighbourhoodDescription" "postalCode"              
[15] "CTUID"                    "DGUID"                   
[17] "CTNAME"                   "land_area_approximate"   
[19] "landWidthMedian"          "age"                     
[21] "ppsf"                     "lanewayBuilt"            
[23] "hasLaneway"              
> print(head(dtBCA2019))
Key: <roll_base>
    roll_base    folioID conveyancePrice conveyanceDate MB_effective_year
        <num>     <char>           <num>         <char>             <num>
1: 1026683240 D0000150K1         1620000     2009-10-29              2005
2: 1032670680 A00000004R          581000     1999-06-18              1993
3: 1032670800 A00000004S         1904761     2010-06-28              2007
4: 1032686050 D00004J5ME         1500000     2009-10-28              2009
5: 1032686170 D00004J5X7         1504761     2009-09-23              2009
6: 1032686230 D00004J5XC         1485714     2009-08-20              2008
   MB_total_finished_area land_width land_depth land_area     roll_number
                    <num>      <num>      <num>     <num>          <char>
1:                   1996         30      112.0        NA 001026683240000
2:                   2172         33      112.0        NA 001032670680000
3:                   2213         33      112.0        NA 001032670800000
4:                   2265         33      112.6        NA 001032686050000
5:                   2307         33      112.6        NA 001032686170000
6:                   2682         33      112.6        NA 001032686230000
   zoning   actualUseDescription neighbourhoodDescription postalCode      CTUID
   <char>                 <char>                   <char>     <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6R 4A1 9330043.01
2:    RS1 Single Family Dwelling               POINT GREY    V6R 3W1 9330043.02
3:    RS1 Single Family Dwelling               POINT GREY    V6R 3W1 9330043.02
4:    RS1 Single Family Dwelling               POINT GREY    V6R 3W4 9330043.02
5:    RS1 Single Family Dwelling               POINT GREY    V6R 3W4 9330043.02
6:    RS1 Single Family Dwelling               POINT GREY    V6R 3W4 9330043.02
                 DGUID  CTNAME land_area_approximate landWidthMedian   age
                <char>  <char>                 <num>           <num> <num>
1: 2021S05079330043.01 0043.01                3360.0              33     4
2: 2021S05079330043.02 0043.02                3696.0              33     6
3: 2021S05079330043.02 0043.02                3696.0              33     3
4: 2021S05079330043.02 0043.02                3715.8              33     0
5: 2021S05079330043.02 0043.02                3715.8              33     0
6: 2021S05079330043.02 0043.02                3715.8              33     1
       ppsf lanewayBuilt hasLaneway
      <num>        <num>     <lgcl>
1: 811.6232           NA      FALSE
2: 267.4954           NA      FALSE
3: 860.7144           NA      FALSE
4: 662.2517           NA      FALSE
5: 652.2588           NA      FALSE
6: 553.9575           NA      FALSE
> 
> MINYEAR <- 2012
> 
> dtBCA2019 <- dtBCA2019[grepl("RS", zoning)]
> # Exclude Shaughnessy and West End
> dtBCA2019 <- dtBCA2019[!neighbourhoodDescription %chin% c("SHAUGNESSY", "WEST END")]
> 
> print(dtBCA2019[year(conveyanceDate) > MINYEAR, quantile(ppsf), by = year(conveyanceDate)])
     year       V1
    <int>    <num>
 1:  2013 205.8917
 2:  2013 376.3058
 3:  2013 458.2951
 4:  2013 607.2106
 5:  2013 885.9913
 6:  2014 220.0000
 7:  2014 432.2430
 8:  2014 509.1884
 9:  2014 640.8798
10:  2014 886.9878
11:  2019 348.0445
12:  2019 614.8193
13:  2019 715.4671
14:  2019 781.4231
15:  2019 886.7758
16:  2017 428.9216
17:  2017 643.9746
18:  2017 714.2857
19:  2017 785.3403
20:  2017 886.4266
21:  2015 184.2471
22:  2015 519.4770
23:  2015 597.5733
24:  2015 693.2409
25:  2015 886.7787
26:  2018 414.3646
27:  2018 635.0482
28:  2018 721.4353
29:  2018 791.3669
30:  2018 884.7321
31:  2016 246.5596
32:  2016 631.4581
33:  2016 700.9684
34:  2016 771.9030
35:  2016 887.3162
     year       V1
> 
> # Analysis sample: no laneways, post-MINYEAR
> dtAnalysis <- dtBCA2019[hasLaneway == FALSE & year(conveyanceDate) >= MINYEAR]
> 
> print(dtBCA2019[, mean(ppsf), by = .(neighbourhoodDescription)])
     neighbourhoodDescription       V1
                       <char>    <num>
 1:                POINT GREY 346.1793
 2:                 KITSILANO 329.2734
 3:                    DUNBAR 301.3038
 4: ARBUTUS/MACKENZIE HEIGHTS 368.9999
 5:                KERRISDALE 344.9746
 6:                SOUTHLANDS 327.7466
 7:               SHAUGHNESSY 259.3387
 8:                    CAMBIE 330.3268
 9:           SOUTH GRANVILLE 290.0718
10:                  OAKRIDGE 304.8670
11:                   MARPOLE 331.2488
12:                 GRANDVIEW 255.0243
13:             CEDAR COTTAGE 265.3372
14:               MAIN/FRASER 271.7079
15:           SOUTH VANCOUVER 269.3265
16:              MARINE DRIVE 282.8837
17:                    KNIGHT 264.8040
18:             HASTINGS EAST 274.3639
19:                   RENFREW 264.5794
20:           RENFREW HEIGHTS 262.2215
21:               COLLINGWOOD 246.4252
22:                 KILLARNEY 260.3522
23:                FRASERVIEW 259.0721
     neighbourhoodDescription       V1
> print(table(dtBCA2019[, .(zoning)]))
zoning
  RS1  RS1A  RS1B  RS1S   RS2   RS3  RS3A   RS5  RS5S   RS6   RS7 
29025   108    64    37    55    53    39  3538     1   398  1365 
> 
> # ==========================================
> # Census tract slopes and means
> # ==========================================
> 
> mainRegTract <- feols(ppsf ~ i(CTUID, MB_total_finished_area) + log(age + 1) + MB_total_finished_area + log(land_width) + log(land_depth)| CTUID , data = dtAnalysis)
NOTE: 24 observations removed because of NA values (RHS: 24, Fixed-effects: 24).
The variable 'CTUID::9330041.02:MB_total_finished_area' has been removed because of collinearity (see $collin.var).
> print(r2(mainRegTract,typ=c("r2","ar2")))
       r2       ar2 
0.2137080 0.1944591 
> logRegTract <- feols(log(ppsf) ~ i(CTUID, log(MB_total_finished_area)) + log(age + 1) + log(MB_total_finished_area) + log(land_width) + log(land_depth)| CTUID , data = dtAnalysis)
NOTE: 24 observations removed because of NA values (RHS: 24, Fixed-effects: 24).
The variables 'CTUID::9330041.02:log(MB_total_finished_area)' and 'log(MB_total_finished_area)' have been removed because of collinearity (see $collin.var).
> print(r2(logRegTract,typ=c("r2","ar2")))
       r2       ar2 
0.2051243 0.1857964 
> 
> dtSlopesTract <- as.data.table(coeftable(mainRegTract), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
> dtSlopesTract[, CTUID := gsub("CTUID::(.*):MB_total_finished_area", "\\1", term)]
> print(head(dtSlopesTract))
                                       term   Estimate  Std. Error    t value
                                     <char>      <num>       <num>      <num>
1: CTUID::9330001.01:MB_total_finished_area -0.3020424 0.003447353 -87.615741
2: CTUID::9330001.02:MB_total_finished_area -0.1029907 0.013576112  -7.586172
3: CTUID::9330002.01:MB_total_finished_area -0.1249011 0.008197236 -15.236976
4: CTUID::9330002.03:MB_total_finished_area -0.1154320 0.009970801 -11.577000
5: CTUID::9330002.04:MB_total_finished_area -0.1259154 0.004848220 -25.971468
6: CTUID::9330003.01:MB_total_finished_area -0.1230526 0.005799186 -21.218938
       Pr(>|t|)      CTUID
          <num>     <char>
1: 1.675797e-76 9330001.01
2: 7.825692e-11 9330001.02
3: 1.604462e-24 9330002.01
4: 2.814297e-18 9330002.03
5: 6.367162e-39 9330002.04
6: 3.442087e-33 9330003.01
> 
> MEANYEAR <- 2015
> dtMeansTract <- dtBCA2019[hasLaneway == FALSE & year(conveyanceDate) >= MEANYEAR, .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = .N), 
+                           by = CTUID]
> dtMeansTract <- merge(dtMeansTract, dtSlopesTract[, .(CTUID, slope = Estimate)], by = "CTUID", all.x = TRUE)
> print(head(dtMeansTract))
Key: <CTUID>
        CTUID meanPPSF  nobs      slope
       <char>    <num> <int>      <num>
1:       <NA> 642.0458    16         NA
2: 9330001.01 665.8382     3 -0.3020424
3: 9330001.02 555.2172    10 -0.1029907
4: 9330002.01 646.9877    58 -0.1249011
5: 9330002.03 616.5682    63 -0.1154320
6: 9330002.04 579.6129    37 -0.1259154
> fwrite(dtMeansTract, "tables/bca19_mean_ppsf_slope_by_tract.csv")
> 
> dtElasticitiesTract <- as.data.table(coeftable(logRegTract), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
> dtElasticitiesTract[, CTUID := gsub("CTUID::(.*):log\\(MB_total_finished_area\\)", "\\1", term)]
> print(head(dtElasticitiesTract))
                                            term   Estimate Std. Error
                                          <char>      <num>      <num>
1: CTUID::9330001.01:log(MB_total_finished_area) -1.1040349 0.01565295
2: CTUID::9330001.02:log(MB_total_finished_area) -0.4427991 0.05820931
3: CTUID::9330002.01:log(MB_total_finished_area) -0.4852546 0.02447386
4: CTUID::9330002.03:log(MB_total_finished_area) -0.5989105 0.02476989
5: CTUID::9330002.04:log(MB_total_finished_area) -0.4873100 0.01636915
6: CTUID::9330003.01:log(MB_total_finished_area) -0.3458140 0.02297029
      t value     Pr(>|t|)      CTUID
        <num>        <num>     <char>
1: -70.532048 1.296241e-69 9330001.01
2:  -7.607016 7.149142e-11 9330001.02
3: -19.827461 2.481289e-31 9330002.01
4: -24.178973 7.295107e-37 9330002.03
5: -29.770023 6.252842e-43 9330002.04
6: -15.054840 3.153317e-24 9330003.01
> print(head(dtMeansTract))
Key: <CTUID>
        CTUID meanPPSF  nobs      slope
       <char>    <num> <int>      <num>
1:       <NA> 642.0458    16         NA
2: 9330001.01 665.8382     3 -0.3020424
3: 9330001.02 555.2172    10 -0.1029907
4: 9330002.01 646.9877    58 -0.1249011
5: 9330002.03 616.5682    63 -0.1154320
6: 9330002.04 579.6129    37 -0.1259154
> dtElasticitiesTract <- merge(dtMeansTract, dtElasticitiesTract[, .(CTUID, elasticity = Estimate)], by = "CTUID", all.x = TRUE)
> 
> ggplot(dtMeansTract[nobs > quantile(nobs, .025) & !is.na(slope)], aes(x = slope, y = meanPPSF)) + 
+   geom_point() + 
+   geom_smooth(method = "lm") + 
+   labs(title = "Mean BCA Price per SqFt vs Pricing Slope by Census Tract", 
+        x = "BCA Pricing Slope ($/sqft per sqft)", 
+        y = "Mean Price per SqFt")
`geom_smooth()` using formula = 'y ~ x'
> ggsave("text/bca19_mean_ppsf_vs_slope_tract.png")
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'
> 
> cat("\nCorrelations (tract):\n")

Correlations (tract):
> print(cor(dtMeansTract[!is.na(slope), .(slope, meanPPSF)]))
             slope  meanPPSF
slope    1.0000000 0.1517602
meanPPSF 0.1517602 1.0000000
> print(cor(dtElasticitiesTract[!is.na(elasticity), .(elasticity, meanPPSF)]))
           elasticity  meanPPSF
elasticity  1.0000000 0.1944449
meanPPSF    0.1944449 1.0000000
> print(cor(dtMeansTract[!is.na(slope) & nobs > quantile(nobs, .025), .(slope, meanPPSF)]))
             slope  meanPPSF
slope    1.0000000 0.1507857
meanPPSF 0.1507857 1.0000000
> print(cor(dtMeansTract[!is.na(slope) & nobs > quantile(nobs, .05), .(slope, meanPPSF)]))
             slope  meanPPSF
slope    1.0000000 0.2454569
meanPPSF 0.2454569 1.0000000
> print(cor(dtElasticitiesTract[!is.na(elasticity) & nobs > quantile(nobs, .05), .(elasticity, meanPPSF)]))
           elasticity meanPPSF
elasticity   1.000000 0.324148
meanPPSF     0.324148 1.000000
> 
> # ==========================================
> # Neighbourhood slopes and means
> # Note much higher correlation slope,mean indicates better measure
> # ==========================================
> 
> mainRegNbhd <- feols(ppsf ~ i(neighbourhoodDescription, MB_total_finished_area) + log(age + 1) + MB_total_finished_area + log(land_width) + log(land_depth) | neighbourhoodDescription  , data = dtAnalysis)
> print(r2(mainRegNbhd,typ=c("r2","ar2")))
       r2       ar2 
0.1715773 0.1651706 
> 
> dtSlopesNbhd <- as.data.table(coeftable(mainRegNbhd), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
> dtSlopesNbhd[, neighbourhoodDescription := gsub("neighbourhoodDescription::(.*):MB_total_finished_area", "\\1", term)]
> print(head(dtSlopesNbhd))
                                                                         term
                                                                       <char>
1: neighbourhoodDescription::ARBUTUS/MACKENZIE HEIGHTS:MB_total_finished_area
2:                    neighbourhoodDescription::CAMBIE:MB_total_finished_area
3:             neighbourhoodDescription::CEDAR COTTAGE:MB_total_finished_area
4:               neighbourhoodDescription::COLLINGWOOD:MB_total_finished_area
5:                    neighbourhoodDescription::DUNBAR:MB_total_finished_area
6:                neighbourhoodDescription::FRASERVIEW:MB_total_finished_area
     Estimate Std. Error   t value     Pr(>|t|)  neighbourhoodDescription
        <num>      <num>     <num>        <num>                    <char>
1: -0.1160181 0.05159855 -2.248476 3.489464e-02 ARBUTUS/MACKENZIE HEIGHTS
2: -0.1618681 0.06271873 -2.580858 1.705258e-02                    CAMBIE
3: -0.1030921 0.05171154 -1.993600 5.873928e-02             CEDAR COTTAGE
4: -0.2268964 0.04730276 -4.796684 8.629623e-05               COLLINGWOOD
5: -0.1099543 0.08133855 -1.351810 1.901720e-01                    DUNBAR
6: -0.1970535 0.06338449 -3.108860 5.117973e-03                FRASERVIEW
> 
> logRegNbhd <- feols(log(ppsf) ~ i(neighbourhoodDescription, log(MB_total_finished_area)) + log(age + 1) + log(MB_total_finished_area) + log(land_width) + log(land_depth) | neighbourhoodDescription , data = dtAnalysis)
The variable 'log(MB_total_finished_area)' has been removed because of collinearity (see $collin.var).
> print(r2(logRegNbhd,typ=c("r2","ar2")))
       r2       ar2 
0.1790621 0.1728439 
> dtElasticitiesNbhd <- as.data.table(coeftable(logRegNbhd), keep.rownames = "term")[grepl("log\\(MB_total_finished_area\\)", term)]
> dtElasticitiesNbhd[, neighbourhoodDescription := gsub("neighbourhoodDescription::(.*):log\\(MB_total_finished_area\\)", "\\1", term)]
> print(head(dtElasticitiesNbhd))
                                                                              term
                                                                            <char>
1: neighbourhoodDescription::ARBUTUS/MACKENZIE HEIGHTS:log(MB_total_finished_area)
2:                    neighbourhoodDescription::CAMBIE:log(MB_total_finished_area)
3:             neighbourhoodDescription::CEDAR COTTAGE:log(MB_total_finished_area)
4:               neighbourhoodDescription::COLLINGWOOD:log(MB_total_finished_area)
5:                    neighbourhoodDescription::DUNBAR:log(MB_total_finished_area)
6:                neighbourhoodDescription::FRASERVIEW:log(MB_total_finished_area)
      Estimate Std. Error     t value     Pr(>|t|)  neighbourhoodDescription
         <num>      <num>       <num>        <num>                    <char>
1:  0.01570852 0.03594612   0.4370018 6.663695e-01 ARBUTUS/MACKENZIE HEIGHTS
2: -0.21090289 0.02947019  -7.1564825 3.564106e-07                    CAMBIE
3:  0.05824355 0.02154215   2.7037021 1.297038e-02             CEDAR COTTAGE
4: -0.46487068 0.02775380 -16.7498022 5.230796e-14               COLLINGWOOD
5: -0.08615699 0.05077912  -1.6967010 1.038585e-01                    DUNBAR
6: -0.53117520 0.02299649 -23.0981010 6.438129e-17                FRASERVIEW
> 
> dtMeansNbhd <- dtBCA2019[hasLaneway == FALSE & year(conveyanceDate) >= MEANYEAR, 
+                          .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = .N), 
+                          by = neighbourhoodDescription]
> dtMeansNbhd <- merge(dtMeansNbhd, dtSlopesNbhd[, .(neighbourhoodDescription, slope = Estimate)], by = "neighbourhoodDescription", all.x = TRUE)
> print(head(dtMeansNbhd))
Key: <neighbourhoodDescription>
    neighbourhoodDescription meanPPSF  nobs      slope
                      <char>    <num> <int>      <num>
1: ARBUTUS/MACKENZIE HEIGHTS 787.7437    54 -0.1160181
2:                    CAMBIE 750.9492    58 -0.1618681
3:             CEDAR COTTAGE 706.9390    75 -0.1030921
4:               COLLINGWOOD 650.0305   132 -0.2268964
5:                    DUNBAR 809.1370    13 -0.1099543
6:                FRASERVIEW 615.9021   165 -0.1970535
> fwrite(dtMeansNbhd, "tables/bca19_mean_ppsf_slope_by_neighbourhood.csv")
> 
> ggplot(dtMeansNbhd[nobs > quantile(nobs, .025) & !is.na(slope)], aes(x = slope, y = meanPPSF)) + 
+   geom_point() + 
+   geom_smooth(method = "lm") + 
+   labs(title = "Mean BCA Price per SqFt vs Pricing Slope by Neighbourhood", 
+        x = "BCA Pricing Slope ($/sqft per sqft)", 
+        y = "Mean Price per SqFt")
`geom_smooth()` using formula = 'y ~ x'
> ggsave("text/bca19_mean_ppsf_vs_slope_neighbourhood.png")
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'
> 
> # ============
> # Do neighbourhood regression but limit to newer homes, and include land area
> # ============
> 
> print(summary(dtAnalysis))
   roll_base           folioID          conveyancePrice   conveyanceDate    
 Min.   :1.033e+09   Length:6386        Min.   : 176750   Length:6386       
 1st Qu.:1.525e+10   Class :character   1st Qu.:1054850   Class :character  
 Median :1.923e+10   Mode  :character   Median :1400000   Mode  :character  
 Mean   :1.739e+10                      Mean   :1498024                     
 3rd Qu.:2.165e+10                      3rd Qu.:1800000                     
 Max.   :2.583e+10                      Max.   :3788000                     
                                                                            
 MB_effective_year MB_total_finished_area   land_width      land_depth   
 Min.   :1910      Min.   :1210           Min.   :28.30   Min.   :110.0  
 1st Qu.:1980      1st Qu.:2139           1st Qu.:33.00   1st Qu.:118.2  
 Median :1995      Median :2416           Median :33.00   Median :122.0  
 Mean   :1993      Mean   :2519           Mean   :35.69   Mean   :122.3  
 3rd Qu.:2010      3rd Qu.:2815           3rd Qu.:33.50   3rd Qu.:124.0  
 Max.   :2019      Max.   :4310           Max.   :78.40   Max.   :149.9  
                                                                         
   land_area    roll_number           zoning          actualUseDescription
 Min.   : NA    Length:6386        Length:6386        Length:6386         
 1st Qu.: NA    Class :character   Class :character   Class :character    
 Median : NA    Mode  :character   Mode  :character   Mode  :character    
 Mean   :NaN                                                              
 3rd Qu.: NA                                                              
 Max.   : NA                                                              
 NA's   :6386                                                             
 neighbourhoodDescription  postalCode           CTUID          
 Length:6386              Length:6386        Length:6386       
 Class :character         Class :character   Class :character  
 Mode  :character         Mode  :character   Mode  :character  
                                                               
                                                               
                                                               
                                                               
    DGUID              CTNAME          land_area_approximate landWidthMedian
 Length:6386        Length:6386        Min.   : 3186         Min.   :33.00  
 Class :character   Class :character   1st Qu.: 3950         1st Qu.:33.00  
 Mode  :character   Mode  :character   Median : 4026         Median :33.00  
                                       Mean   : 4372         Mean   :35.83  
                                       3rd Qu.: 4358         3rd Qu.:33.00  
                                       Max.   :11092         Max.   :75.00  
                                                                            
      age              ppsf         lanewayBuilt  hasLaneway     
 Min.   :  0.00   Min.   : 66.65   Min.   :2021   Mode :logical  
 1st Qu.:  4.00   1st Qu.:463.45   1st Qu.:2021   FALSE:6386     
 Median : 19.00   Median :597.52   Median :2022                  
 Mean   : 21.79   Mean   :592.75   Mean   :2022                  
 3rd Qu.: 35.00   3rd Qu.:724.54   3rd Qu.:2022                  
 Max.   :106.00   Max.   :887.32   Max.   :2023                  
                                   NA's   :6280                  
> dtLimit <- dtAnalysis[age<20]
> limitRegNbhd <- feols(ppsf ~ i(neighbourhoodDescription, MB_total_finished_area) + log(age + 1) + log(land_width) + log(land_depth) + MB_total_finished_area | neighbourhoodDescription , data = dtLimit)
> 
> dtSlopesNbhdLimit <- as.data.table(coeftable(limitRegNbhd), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
> dtSlopesNbhdLimit[, neighbourhoodDescription := gsub("neighbourhoodDescription::(.*):MB_total_finished_area", "\\1", term)]
> print(head(dtSlopesNbhdLimit))
                                                                         term
                                                                       <char>
1: neighbourhoodDescription::ARBUTUS/MACKENZIE HEIGHTS:MB_total_finished_area
2:                    neighbourhoodDescription::CAMBIE:MB_total_finished_area
3:             neighbourhoodDescription::CEDAR COTTAGE:MB_total_finished_area
4:               neighbourhoodDescription::COLLINGWOOD:MB_total_finished_area
5:                    neighbourhoodDescription::DUNBAR:MB_total_finished_area
6:                neighbourhoodDescription::FRASERVIEW:MB_total_finished_area
     Estimate Std. Error   t value    Pr(>|t|)  neighbourhoodDescription
        <num>      <num>     <num>       <num>                    <char>
1: 0.14125381 0.03915083 3.6079392 0.001561316 ARBUTUS/MACKENZIE HEIGHTS
2: 0.01217645 0.03475038 0.3503977 0.729372946                    CAMBIE
3: 0.14950213 0.03747034 3.9898796 0.000618206             CEDAR COTTAGE
4: 0.02285246 0.02974779 0.7682071 0.450532042               COLLINGWOOD
5: 0.07380482 0.04867960 1.5161346 0.143723333                    DUNBAR
6: 0.03517814 0.03251959 1.0817523 0.291077969                FRASERVIEW
> 
> dtMeansNbhdLimit <- dtLimit[hasLaneway == FALSE & year(conveyanceDate) >= MEANYEAR, 
+                          .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = .N), 
+                          by = neighbourhoodDescription]
> dtMeansNbhdLimit <- merge(dtMeansNbhdLimit, dtSlopesNbhdLimit[, .(neighbourhoodDescription, slope = Estimate)], by = "neighbourhoodDescription", all.x = TRUE)
> print(head(dtMeansNbhdLimit))
Key: <neighbourhoodDescription>
    neighbourhoodDescription meanPPSF  nobs      slope
                      <char>    <num> <int>      <num>
1: ARBUTUS/MACKENZIE HEIGHTS 788.2882    28 0.14125381
2:                    CAMBIE 750.9912    24 0.01217645
3:             CEDAR COTTAGE 760.0040    29 0.14950213
4:               COLLINGWOOD 664.1494    53 0.02285246
5:                    DUNBAR 832.7256     4 0.07380482
6:                FRASERVIEW 616.3102    72 0.03517814
> fwrite(dtMeansNbhdLimit, "tables/bca19_mean_ppsf_slope_by_neighbourhood_limit.csv")
> 
> 
> cat("\nLimited Correlations (neighbourhood):\n")

Limited Correlations (neighbourhood):
> print(cor(dtMeansNbhd[!is.na(slope), .(slope, meanPPSF)]))
             slope  meanPPSF
slope    1.0000000 0.5159887
meanPPSF 0.5159887 1.0000000
> print(cor(dtMeansNbhdLimit[!is.na(slope), .(slope, meanPPSF)]))
              slope   meanPPSF
slope    1.00000000 0.07862618
meanPPSF 0.07862618 1.00000000
> dtElasticitiesNbhd <- merge(dtMeansNbhd, dtElasticitiesNbhd[, .(neighbourhoodDescription, elasticity = Estimate)], by = "neighbourhoodDescription", all.x = TRUE)
> print(cor(dtElasticitiesNbhd[!is.na(elasticity), .(elasticity, meanPPSF)]))
           elasticity  meanPPSF
elasticity  1.0000000 0.5587434
meanPPSF    0.5587434 1.0000000
> 
> q("no")
> proc.time()
   user  system elapsed 
  9.923   0.624   3.921 
