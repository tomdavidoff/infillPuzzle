
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # permitsPortland.R 
> # R code to grab portland permits for single family / infill areas
> # Tom Davidoff started by Google AI
> # 12/25/25
> # Modified by Claude 12/26/25: Added ZIP/Tract toggle
> # Modified by google AI to aggregate lot/date
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(sf)
Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE
> library(ggplot2)
> library(tigris)
To enable caching of data, set `options(tigris_use_cache = TRUE)`
in your R script or .Rprofile.
Warning message:
package ‘tigris’ was built under R version 4.4.1 
> 
> # ==========================================
> # TOGGLE: "zip" or "tract"
> # ==========================================
> GEOGRAPHY <- "zip"
> # ==========================================
> 
> options(timeout = 600)
> options(tigris_use_cache = TRUE)
> 
> # --- PORTLAND PERMITS ---
> pdx_file <- "~/OneDrive - UBC/dataRaw/portlandPermit-Search-Results.csv"
> 
> if (!file.exists(pdx_file)) {
+   pdx_url <- "https://opendata.arcgis.com/api/v3/datasets/60341c09939e4407b4d135d55b0a3d6f_0/downloads/data?format=csv&spatialRefId=4326&where=1%3D1"
+   download.file(pdx_url, pdx_file, method = "libcurl")
+ }
> 
> dtPdx <- fread(pdx_file)
> setnames(dtPdx, tolower(names(dtPdx)))
> 
> # Filter for the RIP Era (2021-2025) and Major Construction
> dtPdxMajor <- dtPdx[
+   as.IDate(issued) >= "2021-01-01" &
+   work %in% c("New Construction", "Addition")
+ ]
> 
> # Portland Infill Logic:
> dtPdxMajor[, isPlex := new_units >= 2 |
+              grepl("duplex|triplex|fourplex", description, ignore.case = TRUE) |
+              #(work == "Addition" & new_units > 0) |
+              grepl("Townhouse", type, ignore.case = TRUE)]
> 
> dtPdxMajor <- dtPdxMajor[!is.na(x_web_mercator)]
> 
> sfPermit <- st_as_sf(dtPdxMajor,
+                      coords = c("x_web_mercator", "y_web_mercator"),
+                      crs = 3857)
> 
> # --- PORTLAND ZONING DISTRICTS ---
> zoning_dir <- "~/OneDrive - UBC/dataRaw/portlandZoning"
> shp_path <- list.files(zoning_dir, pattern = "\\.shp$", full.names = TRUE)
> sfZoning <- st_read(shp_path)
Reading layer `Zoning' from data source 
  `/Users/davidoff/Library/CloudStorage/OneDrive-UBC/dataRaw/portlandZoning/Zoning.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 15672 features and 22 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -13674130 ymin: 5689506 xmax: -13633520 ymax: 5724897
Projected CRS: WGS 84 / Pseudo-Mercator
> names(sfZoning) <- tolower(names(sfZoning))
> sfZoning <- st_transform(sfZoning, 3857)
> 
> # --- SPATIAL JOIN: PERMITS + ZONING ---
> sfPermitZoned <- st_join(sfPermit, sfZoning)
> 
> # ==========================================
> # GEOGRAPHY-SPECIFIC JOIN
> # ==========================================
> 
> if (GEOGRAPHY == "tract") {
+   sfTracts <- tracts(state = "OR", county = "Multnomah", year = 2021, cb = TRUE)
+   sfTracts <- st_transform(sfTracts, 3857)
+   sfFinal <- st_join(sfPermitZoned, sfTracts[, c("GEOID", "NAMELSAD")])
+   dtFinal <- as.data.table(sfFinal)
+   setnames(dtFinal, c("GEOID", "NAMELSAD"), c("geo_id", "geo_name"), skip_absent = TRUE)
+ } else {
+   sfZips <- zctas(year = 2020, cb = TRUE)
+   sfZips <- sfZips[grepl("^972", sfZips$ZCTA5CE20), ]
+   sfZips <- st_transform(sfZips, 3857)
+   sfFinal <- st_join(sfPermitZoned, sfZips[, c("ZCTA5CE20")])
+   dtFinal <- as.data.table(sfFinal)
+   setnames(dtFinal, "ZCTA5CE20", "geo_id", skip_absent = TRUE)
+   dtFinal[, geo_name := paste("ZIP", geo_id)]
+ }
> 
> # ==========================================
> # LOT-LEVEL COLLAPSE (The "Nakamura/Zen" fix)
> # ==========================================
> 
> # 1. Filter for R-Zones
> dtAnalysis <- dtFinal[grepl("^R2.5|^R5|^R7|^R10|^R20", zone)]
> 
> 
> # 2. Collapse multiple permits per property_id into a single Lot record
> # We define an 'Infill Lot' as any lot that had at least one Plex permit issued.
> dtLots <- dtAnalysis[!is.na(geo_id) & !is.na(property_id), .(
+   isPlexLot = any(isPlex, na.rm = TRUE),
+   total_sqft_lot = sum(total_sqft, na.rm = TRUE),
+   permit_count = .N
+ ), by = .(property_id, geo_id, zone, geo_name)]
> 
> # 2a. Side project: figure out if new construction projects are different sized
> dtNews <- dtAnalysis[work == "New Construction" & !is.na(geo_id) & !is.na(property_id), .(
+   isPlexLot = any(isPlex, na.rm = TRUE),
+   total_sqft_lot = sum(total_sqft, na.rm = TRUE),
+   permit_count = .N
+ ), by = .(property_id, geo_id, zone, geo_name)]
> print(dtNews[,.(mean(total_sqft_lot),median(total_sqft_lot,by=isPlexlot)),by=isPlexLot])
   isPlexLot       V1     V2
      <lgcl>    <num>  <num>
1:     FALSE 2084.927 1481.5
2:      TRUE 3553.643 3480.0
> 
> 
> # ==========================================
> # GEOGRAPHY-LEVEL PROPENSITY (Based on Lots)
> # ==========================================
> 
> dtGeo <- dtLots[, .(
+   infill_lot_count = sum(isPlexLot, na.rm = TRUE),
+   total_lots_active = .N,
+   propensity = sum(isPlexLot, na.rm = TRUE) / .N
+ ), by = .(geo_id, geo_name)]
> 
> setorder(dtGeo, -total_lots_active)
> 
> # ==========================================
> # SAVE & SUMMARY
> # ==========================================
> output_file <- sprintf("~/OneDrive - UBC/dataProcessed/portland_%s_propensity.rds", GEOGRAPHY)
> saveRDS(dtGeo, output_file)
> 
> cat("\n=== LOT-LEVEL SUMMARY BY", toupper(GEOGRAPHY), "===\n")

=== LOT-LEVEL SUMMARY BY ZIP ===
> cat("Total Active Lots (R-Zones):", nrow(dtLots), "\n")
Total Active Lots (R-Zones): 3563 
> cat("Total Infill Lots (Plexes):", sum(dtLots$isPlexLot), "\n")
Total Infill Lots (Plexes): 403 
> cat("Overall Infill Propensity (Lot-based):",
+     round(sum(dtGeo$infill_lot_count) / sum(dtGeo$total_lots_active), 4), "\n")
Overall Infill Propensity (Lot-based): 0.1131 
> 
> print(head(dtGeo, 15))
    geo_id  geo_name infill_lot_count total_lots_active propensity
    <char>    <char>            <int>             <int>      <num>
 1:  97206 ZIP 97206               67               408 0.16421569
 2:  97219 ZIP 97219               22               367 0.05994550
 3:  97202 ZIP 97202               38               322 0.11801242
 4:  97211 ZIP 97211               45               261 0.17241379
 5:  97203 ZIP 97203               49               241 0.20331950
 6:  97213 ZIP 97213               21               204 0.10294118
 7:  97212 ZIP 97212               10               198 0.05050505
 8:  97217 ZIP 97217               33               190 0.17368421
 9:  97221 ZIP 97221                2               166 0.01204819
10:  97215 ZIP 97215                9               147 0.06122449
11:  97236 ZIP 97236               15               144 0.10416667
12:  97214 ZIP 97214               11               117 0.09401709
13:  97266 ZIP 97266               20               106 0.18867925
14:  97218 ZIP 97218               13               106 0.12264151
15:  97239 ZIP 97239               10               102 0.09803922
> 
> proc.time()
   user  system elapsed 
  3.215   0.352   3.078 
