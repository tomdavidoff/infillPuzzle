
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # permitsPortland.R 
> # R code to grab portland permits for single family / infill areas
> # Tom Davidoff started by Google AI
> # 12/25/25
> # Modified by Claude 12/26/25: Added ZIP/Tract toggle
> # Modified by google AI to aggregate lot/date
> 
> library(data.table)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(ggplot2)
> library(tigris)
To enable caching of data, set `options(tigris_use_cache = TRUE)`
in your R script or .Rprofile.
> 
> # ==========================================
> # TOGGLE: "zip" or "tract"
> # ==========================================
> GEOGRAPHY <- "zip"
> # ==========================================
> 
> options(timeout = 600)
> options(tigris_use_cache = TRUE)
> 
> # --- PORTLAND PERMITS ---
> pdx_file <- "~/OneDrive - UBC/dataRaw/portlandPermit-Search-Results.csv"
> 
> if (!file.exists(pdx_file)) {
+   pdx_url <- "https://opendata.arcgis.com/api/v3/datasets/60341c09939e4407b4d135d55b0a3d6f_0/downloads/data?format=csv&spatialRefId=4326&where=1%3D1"
+   download.file(pdx_url, pdx_file, method = "libcurl")
+ }
> 
> dtPdx <- fread(pdx_file)
> setnames(dtPdx, tolower(names(dtPdx)))
> 
> # Filter for the RIP Era (2021-2025) and Major Construction
> dtPdxMajor <- dtPdx[
+   as.IDate(issued) >= "2021-01-01" &
+   work %in% c("New Construction", "Addition")
+ ]
> 
> # Portland Infill Logic:
> dtPdxMajor[, isPlex := new_units >= 2 |
+              grepl("duplex|triplex|fourplex", description, ignore.case = TRUE) |
+              #(work == "Addition" & new_units > 0) |
+              grepl("Townhouse", type, ignore.case = TRUE)]
> 
> dtPdxMajor <- dtPdxMajor[!is.na(x_web_mercator)]
> 
> sfPermit <- st_as_sf(dtPdxMajor,
+                      coords = c("x_web_mercator", "y_web_mercator"),
+                      crs = 3857)
> 
> # --- PORTLAND ZONING DISTRICTS ---
> zoning_dir <- "~/OneDrive - UBC/dataRaw/portlandZoning"
> shp_path <- list.files(zoning_dir, pattern = "\\.shp$", full.names = TRUE)
> sfZoning <- st_read(shp_path)
Reading layer `Zoning' from data source 
  `/Users/tdavidof/Library/CloudStorage/OneDrive-UBC/dataRaw/portlandZoning/Zoning.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 15672 features and 22 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -13674130 ymin: 5689506 xmax: -13633520 ymax: 5724897
Projected CRS: WGS 84 / Pseudo-Mercator
> names(sfZoning) <- tolower(names(sfZoning))
> sfZoning <- st_transform(sfZoning, 3857)
> 
> # --- SPATIAL JOIN: PERMITS + ZONING ---
> sfPermitZoned <- st_join(sfPermit, sfZoning)
> 
> # ==========================================
> # GEOGRAPHY-SPECIFIC JOIN
> # ==========================================
> 
> if (GEOGRAPHY == "tract") {
+   sfTracts <- tracts(state = "OR", county = "Multnomah", year = 2021, cb = TRUE)
+   sfTracts <- st_transform(sfTracts, 3857)
+   sfFinal <- st_join(sfPermitZoned, sfTracts[, c("GEOID", "NAMELSAD")])
+   dtFinal <- as.data.table(sfFinal)
+   setnames(dtFinal, c("GEOID", "NAMELSAD"), c("geo_id", "geo_name"), skip_absent = TRUE)
+ } else {
+   sfZips <- zctas(year = 2020, cb = TRUE)
+   sfZips <- sfZips[grepl("^972", sfZips$ZCTA5CE20), ]
+   sfZips <- st_transform(sfZips, 3857)
+   sfFinal <- st_join(sfPermitZoned, sfZips[, c("ZCTA5CE20")])
+   dtFinal <- as.data.table(sfFinal)
+   setnames(dtFinal, "ZCTA5CE20", "geo_id", skip_absent = TRUE)
+   dtFinal[, geo_name := paste("ZIP", geo_id)]
+ }
> 
> # ==========================================
> # LOT-LEVEL COLLAPSE (The "Nakamura/Zen" fix)
> # ==========================================
> 
> # 1. Filter for R-Zones
> dtAnalysis <- dtFinal[grepl("^R2.5|^R5|^R7|^R10|^R20", zone)]
> 
> 
> # 2. Collapse multiple permits per property_id into a single Lot record
> # We define an 'Infill Lot' as any lot that had at least one Plex permit issued.
> dtLots <- dtAnalysis[!is.na(geo_id) & !is.na(property_id), .(
+   isPlexLot = any(isPlex, na.rm = TRUE),
+   total_sqft_lot = sum(total_sqft, na.rm = TRUE),
+   permit_count = .N
+ ), by = .(property_id, geo_id, zone, geo_name)]
> 
> # 2a. Side project: figure out if new construction projects are different sized
> dtNews <- dtAnalysis[work == "New Construction" & !is.na(geo_id) & !is.na(property_id), .(
+   isPlexLot = any(isPlex, na.rm = TRUE),
+   total_sqft_lot = sum(total_sqft, na.rm = TRUE),
+   permit_count = .N
+ ), by = .(property_id, geo_id, zone, geo_name)]
> print(dtNews[,.(mean(total_sqft_lot),median(total_sqft_lot,by=isPlexlot)),by=isPlexLot])
   isPlexLot       V1     V2
      <lgcl>    <num>  <num>
1:     FALSE 2084.927 1481.5
2:      TRUE 3553.643 3480.0
> 
> 
> # ==========================================
> # GEOGRAPHY-LEVEL PROPENSITY (Based on Lots)
> # ==========================================
> 
> dtGeo <- dtNews[, .(
+   infill_lot_count = sum(isPlexLot, na.rm = TRUE),
+   total_lots_active = .N,
+   propensity = sum(isPlexLot, na.rm = TRUE) / .N
+ ), by = .(geo_id, geo_name)]
> 
> setorder(dtGeo, -total_lots_active)
> 
> # ==========================================
> # SAVE & SUMMARY
> # ==========================================
> output_file <- sprintf("~/OneDrive - UBC/dataProcessed/portland_%s_propensity.rds", GEOGRAPHY)
> saveRDS(dtGeo, output_file)
> 
> cat("\n=== LOT-LEVEL SUMMARY BY", toupper(GEOGRAPHY), "===\n")

=== LOT-LEVEL SUMMARY BY ZIP ===
> cat("Total Active Lots (R-Zones):", nrow(dtLots), "\n")
Total Active Lots (R-Zones): 3563 
> cat("Total Infill Lots (Plexes):", sum(dtLots$isPlexLot), "\n")
Total Infill Lots (Plexes): 403 
> cat("Overall Infill Propensity (Lot-based):",
+     round(sum(dtGeo$infill_lot_count) / sum(dtGeo$total_lots_active), 4), "\n")
Overall Infill Propensity (Lot-based): 0.2233 
> 
> print(head(dtGeo, 15))
    geo_id  geo_name infill_lot_count total_lots_active propensity
    <char>    <char>            <int>             <int>      <num>
 1:  97206 ZIP 97206               64               244 0.26229508
 2:  97219 ZIP 97219               22               176 0.12500000
 3:  97211 ZIP 97211               44               152 0.28947368
 4:  97203 ZIP 97203               49               147 0.33333333
 5:  97202 ZIP 97202               36               138 0.26086957
 6:  97236 ZIP 97236               15               106 0.14150943
 7:  97217 ZIP 97217               33               103 0.32038835
 8:  97213 ZIP 97213               21                86 0.24418605
 9:  97212 ZIP 97212                9                80 0.11250000
10:  97266 ZIP 97266               19                69 0.27536232
11:  97221 ZIP 97221                2                63 0.03174603
12:  97215 ZIP 97215                9                59 0.15254237
13:  97218 ZIP 97218               13                50 0.26000000
14:  97220 ZIP 97220                9                39 0.23076923
15:  97214 ZIP 97214                9                37 0.24324324
> 
> proc.time()
   user  system elapsed 
  2.532   0.291  12.587 
