
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # processAttom_Minneapolis.R
> # Tom Davidoff
> # Purpose: Pricing slopes by ZIP for Minneapolis/Hennepin County (FIPS 27053)
> # Adapted from Portland code
> 
> library(data.table)
> library(arrow)

Attaching package: ‘arrow’

The following object is masked from ‘package:utils’:

    timestamp

Warning message:
package ‘arrow’ was built under R version 4.5.2 
> library(fixest)
> 
> options(timeout = 600)
> 
> # ==========================================
> # 1) LOAD SALES (27053.txt) - Hennepin County, MN
> # ==========================================
> message("Reading Sales data...")
Reading Sales data...
> 
> raw_txt <- readLines("~/OneDrive - UBC/dataProcessed/27053.txt", warn = FALSE, encoding = "latin1")
> header_line <- raw_txt[1]
> data_body   <- raw_txt[-1]
> 
> header_names <- unlist(strsplit(header_line, "|", fixed = TRUE))
> header_names <- make.names(tolower(header_names))
> 
> message("Splitting pipes...")
Splitting pipes...
> dtSales <- data.table(raw = data_body)
> dtSales <- dtSales[, tstrsplit(raw, "|", fixed = TRUE, fill = NA)]
> 
> names(dtSales)[1:length(header_names)] <- header_names
> setnames(dtSales, "X.attom.id.", "attom_id", skip_absent = TRUE)
> setnames(dtSales, "transferamount", "price", skip_absent = TRUE)
> setnames(dtSales, "transactiondate", "date", skip_absent = TRUE)
> 
> # normalize names after setnames
> setnames(dtSales, tolower(make.names(names(dtSales))))
> 
> # types
> dtSales[, attom_id := as.character(attom_id)]
> dtSales[, price := as.numeric(price)]
> dtSales[, date  := as.IDate(date)]
> dtSales[,yearMonth := format(date, "%Y-%m")]
> 
> # filter years - around 2018 zoning change
> # Minneapolis 2040 plan adopted Dec 2018, implemented Jan 2020
> # Adjust as needed for your research question
> dtSales <- dtSales[year(date) >= 2016 & year(date) <= 2020]
> 
> # ZIP from sales (clean)
> if (!"propertyaddresszip" %in% names(dtSales)) stop("propertyaddresszip not found in dtSales.")
> dtSales[, zip := gsub("[^0-9]", "", as.character(propertyaddresszip))]
> dtSales[nchar(zip) == 9, zip := substr(zip, 1, 5)]
> dtSales[zip == "", zip := NA_character_]
> 
> # OPTIONAL: Filter to Minneapolis-area ZIPs only (554xx range)
> # Uncomment if you want to restrict to Minneapolis proper
> # dtSales <- dtSales[grepl("^554", zip)]
> 
> message("Sales rows after date filter: ", nrow(dtSales))
Sales rows after date filter: 104702
> 
> # ==========================================
> # 2) LOAD ASSESSOR (sqft) from Parquet - Minnesota
> # ==========================================
> message("Opening Assessor Parquet...")
Opening Assessor Parquet...
> ds <- open_dataset("~/OneDrive - UBC/dataProcessed/AH_state_MN.parquet")
> 
> # Pull only what we need - Hennepin County FIPS muni code is "053"
> scanner <- ds$NewScan()$
+   Filter(Expression$field_ref("MM_FIPS_MUNI_CODE") == "053")$
+   Project(c("[ATTOM ID]", "SA_FIN_SQFT_TOT","SA_LOTSIZE","SA_YR_BLT","USE_CODE_STD"))$
+   Finish()
> 
> dtAssessor <- as.data.table(scanner$ToTable())
> setnames(dtAssessor, c("[ATTOM ID]", "SA_FIN_SQFT_TOT","SA_LOTSIZE","SA_YR_BLT","USE_CODE_STD"), c("attom_id", "sqft","lotSize","yearBuilt","useCode"))
> 
> dtAssessor[, attom_id := as.character(attom_id)]
> dtAssessor[, sqft := as.numeric(sqft)]
> dtAssessor[, lotSize := as.numeric(lotSize)]
> dtAssessor[, yearBuilt := as.integer(yearBuilt)]
> 
> # Deduplicate: multiple records per ATTOM id
> dtAssessor[,randomNum := runif(.N)]
> dtAssessor[,maxRandom := max(randomNum+sqft, na.rm=TRUE), by=attom_id]
> dtAssessor_Final <- dtAssessor[randomNum+sqft == maxRandom]
> 
> dtAssessor_Final[is.infinite(sqft), sqft := NA_real_]
> 
> message("Unique assessor ATTOM IDs: ", uniqueN(dtAssessor_Final$attom_id))
Unique assessor ATTOM IDs: 442511
> 
> # ==========================================
> # 3) MERGE + SLOPE ESTIMATION BY ZIP
> # ==========================================
> message("Merging sales + assessor...")
Merging sales + assessor...
> dtFinal <- merge(dtSales, dtAssessor_Final, by = "attom_id", all = FALSE)
> print(table(dtFinal$useCode))

 AFAR  AMSC  CMSC  IMSC  MMSC  RAPT  RCON  RDUP  RMFD  RMSC  RPUD  RSFR  RTHO 
   77     2    29     1    38   248 20145  1351  1490   343     3 72174  5013 
 RTIM  RTRI  VCOM  VIND  VMSC  VRES 
  174   149    71     1    13  2240 
> dtFinal <- dtFinal[useCode=="RSFR"]
> 
> # clean
> dtFinal <- dtFinal[!is.na(price) & !is.na(sqft) & !is.na(zip)]
> dtFinal <- dtFinal[price > 100000 & sqft > 400]
> 
> dtFinal[, ppsf := price / sqft]
> 
> # keep plausible ZIPs
> dtFinal <- dtFinal[nchar(zip) == 5]
> 
> # Filter to ZIPs with enough observations to estimate slopes
> # This avoids collinearity issues from ZIPs with only 1-2 sales
> min_obs <- 20  # adjust as needed
> zip_counts <- dtFinal[, .N, by = zip]
> good_zips <- zip_counts[N >= min_obs, zip]
> dtFinal <- dtFinal[zip %in% good_zips]
> 
> message("Final rows for regression: ", nrow(dtFinal),
+         " | ZIPs: ", uniqueN(dtFinal$zip))
Final rows for regression: 22339 | ZIPs: 58
> 
> # Slope by ZIP: ZIP-specific intercept and ZIP-specific slope on sqft
> # (ppsf = a_zip + b_zip * sqft + error)
> dtFinal[, zip := as.factor(zip)]
> dtFinal[,lppsf := log(ppsf)]
> dtFinal[,lsqft := log(sqft)]
> m <- feols(lppsf ~ 0 + zip + zip:lsqft + log(lotSize) |yearMonth, data = dtFinal)
NOTE: 6 observations removed because of infinite values (RHS: 6).
The variable 'zip55447' has been removed because of collinearity (see $collin.var).
> print(summary(m))
OLS estimation, Dep. Var.: lppsf
Observations: 22,333
Fixed-effects: yearMonth: 60
Standard-errors: Clustered (yearMonth) 
                Estimate Std. Error    t value   Pr(>|t|)    
zip55305       -1.150641   0.614160  -1.873519 6.5952e-02 .  
zip55311        0.008433   0.410343   0.020552 9.8367e-01    
zip55316       -0.032051   0.554780  -0.057773 9.5412e-01    
zip55327       -0.688200   0.589850  -1.166737 2.4801e-01    
zip55331       -1.341527   0.714075  -1.878694 6.5229e-02 .  
zip55340       -2.920000   0.717450  -4.069972 1.4173e-04 ***
zip55343       -0.309325   0.631355  -0.489939 6.2599e-01    
zip55344       -0.872943   1.152507  -0.757430 4.5181e-01    
zip55345       -0.188751   0.594739  -0.317368 7.5208e-01    
zip55346        0.701138   0.502691   1.394769 1.6831e-01    
zip55347       -0.127912   0.637720  -0.200577 8.4172e-01    
zip55356       -2.632816   0.735068  -3.581732 6.9156e-04 ***
zip55357       -1.296525   1.078252  -1.202432 2.3400e-01    
zip55359       -1.316668   0.643012  -2.047656 4.5054e-02 *  
zip55364       -2.039406   0.523524  -3.895535 2.5258e-04 ***
zip55369        0.803045   0.470983   1.705042 9.3447e-02 .  
zip55374        0.147688   0.621020   0.237815 8.1285e-01    
zip55375       -0.631491   0.493778  -1.278896 2.0594e-01    
zip55391       -2.607462   0.641381  -4.065387 1.4392e-04 ***
zip55403       -0.213999   1.699592  -0.125912 9.0023e-01    
zip55404        0.346008   1.178455   0.293611 7.7009e-01    
zip55405       -2.968961   0.691875  -4.291184 6.6983e-05 ***
zip55406        0.865752   0.512236   1.690143 9.6278e-02 .  
zip55407        1.820090   0.479143   3.798638 3.4631e-04 ***
zip55408       -0.998488   0.747981  -1.334912 1.8703e-01    
zip55409       -0.821838   0.579089  -1.419189 1.6111e-01    
zip55410       -0.757220   0.695334  -1.089002 2.8058e-01    
zip55411        1.750065   0.511906   3.418722 1.1465e-03 ** 
zip55412        1.093627   0.440120   2.484840 1.5817e-02 *  
zip55413        0.552626   0.797332   0.693093 4.9097e-01    
zip55414       -1.398042   0.539935  -2.589276 1.2095e-02 *  
zip55416       -1.461516   0.470561  -3.105903 2.9145e-03 ** 
zip55417       -0.400714   0.453210  -0.884169 3.8019e-01    
zip55418        0.497752   0.488384   1.019181 3.1228e-01    
zip55419       -0.615506   0.476159  -1.292649 2.0117e-01    
zip55420        0.969970   0.467589   2.074406 4.2413e-02 *  
zip55422       -0.770010   0.538802  -1.429114 1.5824e-01    
zip55423        1.515370   0.455879   3.324060 1.5286e-03 ** 
zip55424       -2.255907   1.210525  -1.863577 6.7360e-02 .  
zip55425        1.280322   0.684649   1.870040 6.6442e-02 .  
zip55426        1.225332   0.427056   2.869254 5.7014e-03 ** 
zip55427        0.040880   0.807046   0.050654 9.5977e-01    
zip55428        0.174593   0.481554   0.362561 7.1823e-01    
zip55429        1.838910   0.534558   3.440054 1.0739e-03 ** 
zip55430        1.295165   0.464250   2.789801 7.0913e-03 ** 
zip55431        1.153778   0.608116   1.897299 6.2686e-02 .  
zip55435       -0.898598   1.398960  -0.642333 5.2315e-01    
zip55436       -1.058602   0.696993  -1.518813 1.3415e-01    
zip55437       -0.251656   0.619395  -0.406293 6.8600e-01    
zip55438       -0.241643   0.753430  -0.320725 7.4955e-01    
zip55439       -0.471539   0.871084  -0.541325 5.9032e-01    
zip55441       -0.053344   0.597375  -0.089297 9.2915e-01    
zip55442        0.689966   0.487986   1.413906 1.6264e-01    
zip55443       -0.354972   0.433769  -0.818344 4.1645e-01    
zip55444        1.554673   0.518461   2.998630 3.9660e-03 ** 
zip55445        0.713464   0.546752   1.304915 1.9699e-01    
zip55446        0.632134   0.760377   0.831343 4.0913e-01    
log(lotSize)    0.082899   0.006488  12.776357  < 2.2e-16 ***
zip55305:lsqft -0.253247   0.055782  -4.539925 2.8254e-05 ***
zip55311:lsqft -0.411193   0.024902 -16.512263  < 2.2e-16 ***
zip55316:lsqft -0.426789   0.044586  -9.572214 1.2886e-13 ***
zip55327:lsqft -0.342709   0.065234  -5.253530 2.1493e-06 ***
zip55331:lsqft -0.189888   0.072249  -2.628233 1.0924e-02 *  
zip55340:lsqft -0.019149   0.070154  -0.272952 7.8584e-01    
zip55343:lsqft -0.372193   0.063648  -5.847673 2.3113e-07 ***
zip55344:lsqft -0.283979   0.138357  -2.052511 4.4564e-02 *  
zip55345:lsqft -0.379334   0.052381  -7.241804 1.0536e-09 ***
zip55346:lsqft -0.503128   0.043901 -11.460550  < 2.2e-16 ***
zip55347:lsqft -0.381126   0.062974  -6.052106 1.0595e-07 ***
zip55356:lsqft -0.046343   0.071304  -0.649927 5.1826e-01    
zip55357:lsqft -0.271064   0.141947  -1.909612 6.1049e-02 .  
zip55359:lsqft -0.247748   0.068409  -3.621547 6.1007e-04 ***
zip55364:lsqft -0.128507   0.042165  -3.047683 3.4476e-03 ** 
zip55369:lsqft -0.534960   0.040505 -13.207410  < 2.2e-16 ***
zip55374:lsqft -0.455161   0.054181  -8.400685 1.1533e-11 ***
zip55375:lsqft -0.359934   0.062460  -5.762660 3.1915e-07 ***
zip55391:lsqft -0.015846   0.062566  -0.253262 8.0095e-01    
zip55403:lsqft -0.309364   0.213088  -1.451812 1.5185e-01    
zip55404:lsqft -0.502013   0.149410  -3.359980 1.3712e-03 ** 
zip55405:lsqft  0.011867   0.069160   0.171596 8.6434e-01    
zip55406:lsqft -0.539223   0.039895 -13.516185  < 2.2e-16 ***
zip55407:lsqft -0.683426   0.035914 -19.029322  < 2.2e-16 ***
zip55408:lsqft -0.270361   0.088404  -3.058237 3.3447e-03 ** 
zip55409:lsqft -0.294919   0.057872  -5.096050 3.8369e-06 ***
zip55410:lsqft -0.248522   0.064381  -3.860184 2.8353e-04 ***
zip55411:lsqft -0.729226   0.039224 -18.591251  < 2.2e-16 ***
zip55412:lsqft -0.629350   0.022489 -27.984242  < 2.2e-16 ***
zip55413:lsqft -0.497457   0.090083  -5.522201 7.9017e-07 ***
zip55414:lsqft -0.226628   0.073205  -3.095780 3.0013e-03 ** 
zip55416:lsqft -0.177654   0.036482  -4.869640 8.7372e-06 ***
zip55417:lsqft -0.351499   0.033503 -10.491709 4.1291e-15 ***
zip55418:lsqft -0.493883   0.031049 -15.906554  < 2.2e-16 ***
zip55419:lsqft -0.299767   0.039817  -7.528589 3.4396e-10 ***
zip55420:lsqft -0.569475   0.035335 -16.116332  < 2.2e-16 ***
zip55422:lsqft -0.327943   0.035099  -9.343490 3.0722e-13 ***
zip55423:lsqft -0.640396   0.027938 -22.921913  < 2.2e-16 ***
zip55424:lsqft -0.031719   0.146298  -0.216813 8.2910e-01    
zip55425:lsqft -0.616998   0.075993  -8.119108 3.4421e-11 ***
zip55426:lsqft -0.578513   0.040107 -14.424373  < 2.2e-16 ***
zip55427:lsqft -0.432883   0.098372  -4.400488 4.5955e-05 ***
zip55428:lsqft -0.469885   0.033556 -14.003121  < 2.2e-16 ***
zip55429:lsqft -0.717531   0.046653 -15.380054  < 2.2e-16 ***
zip55430:lsqft -0.647664   0.032426 -19.973596  < 2.2e-16 ***
zip55431:lsqft -0.583614   0.064402  -9.062030 9.0054e-13 ***
zip55435:lsqft -0.240060   0.189383  -1.267587 2.0993e-01    
zip55436:lsqft -0.219880   0.078881  -2.787500 7.1358e-03 ** 
zip55437:lsqft -0.374728   0.070159  -5.341142 1.5533e-06 ***
zip55438:lsqft -0.354107   0.086687  -4.084895 1.3482e-04 ***
zip55439:lsqft -0.305697   0.098780  -3.094726 3.0105e-03 ** 
zip55441:lsqft -0.407494   0.063801  -6.386918 2.9234e-08 ***
zip55442:lsqft -0.505450   0.050351 -10.038588 2.2256e-14 ***
zip55443:lsqft -0.389299   0.019491 -19.973187  < 2.2e-16 ***
zip55444:lsqft -0.661290   0.039646 -16.679958  < 2.2e-16 ***
zip55445:lsqft -0.531267   0.038259 -13.886107  < 2.2e-16 ***
zip55446:lsqft -0.488053   0.076581  -6.373013 3.0846e-08 ***
zip55447:lsqft -0.408062   0.056772  -7.187759 1.3009e-09 ***
... 1 variable was removed because of collinearity (zip55447)
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.241624     Adj. R2: 0.505315
                 Within R2: 0.47723 
> 
> # ==========================================
> # 4) EXTRACT SLOPES ROBUSTLY (no broom)
> # ==========================================
> b <- coef(m)
> keep <- grepl(":lsqft$", names(b))
> 
> dtSlopes <- data.table(
+   zip = sub(":lsqft$", "", sub("^zip", "", names(b)[keep])),
+   slope = unname(b[keep])
+ )
> 
> zipStats <- dtFinal[, .(N = .N, mean_ppsf = mean(ppsf, na.rm = TRUE)), by = zip]
> 
> # add sample size per ZIP (useful for filtering)
> dtSlopes <- merge(dtSlopes, zipStats, by = "zip", all.x = TRUE)
> setorder(dtSlopes, -N)
> 
> saveRDS(dtSlopes, "~/OneDrive - UBC/dataProcessed/minneapolis_attom_slopes_by_zip.rds")
> 
> message("Saved slopes: OneDrive - UBC/dataProcessed/minneapolis_attom_slopes_by_zip.rds")
Saved slopes: OneDrive - UBC/dataProcessed/minneapolis_attom_slopes_by_zip.rds
> print(dtSlopes[1:15])
       zip      slope     N mean_ppsf
    <char>      <num> <int>     <num>
 1:  55412 -0.6293497  1257  158.4148
 2:  55422 -0.3279427  1122  203.3202
 3:  55406 -0.5392230   935  246.9198
 4:  55430 -0.6476639   904  178.6320
 5:  55418 -0.4938826   896  224.4130
 6:  55423 -0.6403964   880  226.2104
 7:  55417 -0.3514988   847  249.4844
 8:  55426 -0.5785131   817  264.5879
 9:  55407 -0.6834263   813  223.4378
10:  55411 -0.7292257   803  139.2267
11:  55429 -0.7175309   786  187.6224
12:  55428 -0.4698855   780  199.0576
13:  55419 -0.2997675   618  282.1785
14:  55416 -0.1776542   598  288.9393
15:  55427 -0.4328830   598  226.0925
> print(cor(dtSlopes[,.(slope, mean_ppsf)], use = "complete.obs"))
              slope mean_ppsf
slope     1.0000000 0.5827464
mean_ppsf 0.5827464 1.0000000
> print(cor(dtSlopes[N>median(N),.(slope, mean_ppsf)], use = "complete.obs"))
              slope mean_ppsf
slope     1.0000000 0.6832106
mean_ppsf 0.6832106 1.0000000
> print(cor(dtSlopes[N>quantile(N,.75),.(slope, mean_ppsf)], use = "complete.obs"))
              slope mean_ppsf
slope     1.0000000 0.6828082
mean_ppsf 0.6828082 1.0000000
> 
> proc.time()
   user  system elapsed 
 19.804   2.553  13.704 
