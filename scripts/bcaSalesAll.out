
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSalesAll.R
> # R to evaluate elasticity of price per square foot among *all* BCA sales by neighbourhood description (not tract as need obs of all types...)
> # Tom Davidoff
> 
> # 01/26/26
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(ggplot2)
> library(sf)
Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19SalesAll.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, 
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019, fSales)
+ } 
> dtBCA2019 <- readRDS(fSales)
> dtBCA2019[, duplexTownhome:=(grepl("uplex", actualUseDescription, ignore.case=TRUE) | actualUseDescription=="Row Housing (Single Unit Ownership)")]
> dtBCA2019[, single:=(actualUseDescription %in% c("Residential Dwelling with Suite","Single Family Dwelling"))]
> print(summary(dtBCA2019))
   folioID          conveyancePrice    conveyanceDate     MB_effective_year 
 Length:347727      Length:347727      Length:347727      Length:347727     
 Class :character   Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character   Mode  :character  
 MB_total_finished_area  land_width         land_depth       
 Length:347727          Length:347727      Length:347727     
 Class :character       Class :character   Class :character  
 Mode  :character       Mode  :character   Mode  :character  
  land_area         roll_number           zoning          actualUseDescription
 Length:347727      Length:347727      Length:347727      Length:347727       
 Class :character   Class :character   Class :character   Class :character    
 Mode  :character   Mode  :character   Mode  :character   Mode  :character    
 neighbourhoodDescription  postalCode        duplexTownhome    single       
 Length:347727            Length:347727      Mode :logical   Mode :logical  
 Class :character         Class :character   FALSE:317568    FALSE:204806   
 Mode  :character         Mode  :character   TRUE :30159     TRUE :142921   
> 
> print(table(dtBCA2019$actualUseDescription))

  2 Acres Or More (Single Family Dwelling, Duplex) 
                                                77 
       Bed & Breakfast Operation Less Than 4 Units 
                                                 1 
   Duplex, Non-Strata Side by Side or Front / Back 
                                              2109 
                      Duplex, Non-Strata Up / Down 
                                               254 
                       Duplex, Strata Front / Back 
                                              4222 
                       Duplex, Strata Side by Side 
                                              2497 
                          Duplex, Strata Up / Down 
                                               239 
               Individual Strata Lot (Hotel/Motel) 
                                               156 
                         Multi-Family (Conversion) 
                                               116 
                 Property Subject To Section 19(8) 
                                              1283 
                   Residential Dwelling with Suite 
                                             79676 
                      Residential Outbuilding Only 
                                                 6 
               Row Housing (Single Unit Ownership) 
                                             20761 
                            Single Family Dwelling 
                                             63245 
                Strata-Lot Residence (Condominium) 
                                            172206 
             Stratified Operational Facility Areas 
                                                 2 
  Stratified Rental Apartment (Frame Construction) 
                                               485 
Stratified Rental Apartment (Hi-Rise Construction) 
                                                20 
                       Stratified Rental Townhouse 
                                                31 
                                           Triplex 
                                                15 
              Vacant Residential Less Than 2 Acres 
                                               326 
> 
> # Numeric conversion and cleaning
> cols <- c("conveyancePrice", "MB_effective_year", "MB_total_finished_area")
> dtBCA2019[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
> dtBCA2019 <- dtBCA2019[!is.na(MB_total_finished_area) & conveyancePrice > 100000]
> print(dtBCA2019[,mean(is.na(MB_total_finished_area)),by=single])
   single    V1
   <lgcl> <num>
1:   TRUE     0
2:  FALSE     0
> print(summary(dtBCA2019$MB_total_finished_area))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    100     762    1250    1676    2327   28794 
> print(dtBCA2019[year(conveyanceDate)>=2015 & !is.na(MB_total_finished_area) ,.N,by=c("single","neighbourhoodDescription")])
    single  neighbourhoodDescription     N
    <lgcl>                    <char> <int>
 1:   TRUE                POINT GREY   821
 2:  FALSE                POINT GREY   235
 3:   TRUE                 KITSILANO   675
 4:  FALSE                 KITSILANO  3270
 5:   TRUE                    DUNBAR  1222
 6:  FALSE                    DUNBAR   195
 7:   TRUE ARBUTUS/MACKENZIE HEIGHTS   761
 8:  FALSE ARBUTUS/MACKENZIE HEIGHTS   324
 9:   TRUE                KERRISDALE   635
10:  FALSE                KERRISDALE   504
11:   TRUE                SOUTHLANDS   521
12:  FALSE                SOUTHLANDS    17
13:  FALSE                  FAIRVIEW  3090
14:   TRUE                  FAIRVIEW     5
15:   TRUE               SHAUGHNESSY   429
16:  FALSE               SHAUGHNESSY   130
17:  FALSE                    CAMBIE  1095
18:   TRUE                    CAMBIE   599
19:   TRUE           SOUTH GRANVILLE   621
20:  FALSE           SOUTH GRANVILLE   329
21:  FALSE                  OAKRIDGE   592
22:   TRUE                  OAKRIDGE   320
23:   TRUE                   MARPOLE   516
24:  FALSE                   MARPOLE  1887
25:  FALSE            MOUNT PLEASANT  6675
26:   TRUE            MOUNT PLEASANT   258
27:   TRUE                 GRANDVIEW   645
28:  FALSE                 GRANDVIEW  1761
29:  FALSE             CEDAR COTTAGE   837
30:   TRUE             CEDAR COTTAGE   508
31:   TRUE               MAIN/FRASER  1078
32:  FALSE               MAIN/FRASER   564
33:   TRUE           SOUTH VANCOUVER  1136
34:  FALSE           SOUTH VANCOUVER    99
35:   TRUE              MARINE DRIVE    20
36:  FALSE              MARINE DRIVE  1931
37:   TRUE                    KNIGHT   809
38:  FALSE                    KNIGHT   190
39:  FALSE             HASTINGS EAST   257
40:   TRUE             HASTINGS EAST  1008
41:   TRUE                   RENFREW   630
42:  FALSE                   RENFREW   175
43:   TRUE           RENFREW HEIGHTS   794
44:  FALSE           RENFREW HEIGHTS     7
45:   TRUE               COLLINGWOOD   738
46:  FALSE               COLLINGWOOD  3395
47:  FALSE                 KILLARNEY   155
48:   TRUE                 KILLARNEY   859
49:   TRUE                FRASERVIEW   425
50:  FALSE                FRASERVIEW   274
51:  FALSE                  DOWNTOWN  5803
52:  FALSE                  WEST END  1985
53:   TRUE                  WEST END     5
54:  FALSE                   HARBOUR   456
55:  FALSE            DOWNTOWN SOUTH  4383
56:   TRUE            DOWNTOWN SOUTH     3
57:  FALSE         FALSE CREEK NORTH  2227
    single  neighbourhoodDescription     N
> 
> # Metrics
> dtBCA2019[, `:=`(
+     age = year(conveyanceDate) - MB_effective_year, 
+     ppsf = conveyancePrice / MB_total_finished_area 
+ )]
> 
> # Outlier removal (global)
> CUT <- 0.01
> dtBCA2019 <- dtBCA2019[
+     age >= 0 &
+     MB_total_finished_area %between% quantile(MB_total_finished_area, c(CUT, 1-CUT)) &
+     ppsf %between% quantile(ppsf, c(CUT, 1-CUT))
+ ]
> print(dtBCA2019[year(conveyanceDate)>2014 & !is.na(MB_total_finished_area) ,.N,by=c("single","neighbourhoodDescription")])
    single  neighbourhoodDescription     N
    <lgcl>                    <char> <int>
 1:   TRUE                POINT GREY   407
 2:  FALSE                POINT GREY   227
 3:   TRUE                 KITSILANO   495
 4:  FALSE                 KITSILANO  3106
 5:   TRUE                    DUNBAR   856
 6:  FALSE                    DUNBAR   178
 7:   TRUE ARBUTUS/MACKENZIE HEIGHTS   518
 8:  FALSE ARBUTUS/MACKENZIE HEIGHTS   313
 9:   TRUE                KERRISDALE   506
10:  FALSE                KERRISDALE   474
11:   TRUE                SOUTHLANDS   370
12:  FALSE                SOUTHLANDS    11
13:  FALSE                  FAIRVIEW  3026
14:   TRUE                  FAIRVIEW     5
15:   TRUE               SHAUGHNESSY   190
16:  FALSE               SHAUGHNESSY   113
17:  FALSE                    CAMBIE  1065
18:   TRUE                    CAMBIE   438
19:   TRUE           SOUTH GRANVILLE   404
20:  FALSE           SOUTH GRANVILLE   288
21:  FALSE                  OAKRIDGE   579
22:   TRUE                  OAKRIDGE   236
23:   TRUE                   MARPOLE   427
24:  FALSE                   MARPOLE  1807
25:  FALSE            MOUNT PLEASANT  6445
26:   TRUE            MOUNT PLEASANT   246
27:   TRUE                 GRANDVIEW   578
28:  FALSE                 GRANDVIEW  1713
29:  FALSE             CEDAR COTTAGE   814
30:   TRUE             CEDAR COTTAGE   425
31:   TRUE               MAIN/FRASER   806
32:  FALSE               MAIN/FRASER   555
33:   TRUE           SOUTH VANCOUVER   834
34:  FALSE           SOUTH VANCOUVER    99
35:   TRUE              MARINE DRIVE    20
36:  FALSE              MARINE DRIVE  1929
37:   TRUE                    KNIGHT   634
38:  FALSE                    KNIGHT   183
39:  FALSE             HASTINGS EAST   253
40:   TRUE             HASTINGS EAST   785
41:   TRUE                   RENFREW   449
42:  FALSE                   RENFREW   174
43:   TRUE           RENFREW HEIGHTS   602
44:  FALSE           RENFREW HEIGHTS     7
45:   TRUE               COLLINGWOOD   620
46:  FALSE               COLLINGWOOD  3299
47:  FALSE                 KILLARNEY   152
48:   TRUE                 KILLARNEY   609
49:   TRUE                FRASERVIEW   337
50:  FALSE                FRASERVIEW   274
51:  FALSE                  DOWNTOWN  5270
52:  FALSE                  WEST END  1828
53:   TRUE                  WEST END     3
54:  FALSE                   HARBOUR   188
55:  FALSE            DOWNTOWN SOUTH  4119
56:   TRUE            DOWNTOWN SOUTH     3
57:  FALSE         FALSE CREEK NORTH  1923
    single  neighbourhoodDescription     N
> 
> cat("BCA 2019 transactions loaded:", nrow(dtBCA2019), "\n")
BCA 2019 transactions loaded: 278999 
> 
> MINYEAR <- 2015
> MEANYEAR <- 2012
> 
> dtBCA2019 <- dtBCA2019[!neighbourhoodDescription %chin% c("SHAUGNESSY", "WEST END","SOUTHLANDS")]
> 
> # ==========================================
> # Function to run analysis at a given geographic level
> # ==========================================
> 
> runAnalysis <- function(dt, groupVar, label) {
+   cat("\n==========================================\n")
+   cat("Running analysis at", label, "level\n")
+   cat("==========================================\n")
+   
+ dtAnalysis <- dt
+   
+   
+   # Build formulas dynamically
+   fmlaMain <- as.formula(paste0(
+     "ppsf ~ i(", groupVar, ", MB_total_finished_area) + log(age + 1) + MB_total_finished_area | ", groupVar
+   ))
+ 
+   fmlaLog <- as.formula(paste0(
+     "log(ppsf) ~ i(", groupVar, ", log(MB_total_finished_area)) + log(age + 1) + log(MB_total_finished_area)  | ", groupVar 
+   ))# no main effect for Wald purposes
+   
+ 
+   # Run regressions
+   mainReg <- feols(fmlaMain, data = dtAnalysis)
+   print(r2(mainReg, typ = c("r2", "ar2")))
+   
+   logReg <- feols(fmlaLog, data = dtAnalysis)
+   print(r2(logReg, typ = c("r2", "ar2")))
+ 
+   # Extract slopes
+   dtSlopes <- as.data.table(coeftable(mainReg), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
+   # Extract group identifier from term
+   pattern <- paste0(groupVar, "::(.*):MB_total_finished_area")
+   dtSlopes[, (groupVar) := gsub(pattern, "\\1", term)]
+   
+   # Extract elasticities
+   dtElasticities <- as.data.table(coeftable(logReg), keep.rownames = "term")[grepl("log\\(MB_total_finished_area\\)", term)]
+   patternLog <- paste0(groupVar, "::(.*):log\\(MB_total_finished_area\\)")
+   dtElasticities[, (groupVar) := gsub(patternLog, "\\1", term)]
+   
+   # Compute means
+   dtMeans <- dtAnalysis[year(conveyanceDate) >= MEANYEAR, 
+                         .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = .N), 
+                         by = groupVar]
+   dtMeanDuplex <- dtAnalysis[year(conveyanceDate) >= MEANYEAR & single==0, .(meanPPSF_duplex = mean(ppsf, na.rm = TRUE), nobs_duplex = .N), by = groupVar]
+   dtMeanSingle <- dtAnalysis[year(conveyanceDate) >= MEANYEAR & single==1, .(meanPPSF_single = mean(ppsf, na.rm = TRUE), nobs_single = .N), by = groupVar]
+   dtMeans <- merge(dtMeans, dtMeanDuplex, by = groupVar, all.x = TRUE)
+   dtMeans <- merge(dtMeans, dtMeanSingle, by = groupVar, all.x = TRUE)
+   print("incoming")
+   
+   # Merge slopes and elasticities
+   dtMeans <- merge(dtMeans, dtSlopes[, c(groupVar, "Estimate"), with = FALSE], by = groupVar, all.x = TRUE)
+   setnames(dtMeans, "Estimate", "slope")
+   dtMeans <- merge(dtMeans, dtElasticities[, c(groupVar, "Estimate"), with = FALSE], by = groupVar, all.x = TRUE)
+   setnames(dtMeans, "Estimate", "elasticity")
+   print(dtAnalysis[year(conveyanceDate) >= MEANYEAR & duplexTownhome==1, .N, by = neighbourhoodDescription][order(N)])
+   
+   # Output
+   fwrite(dtMeans, paste0("tables/bca19_mean_ppsf_slope_All_by_", label, ".csv"))
+   
+   # Plot
+   p <- ggplot(dtMeans[nobs > quantile(nobs, .025) & !is.na(slope)], aes(x = slope, y = meanPPSF)) + 
+     geom_point() + 
+     geom_smooth(method = "lm") + 
+     labs(title = paste("Mean BCA Price per SqFt vs Pricing Slope by", label), 
+          x = "BCA Pricing Slope ($/sqft per sqft)", 
+          y = "Mean Price per SqFt")
+   ggsave(paste0("text/bca19_mean_ppsf_vs_slope_", label, ".png"), plot = p)
+   
+   # Correlations
+   cat("\nCorrelations (", label, "):\n", sep = "")
+   print(cor(dtMeans[!is.na(slope), .(slope, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity), .(elasticity, meanPPSF)]))
+   print(cor(dtMeans[!is.na(slope) & nobs > quantile(nobs, .025), .(slope, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .1), .(elasticity, meanPPSF)]))
+   
+   return(dtMeans)
+ }
> 
> # ==========================================
> # Run analyses
> # ==========================================
> 
> dtResultsNbhd <- runAnalysis(copy(dtBCA2019), "neighbourhoodDescription", "neighbourhood")

==========================================
Running analysis at neighbourhood level
==========================================
The variable 'MB_total_finished_area' has been removed because of collinearity (see $collin.var).
       r2       ar2 
0.1844127 0.1842392 
       r2       ar2 
0.2429681 0.2428042 
[1] "incoming"
     neighbourhoodDescription     N
                       <char> <int>
 1:                   RENFREW     6
 2:           RENFREW HEIGHTS     9
 3:                    DUNBAR    11
 4:                POINT GREY    38
 5:             HASTINGS EAST    53
 6:           SOUTH VANCOUVER    67
 7:               SHAUGHNESSY    71
 8:                KERRISDALE    80
 9: ARBUTUS/MACKENZIE HEIGHTS    86
10:                  DOWNTOWN   109
11:                 KILLARNEY   120
12:                   HARBOUR   126
13:                    KNIGHT   143
14:           SOUTH GRANVILLE   190
15:               MAIN/FRASER   190
16:         FALSE CREEK NORTH   219
17:            DOWNTOWN SOUTH   251
18:              MARINE DRIVE   253
19:                    CAMBIE   283
20:                  OAKRIDGE   314
21:                FRASERVIEW   317
22:               COLLINGWOOD   348
23:                   MARPOLE   394
24:             CEDAR COTTAGE   431
25:                  FAIRVIEW   591
26:                 GRANDVIEW   818
27:            MOUNT PLEASANT  1080
28:                 KITSILANO  1301
     neighbourhoodDescription     N
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'

Correlations (neighbourhood):
             slope  meanPPSF
slope    1.0000000 0.4215165
meanPPSF 0.4215165 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.4648948
meanPPSF    0.4648948 1.0000000
             slope  meanPPSF
slope    1.0000000 0.4067744
meanPPSF 0.4067744 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.3744973
meanPPSF    0.3744973 1.0000000
> 
> q("no")
> proc.time()
   user  system elapsed 
 17.597   0.534  11.184 
