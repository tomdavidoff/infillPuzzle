
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSalesAll.R
> # R to evaluate elasticity of price per square foot among *all* BCA sales by neighbourhood description (not tract as need obs of all types...)
> # Tom Davidoff
> 
> # 01/26/26
> library(data.table)
> library(ggplot2)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19SalesAll.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, 
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019, fSales)
+ } 
> dtBCA2019 <- readRDS(fSales)
> dtBCA2019[, duplexTownhome:=(grepl("uplex", actualUseDescription, ignore.case=TRUE) | actualUseDescription=="Row Housing (Single Unit Ownership)")]
> dtBCA2019[, single:=(actualUseDescription %in% c("Residential Dwelling with Suite","Single Family Dwelling"))]
> print(summary(dtBCA2019))
   folioID          conveyancePrice    conveyanceDate     MB_effective_year 
 Length:347727      Length:347727      Length:347727      Length:347727     
 Class :character   Class :character   Class :character   Class :character  
 Mode  :character   Mode  :character   Mode  :character   Mode  :character  
 MB_total_finished_area  land_width         land_depth       
 Length:347727          Length:347727      Length:347727     
 Class :character       Class :character   Class :character  
 Mode  :character       Mode  :character   Mode  :character  
  land_area         roll_number           zoning          actualUseDescription
 Length:347727      Length:347727      Length:347727      Length:347727       
 Class :character   Class :character   Class :character   Class :character    
 Mode  :character   Mode  :character   Mode  :character   Mode  :character    
 neighbourhoodDescription  postalCode        duplexTownhome    single       
 Length:347727            Length:347727      Mode :logical   Mode :logical  
 Class :character         Class :character   FALSE:317568    FALSE:204806   
 Mode  :character         Mode  :character   TRUE :30159     TRUE :142921   
> 
> print(table(dtBCA2019$actualUseDescription))

  2 Acres Or More (Single Family Dwelling, Duplex) 
                                                77 
       Bed & Breakfast Operation Less Than 4 Units 
                                                 1 
   Duplex, Non-Strata Side by Side or Front / Back 
                                              2109 
                      Duplex, Non-Strata Up / Down 
                                               254 
                       Duplex, Strata Front / Back 
                                              4222 
                       Duplex, Strata Side by Side 
                                              2497 
                          Duplex, Strata Up / Down 
                                               239 
               Individual Strata Lot (Hotel/Motel) 
                                               156 
                         Multi-Family (Conversion) 
                                               116 
                 Property Subject To Section 19(8) 
                                              1283 
                   Residential Dwelling with Suite 
                                             79676 
                      Residential Outbuilding Only 
                                                 6 
               Row Housing (Single Unit Ownership) 
                                             20761 
                            Single Family Dwelling 
                                             63245 
                Strata-Lot Residence (Condominium) 
                                            172206 
             Stratified Operational Facility Areas 
                                                 2 
  Stratified Rental Apartment (Frame Construction) 
                                               485 
Stratified Rental Apartment (Hi-Rise Construction) 
                                                20 
                       Stratified Rental Townhouse 
                                                31 
                                           Triplex 
                                                15 
              Vacant Residential Less Than 2 Acres 
                                               326 
> 
> # Numeric conversion and cleaning
> cols <- c("conveyancePrice", "MB_effective_year", "MB_total_finished_area")
> dtBCA2019[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
> dtBCA2019 <- dtBCA2019[!is.na(MB_total_finished_area) & conveyancePrice > 100000]
> print(dtBCA2019[,mean(is.na(MB_total_finished_area)),by=single])
   single    V1
   <lgcl> <num>
1:   TRUE     0
2:  FALSE     0
> print(summary(dtBCA2019$MB_total_finished_area))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    100     762    1250    1676    2327   28794 
> print(dtBCA2019[,.N,by=c("single","neighbourhoodDescription")])
    single  neighbourhoodDescription     N
    <lgcl>                    <char> <int>
 1:   TRUE                POINT GREY  5791
 2:  FALSE                POINT GREY  1360
 3:   TRUE                 KITSILANO  5129
 4:  FALSE                 KITSILANO 19040
 5:   TRUE                    DUNBAR  7869
 6:  FALSE                    DUNBAR   746
 7:   TRUE ARBUTUS/MACKENZIE HEIGHTS  5538
 8:  FALSE ARBUTUS/MACKENZIE HEIGHTS  2109
 9:   TRUE                KERRISDALE  4817
10:  FALSE                KERRISDALE  2344
11:   TRUE                SOUTHLANDS  3495
12:  FALSE                SOUTHLANDS   164
13:  FALSE                  FAIRVIEW 21276
14:   TRUE                  FAIRVIEW    40
15:   TRUE               SHAUGHNESSY  3555
16:  FALSE               SHAUGHNESSY   828
17:  FALSE                    CAMBIE  3211
18:   TRUE                    CAMBIE  4339
19:   TRUE           SOUTH GRANVILLE  4885
20:  FALSE           SOUTH GRANVILLE   573
21:  FALSE                  OAKRIDGE  2537
22:   TRUE                  OAKRIDGE  2076
23:   TRUE                   MARPOLE  4225
24:  FALSE                   MARPOLE  4901
25:  FALSE            MOUNT PLEASANT 18785
26:   TRUE            MOUNT PLEASANT  2023
27:  FALSE                 GRANDVIEW  7560
28:   TRUE                 GRANDVIEW  4899
29:  FALSE             CEDAR COTTAGE  3490
30:   TRUE             CEDAR COTTAGE  4155
31:   TRUE               MAIN/FRASER  8095
32:  FALSE               MAIN/FRASER  2257
33:   TRUE           SOUTH VANCOUVER  9555
34:  FALSE           SOUTH VANCOUVER   562
35:   TRUE              MARINE DRIVE   126
36:  FALSE              MARINE DRIVE  4841
37:   TRUE                    KNIGHT  7002
38:  FALSE                    KNIGHT   697
39:  FALSE             HASTINGS EAST  1034
40:   TRUE             HASTINGS EAST  6885
41:   TRUE                   RENFREW  4708
42:  FALSE                   RENFREW   929
43:  FALSE           RENFREW HEIGHTS    52
44:   TRUE           RENFREW HEIGHTS  6818
45:   TRUE               COLLINGWOOD  7738
46:  FALSE               COLLINGWOOD  9681
47:   TRUE                 KILLARNEY  7816
48:  FALSE                 KILLARNEY   531
49:   TRUE                FRASERVIEW  4171
50:  FALSE                FRASERVIEW  3777
51:  FALSE                  DOWNTOWN 24138
52:  FALSE                  WEST END 13731
53:   TRUE                  WEST END    40
54:  FALSE                   HARBOUR  3426
55:  FALSE            DOWNTOWN SOUTH 23937
56:   TRUE            DOWNTOWN SOUTH     6
57:  FALSE         FALSE CREEK NORTH 16638
    single  neighbourhoodDescription     N
> 
> # Metrics
> dtBCA2019[, `:=`(
+     age = year(conveyanceDate) - MB_effective_year, 
+     ppsf = conveyancePrice / MB_total_finished_area 
+ )]
> 
> # Outlier removal (global)
> CUT <- 0.05
> dtBCA2019 <- dtBCA2019[
+     age >= 0 &
+     MB_total_finished_area %between% quantile(MB_total_finished_area, c(CUT, 1-CUT)) &
+     ppsf %between% quantile(ppsf, c(CUT, 1-CUT))
+ ]
> 
> cat("BCA 2019 transactions loaded:", nrow(dtBCA2019), "\n")
BCA 2019 transactions loaded: 240759 
> 
> MINYEAR <- 2012
> MEANYEAR <- 2012
> WIDTHCUT <- 0.15
> 
> dtBCA2019 <- dtBCA2019[grepl("RS", zoning)]
> # Exclude Shaughnessy and West End
> dtBCA2019 <- dtBCA2019[!neighbourhoodDescription %chin% c("SHAUGNESSY", "WEST END","SOUTHLANDS")]
> 
> # ==========================================
> # Function to run analysis at a given geographic level
> # ==========================================
> 
> runAnalysis <- function(dt, groupVar, label) {
+   cat("\n==========================================\n")
+   cat("Running analysis at", label, "level\n")
+   cat("==========================================\n")
+   
+ dtAnalysis <- dt
+   
+   
+   # Build formulas dynamically
+   fmlaMain <- as.formula(paste0(
+     "ppsf ~ i(", groupVar, ", MB_total_finished_area) + log(age + 1) + MB_total_finished_area | ", groupVar
+   ))
+ 
+   fmlaLog <- as.formula(paste0(
+     "log(ppsf) ~ i(", groupVar, ", log(MB_total_finished_area)) + log(age + 1) + log(MB_total_finished_area)  | ", groupVar 
+   ))# no main effect for Wald purposes
+   
+ 
+   # Run regressions
+   mainReg <- feols(fmlaMain, data = dtAnalysis)
+   print(r2(mainReg, typ = c("r2", "ar2")))
+   
+   logReg <- feols(fmlaLog, data = dtAnalysis)
+   print(r2(logReg, typ = c("r2", "ar2")))
+ 
+   # Extract slopes
+   dtSlopes <- as.data.table(coeftable(mainReg), keep.rownames = "term")[grepl("MB_total_finished_area", term)]
+   # Extract group identifier from term
+   pattern <- paste0(groupVar, "::(.*):MB_total_finished_area")
+   dtSlopes[, (groupVar) := gsub(pattern, "\\1", term)]
+   
+   # Extract elasticities
+   dtElasticities <- as.data.table(coeftable(logReg), keep.rownames = "term")[grepl("log\\(MB_total_finished_area\\)", term)]
+   patternLog <- paste0(groupVar, "::(.*):log\\(MB_total_finished_area\\)")
+   dtElasticities[, (groupVar) := gsub(patternLog, "\\1", term)]
+   
+   # Compute means
+   dtMeans <- dtAnalysis[year(conveyanceDate) >= MEANYEAR, 
+                         .(meanPPSF = mean(ppsf, na.rm = TRUE), nobs = .N), 
+                         by = groupVar]
+   dtMeanDuplex <- dtAnalysis[year(conveyanceDate) >= MEANYEAR & single==0, .(meanPPSF_duplex = mean(ppsf, na.rm = TRUE), nobs_duplex = .N), by = groupVar]
+   dtMeanSingle <- dtAnalysis[year(conveyanceDate) >= MEANYEAR & single==1, .(meanPPSF_single = mean(ppsf, na.rm = TRUE), nobs_single = .N), by = groupVar]
+   dtMeans <- merge(dtMeans, dtMeanDuplex, by = groupVar, all.x = TRUE)
+   dtMeans <- merge(dtMeans, dtMeanSingle, by = groupVar, all.x = TRUE)
+   
+   # Merge slopes and elasticities
+   dtMeans <- merge(dtMeans, dtSlopes[, c(groupVar, "Estimate"), with = FALSE], by = groupVar, all.x = TRUE)
+   setnames(dtMeans, "Estimate", "slope")
+   dtMeans <- merge(dtMeans, dtElasticities[, c(groupVar, "Estimate"), with = FALSE], by = groupVar, all.x = TRUE)
+   setnames(dtMeans, "Estimate", "elasticity")
+   print(dtAnalysis[year(conveyanceDate) >= MEANYEAR & duplexTownhome==1, .N, by = neighbourhoodDescription][order(N)])
+   
+   # Output
+   fwrite(dtMeans, paste0("tables/bca19_mean_ppsf_slope_All_by_", label, ".csv"))
+   
+   # Plot
+   p <- ggplot(dtMeans[nobs > quantile(nobs, .025) & !is.na(slope)], aes(x = slope, y = meanPPSF)) + 
+     geom_point() + 
+     geom_smooth(method = "lm") + 
+     labs(title = paste("Mean BCA Price per SqFt vs Pricing Slope by", label), 
+          x = "BCA Pricing Slope ($/sqft per sqft)", 
+          y = "Mean Price per SqFt")
+   ggsave(paste0("text/bca19_mean_ppsf_vs_slope_", label, ".png"), plot = p)
+   
+   # Correlations
+   cat("\nCorrelations (", label, "):\n", sep = "")
+   print(cor(dtMeans[!is.na(slope), .(slope, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity), .(elasticity, meanPPSF)]))
+   print(cor(dtMeans[!is.na(slope) & nobs > quantile(nobs, .025), .(slope, meanPPSF)]))
+   print(cor(dtMeans[!is.na(elasticity) & nobs > quantile(nobs, .1), .(elasticity, meanPPSF)]))
+   
+   return(dtMeans)
+ }
> 
> # ==========================================
> # Run analyses
> # ==========================================
> 
> dtResultsNbhd <- runAnalysis(copy(dtBCA2019), "neighbourhoodDescription", "neighbourhood")

==========================================
Running analysis at neighbourhood level
==========================================
        r2        ar2 
0.04970327 0.04902677 
The variable 'log(MB_total_finished_area)' has been removed because of collinearity (see $collin.var).
        r2        ar2 
0.04284548 0.04217925 
    neighbourhoodDescription     N
                      <char> <int>
 1:              MAIN/FRASER     1
 2:              SHAUGHNESSY     2
 3:                GRANDVIEW     2
 4:               POINT GREY     3
 5:                KILLARNEY     3
 6:                   CAMBIE     4
 7:                  MARPOLE     4
 8:            HASTINGS EAST     4
 9:            CEDAR COTTAGE     5
10:                KITSILANO     6
11:               FRASERVIEW    31
Saving 7 x 7 in image
`geom_smooth()` using formula = 'y ~ x'

Correlations (neighbourhood):
             slope  meanPPSF
slope    1.0000000 0.7074571
meanPPSF 0.7074571 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.7710183
meanPPSF    0.7710183 1.0000000
             slope  meanPPSF
slope    1.0000000 0.7180622
meanPPSF 0.7180622 1.0000000
           elasticity  meanPPSF
elasticity  1.0000000 0.7561551
meanPPSF    0.7561551 1.0000000
> 
> q("no")
> proc.time()
   user  system elapsed 
  6.724   1.683   3.389 
