
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSalesAll.R
> # R to evaluate elasticity of price per square foot among *all* BCA sales by census tract
> # Tom Davidoff
> 
> # 01/26/26
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(ggplot2)
> library(sf)
Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> BCA26 <- "/Volumes/T7Office/bigFiles/bca_folios.gpkg"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> fRollLatLon <- "~/OneDrive - UBC/dataProcessed/bca26RollCensusTractAll.rds"
> fLaneway <-  "~/OneDrive - UBC/dataRaw/20231231_UBC_CustomLanewayReport.xlsx"
> 
> # drop duplex
> if (!file.exists(fRollLatLon)) {
+   cat("Extracting lot centroids from BCA 2026 data...\n")
+   desc26 <- st_read(BCA26,
+       layer="WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV",
+       query = "SELECT ROLL_NUMBER, geom FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV WHERE JURISDICTION_CODE=='200' ", 
+       quiet = TRUE
+   )
+   print(head(desc26))
+   stDesc <- st_crs(desc26)
+   roll_pt <- st_point_on_surface(desc26)
+   # convert geom to centroid
+   # --- 2021 Census Tracts (cartographic) via download
+   ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
+   sCT <- st_read(ct_file, quiet = TRUE)
+   sCT <- st_make_valid(sCT)
+   sCT <- st_transform(sCT, stDesc)
+ 
+   roll_ct <- st_join(roll_pt, sCT[, c("CTUID", "DGUID", "CTNAME", "PRUID")], join = st_within, left = TRUE)
+   print(head(roll_ct))
+   saveRDS(roll_ct, fRollLatLon)
+ }
Extracting lot centroids from BCA 2026 data...
Simple feature collection with 6 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 1203371 ymin: 476706.6 xmax: 1204628 ymax: 477155.1
Projected CRS: NAD83 / BC Albers
      ROLL_NUMBER                           geom
1 001630024560000 POLYGON ((1203371 477104.1,...
2 001630024660000 POLYGON ((1203408 477104.6,...
3 001630033120000 POLYGON ((1204517 476707.5,...
4 001630033160000 POLYGON ((1204545 476751, 1...
5 001630033420000 POLYGON ((1204543 476807, 1...
6 001630033470000 POLYGON ((1204485 476811.5,...
Simple feature collection with 6 features and 5 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 1203380 ymin: 476762.9 xmax: 1204571 ymax: 477127.3
Projected CRS: NAD83 / BC Albers
      ROLL_NUMBER      CTUID               DGUID  CTNAME PRUID
1 001630024560000 9330044.00 2021S05079330044.00 0044.00    59
2 001630024660000 9330044.00 2021S05079330044.00 0044.00    59
3 001630033120000 9330044.00 2021S05079330044.00 0044.00    59
4 001630033160000 9330044.00 2021S05079330044.00 0044.00    59
5 001630033420000 9330044.00 2021S05079330044.00 0044.00    59
6 001630033470000 9330044.00 2021S05079330044.00 0044.00    59
                      geom
1 POINT (1203380 477124.5)
2 POINT (1203398 477127.3)
3 POINT (1204501 476762.9)
4 POINT (1204529 476781.5)
5 POINT (1204571 476788.4)
6 POINT (1204554 476911.3)
Warning messages:
1: In CPL_read_ogr(dsn, layer, query, as.character(options), quiet,  :
  argument layer is ignored when query is specified
2: st_point_on_surface assumes attributes are constant over geometries 
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19SalesAll.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.land_width, i.land_depth, i.land_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, a.postalCode
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019, fSales)
+ } 
Extracting BCA 2019 sales data...
> dtBCA2019 <- readRDS(fSales)
> print(head(dtBCA2019))
      folioID conveyancePrice conveyanceDate MB_effective_year
       <char>          <char>         <char>            <char>
1: A000000009         9450000     2014-06-16              2019
2: A00000000A         8800000     2013-02-08              1997
3: A00000000A         1700000     1991-07-09              1997
4: A00000000B         3850000     2006-12-04              1945
5: A00000000B          190000     1977-04-15              1945
6: A00000000C         2308000     1991-09-03              2011
   MB_total_finished_area land_width land_depth land_area     roll_number
                   <char>     <char>     <char>    <char>          <char>
1:                  11895                                 001019632060000
2:                   7760        195      251.9           001019632290000
3:                   7760        195      251.9           001019632290000
4:                   3215        150        250           001019632450000
5:                   3215        150        250           001019632450000
6:                   8673        150        250           001019632650000
   zoning   actualUseDescription neighbourhoodDescription postalCode
   <char>                 <char>                   <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6T 1A9
2:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
3:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
4:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
5:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
6:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
> 
> # merge back with census tract on roll number/1000
> dtRollLatLon <- as.data.table(readRDS(fRollLatLon))
> dtBCA2019[, roll_base := floor(as.numeric(roll_number) / 1000)]
> dtRollLatLon[, roll_base := floor(as.numeric(ROLL_NUMBER) / 1000)]
> dtBCA2019 <- merge(dtBCA2019, dtRollLatLon[, .(roll_base, CTUID, DGUID, CTNAME)], by = "roll_base", all.x = TRUE)
Error in vecseq(f__, len__, if (allow.cartesian || notjoin || !anyDuplicated(f__,  : 
  Join results in 28272950 rows; more than 564909 = nrow(x)+nrow(i). Check for duplicate key values in i each of which join to the same group in x over and over again. If that's ok, try by=.EACHI to run j for each group to avoid the large allocation. If you are sure you wish to proceed, rerun with allow.cartesian=TRUE. Otherwise, please search for this error message in the FAQ, Wiki, Stack Overflow and data.table issue tracker for advice.
Calls: merge -> merge.data.table -> [ -> [.data.table -> vecseq
Execution halted
