
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSalesAll.R
> # R to evaluate elasticity of price per square foot among *all* BCA sales by census tract
> # Tom Davidoff
> 
> # 01/26/26
> library(data.table)
> library(ggplot2)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> 
> BCA19    <- "~/OneDrive - UBC/dataRaw/REVD19_and_inventory_extracts.sqlite3"
> BCA26 <- "/Volumes/T7Office/bigFiles/bca_folios.gpkg"
> 
> # use 2026 data to get floor(roll number/1000) to get lot polygons -> centroid , maybe zoning 
> fRollLatLon <- "~/OneDrive - UBC/dataProcessed/bca26RollCensusTractAll.rds"
> fLaneway <-  "~/OneDrive - UBC/dataRaw/20231231_UBC_CustomLanewayReport.xlsx"
> 
> # drop duplex
> if (!file.exists(fRollLatLon)) {
+   cat("Extracting lot centroids from BCA 2026 data...\n")
+   desc26 <- st_read(BCA26,
+       layer="WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV",
+       query = "SELECT ROLL_NUMBER, geom FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_DESCRIPTIONS_SV WHERE JURISDICTION_CODE=='200' ", 
+       quiet = TRUE
+   )
+   print(head(desc26))
+   stDesc <- st_crs(desc26)
+   roll_pt <- st_point_on_surface(desc26)
+   # convert geom to centroid
+   # --- 2021 Census Tracts (cartographic) via download
+   ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
+   sCT <- st_read(ct_file, quiet = TRUE)
+   sCT <- st_make_valid(sCT)
+   sCT <- st_transform(sCT, stDesc)
+ 
+   roll_ct <- st_join(roll_pt, sCT[, c("CTUID", "DGUID", "CTNAME", "PRUID")], join = st_within, left = TRUE)
+   print(head(roll_ct))
+   saveRDS(roll_ct, fRollLatLon)
+ }
> 
> # Load BCA 2019 sales data (all residential)
> fSales <- "~/OneDrive - UBC/dataProcessed/bca19SalesAll.rds"
> if (!file.exists(fSales)) {
+   cat("Extracting BCA 2019 sales data...\n")
+   db <- dbConnect(SQLite(), BCA19)
+   dtBCA2019 <- as.data.table(dbGetQuery(db, "
+       SELECT s.folioID, s.conveyancePrice, s.conveyanceDate,
+              i.MB_effective_year, i.MB_total_finished_area, i.land_width, i.land_depth, i.land_area, i.roll_number, i.zoning,
+              d.actualUseDescription, d.neighbourhoodDescription, a.postalCode
+       FROM sales s
+       JOIN folio f ON s.folioID = f.folioID
+       JOIN residentialInventory i ON f.rollNumber = i.roll_number
+       JOIN folioDescription d ON f.folioID = d.folioID
+       JOIN address a ON f.folioID = a.folioID
+       WHERE s.conveyanceTypeDescription = 'Improved Single Property Transaction'
+         AND i.jurisdiction = 200
+   "))
+   dbDisconnect(db)
+   saveRDS(dtBCA2019, fSales)
+ } 
> dtBCA2019 <- readRDS(fSales)
> print(head(dtBCA2019))
      folioID conveyancePrice conveyanceDate MB_effective_year
       <char>          <char>         <char>            <char>
1: A000000009         9450000     2014-06-16              2019
2: A00000000A         8800000     2013-02-08              1997
3: A00000000A         1700000     1991-07-09              1997
4: A00000000B         3850000     2006-12-04              1945
5: A00000000B          190000     1977-04-15              1945
6: A00000000C         2308000     1991-09-03              2011
   MB_total_finished_area land_width land_depth land_area     roll_number
                   <char>     <char>     <char>    <char>          <char>
1:                  11895                                 001019632060000
2:                   7760        195      251.9           001019632290000
3:                   7760        195      251.9           001019632290000
4:                   3215        150        250           001019632450000
5:                   3215        150        250           001019632450000
6:                   8673        150        250           001019632650000
   zoning   actualUseDescription neighbourhoodDescription postalCode
   <char>                 <char>                   <char>     <char>
1:    RS1 Single Family Dwelling               POINT GREY    V6T 1A9
2:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
3:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
4:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
5:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
6:    RS1 Single Family Dwelling               POINT GREY    V6T 1B2
> 
> # merge back with census tract on roll number/1000
> dtRollLatLon <- as.data.table(readRDS(fRollLatLon))
> dtBCA2019[, roll_base := floor(as.numeric(roll_number) / 1000)]
> dtRollLatLon[, roll_base := floor(as.numeric(ROLL_NUMBER) / 1000)]
> # print variance of as.numeric CTUID within roll_base to check
> dTest <- dtRollLatLon[, .(nCTUID = uniqueN(CTUID),nGeom=uniqueN(geom)), by = roll_base]
Error in uniqueN(geom) : 
  x must be an atomic vector or a data.frame/data.table
Calls: [ ... [.data.table -> uniqueN -> stopf -> raise_condition -> signal
Execution halted
