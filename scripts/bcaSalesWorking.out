
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSales.R
> # R to use 2019 sales to get census-tract level coefficients on duplex vs single family and also square footage coefficients on ppsf
> # Tom Davidoff
> # 01/14/26
> 
> # strategy:
> # Get 2026 roll centroids, merge on roll/1000 (for subdivisions), confirm coverage for 2019 sales data (through 2018)
> # merge with census tract centroids
> # Regress coefficients, etc.
> 
> library(data.table)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(ggplot2)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> library(geosphere)
> library(nnet)
> 
> # per google
> latDowntown <- 49.2827
> lonDowntown <- -123.1207
> WIDTHTOL <- .10
> MAXAGE <- 25
> MINOBS <- 20
> 
> centroidsFile <- "~/OneDrive - UBC/dataProcessed/bca25Centroids.rds"
> print(centroidsFile)
[1] "~/OneDrive - UBC/dataProcessed/bca25Centroids.rds"
> print(file.exists(centroidsFile))
[1] TRUE
> if (!file.exists(centroidsFile)) {
+   source("scripts/getBCAVancouverCentroids.R")
+ }
> dtCentroids <- readRDS(centroidsFile)
> # add to data.table
> 
> dtInventory <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/Residential_inventory_202501/20250101_A09_Residential_Inventory_Extract.txt",select=c("Roll_Number","MB_Total_Finished_Area","Zoning","Land_Width_Width","Land_Depth_Depth","MB_Effective_Year"),colClasses=c(Roll_Number="character",MB_Total_Finished_Area="numeric",Zoning="character",Land_Width_Width="numeric",Land_Depth_Depth="numeric"))
> print(head(dtInventory))
       Roll_Number MB_Total_Finished_Area Zoning Land_Width_Width
            <char>                  <num> <char>            <num>
1: 001019632060000                  11895   R1-1               NA
2: 001019632290000                   7760   R1-1              195
3: 001019632450000                   3215   R1-1              150
4: 001019632650000                   8673   R1-1              150
5: 001019632760000                   2942   R1-1              170
6: 001019635070000                   4739   R1-1              170
   Land_Depth_Depth MB_Effective_Year
              <num>             <int>
1:                0              2020
2:              252              1997
3:              250              1945
4:              250              2011
5:              215              2022
6:              219              1995
> dtSales <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_sales_20250331_REVD25.csv",select=c("ROLL_NUMBER","FOLIO_ID","CONVEYANCE_DATE","CONVEYANCE_PRICE","CONVEYANCE_TYPE_DESCRIPTION"))
> dtSales <- dtSales[CONVEYANCE_TYPE_DESCRIPTION=="Improved Single Property Transaction"]
> dtSales[,saleYear:=as.numeric(substring(CONVEYANCE_DATE,1,4))]
> print(head(dtSales))
       ROLL_NUMBER   FOLIO_ID CONVEYANCE_DATE CONVEYANCE_PRICE
            <char>     <char>           <i64>            <int>
1: 001029650840000 A000000045  20080415000000          2775000
2: 001029650840000 A000000045  19880830000000           570000
3: 001029650840000 A000000045  19830127000000           266000
4: 001029650870000 A000000046  20121031000000          2698000
5: 001029650950000 A000000047  19771115000000           111500
6: 001030683570000 A00000004C  19950427000000           751000
            CONVEYANCE_TYPE_DESCRIPTION saleYear
                                 <char>    <num>
1: Improved Single Property Transaction     2008
2: Improved Single Property Transaction     1988
3: Improved Single Property Transaction     1983
4: Improved Single Property Transaction     2012
5: Improved Single Property Transaction     1977
6: Improved Single Property Transaction     1995
> MINYEAR <- 2012
> MAXYEAR <- 2018
> dtSales <- dtSales[saleYear>=MINYEAR & saleYear<=MAXYEAR]
> dtDescription <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_descriptions_20250331_REVD25.csv",select=c("FOLIO_ID","ROLL_NUMBER","ACTUAL_USE_DESCRIPTION","NEIGHBOURHOOD","JURISDICTION_CODE"))
> dtDescription <- dtDescription[JURISDICTION_CODE==200]
> dtMerge <- merge(dtDescription,dtCentroids,by="ROLL_NUMBER")
> dtMerge <- merge(dtMerge,dtInventory,by.x="ROLL_NUMBER",by.y="Roll_Number")
> print(nrow(dtMerge))
[1] 199693
> dtMerge <- merge(dtMerge,dtSales,by="ROLL_NUMBER")
> # order by frequency
> print(table(dtMerge[,ACTUAL_USE_DESCRIPTION])[order(table(dtMerge[,ACTUAL_USE_DESCRIPTION]),decreasing=TRUE)])

                Strata-Lot Residence (Condominium) 
                                             51652 
                   Residential Dwelling with Suite 
                                             11182 
                            Single Family Dwelling 
                                              8018 
               Row Housing (Single Unit Ownership) 
                                              5151 
                       Duplex, Strata Front / Back 
                                              1076 
                       Duplex, Strata Side by Side 
                                               545 
   Duplex, Non-Strata Side by Side or Front / Back 
                                               145 
                          Duplex, Strata Up / Down 
                                                50 
              Vacant Residential Less Than 2 Acres 
                                                36 
  Stratified Rental Apartment (Frame Construction) 
                                                32 
                      Duplex, Non-Strata Up / Down 
                                                27 
                 Property Subject To Section 19(8) 
                                                13 
                                           Triplex 
                                                 8 
  2 Acres Or More (Single Family Dwelling, Duplex) 
                                                 7 
Stratified Rental Apartment (Hi-Rise Construction) 
                                                 5 
       Bed & Breakfast Operation Less Than 4 Units 
                                                 3 
                     2 Acres Or More (Outbuilding) 
                                                 1 
                      Residential Outbuilding Only 
                                                 1 
                       Stratified Rental Townhouse 
                                                 1 
> dtMerge <- dtMerge[ACTUAL_USE_DESCRIPTION %in% c("Strata-Lot Residence (Condominium)", "Residential Dwelling with Suite", "Single Family Dwelling", "Row Housing (Single Unit Ownership)") | grepl("Duplex",ACTUAL_USE_DESCRIPTION)]
> # first question: among single family homes are neighbourhoods relevant?
> dtMerge[,age:=saleYear-MB_Effective_Year]
> # citywide optimal square feet?
> 
> dtMerge[,distDowntown:=distGeo(cbind(lon,lat),c(lonDowntown,latDowntown))]
> regValue1 <- feols(log(CONVEYANCE_PRICE) ~ log(MB_Total_Finished_Area) + log(age+1) +lon*distDowntown|saleYear^ACTUAL_USE_DESCRIPTION,data=dtMerge )
NOTE: 4,197 observations removed because of NA and infinite values (LHS: 1, RHS: 4,196).
Warning message:
In log(age + 1) : NaNs produced
> regValue2 <- feols(log(CONVEYANCE_PRICE) ~ log(MB_Total_Finished_Area) + log(age+1) +lon*distDowntown + i(NEIGHBOURHOOD)|saleYear^ACTUAL_USE_DESCRIPTION,data=dtMerge )
NOTE: 4,197 observations removed because of NA and infinite values (LHS: 1, RHS: 4,196).
Warning message:
In log(age + 1) : NaNs produced
> # add census tract merge from Lon/Lat
> ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
> sCT <- st_read(ct_file, quiet = TRUE)
> sCT <- st_make_valid(sCT)
> 
> # turn lon/lat into a spatial point, then merge with census tract geometry as a spatial merge
> # plain vanilla crs lat lon
> sMerge <- st_as_sf(dtMerge, coords = c("lon", "lat"),crs=4326)
> sMerge <- st_transform(sMerge, crs = st_crs(sCT))
> sMerge <- st_join(sMerge, sCT, left = TRUE)
> # reconvert to better crs and get lon/lat familiarly
> sMerge <- st_transform(sMerge, crs = 4326)
> sMerge$lon <- st_coordinates(sMerge)[,1]
> sMerge$lat <- st_coordinates(sMerge)[,2]
> df <- as.data.table(sMerge)
> print(nrow(df))
[1] 77853
> print(nrow(df))
[1] 77853
> regValue3 <- feols(log(CONVEYANCE_PRICE) ~ log(MB_Total_Finished_Area) + log(age+1) +lon*distDowntown |saleYear^ACTUAL_USE_DESCRIPTION + CTNAME,data=df )
NOTE: 4,197 observations removed because of NA and infinite values (LHS: 1, RHS: 4,196).
Warning message:
In log(age + 1) : NaNs produced
> regValue4 <- feols(log(CONVEYANCE_PRICE) ~ log(MB_Total_Finished_Area) + log(age+1) |saleYear^ACTUAL_USE_DESCRIPTION + CTNAME,data=df )
NOTE: 4,197 observations removed because of NA and infinite values (LHS: 1, RHS: 4,196).
Warning message:
In log(age + 1) : NaNs produced
> # print etable with adjusted r2
> print(etable(regValue1,regValue2,regValue3,regValue4,fitstat="ar2"))
                                            regValue1             regValue2
Dependent Var.:                 log(CONVEYANCE_PRICE) log(CONVEYANCE_PRICE)
                                                                           
log(MB_Total_Finished_Area)         1.124*** (0.0275)     1.071*** (0.0311)
log(age+1)                        -0.0403*** (0.0111)    -0.0358** (0.0111)
lon                                -5.394*** (0.3731)     -9.232*** (1.021)
distDowntown                       0.0446*** (0.0068)    0.0805*** (0.0150)
lon x distDowntown                0.0004*** (5.56e-5)    0.0007*** (0.0001)
NEIGHBOURHOOD = Cambie                                     0.0988* (0.0435)
NEIGHBOURHOOD = CedarCottage                              0.1605** (0.0507)
NEIGHBOURHOOD = CoalHarbour                              0.4580*** (0.0374)
NEIGHBOURHOOD = Collingwood                              0.3261*** (0.0621)
NEIGHBOURHOOD = Downtown                                    0.0440 (0.0421)
NEIGHBOURHOOD = DowntownSouth                              -0.0086 (0.0319)
NEIGHBOURHOOD = Dunbar                                     -0.0006 (0.0226)
NEIGHBOURHOOD = Fairview                                  -0.0512* (0.0226)
NEIGHBOURHOOD = FalseCreekNorth                           0.1296** (0.0382)
NEIGHBOURHOOD = Fraserview                               0.2198*** (0.0568)
NEIGHBOURHOOD = Grandview                                0.2194*** (0.0612)
NEIGHBOURHOOD = HastingsEast                             0.2654*** (0.0654)
NEIGHBOURHOOD = Kerrisdale                                0.0578** (0.0217)
NEIGHBOURHOOD = Killarney                                0.2811*** (0.0526)
NEIGHBOURHOOD = Kitsilano                               -0.1276*** (0.0171)
NEIGHBOURHOOD = Knight                                     0.1338* (0.0565)
NEIGHBOURHOOD = Main&Fraser                                0.1042* (0.0505)
NEIGHBOURHOOD = MarineDrive                              0.2961*** (0.0572)
NEIGHBOURHOOD = Marpole                                  0.2017*** (0.0370)
NEIGHBOURHOOD = MountPleasant                               0.0735 (0.0464)
NEIGHBOURHOOD = Oakridge                                 0.2055*** (0.0308)
NEIGHBOURHOOD = PointGrey                                   0.0435 (0.0352)
NEIGHBOURHOOD = Renfrew                                   0.1742** (0.0634)
NEIGHBOURHOOD = RenfrewHeights                           0.2814*** (0.0589)
NEIGHBOURHOOD = Shaughnessy                              0.1824*** (0.0408)
NEIGHBOURHOOD = SouthGranville                           0.1736*** (0.0298)
NEIGHBOURHOOD = SouthVancouver                             0.0918* (0.0437)
NEIGHBOURHOOD = Southlands                               0.0940*** (0.0263)
NEIGHBOURHOOD = WestEnd                                 -0.0892*** (0.0244)
Fixed-Effects:                  --------------------- ---------------------
saleYear-ACTUAL_USE_DESCRIPTION                   Yes                   Yes
CTNAME                                             No                    No
_______________________________ _____________________ _____________________
S.E.: Clustered                 by: saleYear-ACTUAL.. by: saleYear-ACTUAL..
Adj. R2                                       0.90713               0.91701

                                            regValue3             regValue4
Dependent Var.:                 log(CONVEYANCE_PRICE) log(CONVEYANCE_PRICE)
                                                                           
log(MB_Total_Finished_Area)         1.073*** (0.0305)     1.076*** (0.0303)
log(age+1)                         -0.0324** (0.0107)    -0.0304** (0.0110)
lon                                     2.088 (1.422)                      
distDowntown                      -0.1004*** (0.0253)                      
lon x distDowntown                -0.0008*** (0.0002)                      
NEIGHBOURHOOD = Cambie                                                     
NEIGHBOURHOOD = CedarCottage                                               
NEIGHBOURHOOD = CoalHarbour                                                
NEIGHBOURHOOD = Collingwood                                                
NEIGHBOURHOOD = Downtown                                                   
NEIGHBOURHOOD = DowntownSouth                                              
NEIGHBOURHOOD = Dunbar                                                     
NEIGHBOURHOOD = Fairview                                                   
NEIGHBOURHOOD = FalseCreekNorth                                            
NEIGHBOURHOOD = Fraserview                                                 
NEIGHBOURHOOD = Grandview                                                  
NEIGHBOURHOOD = HastingsEast                                               
NEIGHBOURHOOD = Kerrisdale                                                 
NEIGHBOURHOOD = Killarney                                                  
NEIGHBOURHOOD = Kitsilano                                                  
NEIGHBOURHOOD = Knight                                                     
NEIGHBOURHOOD = Main&Fraser                                                
NEIGHBOURHOOD = MarineDrive                                                
NEIGHBOURHOOD = Marpole                                                    
NEIGHBOURHOOD = MountPleasant                                              
NEIGHBOURHOOD = Oakridge                                                   
NEIGHBOURHOOD = PointGrey                                                  
NEIGHBOURHOOD = Renfrew                                                    
NEIGHBOURHOOD = RenfrewHeights                                             
NEIGHBOURHOOD = Shaughnessy                                                
NEIGHBOURHOOD = SouthGranville                                             
NEIGHBOURHOOD = SouthVancouver                                             
NEIGHBOURHOOD = Southlands                                                 
NEIGHBOURHOOD = WestEnd                                                    
Fixed-Effects:                  --------------------- ---------------------
saleYear-ACTUAL_USE_DESCRIPTION                   Yes                   Yes
CTNAME                                            Yes                   Yes
_______________________________ _____________________ _____________________
S.E.: Clustered                 by: saleYear-ACTUAL.. by: saleYear-ACTUAL..
Adj. R2                                       0.92160               0.92065
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> df[,propertyType:=ifelse(ACTUAL_USE_DESCRIPTION %chin% c("Single Family Dwelling","Residential Dwelling with Suite"),"single",ifelse(grepl("Duplex,",ACTUAL_USE_DESCRIPTION),"duplex",ifelse(ACTUAL_USE_DESCRIPTION=="Row Housing (Single Unit Ownership)","TH","condo")))]
> df <- df[propertyType!="single" | Zoning=="R1-1"]
> df[,single:=propertyType=="single"]
> df[,ppsf:=CONVEYANCE_PRICE/MB_Total_Finished_Area]
> df <- df[!is.na(ppsf)]
> EXTREME_VAL <- .005
> minVal <- quantile(df[,ppsf], EXTREME_VAL)
> maxVal <- quantile(df[,ppsf], 1-EXTREME_VAL)
> df <- df[ppsf %between% c(minVal,maxVal)]
> print(summary(df))
 ROLL_NUMBER         FOLIO_ID.x        ACTUAL_USE_DESCRIPTION
 Length:74706       Length:74706       Length:74706          
 Class :character   Class :character   Class :character      
 Mode  :character   Mode  :character   Mode  :character      
                                                             
                                                             
                                                             
                                                             
 NEIGHBOURHOOD      JURISDICTION_CODE MB_Total_Finished_Area    Zoning         
 Length:74706       Min.   :200       Min.   :  329          Length:74706      
 Class :character   1st Qu.:200       1st Qu.:  651          Class :character  
 Mode  :character   Median :200       Median :  911          Mode  :character  
                    Mean   :200       Mean   : 1365                            
                    3rd Qu.:200       3rd Qu.: 1642                            
                    Max.   :200       Max.   :25164                            
                                                                               
 Land_Width_Width Land_Depth_Depth MB_Effective_Year  FOLIO_ID.y       
 Min.   : 16.00   Min.   :  0.00   Min.   :   0      Length:74706      
 1st Qu.: 33.00   1st Qu.:  0.00   1st Qu.:1994      Class :character  
 Median : 34.00   Median :  0.00   Median :2006      Mode  :character  
 Mean   : 42.62   Mean   : 29.91   Mean   :2002                        
 3rd Qu.: 50.00   3rd Qu.:  0.00   3rd Qu.:2014                        
 Max.   :330.00   Max.   :573.00   Max.   :2024                        
 NA's   :56495                     NA's   :1                           
 CONVEYANCE_DATE          CONVEYANCE_PRICE   CONVEYANCE_TYPE_DESCRIPTION
 Min.   :20120103000000   Min.   :   92607   Length:74706               
 1st Qu.:20140203000000   1st Qu.:  435000   Class :character           
 Median :20150903000000   Median :  667000   Mode  :character           
 Mean   :20151713121797   Mean   : 1031658                              
 3rd Qu.:20170316000000   3rd Qu.: 1200000                              
 Max.   :20181231000000   Max.   :24500000                              
                                                                        
    saleYear         age           distDowntown        CTUID          
 Min.   :2012   Min.   : -12.00   Min.   :  169.3   Length:74706      
 1st Qu.:2014   1st Qu.:   1.00   1st Qu.: 1243.3   Class :character  
 Median :2015   Median :   9.00   Median : 3160.6   Mode  :character  
 Mean   :2015   Mean   :  13.43   Mean   : 3883.1                     
 3rd Qu.:2017   3rd Qu.:  21.00   3rd Qu.: 6178.6                     
 Max.   :2018   Max.   :2018.00   Max.   :10819.7                     
                NA's   :1                                             
    DGUID              CTNAME             LANDAREA         PRUID          
 Length:74706       Length:74706       Min.   :0.1238   Length:74706      
 Class :character   Class :character   1st Qu.:0.3375   Class :character  
 Mode  :character   Mode  :character   Median :0.6813   Mode  :character  
                                       Mean   :0.8434                     
                                       3rd Qu.:1.2593                     
                                       Max.   :4.0575                     
                                                                          
          geometry          lon              lat        propertyType      
 POINT        :74706   Min.   :-123.2   Min.   :49.20   Length:74706      
 epsg:4326    :    0   1st Qu.:-123.1   1st Qu.:49.24   Class :character  
 +proj=long...:    0   Median :-123.1   Median :49.26   Mode  :character  
                       Mean   :-123.1   Mean   :49.26                     
                       3rd Qu.:-123.1   3rd Qu.:49.28                     
                       Max.   :-123.0   Max.   :49.29                     
                                                                          
   single             ppsf       
 Mode :logical   Min.   : 259.7  
 FALSE:58309     1st Qu.: 564.9  
 TRUE :16397     Median : 694.6  
                 Mean   : 745.9  
                 3rd Qu.: 881.1  
                 Max.   :1949.9  
                                 
> # turn the below into a regression
> df[,roundSQFT:=round(MB_Total_Finished_Area/200)]
> MINSQFT <- .25*.8*33*122
> MAXSQFT <- 1.5*.8*33*122
> MINWIDTH <- 30
> MAXWIDTH <- 35 # over half of properties
> df <- df[Land_Width_Width %between% c(MINWIDTH,MAXWIDTH)]
> df <- df[MB_Total_Finished_Area %between% c(MINSQFT,MAXSQFT)]
> df[,sfk:=MB_Total_Finished_Area/1000]
> df <- df[propertyType %chin% c("condo","TH")==FALSE] # apples to apples!
> ONTARIOLON <- -123.105 # google
> df[,east:=lon>ONTARIOLON]
> # functional form
> # Automate some of this code
> library(data.table)
> library(fixest)
> 
> setDT(df)
> df[, single := propertyType == "single"]
> 
> 
> setDT(df)
> 
> # precompute raw polynomial terms as plain numeric columns
> df[, `:=`(
+   sfk1 = sfk,
+   sfk2 = sfk^2,
+   sfk3 = sfk^3,
+   single = propertyType == "single"
+ )]
> 
> gvars <- c("east", "NEIGHBOURHOOD", "CTNAME")
> fes   <- "saleYear + age + CTNAME"
> 
> run_triplet <- function(dt, y, x, gvars, fes) {
+   sapply(gvars, function(g) {
+     fml <- as.formula(sprintf("%s ~ (%s)*i(%s) | %s", y, x, g, fes))
+     fitstat(feols(fml, data = dt), "war2")
+   })
+ }
> 
> specs <- list(
+   cubic  = list(dt = df[age < MAXAGE], y = "ppsf",      x = "sfk1 + sfk2 + sfk3"),
+   loglog = list(dt = df[age < MAXAGE], y = "log(ppsf)", x = "log(sfk)"),
+   linear = list(dt = df[age < MAXAGE], y = "ppsf",      x = "sfk"),
+   single = list(dt = df[age < 20],     y = "ppsf",      x = "single")
+ )
> 
> war2_mat <- do.call(rbind, lapply(specs, function(s)
+   run_triplet(s$dt, s$y, s$x, gvars, fes)
+ ))
The variables 'sfk1:east::TRUE' and 'sfk3:east::TRUE' have been removed because of collinearity (see $collin.var).
The variables 'NEIGHBOURHOOD::Fairview', 'NEIGHBOURHOOD::Fraserview', 'NEIGHBOURHOOD::Point Grey', 'NEIGHBOURHOOD::West End', 'sfk1:NEIGHBOURHOOD::Fairview', 'sfk1:NEIGHBOURHOOD::Southlands' and 8 others have been removed because of collinearity (see $collin.var).
The variables 'CTNAME::0002.03', 'CTNAME::0002.04', 'CTNAME::0003.01', 'CTNAME::0003.02', 'CTNAME::0004.01', 'CTNAME::0004.02' and 98 others have been removed because of collinearity (see $collin.var).
The variable 'log(sfk):east::TRUE' has been removed because of collinearity (see $collin.var).
The variables 'NEIGHBOURHOOD::Fairview', 'NEIGHBOURHOOD::Fraserview', 'NEIGHBOURHOOD::Point Grey', 'NEIGHBOURHOOD::West End', 'log(sfk):NEIGHBOURHOOD::Fairview', 'log(sfk):NEIGHBOURHOOD::Southlands' and 'log(sfk):NEIGHBOURHOOD::West End' have been removed because of collinearity (see $collin.var).
The variables 'CTNAME::0002.03', 'CTNAME::0002.04', 'CTNAME::0003.01', 'CTNAME::0003.02', 'CTNAME::0004.01', 'CTNAME::0004.02' and 83 others have been removed because of collinearity (see $collin.var).
The variable 'sfk:east::TRUE' has been removed because of collinearity (see $collin.var).
The variables 'NEIGHBOURHOOD::Fairview', 'NEIGHBOURHOOD::Fraserview', 'NEIGHBOURHOOD::Point Grey', 'NEIGHBOURHOOD::West End', 'sfk:NEIGHBOURHOOD::Fairview', 'sfk:NEIGHBOURHOOD::Southlands' and 'sfk:NEIGHBOURHOOD::West End' have been removed because of collinearity (see $collin.var).
The variables 'CTNAME::0002.03', 'CTNAME::0002.04', 'CTNAME::0003.01', 'CTNAME::0003.02', 'CTNAME::0004.01', 'CTNAME::0004.02' and 83 others have been removed because of collinearity (see $collin.var).
The variables 'singleTRUE:east::FALSE', 'singleFALSE:east::TRUE' and 'singleTRUE:east::TRUE' have been removed because of collinearity (see $collin.var).
The variables 'NEIGHBOURHOOD::Fairview', 'NEIGHBOURHOOD::Fraserview', 'NEIGHBOURHOOD::Point Grey', 'NEIGHBOURHOOD::West End', 'singleTRUE:NEIGHBOURHOOD::Arbutus Ridge - Mackenzie Heights', 'singleTRUE:NEIGHBOURHOOD::Cambie' and 35 others have been removed because of collinearity (see $collin.var).
The variables 'CTNAME::0002.03', 'CTNAME::0002.04', 'CTNAME::0003.01', 'CTNAME::0003.02', 'CTNAME::0004.01', 'CTNAME::0004.02' and 209 others have been removed because of collinearity (see $collin.var).
> df[,lsqft := log(MB_Total_Finished_Area)]
> regT <- feols(log(ppsf) ~ 0+ lsqft*i(CTNAME) | saleYear + age +CTNAME, data=df[age<MAXAGE])
The variables 'CTNAME::0002.03', 'CTNAME::0002.04', 'CTNAME::0003.01', 'CTNAME::0003.02', 'CTNAME::0004.01', 'CTNAME::0004.02' and 82 others have been removed because of collinearity (see $collin.var).
> regN <- feols(log(CONVEYANCE_PRICE) ~ 0+ lsqft*i(NEIGHBOURHOOD) | saleYear + age +NEIGHBOURHOOD, data=df[age<MAXAGE])
The variables 'NEIGHBOURHOOD::Cambie', 'NEIGHBOURHOOD::Cedar Cottage', 'NEIGHBOURHOOD::Collingwood', 'NEIGHBOURHOOD::Dunbar', 'NEIGHBOURHOOD::Fairview', 'NEIGHBOURHOOD::Fraserview' and 21 others have been removed because of collinearity (see $collin.var).
> regL <- feols(log(CONVEYANCE_PRICE) ~ 0 + lsqft*lon | saleYear + age,data=df[age<MAXAGE])
> print(summary(regT))
OLS estimation, Dep. Var.: log(ppsf)
Observations: 6,466
Fixed-effects: saleYear: 7,  age: 37,  CTNAME: 85
Standard-errors: Clustered (saleYear) 
                        Estimate Std. Error       t value Pr(>|t|) 
lsqft                  -0.434995    9602.12 -0.0000453020  0.99997 
lsqft:CTNAME::0002.01  -0.221221    9602.35 -0.0000230382  0.99998 
lsqft:CTNAME::0002.03   0.179236    9602.22  0.0000186661  0.99999 
lsqft:CTNAME::0002.04   0.441917    9602.06  0.0000460232  0.99996 
lsqft:CTNAME::0003.01   0.019344    9602.17  0.0000020145  1.00000 
lsqft:CTNAME::0003.02   0.146277    9602.11  0.0000152338  0.99999 
lsqft:CTNAME::0004.01  -0.118855    9602.14 -0.0000123779  0.99999 
lsqft:CTNAME::0004.02   0.057767    9602.10  0.0000060161  1.00000 
lsqft:CTNAME::0005.00   0.168430    9602.01  0.0000175412  0.99999 
lsqft:CTNAME::0006.01   0.370796    9602.14  0.0000386159  0.99997 
lsqft:CTNAME::0006.02   0.332789    9602.15  0.0000346578  0.99997 
lsqft:CTNAME::0007.01   0.046194    9602.12  0.0000048108  1.00000 
lsqft:CTNAME::0007.02   0.187420    9602.12  0.0000195186  0.99999 
lsqft:CTNAME::0008.02  -0.027134    9602.14 -0.0000028258  1.00000 
lsqft:CTNAME::0009.00   0.043455    9602.17  0.0000045255  1.00000 
lsqft:CTNAME::0011.00   0.013917    9602.12  0.0000014494  1.00000 
lsqft:CTNAME::0012.01   0.250614    9602.13  0.0000260998  0.99998 
lsqft:CTNAME::0012.02   0.172967    9602.15  0.0000180134  0.99999 
lsqft:CTNAME::0013.01   0.020646    9602.12  0.0000021501  1.00000 
lsqft:CTNAME::0013.03  -0.147469    9602.12 -0.0000153579  0.99999 
lsqft:CTNAME::0013.04   0.058968    9602.15  0.0000061411  1.00000 
lsqft:CTNAME::0014.01   0.167989    9602.15  0.0000174949  0.99999 
lsqft:CTNAME::0014.02   0.062461    9602.10  0.0000065050  1.00000 
lsqft:CTNAME::0015.01  -0.103348    9602.13 -0.0000107630  0.99999 
lsqft:CTNAME::0015.02  -0.210698    9602.12 -0.0000219428  0.99998 
lsqft:CTNAME::0016.01   0.022388    9602.15  0.0000023315  1.00000 
lsqft:CTNAME::0016.04   0.025518    9602.20  0.0000026575  1.00000 
lsqft:CTNAME::0016.05  -0.312260    9602.11 -0.0000325200  0.99998 
lsqft:CTNAME::0017.02   0.041968    9602.15  0.0000043707  1.00000 
lsqft:CTNAME::0017.03   0.271534    9602.16  0.0000282784  0.99998 
lsqft:CTNAME::0017.04   0.070813    9602.07  0.0000073747  0.99999 
lsqft:CTNAME::0018.01   0.075778    9602.19  0.0000078917  0.99999 
lsqft:CTNAME::0018.02  -0.122974    9602.13 -0.0000128069  0.99999 
lsqft:CTNAME::0019.00  -0.101415    9602.10 -0.0000105618  0.99999 
lsqft:CTNAME::0021.00  -0.434667    9602.07 -0.0000452680  0.99997 
lsqft:CTNAME::0022.00   0.524056    9602.20  0.0000545766  0.99996 
lsqft:CTNAME::0023.00   0.172338    9602.03  0.0000179481  0.99999 
lsqft:CTNAME::0024.00   0.385096    9602.20  0.0000401050  0.99997 
lsqft:CTNAME::0025.00   0.246372    9602.09  0.0000256582  0.99998 
lsqft:CTNAME::0026.00   0.107828    9602.14  0.0000112296  0.99999 
lsqft:CTNAME::0029.00   0.010363    9602.13  0.0000010793  1.00000 
lsqft:CTNAME::0030.00  -0.139455    9602.11 -0.0000145234  0.99999 
lsqft:CTNAME::0031.01   0.165965    9602.14  0.0000172842  0.99999 
lsqft:CTNAME::0031.02   0.336122    9602.12  0.0000350049  0.99997 
lsqft:CTNAME::0032.01   0.232271    9602.18  0.0000241894  0.99998 
lsqft:CTNAME::0032.02   0.208878    9602.16  0.0000217532  0.99998 
lsqft:CTNAME::0033.01   0.159300    9602.08  0.0000165901  0.99999 
lsqft:CTNAME::0033.02   0.129289    9602.14  0.0000134646  0.99999 
lsqft:CTNAME::0034.01   0.072651    9602.12  0.0000075661  0.99999 
lsqft:CTNAME::0034.02  -0.044446    9602.17 -0.0000046288  1.00000 
lsqft:CTNAME::0035.01   0.119202    9602.13  0.0000124141  0.99999 
lsqft:CTNAME::0035.02   0.056839    9602.10  0.0000059194  1.00000 
lsqft:CTNAME::0036.01  -0.178066    9602.07 -0.0000185445  0.99999 
lsqft:CTNAME::0036.02  -0.254250    9602.09 -0.0000264786  0.99998 
lsqft:CTNAME::0037.01   0.212677    9602.19  0.0000221488  0.99998 
lsqft:CTNAME::0037.02  -0.029890    9602.08 -0.0000031129  1.00000 
lsqft:CTNAME::0038.00   0.327276    9602.10  0.0000340838  0.99997 
lsqft:CTNAME::0039.01   0.465710    9601.94  0.0000485017  0.99996 
lsqft:CTNAME::0041.02   0.708492    9602.12  0.0000737850  0.99994 
lsqft:CTNAME::0042.00  -0.083722    9602.09 -0.0000087192  0.99999 
lsqft:CTNAME::0043.01   0.038908    9602.17  0.0000040520  1.00000 
lsqft:CTNAME::0043.02   0.006024    9602.09  0.0000006274  1.00000 
lsqft:CTNAME::0044.00   0.714911    9602.03  0.0000744542  0.99994 
lsqft:CTNAME::0045.01   0.751294    9602.05  0.0000782431  0.99994 
lsqft:CTNAME::0045.02  -0.082450    9602.17 -0.0000085866  0.99999 
lsqft:CTNAME::0046.00 -18.866718    9602.12 -0.0019648483  0.99850 
lsqft:CTNAME::0048.01  -0.048953    9602.30 -0.0000050981  1.00000 
lsqft:CTNAME::0050.02  -0.181584    9602.10 -0.0000189108  0.99999 
lsqft:CTNAME::0050.03  -0.139691    9602.08 -0.0000145480  0.99999 
lsqft:CTNAME::0050.04   0.055466    9602.14  0.0000057764  1.00000 
lsqft:CTNAME::0051.01   0.073048    9602.09  0.0000076075  0.99999 
lsqft:CTNAME::0051.02  -0.130670    9602.16 -0.0000136084  0.99999 
lsqft:CTNAME::0052.01  -0.074413    9602.06 -0.0000077496  0.99999 
lsqft:CTNAME::0052.02  -0.031011    9602.11 -0.0000032296  1.00000 
lsqft:CTNAME::0053.01  -0.100767    9602.15 -0.0000104943  0.99999 
lsqft:CTNAME::0053.02   0.154892    9602.10  0.0000161310  0.99999 
lsqft:CTNAME::0054.01   0.030403    9602.03  0.0000031663  1.00000 
lsqft:CTNAME::0054.02  -0.120017    9602.08 -0.0000124991  0.99999 
lsqft:CTNAME::0055.01  -0.000315    9602.11 -0.0000000329  1.00000 
lsqft:CTNAME::0055.02   0.310422    9602.05  0.0000323287  0.99998 
lsqft:CTNAME::0056.01  -0.593434    9602.01 -0.0000618031  0.99995 
lsqft:CTNAME::0056.02   0.199886    9602.12  0.0000208169  0.99998 
... 88 variables were removed because of collinearity (CTNAME::0002.03, CTNAME::0002.04 and 86 others [full set in $collin.var])
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.148647     Adj. R2: 0.854232
                 Within R2: 0.168804
> print(summary(regN))
OLS estimation, Dep. Var.: log(CONVEYANCE_PRICE)
Observations: 6,466
Fixed-effects: saleYear: 7,  age: 37,  NEIGHBOURHOOD: 26
Standard-errors: Clustered (saleYear) 
                                                        Estimate Std. Error
lsqft                                                   0.470411   0.125569
lsqft:NEIGHBOURHOOD::Arbutus Ridge - Mackenzie Heights  0.168260   0.151833
lsqft:NEIGHBOURHOOD::Cambie                             0.045528   0.117397
lsqft:NEIGHBOURHOOD::Cedar Cottage                      0.423839   0.118176
lsqft:NEIGHBOURHOOD::Collingwood                        0.192339   0.114396
lsqft:NEIGHBOURHOOD::Dunbar                             0.299935   0.202553
lsqft:NEIGHBOURHOOD::Fairview                           0.214969   0.127478
lsqft:NEIGHBOURHOOD::Fraserview                         0.369661   0.299850
lsqft:NEIGHBOURHOOD::Grandview                          0.074516   0.125056
lsqft:NEIGHBOURHOOD::Hastings East                      0.086478   0.152103
lsqft:NEIGHBOURHOOD::Kerrisdale                         0.199801   0.171732
lsqft:NEIGHBOURHOOD::Killarney                          0.116160   0.131725
lsqft:NEIGHBOURHOOD::Kitsilano                          0.294356   0.120666
lsqft:NEIGHBOURHOOD::Knight                             0.148721   0.124289
lsqft:NEIGHBOURHOOD::Main & Fraser                      0.182435   0.140031
lsqft:NEIGHBOURHOOD::Marine Drive                       1.205730   0.468910
lsqft:NEIGHBOURHOOD::Marpole                            0.437391   0.121596
lsqft:NEIGHBOURHOOD::Mount Pleasant                     0.246562   0.076081
lsqft:NEIGHBOURHOOD::Oakridge                          -0.118199   0.292143
lsqft:NEIGHBOURHOOD::Point Grey                         0.359154   0.168635
lsqft:NEIGHBOURHOOD::Renfrew                            0.007937   0.126233
lsqft:NEIGHBOURHOOD::Renfrew Heights                    0.041667   0.174578
lsqft:NEIGHBOURHOOD::Shaughnessy                       -7.105163   0.412372
lsqft:NEIGHBOURHOOD::South Granville                    0.311329   0.194221
lsqft:NEIGHBOURHOOD::South Vancouver                    0.171426   0.105426
                                                          t value   Pr(>|t|)
lsqft                                                    3.746229 9.5521e-03
lsqft:NEIGHBOURHOOD::Arbutus Ridge - Mackenzie Heights   1.108191 3.1021e-01
lsqft:NEIGHBOURHOOD::Cambie                              0.387810 7.1154e-01
lsqft:NEIGHBOURHOOD::Cedar Cottage                       3.586497 1.1552e-02
lsqft:NEIGHBOURHOOD::Collingwood                         1.681339 1.4369e-01
lsqft:NEIGHBOURHOOD::Dunbar                              1.480775 1.8917e-01
lsqft:NEIGHBOURHOOD::Fairview                            1.686317 1.4271e-01
lsqft:NEIGHBOURHOOD::Fraserview                          1.232820 2.6375e-01
lsqft:NEIGHBOURHOOD::Grandview                           0.595856 5.7305e-01
lsqft:NEIGHBOURHOOD::Hastings East                       0.568546 5.9029e-01
lsqft:NEIGHBOURHOOD::Kerrisdale                          1.163451 2.8882e-01
lsqft:NEIGHBOURHOOD::Killarney                           0.881841 4.1179e-01
lsqft:NEIGHBOURHOOD::Kitsilano                           2.439434 5.0511e-02
lsqft:NEIGHBOURHOOD::Knight                              1.196572 2.7661e-01
lsqft:NEIGHBOURHOOD::Main & Fraser                       1.302819 2.4040e-01
lsqft:NEIGHBOURHOOD::Marine Drive                        2.571345 4.2258e-02
lsqft:NEIGHBOURHOOD::Marpole                             3.597075 1.1407e-02
lsqft:NEIGHBOURHOOD::Mount Pleasant                      3.240763 1.7670e-02
lsqft:NEIGHBOURHOOD::Oakridge                           -0.404594 6.9980e-01
lsqft:NEIGHBOURHOOD::Point Grey                          2.129768 7.7234e-02
lsqft:NEIGHBOURHOOD::Renfrew                             0.062873 9.5191e-01
lsqft:NEIGHBOURHOOD::Renfrew Heights                     0.238671 8.1930e-01
lsqft:NEIGHBOURHOOD::Shaughnessy                       -17.229993 2.4478e-06
lsqft:NEIGHBOURHOOD::South Granville                     1.602967 1.6006e-01
lsqft:NEIGHBOURHOOD::South Vancouver                     1.626031 1.5507e-01
                                                          
lsqft                                                  ** 
lsqft:NEIGHBOURHOOD::Arbutus Ridge - Mackenzie Heights    
lsqft:NEIGHBOURHOOD::Cambie                               
lsqft:NEIGHBOURHOOD::Cedar Cottage                     *  
lsqft:NEIGHBOURHOOD::Collingwood                          
lsqft:NEIGHBOURHOOD::Dunbar                               
lsqft:NEIGHBOURHOOD::Fairview                             
lsqft:NEIGHBOURHOOD::Fraserview                           
lsqft:NEIGHBOURHOOD::Grandview                            
lsqft:NEIGHBOURHOOD::Hastings East                        
lsqft:NEIGHBOURHOOD::Kerrisdale                           
lsqft:NEIGHBOURHOOD::Killarney                            
lsqft:NEIGHBOURHOOD::Kitsilano                         .  
lsqft:NEIGHBOURHOOD::Knight                               
lsqft:NEIGHBOURHOOD::Main & Fraser                        
lsqft:NEIGHBOURHOOD::Marine Drive                      *  
lsqft:NEIGHBOURHOOD::Marpole                           *  
lsqft:NEIGHBOURHOOD::Mount Pleasant                    *  
lsqft:NEIGHBOURHOOD::Oakridge                             
lsqft:NEIGHBOURHOOD::Point Grey                        .  
lsqft:NEIGHBOURHOOD::Renfrew                              
lsqft:NEIGHBOURHOOD::Renfrew Heights                      
lsqft:NEIGHBOURHOOD::Shaughnessy                       ***
lsqft:NEIGHBOURHOOD::South Granville                      
lsqft:NEIGHBOURHOOD::South Vancouver                      
... 27 variables were removed because of collinearity (NEIGHBOURHOOD::Cambie, NEIGHBOURHOOD::Cedar Cottage and 25 others [full set in $collin.var])
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.155676     Adj. R2: 0.881621
                 Within R2: 0.4658  
> print(summary(regL))
OLS estimation, Dep. Var.: log(CONVEYANCE_PRICE)
Observations: 6,466
Fixed-effects: saleYear: 7,  age: 37
Standard-errors: Clustered (saleYear) 
            Estimate Std. Error  t value   Pr(>|t|)    
lsqft     -205.65233  22.945945 -8.96247 0.00010778 ***
lon          8.54368   1.418541  6.02287 0.00094547 ***
lsqft:lon   -1.67686   0.186500 -8.99119 0.00010585 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.173531     Adj. R2: 0.853986
                 Within R2: 0.805853
> #lsqft:NEIGHBOURHOOD::Renfrew Heights  
> # turn coefficients of this form into a data.table
> df <- df[NEIGHBOURHOOD!="Shaughnessy"]
> dtInteractionsNeighbourhood <- data.table(neighbourhood=character(),interactionLSF=numeric(),medianPPSF=numeric())
> interceptLSF <- coef(regN)["lsqft"]
> for (n in unique(df[,NEIGHBOURHOOD])) {
+ 	medianPPSF <- median(df[NEIGHBOURHOOD==n & propertyType=="single" & age<MAXAGE,ppsf])
+ 	x <- data.table(neighbourhood=n,interactionLSF=coef(regN)[paste0("lsqft:NEIGHBOURHOOD::",n)][1]+interceptLSF,medianPPSF=medianPPSF)
+ 	dtInteractionsNeighbourhood <- rbind(dtInteractionsNeighbourhood, x)
+ }
> fwrite(dtInteractionsNeighbourhood,file="~/OneDrive - UBC/dataProcessed/neighbourhoodInteractionsVancouver.csv")
> q("no")
> proc.time()
   user  system elapsed 
 19.119   4.762   9.244 
