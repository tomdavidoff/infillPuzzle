
R version 4.5.2 (2025-10-31) -- "[Not] Part in a Rumble"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # bcaSales.R
> # R to use 2019 sales to get census-tract level coefficients on duplex vs single family and also square footage coefficients on ppsf
> # Tom Davidoff
> # 01/14/26
> 
> # strategy:
> # Get 2026 roll centroids, merge on roll/1000 (for subdivisions), confirm coverage for 2019 sales data (through 2018)
> # merge with census tract centroids
> # Regress coefficients, etc.
> 
> library(data.table)
> library(sf)
Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE
> library(RSQLite)
> library(fixest)
> library(ggplot2)
> library(scales)

Attaching package: ‘scales’

The following object is masked from ‘package:fixest’:

    pvalue

> library(stringr)
> library(readxl)
> library(geosphere)
> library(nnet)
> library(xtable)
> 
> # per google
> latDowntown <- 49.2827
> lonDowntown <- -123.1207
> ONTARIOLON <- -123.105 # google
> WIDTHTOL <- .10
> MAXAGE <- 25
> MINOBS <- 20
> 
> centroidsFile <- "~/OneDrive - UBC/dataProcessed/bca25Centroids.rds"
> print(centroidsFile)
[1] "~/OneDrive - UBC/dataProcessed/bca25Centroids.rds"
> print(file.exists(centroidsFile))
[1] TRUE
> if (!file.exists(centroidsFile)) {
+   source("scripts/getBCAVancouverCentroids.R")
+ }
> dtCentroids <- readRDS(centroidsFile)
> # add to data.table
> 
> dtInventory <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/Residential_inventory_202501/20250101_A09_Residential_Inventory_Extract.txt",select=c("Roll_Number","MB_Total_Finished_Area","Zoning","Land_Width_Width","Land_Depth_Depth","MB_Effective_Year"),colClasses=c(Roll_Number="character",MB_Total_Finished_Area="numeric",Zoning="character",Land_Width_Width="numeric",Land_Depth_Depth="numeric"))
> print(head(dtInventory))
       Roll_Number MB_Total_Finished_Area Zoning Land_Width_Width
            <char>                  <num> <char>            <num>
1: 001019632060000                  11895   R1-1               NA
2: 001019632290000                   7760   R1-1              195
3: 001019632450000                   3215   R1-1              150
4: 001019632650000                   8673   R1-1              150
5: 001019632760000                   2942   R1-1              170
6: 001019635070000                   4739   R1-1              170
   Land_Depth_Depth MB_Effective_Year
              <num>             <int>
1:                0              2020
2:              252              1997
3:              250              1945
4:              250              2011
5:              215              2022
6:              219              1995
> dtSales <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_sales_20250331_REVD25.csv",select=c("ROLL_NUMBER","FOLIO_ID","CONVEYANCE_DATE","CONVEYANCE_PRICE","CONVEYANCE_TYPE_DESCRIPTION"))
> dtSales <- dtSales[CONVEYANCE_TYPE_DESCRIPTION=="Improved Single Property Transaction"]
> dtSales[,saleYear:=as.numeric(substring(CONVEYANCE_DATE,1,4))]
> print(head(dtSales))
       ROLL_NUMBER   FOLIO_ID CONVEYANCE_DATE CONVEYANCE_PRICE
            <char>     <char>           <i64>            <int>
1: 001029650840000 A000000045  20080415000000          2775000
2: 001029650840000 A000000045  19880830000000           570000
3: 001029650840000 A000000045  19830127000000           266000
4: 001029650870000 A000000046  20121031000000          2698000
5: 001029650950000 A000000047  19771115000000           111500
6: 001030683570000 A00000004C  19950427000000           751000
            CONVEYANCE_TYPE_DESCRIPTION saleYear
                                 <char>    <num>
1: Improved Single Property Transaction     2008
2: Improved Single Property Transaction     1988
3: Improved Single Property Transaction     1983
4: Improved Single Property Transaction     2012
5: Improved Single Property Transaction     1977
6: Improved Single Property Transaction     1995
> dtDescription <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_descriptions_20250331_REVD25.csv",select=c("FOLIO_ID","ROLL_NUMBER","ACTUAL_USE_DESCRIPTION","NEIGHBOURHOOD","JURISDICTION_CODE"))
> dtDescription <- dtDescription[JURISDICTION_CODE==200]
> dtMerge <- merge(dtDescription,dtCentroids,by="ROLL_NUMBER")
> dtMerge <- merge(dtMerge,dtInventory,by.x="ROLL_NUMBER",by.y="Roll_Number")
> print(nrow(dtMerge))
[1] 199693
> dtMerge <- merge(dtMerge,dtSales,by="ROLL_NUMBER")
> # order by frequency
> print(table(dtMerge[,ACTUAL_USE_DESCRIPTION])[order(table(dtMerge[,ACTUAL_USE_DESCRIPTION]),decreasing=TRUE)])

                Strata-Lot Residence (Condominium) 
                                            194246 
                   Residential Dwelling with Suite 
                                             66161 
                            Single Family Dwelling 
                                             58666 
               Row Housing (Single Unit Ownership) 
                                             22642 
                       Duplex, Strata Front / Back 
                                              5443 
                       Duplex, Strata Side by Side 
                                              3004 
                 Property Subject To Section 19(8) 
                                              1512 
   Duplex, Non-Strata Side by Side or Front / Back 
                                              1317 
  Stratified Rental Apartment (Frame Construction) 
                                               498 
                          Duplex, Strata Up / Down 
                                               269 
              Vacant Residential Less Than 2 Acres 
                                               195 
                      Duplex, Non-Strata Up / Down 
                                               151 
Stratified Rental Apartment (Hi-Rise Construction) 
                                               104 
  2 Acres Or More (Single Family Dwelling, Duplex) 
                                                63 
                                           Triplex 
                                                56 
                       Stratified Rental Townhouse 
                                                38 
       Bed & Breakfast Operation Less Than 4 Units 
                                                29 
                      Residential Outbuilding Only 
                                                 5 
                     2 Acres Or More (Outbuilding) 
                                                 3 
                          2 Acres Or More (Vacant) 
                                                 2 
                                             Other 
                                                 2 
> dtMerge <- dtMerge[ACTUAL_USE_DESCRIPTION %in% c("Strata-Lot Residence (Condominium)", "Residential Dwelling with Suite", "Single Family Dwelling", "Row Housing (Single Unit Ownership)") | grepl("Duplex",ACTUAL_USE_DESCRIPTION)]
> # first question: among single family homes are neighbourhoods relevant?
> dtMerge[,age:=saleYear-MB_Effective_Year]
> # citywide optimal square feet?
> 
> dtMerge[,distDowntown:=distGeo(cbind(lon,lat),c(lonDowntown,latDowntown))]
> regValue1 <- feols(log(CONVEYANCE_PRICE) ~ log(MB_Total_Finished_Area) + log(age+1) +lon*distDowntown|saleYear^ACTUAL_USE_DESCRIPTION,data=dtMerge )
NOTES: 30,749 observations removed because of NA and infinite values (LHS: 40, RHS: 30,710).
       35 fixed-effect singletons were removed (35 observations).
Warning message:
In log(age + 1) : NaNs produced
> regValue2 <- feols(log(CONVEYANCE_PRICE) ~ log(MB_Total_Finished_Area) + log(age+1) +lon*distDowntown + i(NEIGHBOURHOOD)|saleYear^ACTUAL_USE_DESCRIPTION,data=dtMerge )
NOTES: 30,749 observations removed because of NA and infinite values (LHS: 40, RHS: 30,710).
       35 fixed-effect singletons were removed (35 observations).
Warning message:
In log(age + 1) : NaNs produced
> # add census tract merge from Lon/Lat
> ct_file <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
> sCT <- st_read(ct_file, quiet = TRUE)
> sCT <- st_make_valid(sCT)
> 
> # turn lon/lat into a spatial point, then merge with census tract geometry as a spatial merge
> # plain vanilla crs lat lon
> sMerge <- st_as_sf(dtMerge, coords = c("lon", "lat"),crs=4326)
> sMerge <- st_transform(sMerge, crs = st_crs(sCT))
> sMerge <- st_join(sMerge, sCT, left = TRUE)
> # reconvert to better crs and get lon/lat familiarly
> sMerge <- st_transform(sMerge, crs = 4326)
> sMerge$lon <- st_coordinates(sMerge)[,1]
> sMerge$lat <- st_coordinates(sMerge)[,2]
> df <- as.data.table(sMerge)
> MINSQFT <- 400
> df[,propertyType:=ifelse(ACTUAL_USE_DESCRIPTION %chin% c("Single Family Dwelling","Residential Dwelling with Suite"),"single",ifelse(grepl("Duplex,",ACTUAL_USE_DESCRIPTION),"duplex",ifelse(ACTUAL_USE_DESCRIPTION=="Row Housing (Single Unit Ownership)","TH","condo")))]
> df[,lsqft := log(MB_Total_Finished_Area)]
> df <- df[!is.na(lsqft) & !is.na(CONVEYANCE_PRICE) & !is.na(age) & !is.na(lon) & !is.na(lat) & !is.na(saleYear) & !is.na(CTNAME) & CONVEYANCE_PRICE>0 & age>=0 & MB_Total_Finished_Area>MINSQFT]
> MINWIDTH <- 30
> MAXWIDTH <- 35 # over half of properties
> df <- df[Land_Width_Width %between% c(MINWIDTH,MAXWIDTH)]
> df[,east:=lon>ONTARIOLON]
> df[,single:=propertyType=="single"]
> 
> ancientYears <- c(2002,2004)
> oldYears <- c(2012,2014)
> modYears <- c(2017,2018)
> newYears <- c(2022,2024)
> residPlot <- function(yearList) {
+ 	dmap <- df[propertyType %in% c("single","duplex") & age<MAXAGE & saleYear %in% yearList]
+ 	rr <- feols(log(CONVEYANCE_PRICE) ~ lsqft | saleYear + age ,  data=dmap)
+ 	dmap[,rrResidual := resid(rr)]
+ 	ggplot(dmap,aes(x=lon,y=lat,color=rrResidual)) + geom_point() + scale_color_gradient2(low="grey80",high="grey10",limits = c(-1,1),
+     oob = scales::squish) + theme_minimal() + labs(color="Residual") + geom_vline(xintercept=ONTARIOLON, linetype="dashed", color="black") + theme(legend.position = "bottom") 
+ 	ggsave(paste0("text/residualsMap",yearList[1],"to",yearList[2],".png"))
+ }
> lapply(list(ancientYears,oldYears,modYears,newYears), residPlot)
Saving 7 x 7 in image
Saving 7 x 7 in image
Saving 7 x 7 in image
Saving 7 x 7 in image
[[1]]
[1] "text/residualsMap2002to2004.png"

[[2]]
[1] "text/residualsMap2012to2014.png"

[[3]]
[1] "text/residualsMap2017to2018.png"

[[4]]
[1] "text/residualsMap2022to2024.png"

> 
> print(etable(feols(log(CONVEYANCE_PRICE) ~ lsqft + i(propertyType)*east | saleYear + age,data=df[age<MAXAGE])))
The variables 'eastTRUE:propertyType::duplex', 'eastFALSE:propertyType::single',
'eastTRUE:propertyType::single', 'eastFALSE:propertyType::TH' and
'eastTRUE:propertyType::TH' have been removed because of collinearity (see
$collin.var).
                                  feols(log(CONVEYANC..
Dependent Var.:                   log(CONVEYANCE_PRICE)
                                                       
lsqft                                0.5506*** (0.0082)
propertyType = single                0.0918*** (0.0070)
propertyType = TH                       0.2905 (0.2653)
eastTRUE                            -0.4143*** (0.0033)
eastFALSE x propertyType = duplex     -0.0218* (0.0086)
Fixed-Effects:                    ---------------------
saleYear                                            Yes
age                                                 Yes
_________________________________ _____________________
S.E. type                                           IID
Observations                                     39,435
R2                                              0.94103
Within R2                                       0.48955
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
> 
> df <- df[saleYear>2016 & saleYear<2020,]
> 
> r0 <- feols(log(CONVEYANCE_PRICE) ~ lsqft |saleYear+age,data=df[age<MAXAGE])
> rD <- feols(log(CONVEYANCE_PRICE) ~ lsqft + lon*east |saleYear+age+east,data=df[age<MAXAGE])
The variable 'eastTRUE' has been removed because of collinearity (see
$collin.var).
> rL <- feols(log(CONVEYANCE_PRICE) ~ lsqft + lon|saleYear+age,data=df[age<MAXAGE])
> rLN <- feols(log(CONVEYANCE_PRICE) ~ lsqft |saleYear+age+NEIGHBOURHOOD,data=df[age<MAXAGE])
NOTE: 0/0/1 fixed-effect singleton was removed (1 observation).
> rLT <- feols(log(CONVEYANCE_PRICE) ~ lsqft |saleYear+age+CTNAME,data=df[age<MAXAGE])
NOTE: 0/0/4 fixed-effect singletons were removed (4 observations).
> # create a latex table of adjusted r2 for these regressions with brief descriptive names
> baseRegTable <- data.table(
+   Specification = c("Baseline", "East Dummy", "Longitude ", "Neighbourhood FE", "Census Tract FE"),
+   Adjusted_R2 = sapply(list(r0,rD, rL, rLN, rLT), function(reg) round(as.numeric(fitstat(reg, "ar2")),2))
+ )
> print(xtable(baseRegTable),file="text/vancouverRegressionComparisonTable.tex",include.rownames=FALSE, floating=FALSE)
> 
> r0 <- feols(log(CONVEYANCE_PRICE) ~ lsqft |saleYear+age,data=df[age<MAXAGE])
> rD <- feols(log(CONVEYANCE_PRICE) ~ lsqft*east|saleYear+age ,data=df[age<MAXAGE])
> rL <- feols(log(CONVEYANCE_PRICE) ~ lsqft*lon|saleYear+age ,data=df[age<MAXAGE])
> rLN <- feols(log(CONVEYANCE_PRICE) ~ lsqft*NEIGHBOURHOOD |saleYear+age,data=df[age<MAXAGE])
The variable 'lsqft:NEIGHBOURHOODFairview' has been removed because of
collinearity (see $collin.var).
> rLT <- feols(log(CONVEYANCE_PRICE) ~ lsqft*CTNAME |saleYear+age,data=df[age<MAXAGE])
The variables 'lsqft:CTNAME0039.02', 'lsqft:CTNAME0041.02',
'lsqft:CTNAME0047.02' and 'lsqft:CTNAME0050.04' have been removed because of
collinearity (see $collin.var).
> interRegTable <- data.table(
+   Specification = c("Baseline", "East Dummy Interaction", "Longitude Interaction", "Neighbourhood Interaction", "Census Tract Interaction"),
+   Adjusted_R2 = sapply(list(r0,rD, rL, rLN, rLT), function(reg) round(as.numeric(fitstat(reg, "ar2")),2))
+ )
> print(xtable(interRegTable),file="text/vancouverInteractionRegressionComparisonTable.tex",include.rownames=FALSE, floating=FALSE)
> 
> rD0 <- feols(log(CONVEYANCE_PRICE) ~ lsqft + east|saleYear+age,data=df[age<MAXAGE])
> rL0 <- feols(log(CONVEYANCE_PRICE) ~ lsqft + lon|saleYear+age,data=df[age<MAXAGE])
> 
> rD <- feols(log(CONVEYANCE_PRICE) ~ lsqft*east|saleYear+age,data=df[age<MAXAGE])
> rDR <- feols(log(CONVEYANCE_PRICE) ~ lsqft+ single*east|saleYear+age,data=df[age<MAXAGE])
> print(etable(rD0,rL0,rD,rL,rDR,tex=TRUE))
\begingroup
\centering
\begin{tabular}{lccccc}
   \tabularnewline \midrule \midrule
   Dependent Variable: & \multicolumn{5}{c}{log(CONVEYANCE\_PRICE)}\\
   Model:                        & (1)             & (2)            & (3)             & (4)            & (5)\\  
   \midrule
   \emph{Variables}\\
   lsqft                         & 0.7202$^{***}$  & 0.7311$^{***}$ & 0.8504$^{***}$  & -101.1$^{**}$  & 0.6278$^{***}$\\   
                                 & (0.0166)        & (0.0160)       & (0.0282)        & (42.71)        & (0.0293)\\   
   eastTRUE                      & -0.4198$^{***}$ &                & 1.097$^{***}$   &                & -0.3278$^{***}$\\   
                                 & (0.0100)        &                & (0.2673)        &                & (0.0235)\\   
   lon                           &                 & -3.903$^{***}$ &                 & 2.510          &   \\   
                                 &                 & (0.0881)       &                 & (2.692)        &   \\   
   lsqft $\times$ eastTRUE       &                 &                & -0.1966$^{***}$ &                &   \\   
                                 &                 &                & (0.0346)        &                &   \\   
   lsqft $\times$ lon            &                 &                &                 & -0.8269$^{**}$ &   \\   
                                 &                 &                &                 & (0.3470)       &   \\   
   singleTRUE                    &                 &                &                 &                & 0.1613$^{***}$\\   
                                 &                 &                &                 &                & (0.0286)\\   
   singleTRUE $\times$ eastTRUE  &                 &                &                 &                & -0.1201$^{***}$\\   
                                 &                 &                &                 &                & (0.0259)\\   
   \midrule
   \emph{Fixed-effects}\\
   saleYear                      & Yes             & Yes            & Yes             & Yes            & Yes\\  
   age                           & Yes             & Yes            & Yes             & Yes            & Yes\\  
   \midrule
   \emph{Fit statistics}\\
   Observations                  & 1,592           & 1,592          & 1,592           & 1,592          & 1,592\\  
   R$^2$                         & 0.77255         & 0.78560        & 0.77715         & 0.78638        & 0.77723\\  
   Within R$^2$                  & 0.75673         & 0.77069        & 0.76165         & 0.77152        & 0.76174\\  
   \midrule \midrule
   \multicolumn{6}{l}{\emph{IID standard-errors in parentheses}}\\
   \multicolumn{6}{l}{\emph{Signif. Codes: ***: 0.01, **: 0.05, *: 0.1}}\\
\end{tabular}
\par\endgroup
> 
> df[,ppsf:=CONVEYANCE_PRICE/MB_Total_Finished_Area]
> rDL <- feols(log(ppsf) ~ lsqft + east|saleYear+age,data=df[age<MAXAGE])
> rD <- feols(log(ppsf) ~ lsqft*east|saleYear+age,data=df[age<MAXAGE])
> print(etable(rDL,rD,tex=TRUE,file="text/vancouverEastPPSF.tex"))
\begingroup
\centering
\begin{tabular}{lcc}
   \tabularnewline \midrule \midrule
   Dependent Variable: & \multicolumn{2}{c}{log(ppsf)}\\
   Model:                   & (1)             & (2)\\  
   \midrule
   \emph{Variables}\\
   lsqft                    & -0.2798$^{***}$ & -0.1496$^{***}$\\   
                            & (0.0166)        & (0.0282)\\   
   eastTRUE                 & -0.4198$^{***}$ & 1.097$^{***}$\\   
                            & (0.0100)        & (0.2673)\\   
   lsqft $\times$ eastTRUE  &                 & -0.1966$^{***}$\\   
                            &                 & (0.0346)\\   
   \midrule
   \emph{Fixed-effects}\\
   saleYear                 & Yes             & Yes\\  
   age                      & Yes             & Yes\\  
   \midrule
   \emph{Fit statistics}\\
   Observations             & 1,592           & 1,592\\  
   R$^2$                    & 0.57012         & 0.57881\\  
   Within R$^2$             & 0.53592         & 0.54530\\  
   \midrule \midrule
   \multicolumn{3}{l}{\emph{IID standard-errors in parentheses}}\\
   \multicolumn{3}{l}{\emph{Signif. Codes: ***: 0.01, **: 0.05, *: 0.1}}\\
\end{tabular}
\par\endgroup
> WIDTH <- 33
> DEPTH <- 110
> Laneway <- WIDTH*DEPTH*.16
> Duplex <- WIDTH*DEPTH*.7/2
> Single <- WIDTH*DEPTH*.7
> plex4 <- WIDTH*DEPTH*1/4
> sqft <- c(Laneway,Single,Duplex,plex4)
> print(summary(df[,.(lsqft,CONVEYANCE_PRICE,age,saleYear,east)]))
     lsqft       CONVEYANCE_PRICE        age           saleYear   
 Min.   :6.458   Min.   :  490000   Min.   : 0.00   Min.   :2017  
 1st Qu.:7.485   1st Qu.: 1350000   1st Qu.: 9.00   1st Qu.:2017  
 Median :7.688   Median : 1620000   Median :22.00   Median :2018  
 Mean   :7.633   Mean   : 1874711   Mean   :24.56   Mean   :2018  
 3rd Qu.:7.819   3rd Qu.: 2218000   3rd Qu.:38.00   3rd Qu.:2019  
 Max.   :8.281   Max.   :10500000   Max.   :94.00   Max.   :2019  
    east        
 Mode :logical  
 FALSE:908      
 TRUE :1989     
                
                
                
> playData <- data.table(lsqft =rep(log(sqft),2),east=c(rep("FALSE",length(sqft)),rep("TRUE",length(sqft))),age=rep(0,2*length(sqft)),saleYear=rep(2019,2*length(sqft)))
> playData[,pred := predict(rD, newdata=playData)]
> playData[,fittedPPSF := round(exp(pred),2)]
> playData[,type:=rep(c("laneway","single","duplex","quadplex"),2)]
> playData[,sqft:=rep(sqft,2)]
> playData[,units:=rep(c(1,1,2,4),2)]
> playData[,totalPrice:=round(fittedPPSF*sqft*units,2)]
> print(xtable(playData[,.(type,east,sqft,fittedPPSF,totalPrice)]), file="text/vancouverFittedValues.tex",include.rownames=FALSE,floating=FALSE)
> 
> 
> q("no")
> proc.time()
   user  system elapsed 
 27.792   0.778  15.608 
