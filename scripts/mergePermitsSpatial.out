
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # mergePermitsSpatial.R
> # merge permit data with single family lots as of 2019 BCA (2018 assessment) and then census tracts
> # Tom Davidoff
> # 01/16/26
> 
> library(data.table)
Warning message:
package ‘data.table’ was built under R version 4.4.1 
> library(sf)
Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE
> 
> dtBCA <- readRDS("~/OneDrive - UBC/dataProcessed/bca_vancouver_residential.rds")
>  #[1] "permitnumber"              "permitnumbercreateddate"  [3] "issuedate"                 "permitelapseddays"        [5] "projectvalue"              "typeofwork"               [7] "address"                   "projectdescription"       [9] "permitcategory"            "applicant"                [11] "applicantaddress"          "propertyuse"              [13] "specificusecategory"       "buildingcontractor"       [15] "buildingcontractoraddress" "issueyear"                [17] "geolocalarea"              "geom"                     [19] "yearmonth"                 "geo_point_2d"             
> dtP <- fread("~/OneDrive - UBC/dataRaw/vancouver_permits_full.csv",select=c("geom","geo_point_2d","permitnumber","permitnumbercreateddate","applicant","typeofwork","projectvalue","specificusecategory"))
> dtP <- dtP[typeofwork %in% c("Addition / Alteration","New Building")]
> dtP[,yearMoCreated:=substr(permitnumbercreateddate,1,7)]
> dtP <- dtP[specificusecategory %in% c("Single Detached House","Laneway House","Single Detached House w/ Sec Suite","Multiple Dwelling","Duplex","Duplex w/Secondary Suite","address")]
> print(quantile(dtP[typeofwork=="Addition / Alteration",projectvalue]))
      0%      25%      50%      75%     100% 
       0    15000    45000   125000 38200000 
> MINVAL <- 125000 # appx 75th percentile for Addition / Alteration
> dtP <- dtP[projectvalue>=MINVAL]
> print(head(dtP[,.(geo_point_2d)]))
               geo_point_2d
                     <char>
1: 49.2746571, -123.1498796
2: 49.2548589, -123.1509132
3: 49.2789658, -123.0859052
4: 49.2729074, -123.2125593
5: 49.2537249, -123.1237645
6: 49.2535063, -123.1238697
> print(head(dtBCA[,.(geom)]))
                             geom
                    <sfc_POLYGON>
1: POLYGON ((1202268 477115.7,...
2: POLYGON ((1202148 477104.5,...
3: POLYGON ((1202142 477028.4,...
4: POLYGON ((1202194 477101.1,...
5: POLYGON ((1202351 477100.2,...
6: POLYGON ((1202339 477034.2,...
> # 1. Parse the point string and create sf geometry
> dtP[, c("lat", "lon") := tstrsplit(geo_point_2d, ", ", type.convert = TRUE)]
> dtP <- dtP[!is.na(lat)]
> sfP <- st_as_sf(dtP, coords = c("lon", "lat"), crs = 4326)
> 
> # 2. Transform to match BCA's CRS (check with st_crs(dtBCA))
> sfBCA <- st_as_sf(dtBCA)
> sfP <- st_transform(sfP, st_crs(sfBCA)) #st_crs(dtBCA)) from ogrinfo of original BCA .gpkg
> print(st_crs(sfBCA))
Coordinate Reference System:
  User input: NAD83 / BC Albers 
  wkt:
PROJCRS["NAD83 / BC Albers",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["British Columbia Albers",
        METHOD["Albers Equal Area",
            ID["EPSG",9822]],
        PARAMETER["Latitude of false origin",45,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-126,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",50,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",58.5,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",1000000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Province-wide spatial data management."],
        AREA["Canada - British Columbia."],
        BBOX[48.25,-139.04,60.01,-114.08]],
    ID["EPSG",3005]]
> 
> 
> # 3. Spatial join (points within polygons)
> merged <- st_join(sfP, sfBCA, join = st_within)
> print(head(merged))
Simple feature collection with 6 features and 19 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 1202978 ymin: 475052.4 xmax: 1212168 ymax: 477992
Projected CRS: NAD83 / BC Albers
                                                                geom
1 {""coordinates"": [-123.1498796, 49.2746571], ""type"": ""Point""}
2 {""coordinates"": [-123.1509132, 49.2548589], ""type"": ""Point""}
3 {""coordinates"": [-123.0859052, 49.2789658], ""type"": ""Point""}
4 {""coordinates"": [-123.2125593, 49.2729074], ""type"": ""Point""}
5 {""coordinates"": [-123.1237645, 49.2537249], ""type"": ""Point""}
6 {""coordinates"": [-123.1238697, 49.2535063], ""type"": ""Point""}
              geo_point_2d  permitnumber permitnumbercreateddate
1 49.2746571, -123.1498796 BP-2019-02286              2019-05-27
2 49.2548589, -123.1509132 BP-2024-02231              2024-06-17
3 49.2789658, -123.0859052 BP-2023-01594              2023-05-10
4 49.2729074, -123.2125593 BP-2024-00174              2024-01-17
5 49.2537249, -123.1237645 DB-2019-00743              2019-02-21
6 49.2535063, -123.1238697 DB-2019-00746              2019-02-21
                   applicant            typeofwork projectvalue
1 Measured Architecture Inc. Addition / Alteration       980000
2 Measured Architecture Inc.          New Building      7500000
3 Measured Architecture Inc. Addition / Alteration       750000
4 Measured Architecture Inc. Addition / Alteration      1150000
5 Measured Architecture Inc.          New Building       703730
6 Measured Architecture Inc.          New Building       180205
    specificusecategory yearMoCreated  rollStart    folioID      rollNumber
1 Single Detached House       2019-05         NA       <NA>            <NA>
2 Single Detached House       2024-06         NA       <NA>            <NA>
3 Single Detached House       2023-05         NA       <NA>            <NA>
4 Single Detached House       2024-01 1633021620 A0000000CR 001633021620000
5 Single Detached House       2019-02 9697153290 A00000191E 009697153290000
6         Laneway House       2019-02         NA       <NA>            <NA>
  zoning MB_effective_year MB_total_finished_area   actualUseDescription
1   <NA>              <NA>                   <NA>                   <NA>
2   <NA>              <NA>                   <NA>                   <NA>
3   <NA>              <NA>                   <NA>                   <NA>
4    RS1              1965                   4002 Single Family Dwelling
5    RS5                                          Single Family Dwelling
6   <NA>              <NA>                   <NA>                   <NA>
  neighbourhoodDescription     ROLL_NUMBER Nlot                 geometry
1                     <NA>            <NA>   NA   POINT (1207532 477324)
2                     <NA>            <NA>   NA POINT (1207545 475122.9)
3                     <NA>            <NA>   NA   POINT (1212168 477992)
4               POINT GREY 001633021620000    1   POINT (1202978 476948)
5                   CAMBIE 009697153290000    1   POINT (1209527 475077)
6                     <NA>            <NA>   NA POINT (1209520 475052.4)
> print(nrow(sfP))
[1] 9336
> print(nrow(dtBCA))
[1] 64210
> print(nrow(sfP))
[1] 9336
> 
> # now get census tracts
> fCT <- "~/OneDrive - UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp"
> dCT <- st_read(fCT)
Reading layer `lct_000b21a_e' from data source 
  `/Users/davidoff/Library/CloudStorage/OneDrive-UBC/dataRaw/lct_000b21a_e/lct_000b21a_e.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 6247 features and 5 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 3912489 ymin: 687427.7 xmax: 8996148 ymax: 2810992
Projected CRS: NAD83 / Statistics Canada Lambert
> print(head(dCT))
Simple feature collection with 6 features and 5 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 7172098 ymin: 860422.8 xmax: 8980685 ymax: 2153697
Projected CRS: NAD83 / Statistics Canada Lambert
       CTUID               DGUID  CTNAME LANDAREA PRUID
1 5370001.08 2021S05075370001.08 0001.08   1.6383    35
2 0010002.00 2021S05070010002.00 0002.00   1.9638    10
3 5370001.09 2021S05075370001.09 0001.09   1.9699    35
4 5370120.02 2021S05075370120.02 0120.02  76.9650    35
5 0010006.00 2021S05070010006.00 0006.00   1.0467    10
6 0010007.00 2021S05070010007.00 0007.00   0.5364    10
                        geometry
1 MULTIPOLYGON (((7196507 869...
2 MULTIPOLYGON (((8980217 215...
3 MULTIPOLYGON (((7196437 869...
4 MULTIPOLYGON (((7189476 865...
5 MULTIPOLYGON (((8980091 215...
6 MULTIPOLYGON (((8980158 215...
> # swap crs of census tracts to that of merged)
> print(st_crs(dCT))
Coordinate Reference System:
  User input: NAD83 / Statistics Canada Lambert 
  wkt:
PROJCRS["NAD83 / Statistics Canada Lambert",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["Statistics Canada Lambert",
        METHOD["Lambert Conic Conformal (2SP)",
            ID["EPSG",9802]],
        PARAMETER["Latitude of false origin",63.390675,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-91.8666666666667,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",49,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",77,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",6200000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",3000000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Topographic mapping (small scale)."],
        AREA["Canada - onshore and offshore - Alberta; British Columbia; Manitoba; New Brunswick; Newfoundland and Labrador; Northwest Territories; Nova Scotia; Nunavut; Ontario; Prince Edward Island; Quebec; Saskatchewan; Yukon."],
        BBOX[38.21,-141.01,86.46,-40.73]],
    ID["EPSG",3347]]
> print(st_crs(merged))
Coordinate Reference System:
  User input: NAD83 / BC Albers 
  wkt:
PROJCRS["NAD83 / BC Albers",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["British Columbia Albers",
        METHOD["Albers Equal Area",
            ID["EPSG",9822]],
        PARAMETER["Latitude of false origin",45,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-126,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",50,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",58.5,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",1000000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    USAGE[
        SCOPE["Province-wide spatial data management."],
        AREA["Canada - British Columbia."],
        BBOX[48.25,-139.04,60.01,-114.08]],
    ID["EPSG",3005]]
> dCT <- st_transform(dCT,st_crs(merged))
> 
> mergedCT <- st_join(merged,dCT,join=st_within)
> print(head(mergedCT))
Simple feature collection with 6 features and 24 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 1202978 ymin: 475052.4 xmax: 1212168 ymax: 477992
Projected CRS: NAD83 / BC Albers
                                                                geom
1 {""coordinates"": [-123.1498796, 49.2746571], ""type"": ""Point""}
2 {""coordinates"": [-123.1509132, 49.2548589], ""type"": ""Point""}
3 {""coordinates"": [-123.0859052, 49.2789658], ""type"": ""Point""}
4 {""coordinates"": [-123.2125593, 49.2729074], ""type"": ""Point""}
5 {""coordinates"": [-123.1237645, 49.2537249], ""type"": ""Point""}
6 {""coordinates"": [-123.1238697, 49.2535063], ""type"": ""Point""}
              geo_point_2d  permitnumber permitnumbercreateddate
1 49.2746571, -123.1498796 BP-2019-02286              2019-05-27
2 49.2548589, -123.1509132 BP-2024-02231              2024-06-17
3 49.2789658, -123.0859052 BP-2023-01594              2023-05-10
4 49.2729074, -123.2125593 BP-2024-00174              2024-01-17
5 49.2537249, -123.1237645 DB-2019-00743              2019-02-21
6 49.2535063, -123.1238697 DB-2019-00746              2019-02-21
                   applicant            typeofwork projectvalue
1 Measured Architecture Inc. Addition / Alteration       980000
2 Measured Architecture Inc.          New Building      7500000
3 Measured Architecture Inc. Addition / Alteration       750000
4 Measured Architecture Inc. Addition / Alteration      1150000
5 Measured Architecture Inc.          New Building       703730
6 Measured Architecture Inc.          New Building       180205
    specificusecategory yearMoCreated  rollStart    folioID      rollNumber
1 Single Detached House       2019-05         NA       <NA>            <NA>
2 Single Detached House       2024-06         NA       <NA>            <NA>
3 Single Detached House       2023-05         NA       <NA>            <NA>
4 Single Detached House       2024-01 1633021620 A0000000CR 001633021620000
5 Single Detached House       2019-02 9697153290 A00000191E 009697153290000
6         Laneway House       2019-02         NA       <NA>            <NA>
  zoning MB_effective_year MB_total_finished_area   actualUseDescription
1   <NA>              <NA>                   <NA>                   <NA>
2   <NA>              <NA>                   <NA>                   <NA>
3   <NA>              <NA>                   <NA>                   <NA>
4    RS1              1965                   4002 Single Family Dwelling
5    RS5                                          Single Family Dwelling
6   <NA>              <NA>                   <NA>                   <NA>
  neighbourhoodDescription     ROLL_NUMBER Nlot      CTUID               DGUID
1                     <NA>            <NA>   NA 9330048.01 2021S05079330048.01
2                     <NA>            <NA>   NA 9330027.01 2021S05079330027.01
3                     <NA>            <NA>   NA 9330057.02 2021S05079330057.02
4               POINT GREY 001633021620000    1 9330044.00 2021S05079330044.00
5                   CAMBIE 009697153290000    1 9330029.00 2021S05079330029.00
6                     <NA>            <NA>   NA 9330029.00 2021S05079330029.00
   CTNAME LANDAREA PRUID                 geometry
1 0048.01   0.8336    59   POINT (1207532 477324)
2 0027.01   1.2742    59 POINT (1207545 475122.9)
3 0057.02   1.6262    59   POINT (1212168 477992)
4 0044.00   2.8772    59   POINT (1202978 476948)
5 0029.00   1.5016    59   POINT (1209527 475077)
6 0029.00   1.5016    59 POINT (1209520 475052.4)
> 
> ##
> merged[,matched:=!is.na(zoning)]
Error in `:=`(matched, !is.na(zoning)) : 
  Check that is.data.table(DT) == TRUE. Otherwise, :=, `:=`(...) and let(...) are defined for use in j, once only and in particular ways. Note that namespace-qualification like data.table::`:=`(...) is not supported. See help(":=").
Calls: [ ... [.data.frame -> := -> stopf -> raise_condition -> signal
Execution halted
